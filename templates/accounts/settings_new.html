{% extends "accounts/base_with_sidebar.html" %}
{% load static %}
{% load humanize %}

{% block title %}Settings - LFG ðŸš€ðŸš€{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/organizations.css' %}">
<style>
    /* Theme-aware CSS variables for settings page */
    :root {
        --settings-card-bg: #1a1a1a;
        --settings-card-border: #2a2a2a;
        --settings-content-bg: #1a1a1a;
        --settings-text-primary: #e5e7eb;
        --settings-text-secondary: #6b7280;
        --settings-text-muted: #9ca3af;
        --settings-badge-bg: #1f2937;
        --settings-progress-bg: #0f0f0f;
        --settings-button-secondary-bg: #374151;
        --settings-card-icon-bg: #4b5563;
        --settings-modal-bg: #1a1a1a;
        --input-bg: rgba(10, 10, 15, 0.6);
    }

    [data-theme="light"] {
        --settings-card-bg: #ffffff;
        --settings-card-border: #e2e8f0;
        --settings-content-bg: #f8fafc;
        --settings-text-primary: #1e293b;
        --settings-text-secondary: #64748b;
        --settings-text-muted: #94a3b8;
        --settings-badge-bg: #e2e8f0;
        --settings-progress-bg: #e2e8f0;
        --settings-button-secondary-bg: #e2e8f0;
        --settings-card-icon-bg: #94a3b8;
        --settings-modal-bg: #ffffff;
        --input-bg: #ffffff;
    }

    /* Subtle notification styling */
    .messages {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 400px;
    }
    
    .alert {
        background: rgba(167, 139, 250, 0.1);
        border: 1px solid rgba(167, 139, 250, 0.3);
        color: #a78bfa;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .alert::before {
        content: '\f05a';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        font-size: 1rem;
    }
    
    .alert-success {
        background: rgba(34, 197, 94, 0.1);
        border-color: rgba(34, 197, 94, 0.3);
        color: #22c55e;
    }
    
    .alert-success::before {
        content: '\f058';
    }
    
    .alert-danger {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
        color: #ef4444;
    }
    
    .alert-danger::before {
        content: '\f06a';
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Auto-hide after 5 seconds */
    .alert {
        animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-out 5s forwards;
    }
    
    @keyframes fadeOut {
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }
    /* Ensure full height for parent containers */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    
    .app-container {
        height: 100vh;
        display: flex;
    }
    
    .main-content-with-sidebar {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    /* Override container styles for full-height layout */
    .main-content-with-sidebar .container {
        max-width: 100%;
        padding: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    
    /* Page header matching Projects style */
    .page-header {
        padding: 2rem 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-shrink: 0;
    }
    
    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .settings-container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem 0;
        display: flex;
        flex-direction: column;
        height: 100%;
        flex: 1;
        transition: all 0.3s ease;
    }
    
    /* When sidebar is minimized, center the content better */
    .sidebar-minimized .settings-container {
        max-width: 1200px;
        padding: 2rem 4rem 0;
    }
    
    .sidebar-minimized .settings-wrapper {
        max-width: 1000px;
        margin: 0 auto;
        gap: 3rem;
    }
    
    .sidebar-minimized .settings-sidebar {
        width: 260px;
    }
    
    /* Ensure consistent widths when sidebar is minimized - override any previous rules */
    .sidebar-minimized .settings-section .integrations-list,
    .sidebar-minimized .settings-section .usage-content-wrapper,
    .sidebar-minimized .settings-section .subscription-cards-grid {
        max-width: 800px !important;
        width: 100% !important;
        margin: 0 auto !important;
    }

    .settings-container .page-header {
        border-bottom: 1px solid var(--border-color);
    }
    
    .page-title i {
        font-size: 1.5rem;
    }
    
    /* Settings wrapper - full height layout */
    .settings-wrapper {
        display: flex;
        flex: 1;
        overflow: hidden;
        gap: 2rem;
        height: 100%;
    }
    
    /* Settings sidebar */
    .settings-sidebar {
        width: 280px;
        background: transparent;
        overflow-y: auto;
        flex-shrink: 0;
        padding-left: 0;
        height: 100%;
    }
    
    /* Custom scrollbar styling for settings sidebar */
    .settings-sidebar::-webkit-scrollbar {
        width: 4px;
    }
    
    .settings-sidebar::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .settings-sidebar::-webkit-scrollbar-thumb {
        background: rgba(167, 139, 250, 0.2);
        border-radius: 2px;
    }
    
    .settings-sidebar::-webkit-scrollbar-thumb:hover {
        background: rgba(167, 139, 250, 0.4);
    }
    
    .settings-nav {
        padding: 0;
        background: var(--settings-card-bg);
        border-radius: 8px;
        overflow: hidden;
        padding: 1rem 0;
    }

    .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        color: var(--settings-text-secondary);
        text-decoration: none;
        transition: all 0.15s ease;
        font-size: 0.875rem;
        font-weight: 500;
        position: relative;
        margin: 0.25rem 0.5rem;
        border-radius: 6px;
    }

    .settings-nav-item:hover {
        background: rgba(128, 128, 128, 0.1);
        color: var(--settings-text-primary);
    }
    
    .settings-nav-item.active {
        background: rgba(167, 139, 250, 0.1);
        color: #a78bfa;
    }
    
    .settings-nav-item.active::after {
        display: none;
    }
    
    .settings-nav-item.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    .settings-nav-item i {
        width: 18px;
        text-align: center;
        font-size: 16px;
    }
    
    /* Settings content */
    .settings-content {
        flex: 1;
        overflow: hidden;
        background: var(--settings-content-bg);
        border-radius: 8px;
        position: relative;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .settings-section {
        display: none;
        padding: 3rem;
        width: 100%;
        height: 100%;
        flex-direction: column;
        align-items: center;
        overflow-y: auto;
        /* Allow visible scrollbar for better usability */
    }
    
    /* Ensure all settings sections have consistent max width */
    .settings-section .integrations-list,
    .settings-section .usage-content-wrapper,
    .settings-section .subscription-cards-grid {
        max-width: 800px !important;
        width: 100% !important;
        margin: 0 auto !important;
    }
    
    /* Custom scrollbar styling for settings sections */
    .settings-section::-webkit-scrollbar {
        width: 6px;
    }
    
    .settings-section::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }
    
    .settings-section::-webkit-scrollbar-thumb {
        background: rgba(167, 139, 250, 0.3);
        border-radius: 3px;
    }
    
    .settings-section::-webkit-scrollbar-thumb:hover {
        background: rgba(167, 139, 250, 0.5);
    }
    
    .settings-section.active {
        display: flex;
    }
    
    .section-heading {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: var(--text-color);
        text-align: center;
        width: 100%;
    }
    
    /* List view for integrations */
    .integrations-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        width: 100%;
    }
    
    .integration-item {
        background: var(--settings-card-bg);
        border: 1px solid var(--settings-card-border);
        border-radius: 16px;
        padding: 1.75rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .integration-item:hover {
        border-color: rgba(167, 139, 250, 0.5);
        background: rgba(167, 139, 250, 0.08);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    .integration-header {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        margin-bottom: 1.25rem;
    }
    
    .integration-icon {
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        background: white;
        border-radius: 12px;
        padding: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .integration-icon svg {
        width: 100%;
        height: 100%;
    }
    
    .integration-info {
        flex: 1;
    }
    
    .integration-name {
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .integration-description {
        font-size: 0.875rem;
        color: var(--settings-text-secondary);
        margin: 0.375rem 0 0 0;
    }
    
    /* Connected status check */
    .connected-check {
        width: 20px;
        height: 20px;
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }
    
    /* API Key Input Section */
    .api-key-section {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        margin-top: 1rem;
    }
    
    .api-key-input-wrapper {
        flex: 1;
        position: relative;
        max-width: 100%;
    }
    
    .api-input {
        width: 100%;
        padding: 0.625rem 1rem;
        padding-right: 3rem;
        background: var(--input-bg, #ffffff);
        border: 1px solid var(--settings-card-border);
        border-radius: 10px;
        color: var(--text-color);
        font-size: 0.875rem;
        font-family: monospace;
        height: 42px;
        box-sizing: border-box;
        transition: all 0.2s ease;
    }
    
    .api-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    .api-input.connected {
        background: rgba(34, 197, 94, 0.05);
        border-color: rgba(34, 197, 94, 0.3);
        height: 36px;
        box-sizing: border-box;
    }
    
    .input-status {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.875rem;
    }
    
    .save-button,
    .disconnect-button {
        padding: 0.625rem 1.25rem;
        border: none;
        border-radius: 10px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        height: 42px;
        display: inline-flex;
        align-items: center;
    }
    
    .save-button {
        background: linear-gradient(135deg, #8B5CF6, #A855F7);
        color: white;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
    }
    
    .save-button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.35);
    }
    
    .save-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .disconnect-button {
        background: transparent;
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .disconnect-button:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.5);
    }
    
    /* Ensure consistent alignment for connected state */
    .integration-item form {
        margin: 0;
    }
    
    .integration-item .api-key-section {
        margin-top: 0.75rem;
    }
    
    .external-link {
        font-size: 0.875rem;
        color: var(--primary-color);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        margin-top: 0.75rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .external-link:hover {
        color: var(--accent-purple);
        transform: translateX(2px);
    }
    
    /* Connected user info */
    .connected-user {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--text-light);
    }
    
    .connected-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
    }
    
    /* GitHub connection info */
    .github-connection-info {
        margin-top: 0.75rem;
    }
    
    .github-connection-info .connected-user {
        margin-top: 0;
        margin-bottom: 0.75rem;
    }
    
    /* Project Collaboration Settings */
    .collaboration-setting {
        width: 100%;
    }
    
    .setting-toggle-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 28px;
        margin: 0;
        flex-shrink: 0;
        margin-top: 2px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: 0.3s;
        border-radius: 28px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: rgba(255, 255, 255, 0.6);
        transition: 0.3s;
        border-radius: 50%;
    }
    
    .toggle-switch input:checked + .toggle-slider {
        background: linear-gradient(135deg, #8B5CF6, #A855F7);
        border-color: #A855F7;
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
        background-color: white;
    }
    
    .setting-info {
        flex: 1;
    }
    
    .setting-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        margin: 0 0 0.5rem 0;
    }
    
    .setting-description {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.6);
        margin: 0;
        line-height: 1.5;
    }
    
    .setting-details {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .detail-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .detail-item i {
        width: 16px;
        text-align: center;
        flex-shrink: 0;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .settings-sidebar {
            width: 240px;
        }
        
        .settings-wrapper {
            gap: 1.5rem;
        }
    }
    
    @media (max-width: 1024px) {
        .settings-container {
            max-width: 100%;
            padding: 2rem 0.5rem 0;
        }
        
        .settings-sidebar {
            width: 220px;
        }
        
        .settings-wrapper {
            gap: 1rem;
        }
        
        .subscription-plans-grid {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .settings-container {
            padding: 0 0.5rem;
        }
        
        .settings-wrapper {
            flex-direction: column;
            gap: 1rem;
        }
        
        .settings-sidebar {
            width: 100%;
            height: auto;
        }
        
        .settings-nav {
            margin-bottom: 1rem;
        }
        
        .integrations-list {
            max-width: 100%;
        }
        
        .usage-content-wrapper {
            max-width: 100% !important;
        }
        
        .setting-toggle-wrapper {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .toggle-switch {
            align-self: flex-start;
        }
    }
    
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="settings-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-cog"></i>
            Settings
        </h1>
    </div>

    <div class="settings-wrapper">
    <!-- Settings Sidebar -->
    <aside class="settings-sidebar">
        <nav class="settings-nav">
            <a href="#llm-keys" class="settings-nav-item active" data-section="llm-keys">
                <i class="fas fa-key"></i>
                <span>LLM Keys</span>
            </a>
            <a href="#subscriptions" class="settings-nav-item" data-section="subscriptions">
                <i class="fas fa-credit-card"></i>
                <span>Subscriptions</span>
            </a>
            <a href="#project-management-new" class="settings-nav-item" data-section="project-management-new">
                <i class="fas fa-tasks"></i>
                <span>Project Management</span>
            </a>
            <!-- <a href="#organizations" class="settings-nav-item" data-section="organizations">
                <i class="fas fa-users"></i>
                <span>Organizations</span>
            </a> -->
            <a href="#github" class="settings-nav-item" data-section="github">
                <i class="fab fa-github"></i>
                <span>GitHub</span>
            </a>
            <a href="#claude-code" class="settings-nav-item" data-section="claude-code">
                <i class="fas fa-terminal"></i>
                <span>Claude Code</span>
            </a>
            <a href="#prompts" class="settings-nav-item disabled" data-section="prompts">
                <i class="fas fa-comment-dots"></i>
                <span>Prompts</span>
            </a>
        </nav>
    </aside>
    
    <!-- Settings Content -->
    <div class="settings-content">
        
        <!-- LLM Keys Section -->
        <div id="llm-keys" class="settings-section active">
            <h2 class="section-heading">AI Model API Keys</h2>
            
            <style>
                .llm-integrations-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                    gap: 1.25rem;
                    width: 100%;
                }

                @media (max-width: 768px) {
                    .llm-integrations-grid {
                        grid-template-columns: 1fr;
                    }
                }
                
                .llm-integration-card {
                    background: var(--settings-card-bg);
                    border: 1px solid var(--settings-card-border);
                    border-radius: 12px;
                    padding: 24px;
                    transition: all 0.3s ease;
                }
                
                .llm-integration-card:hover:not(.disabled) {
                    border-color: rgba(167, 139, 250, 0.3);
                    background: rgba(167, 139, 250, 0.05);
                }
                
                .llm-integration-card.connected {
                    border-color: rgba(34, 197, 94, 0.3);
                    background: rgba(34, 197, 94, 0.05);
                }

                .llm-integration-card.locked {
                    border-color: rgba(167, 139, 250, 0.35);
                    background: rgba(30, 18, 64, 0.5);
                    box-shadow: inset 0 0 0 1px rgba(167, 139, 250, 0.1);
                }

                .llm-integration-card.locked .llm-integration-status {
                    color: #a855f7;
                }

                .llm-integration-locked {
                    margin-top: 16px;
                    padding: 16px;
                    border: 1px dashed rgba(167, 139, 250, 0.35);
                    border-radius: 10px;
                    background: rgba(76, 29, 149, 0.15);
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                }

                .llm-integration-locked-message {
                    display: flex;
                    gap: 10px;
                    align-items: flex-start;
                    color: #c4b5fd;
                    font-size: 14px;
                    line-height: 1.5;
                }

                .llm-integration-locked-message i {
                    font-size: 16px;
                    color: #a855f7;
                    margin-top: 2px;
                }

                .llm-integration-locked-actions {
                    display: flex;
                    gap: 12px;
                    flex-wrap: wrap;
                }

                .llm-availability-note {
                    margin-bottom: 24px;
                    padding: 16px 18px;
                    border-radius: 10px;
                    background: var(--settings-card-bg);
                    border: 1px solid var(--settings-card-border);
                    display: flex;
                    gap: 14px;
                    align-items: flex-start;
                    color: var(--settings-text-secondary);
                    font-size: 14px;
                    line-height: 1.6;
                }

                .llm-availability-note i {
                    color: #8b5cf6;
                    margin-top: 2px;
                }

                .inline-upgrade-link {
                    color: #a855f7;
                    font-weight: 600;
                    text-decoration: none;
                }

                .inline-upgrade-link:hover {
                    text-decoration: underline;
                }
                
                .llm-integration-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 16px;
                }
                
                .llm-integration-info {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .llm-integration-logo {
                    width: 40px;
                    height: 40px;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 20px;
                    flex-shrink: 0;
                }

                .llm-logo-img {
                    width: 32px;
                    height: 32px;
                    display: block;
                }

                .integration-icon img {
                    width: 28px;
                    height: 28px;
                    display: block;
                }
                
                .llm-integration-logo {
                    background: transparent !important;
                    border: none;
                }
                
                .llm-integration-logo.openai {
                    color: #10a37f;
                }
                
                .llm-integration-logo.anthropic {
                    color: #d97706;
                }
                
                .llm-integration-logo.gemini {
                    color: #4285f4;
                }
                
                .llm-integration-details h3 {
                    margin: 0 0 4px 0;
                    font-size: 16px;
                    font-weight: 600;
                    color: #e5e7eb;
                }
                
                .llm-integration-details p {
                    margin: 0;
                    font-size: 14px;
                    color: #9ca3af;
                }
                
                .llm-integration-status {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 14px;
                    font-weight: 500;
                }
                
                .llm-integration-status.connected {
                    color: #22c55e;
                }
                
                .llm-integration-status.disconnected {
                    color: #6b7280;
                }

                .llm-integration-status.locked {
                    color: #a855f7;
                }
                
                .llm-integration-actions {
                    margin-top: 16px;
                    display: flex;
                    gap: 12px;
                    align-items: center;
                }
                
                .llm-integration-button {
                    padding: 8px 16px;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    text-decoration: none;
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                }
                
                .llm-integration-button.primary {
                    background: linear-gradient(135deg, #8B5CF6, #A855F7);
                    color: white;
                }
                
                .llm-integration-button.primary:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
                }
                
                .llm-integration-button.secondary {
                    background: transparent;
                    color: #9ca3af;
                    border: 1px solid #374151;
                }
                
                .llm-integration-button.secondary:hover {
                    background: rgba(255, 255, 255, 0.05);
                    border-color: #4b5563;
                }
                
                .llm-integration-button.danger {
                    background: transparent;
                    color: #ef4444;
                    border: 1px solid rgba(239, 68, 68, 0.3);
                }
                
                .llm-integration-button.danger:hover {
                    background: rgba(239, 68, 68, 0.1);
                    border-color: rgba(239, 68, 68, 0.5);
                }
                
                .llm-api-key-input-section {
                    margin-top: 16px;
                    padding-top: 16px;
                    border-top: 1px solid var(--settings-card-border);
                }
                
                .llm-api-key-form {
                    display: flex;
                    gap: 12px;
                    margin-top: 12px;
                }
                
                .llm-api-key-form input {
                    flex: 1;
                    padding: 10px 14px;
                    background: rgba(10, 10, 15, 0.6);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    color: #e5e7eb;
                    font-size: 14px;
                    font-family: monospace;
                }
                
                .llm-api-key-form input:focus {
                    outline: none;
                    border-color: #8B5CF6;
                }
                
                .llm-api-key-form button {
                    padding: 10px 16px;
                    background: linear-gradient(135deg, #8B5CF6, #A855F7);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    font-size: 14px;
                }
                
                .llm-api-key-form button:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
                }

                .llm-byok-controls {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 18px 20px;
                    border: 1px solid var(--settings-card-border);
                    border-radius: 10px;
                    background: var(--settings-card-bg);
                    margin-bottom: 20px;
                    gap: 16px;
                }

                .llm-byok-copy {
                    color: var(--settings-text-secondary);
                    font-size: 14px;
                    line-height: 1.5;
                }

                .llm-byok-title {
                    font-size: 14px;
                    font-weight: 600;
                    color: var(--settings-text-primary);
                    margin-bottom: 6px;
                    text-transform: uppercase;
                    letter-spacing: 0.08em;
                }

                .llm-keys-table {
                    width: 100%;
                    border: 1px solid var(--settings-card-border);
                    border-radius: 12px;
                    overflow: hidden;
                    background: var(--settings-card-bg);
                }

                .llm-keys-row {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 18px 22px;
                    border-bottom: 1px solid var(--settings-card-border);
                    gap: 32px;
                }

                .llm-keys-row:last-child {
                    border-bottom: none;
                }

                .llm-row-label {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                    flex: 1;
                }

                .llm-row-value {
                    flex: 1;
                    display: flex;
                    justify-content: flex-end;
                    align-items: center;
                }

                .llm-row-title {
                    font-size: 15px;
                    font-weight: 600;
                    color: var(--settings-text-primary);
                    margin-bottom: 2px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }

                .llm-row-subtitle {
                    font-size: 12px;
                    color: var(--settings-text-muted);
                }

                .llm-row-status {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 13px;
                    color: var(--settings-text-muted);
                }

                .llm-row-actions {
                    width: 100%;
                    display: flex;
                    justify-content: flex-end;
                    align-items: center;
                    gap: 12px;
                }

                .llm-row-actions form {
                    margin: 0;
                }

                .llm-row-input {
                    flex: 1;
                    max-width: 440px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .llm-row-input a.mini-link {
                    font-size: 12px;
                    color: #a5b4fc;
                    text-decoration: none;
                }

                .llm-row-input input {
                    flex: 1;
                    padding: 10px 12px;
                    background: var(--input-bg, #ffffff);
                    border: 1px solid var(--settings-card-border);
                    border-radius: 6px;
                    color: var(--settings-text-primary);
                    font-size: 13px;
                    font-family: monospace;
                }

                .llm-row-input input:disabled {
                    opacity: 0.65;
                    cursor: default;
                }

                .integration-help {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 1px solid rgba(148, 163, 184, 0.45);
                    color: #cbd5f5;
                    font-size: 11px;
                    text-decoration: none;
                    transition: all 0.2s ease;
                }

                .integration-help:hover {
                    border-color: rgba(167, 139, 250, 0.8);
                    color: #f4f4ff;
                }

                .connect-arrow {
                    width: 32px;
                    height: 32px;
                    padding: 0 !important;
                    border-radius: 20%;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0;
                }

                .connect-arrow i {
                    margin: 0;
                    font-size: 14px;
                }

                .llm-integration-button.compact {
                    width: 40px;
                    height: 40px;
                    padding: 0;
                    border-radius: 50%;
                    justify-content: center;
                    gap: 0;
                }

                .llm-integration-button.compact i {
                    margin: 0;
                }

                .llm-keys-table.byok-disabled .llm-row-actions {
                    opacity: 0.35;
                    pointer-events: none;
                }

                .llm-row-disabled-note {
                    font-size: 12px;
                    color: #94a3b8;
                }

                .hidden {
                    display: none !important;
                }

                .openai-mode-card {
                    margin-top: 18px;
                    padding: 18px 20px;
                    border-radius: 10px;
                    border: 1px solid rgba(255, 255, 255, 0.08);
                    background: rgba(15, 23, 42, 0.65);
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 16px;
                }

                .openai-mode-label {
                    display: block;
                    text-transform: uppercase;
                    font-size: 12px;
                    letter-spacing: 0.08em;
                    color: #a78bfa;
                    margin-bottom: 6px;
                }

                .openai-mode-description {
                    margin: 0;
                    color: #cbd5f5;
                    font-size: 14px;
                    line-height: 1.5;
                }

                .openai-mode-toggle {
                    display: flex;
                    align-items: center;
                    justify-content: flex-end;
                }

                .llm-platform-note {
                    margin-top: 18px;
                    padding: 16px;
                    border-radius: 10px;
                    background: rgba(15, 118, 110, 0.12);
                    border: 1px solid rgba(45, 212, 191, 0.35);
                    color: #99f6e4;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    font-size: 14px;
                }
        </style>
        
        <div class="llm-availability-note">
            <i class="fas fa-info-circle"></i>
            <div>
                <div style="color: var(--settings-text-primary); font-weight: 600; margin-bottom: 6px;">
                    {% if has_paid_subscription %}Paid plan active{% else %}Upgrade for more models{% endif %}
                </div>
                <div>
                    {% if has_paid_subscription %}
                        GPT-5 access is included with your subscription. Add your Anthropic or Google API keys below to use Claude and Gemini with your own credits.
                    {% else %}
                        GPT-5-mini is available with the platform key. Upgrade to <a href="#subscriptions" class="inline-upgrade-link">Pro Monthly</a> to unlock GPT-5 and bring your own Anthropic &amp; Google keys.
                    {% endif %}
                </div>
            </div>
        </div>

        {% if has_paid_subscription %}
        <div class="llm-byok-controls">
            <div>
                <div class="llm-byok-title">Bring your own keys</div>
                <div class="llm-byok-copy">
                    {% if byok_enabled %}
                        Your OpenAI, Anthropic, and Google keys will be used where available.
                    {% else %}
                        Using LFG platform credits only. Enable the switch to add personal keys.
                    {% endif %}
                </div>
            </div>
            <form id="byok-toggle-form" method="post" action="{% url 'accounts:toggle_llm_byok' %}">
                {% csrf_token %}
                <input type="hidden" name="enable" value="{{ byok_enabled|yesno:'1,0' }}">
                <label class="toggle-switch">
                    <input type="checkbox" id="byok-toggle" {% if byok_enabled %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </form>
        </div>
        {% endif %}

            <div class="llm-keys-table {% if not has_paid_subscription or not byok_enabled %}byok-disabled{% endif %}" id="llm-keys-table">
            <!-- OpenAI Row -->
            <div class="llm-keys-row">
                <div class="llm-row-label">
                    <div class="llm-integration-logo openai">
                        <svg fill="currentColor" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142-.0852 4.783-2.7582a.7712.7712 0 0 0 .7806 0l5.8428 3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142.0852-4.7735 2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0593a4.4708 4.4708 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997L9.4041 13.5V10.4976z"/></svg>
                    </div>
                    <div>
                        <div class="llm-row-title">
                            OpenAI
                            <a href="https://platform.openai.com/api-keys" target="_blank" class="integration-help" title="How to get an OpenAI key">?</a>
                        </div>
                        <div class="llm-row-subtitle">{% if has_paid_subscription %}GPT-5 access with platform credits{% else %}GPT-5-mini with platform credits{% endif %}</div>
                    </div>
                </div>
                <div class="llm-row-value">
                    <div class="llm-row-actions">
                        {% if has_paid_subscription %}
                            {% if openai_connected %}
                                <form method="post" action="{% url 'accounts:disconnect_api_key' 'openai' %}" class="llm-row-input" id="openai-disconnect-form">
                                    {% csrf_token %}
                                    <input type="password" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" disabled>
                                    <button type="submit" class="llm-integration-button danger connect-arrow" aria-label="Disconnect OpenAI" title="Disconnect OpenAI">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            {% else %}
                                <form method="post" action="{% url 'accounts:save_api_key' 'openai' %}" class="llm-row-input">
                                    {% csrf_token %}
                                    <input type="password" name="api_key" placeholder="Enter OpenAI key (sk-...)" required>
                                    <button type="submit" class="llm-integration-button primary connect-arrow" aria-label="Connect OpenAI" title="Connect OpenAI">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </form>
                            {% endif %}
                        {% else %}
                            <div class="llm-row-disabled-note">Upgrade to Pro to bring your own keys.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Anthropic Row -->
            <div class="llm-keys-row">
                <div class="llm-row-label">
                    <div class="llm-integration-logo anthropic">
                        <img src="{% static 'images/anthropic-logo.png' %}" alt="Anthropic" class="llm-logo-img">
                    </div>
                    <div>
                        <div class="llm-row-title">
                            Anthropic
                            <a href="https://console.anthropic.com/settings/keys" target="_blank" class="integration-help" title="How to get an Anthropic key">?</a>
                        </div>
                        <div class="llm-row-subtitle">Bring your Claude API key</div>
                    </div>
                </div>
                <div class="llm-row-value">
                    <div class="llm-row-actions">
                        {% if has_paid_subscription %}
                            {% if anthropic_connected %}
                                <form method="post" action="{% url 'accounts:disconnect_api_key' 'anthropic' %}" class="llm-row-input">
                                    {% csrf_token %}
                                    <input type="password" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" disabled>
                                    <button type="submit" class="llm-integration-button danger connect-arrow" aria-label="Disconnect Anthropic" title="Disconnect Anthropic">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            {% else %}
                                <form method="post" action="{% url 'accounts:save_api_key' 'anthropic' %}" class="llm-row-input">
                                    {% csrf_token %}
                                    <input type="password" name="api_key" placeholder="Enter Anthropic API key" required>
                                    <button type="submit" class="llm-integration-button primary connect-arrow" aria-label="Connect Anthropic" title="Connect Anthropic">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </form>
                            {% endif %}
                        {% else %}
                            <div class="llm-row-disabled-note">Upgrade to connect your Anthropic key.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Google Gemini Row -->
            <div class="llm-keys-row">
                <div class="llm-row-label">
                    <div class="llm-integration-logo gemini">
                        <img src="{% static 'images/gemini-logo.png' %}" alt="Google Gemini" class="llm-logo-img">
                    </div>
                    <div>
                        <div class="llm-row-title">
                            Google Gemini
                            <a href="https://makersuite.google.com/app/apikey" target="_blank" class="integration-help" title="How to get a Gemini key">?</a>
                        </div>
                        <div class="llm-row-subtitle">Bring your Gemini API key</div>
                    </div>
                </div>
                <div class="llm-row-value">
                    <div class="llm-row-actions">
                        {% if has_paid_subscription %}
                            {% if google_connected %}
                                <form method="post" action="{% url 'accounts:disconnect_api_key' 'google' %}" class="llm-row-input" id="google-disconnect-form">
                                    {% csrf_token %}
                                    <input type="password" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" disabled>
                                    <button type="submit" class="llm-integration-button danger connect-arrow" aria-label="Disconnect Gemini" title="Disconnect Gemini">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            {% else %}
                                <form method="post" action="{% url 'accounts:save_api_key' 'google' %}" class="llm-row-input">
                                    {% csrf_token %}
                                    <input type="password" name="api_key" placeholder="Enter Gemini API key" required>
                                    <button type="submit" class="llm-integration-button primary connect-arrow" aria-label="Connect Gemini" title="Connect Gemini">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </form>
                            {% endif %}
                        {% else %}
                            <div class="llm-row-disabled-note">Upgrade to connect Google Gemini.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if has_paid_subscription %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const toggle = document.getElementById('byok-toggle');
                const form = document.getElementById('byok-toggle-form');
                const table = document.getElementById('llm-keys-table');
                if (!toggle || !form || !table) return;
                const hiddenInput = form.querySelector('input[name="enable"]');

                const setTableState = (enabled) => {
                    table.classList.toggle('byok-disabled', !enabled);
                };

                setTableState(toggle.checked);

                toggle.addEventListener('change', function() {
                    const enabled = toggle.checked;
                    if (!enabled) {
                        const confirmed = confirm('Disabling BYOK will remove your saved OpenAI, Anthropic, and Google keys.');
                        if (!confirmed) {
                            toggle.checked = true;
                            return;
                        }
                    }
                    if (hiddenInput) {
                        hiddenInput.value = enabled ? '1' : '0';
                    }
                    setTableState(enabled);
                    form.submit();
                });
            });
        </script>
        {% endif %}
        </div>

<!-- Project Management Section -->
        <div id="project-management-new" class="settings-section">
            <h2 class="section-heading">Project Management Integrations</h2>

            <style>
                .project-table {
                    margin-top: 20px;
                }

                .project-table .llm-row-label {
                    flex: 1.15;
                }

                .project-table .llm-row-actions {
                    align-items: flex-start;
                }

                .project-table .integration-logo {
                    width: 42px;
                    height: 42px;
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 20px;
                    background: transparent;
                }
                
                .project-coming-soon {
                    opacity: 0.75;
                }

                .coming-soon-chip {
                    background: rgba(148, 163, 184, 0.2);
                    color: #cbd5f5;
                    padding: 4px 10px;
                    border-radius: 999px;
                    font-size: 12px;
                    letter-spacing: 0.08em;
                    text-transform: uppercase;
                }
            </style>

            <div class="llm-keys-table project-table">
                <div class="llm-keys-row">
                    <div class="llm-row-label">
                        <div class="integration-logo linear">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 100 100"><path fill="currentColor" d="M1.22541 61.5228c-.2225-.9485.90748-1.5459 1.59638-.857L39.3342 97.1782c.6889.6889.0915 1.8189-.857 1.5964C20.0515 94.4522 5.54779 79.9485 1.22541 61.5228ZM.00189135 46.8891c-.01764375.2833.08887215.5599.28957165.7606L52.3503 99.7085c.2007.2007.4773.3075.7606.2896 2.3692-.1476 4.6938-.46 6.9624-.9259.7645-.157 1.0301-1.0963.4782-1.6481L2.57595 39.4485c-.55186-.5519-1.49117-.2863-1.648174.4782-.465915 2.2686-.77832 4.5932-.92588465 6.9624ZM4.21093 29.7054c-.16649.3738-.08169.8106.20765 1.1l64.77602 64.776c.2894.2894.7262.3742 1.1.2077 1.7861-.7956 3.5171-1.6927 5.1855-2.684.5521-.328.6373-1.0867.1832-1.5407L8.43566 24.3367c-.45409-.4541-1.21271-.3689-1.54074.1832-.99132 1.6684-1.88843 3.3994-2.68399 5.1855ZM12.6587 18.074c-.3701-.3701-.393-.9637-.0443-1.3541C21.7795 6.45931 35.1114 0 49.9519 0 77.5927 0 100 22.4073 100 50.0481c0 14.8405-6.4593 28.1724-16.7199 37.3375-.3903.3487-.984.3258-1.3542-.0443L12.6587 18.074Z"/></svg>
                        </div>
                        <div>
                            <div class="llm-row-title">
                                Linear
                                <a href="https://linear.app/settings/api" target="_blank" class="integration-help" title="How to get your Linear API key">?</a>
                            </div>
                            <div class="llm-row-subtitle">Issue tracking and project management</div>
                        </div>
                    </div>
                    <div class="llm-row-value">
                        <div class="llm-row-actions">
                            {% if linear_connected %}
                                <div class="llm-row-input">
                                    <a href="https://linear.app" target="_blank" class="llm-integration-button secondary compact" aria-label="Open Linear" title="Open Linear">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    <form method="post" action="{% url 'accounts:disconnect_api_key' 'linear' %}">
                                        {% csrf_token %}
                                        <button type="submit" class="llm-integration-button danger connect-arrow" aria-label="Disconnect Linear" title="Disconnect Linear" onclick="return confirm('Disconnect Linear integration?');">
                                            <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </form>
                                </div>
                            {% else %}
                                <form method="post" action="{% url 'accounts:save_api_key' 'linear' %}" class="llm-row-input">
                                    {% csrf_token %}
                                    <input type="password" name="api_key" placeholder="Enter your Linear API key" required>
                                    <button type="submit" class="llm-integration-button primary connect-arrow" aria-label="Connect Linear">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="llm-keys-row">
                    <div class="llm-row-label">
                        <div class="integration-logo notion">
                            <svg width="24" height="24" viewBox="0 0 29 30" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.81 1.294L18.446.068c2.043-.175 2.568-.057 3.852.875l5.311 3.733c.877.642 1.169.817 1.169 1.516v20.473c0 1.283-.468 2.042-2.102 2.158L7.357 29.99c-1.228.058-1.811-.117-2.454-.934l-3.91-5.074C.29 23.048 0 22.349 0 21.532V3.334c0-1.049.468-1.924 1.81-2.04z" fill="#fff"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M18.447.068L1.808 1.294C.468 1.41 0 2.285 0 3.334v18.198c0 .817.291 1.516.992 2.45l3.911 5.074c.643.817 1.226.992 2.453.934l19.321-1.167c1.634-.116 2.102-.875 2.102-2.158V6.192c0-.663-.263-.854-1.037-1.42l-.132-.096L22.3.943c-1.285-.932-1.81-1.05-3.854-.875zM7.793 5.857c-1.577.106-1.936.13-2.831-.597L2.685 3.452c-.233-.234-.116-.526.467-.584l15.995-1.166c1.342-.117 2.043.35 2.568.758l2.744 1.983c.117.059.408.408.058.408l-16.52.992-.203.014zM5.954 26.49V9.11c0-.759.234-1.109.934-1.168l18.971-1.108c.643-.058.935.35.935 1.108v17.264c0 .759-.117 1.401-1.168 1.459l-18.154 1.05c-1.05.058-1.518-.291-1.518-1.225zm17.922-16.448c.116.525 0 1.05-.527 1.11l-.874.173v12.832c-.76.408-1.46.641-2.044.641-.934 0-1.168-.292-1.868-1.166l-5.721-8.982v8.69l1.81.409s0 1.05-1.46 1.05l-4.027.233c-.117-.234 0-.817.408-.933l1.051-.291v-11.49L9.165 12.2c-.117-.525.174-1.283.992-1.341l4.32-.292 5.954 9.1v-8.05l-1.518-.174c-.116-.643.35-1.109.934-1.167l4.029-.234z" fill="#000"></path></svg>
                        </div>
                        <div>
                            <div class="llm-row-title">Notion
                                <a href="https://www.notion.so/my-integrations" target="_blank" class="integration-help" title="Steps to create a Notion integration token">?</a>
                            </div>
                            <div class="llm-row-subtitle">Documentation and knowledge management</div>
                        </div>
                    </div>
                    <div class="llm-row-value">
                        <div class="llm-row-actions">
                            {% if notion_connected %}
                                <div class="llm-row-input">
                                    <a href="https://www.notion.so" target="_blank" class="llm-integration-button secondary compact" aria-label="Open Notion" title="Open Notion workspace">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    <form method="post" action="{% url 'accounts:disconnect_api_key' 'notion' %}">
                                        {% csrf_token %}
                                        <button type="submit" class="llm-integration-button danger connect-arrow" aria-label="Disconnect Notion" title="Disconnect Notion" onclick="return confirm('Disconnect Notion integration?');">
                                            <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </form>
                                </div>
                            {% else %}
                                <form method="post" action="{% url 'accounts:save_api_key' 'notion' %}" class="llm-row-input">
                                    {% csrf_token %}
                                    <input type="password" name="api_key" placeholder="Enter your Notion integration token" required>
                                    <button type="submit" class="llm-integration-button primary connect-arrow" aria-label="Connect Notion">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="llm-keys-row project-coming-soon">
                    <div class="llm-row-label">
                        <div class="integration-logo jira">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.146 2H11.18a.6.6 0 00-.424.176l-8.58 8.58a.6.6 0 000 .849l7.965 7.966a.6.6 0 00.849 0l8.58-8.58a.6.6 0 00.176-.424V2.6a.6.6 0 00-.6-.6zm-5.6 6.4h3.549L12 13.494 8.905 10.4h3.54a.6.6 0 00.6-.6V4.16l3.245 3.245h-2.744a.6.6 0 00-.6.6v2.395z"/></svg>
                        </div>
                        <div>
                            <div class="llm-row-title">Jira</div>
                            <div class="llm-row-subtitle">Enterprise issue tracking</div>
                        </div>
                    </div>
                    <div class="llm-row-value">
                        <div class="llm-row-status">
                            <span class="coming-soon-chip">Coming Soon</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!-- Subscriptions Section -->
        <div id="subscriptions" class="settings-section">
            <h2 class="section-heading">Subscription & Billing</h2>

            <style>
                /* Full subscriptions dashboard styles */
                /* Main subscription cards grid */
                .subscription-cards-grid {
                    display: grid;
                    grid-template-columns: 1fr;
                    gap: 24px;
                    margin-bottom: 24px;
                }
                
                .subscription-plan-card {
                    background: var(--settings-card-bg);
                    border: 1px solid var(--settings-card-border);
                    border-radius: 12px;
                    padding: 24px;
                    display: flex;
                    flex-direction: column;
                    height: auto;
                }
                
                .subscription-plan-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 24px;
                }
                
                .subscription-plan-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    padding: 8px 16px;
                    background: var(--settings-badge-bg);
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 500;
                    color: var(--settings-text-muted);
                }
                
                .subscription-plan-badge.pro {
                    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
                    color: #e9d5ff;
                }
                
                .subscription-usage-progress {
                    margin-bottom: 24px;
                }
                
                .subscription-progress-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: baseline;
                    margin-bottom: 12px;
                }
                
                .subscription-progress-title {
                    color: var(--settings-text-primary);
                    font-size: 14px;
                    font-weight: 500;
                }

                .subscription-progress-bar-container {
                    background: var(--settings-progress-bg);
                    height: 6px;
                    border-radius: 3px;
                    overflow: hidden;
                }
                
                .subscription-progress-bar-fill {
                    height: 100%;
                    background: #a78bfa;
                    transition: width 0.3s ease;
                }
                
                .subscription-progress-bar-fill.warning {
                    background: #f59e0b;
                }
                
                .subscription-progress-bar-fill.danger {
                    background: #ef4444;
                }
                
                .subscription-usage-stats {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 20px;
                    margin-bottom: 24px;
                }
                
                .subscription-stat-item {
                    text-align: center;
                }
                
                .subscription-stat-label {
                    display: block;
                    color: var(--settings-text-secondary);
                    font-size: 11px;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                    margin-bottom: 6px;
                }

                .subscription-stat-value {
                    display: block;
                    font-size: 24px;
                    font-weight: 700;
                    line-height: 1;
                    font-variant-numeric: tabular-nums;
                    color: var(--settings-text-primary);
                }
                
                .subscription-stat-value.remaining {
                    color: #10b981;
                }
                
                .subscription-stat-value.remaining.low {
                    color: #ef4444;
                }
                
                .subscription-stat-value.limit {
                    color: var(--settings-text-secondary);
                }
                
                .subscription-usage-breakdown {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 16px;
                    padding-top: 20px;
                    border-top: 1px solid var(--settings-card-border);
                }
                
                .subscription-breakdown-item {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 4px 0;
                }
                
                .subscription-breakdown-label {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    color: #9ca3af;
                    font-size: 13px;
                }
                
                .subscription-breakdown-value {
                    color: #e5e7eb;
                    font-size: 14px;
                    font-weight: 600;
                    font-variant-numeric: tabular-nums;
                }
                
                .subscription-payment-methods-card {
                    background: var(--settings-card-bg);
                    border: 1px solid var(--settings-card-border);
                    border-radius: 12px;
                    padding: 24px;
                    margin-bottom: 24px;
                }
                
                .subscription-payment-method-item {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 16px;
                    background: rgba(255, 255, 255, 0.03);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    margin-bottom: 12px;
                    transition: all 0.2s ease;
                }
                
                .subscription-payment-method-item:hover {
                    background: rgba(255, 255, 255, 0.05);
                    border-color: rgba(167, 139, 250, 0.3);
                }
                
                .subscription-payment-method-info {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .subscription-card-icon {
                    width: 32px;
                    height: 20px;
                    background: var(--settings-card-icon-bg);
                    border-radius: 4px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    color: white;
                    font-weight: 600;
                }
                
                .subscription-card-icon.visa { background: #1e40af; }
                .subscription-card-icon.mastercard { background: #dc2626; }
                .subscription-card-icon.amex { background: #059669; }
                .subscription-card-icon.discover { background: #ea580c; }
                
                .subscription-card-details {
                    display: flex;
                    flex-direction: column;
                }
                
                .subscription-card-number {
                    font-size: 14px;
                    font-weight: 500;
                    color: var(--settings-text-primary);
                    font-family: monospace;
                }

                .subscription-card-expiry {
                    font-size: 12px;
                    color: var(--settings-text-muted);
                }
                
                .subscription-payment-method-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .subscription-method-action {
                    padding: 6px 12px;
                    border: none;
                    border-radius: 6px;
                    font-size: 12px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }
                
                .subscription-method-default {
                    background: rgba(16, 185, 129, 0.1);
                    color: #10b981;
                    border: 1px solid rgba(16, 185, 129, 0.3);
                }
                
                .subscription-method-make-default {
                    background: transparent;
                    color: #9ca3af;
                    border: 1px solid #374151;
                }
                
                .subscription-method-make-default:hover {
                    background: rgba(255, 255, 255, 0.05);
                    border-color: #4b5563;
                }
                
                .subscription-method-remove {
                    background: transparent;
                    color: #ef4444;
                    border: 1px solid rgba(239, 68, 68, 0.3);
                }
                
                .subscription-method-remove:hover {
                    background: rgba(239, 68, 68, 0.1);
                    border-color: rgba(239, 68, 68, 0.5);
                }
                
                .subscription-plans-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 16px;
                    margin-bottom: 0;
                    flex: 1;
                }
                
                .subscription-pricing-card {
                    background: rgba(30, 30, 35, 0.5);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 12px;
                    padding: 24px;
                    transition: all 0.3s ease;
                    position: relative;
                    backdrop-filter: blur(10px);
                }
                
                .subscription-pricing-card:hover {
                    border-color: rgba(167, 139, 250, 0.5);
                    background: rgba(167, 139, 250, 0.08);
                    transform: translateY(-2px);
                    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
                }
                
                .subscription-pricing-card.recommended {
                    border-color: rgba(167, 139, 250, 0.3);
                    background: rgba(167, 139, 250, 0.05);
                }
                
                .subscription-recommended-badge {
                    position: absolute;
                    top: -10px;
                    right: 16px;
                    background: linear-gradient(135deg, #8B5CF6, #A855F7);
                    color: white;
                    padding: 4px 14px;
                    border-radius: 999px;
                    font-size: 10px;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                }
                
                .subscription-plan-name {
                    font-size: 18px;
                    font-weight: 600;
                    margin-bottom: 8px;
                    color: #e5e7eb;
                }
                
                .subscription-plan-price {
                    font-size: 28px;
                    font-weight: 700;
                    margin-bottom: 6px;
                    color: #e5e7eb;
                }
                
                .subscription-plan-price span {
                    font-size: 14px;
                    font-weight: 400;
                    color: #9ca3af;
                }
                
                .subscription-plan-description {
                    color: #9ca3af;
                    font-size: 13px;
                    margin-bottom: 20px;
                    line-height: 1.4;
                }
                
                .subscription-plan-features {
                    list-style: none;
                    padding: 0;
                    margin: 0 0 24px 0;
                }
                
                .subscription-plan-features li {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 10px;
                    color: #e5e7eb;
                    font-size: 13px;
                }
                
                .subscription-plan-features i {
                    color: #10b981;
                    font-size: 12px;
                }
                
                .subscription-plan-button {
                    width: 100%;
                    padding: 12px 20px;
                    border: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    text-decoration: none;
                    display: inline-block;
                    text-align: center;
                }
                
                .subscription-plan-button.primary {
                    background: linear-gradient(135deg, #8B5CF6, #A855F7);
                    color: white;
                    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
                }
                
                .subscription-plan-button.primary:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.35);
                }
                
                .subscription-plan-button.secondary {
                    background: var(--settings-button-secondary-bg);
                    color: var(--settings-text-muted);
                }
                
                .subscription-plan-button:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                
                .add-payment-button-settings {
                    width: 100%;
                    padding: 16px;
                    background: rgba(139, 92, 246, 0.1);
                    color: #a78bfa;
                    border: 2px dashed rgba(139, 92, 246, 0.3);
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                }
                
                .add-payment-button-settings:hover {
                    background: rgba(139, 92, 246, 0.15);
                    border-color: rgba(139, 92, 246, 0.5);
                }
                
                .subscription-transactions-card {
                    background: var(--settings-card-bg);
                    border: 1px solid var(--settings-card-border);
                    border-radius: 12px;
                    padding: 24px;
                    margin-bottom: 24px;
                }
                
                .subscription-transactions-table {
                    width: 100%;
                    font-size: 13px;
                }
                
                .subscription-transactions-table thead {
                    border-bottom: 1px solid var(--settings-card-border);
                }
                
                .subscription-transactions-table th {
                    padding: 12px;
                    text-align: left;
                    font-weight: 500;
                    color: #9ca3af;
                    text-transform: uppercase;
                    letter-spacing: 0.05em;
                    font-size: 11px;
                }
                
                .subscription-transactions-table td {
                    padding: 12px;
                    border-bottom: 1px solid #1f2937;
                    color: #e5e7eb;
                }
                
                .subscription-transactions-table tbody tr:last-child td {
                    border-bottom: none;
                }
                
                .subscription-status-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 4px;
                    padding: 4px 10px;
                    border-radius: 999px;
                    font-size: 11px;
                    font-weight: 500;
                }
                
                .subscription-status-badge.completed {
                    background: rgba(16, 185, 129, 0.1);
                    color: #10b981;
                }
                
                .subscription-status-badge.pending {
                    background: rgba(245, 158, 11, 0.1);
                    color: #f59e0b;
                }
                
                .subscription-status-badge.failed {
                    background: rgba(239, 68, 68, 0.1);
                    color: #ef4444;
                }
                
                .subscription-empty-state {
                    text-align: center;
                    padding: 40px;
                    color: #6b7280;
                }
                
                .subscription-empty-state i {
                    font-size: 36px;
                    opacity: 0.3;
                    margin-bottom: 12px;
                }
                
                /* Original payment method styles for compatibility */
                .payment-method-item {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 16px;
                    background: rgba(255, 255, 255, 0.03);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    margin-bottom: 12px;
                    transition: all 0.2s ease;
                }
                
                .payment-method-item:hover {
                    background: rgba(255, 255, 255, 0.05);
                    border-color: rgba(167, 139, 250, 0.3);
                }
                
                .payment-method-info {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .card-icon {
                    width: 32px;
                    height: 20px;
                    background: var(--settings-card-icon-bg);
                    border-radius: 4px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    color: white;
                    font-weight: 600;
                }
                
                .card-icon.visa { background: #1e40af; }
                .card-icon.mastercard { background: #dc2626; }
                .card-icon.amex { background: #059669; }
                .card-icon.discover { background: #ea580c; }
                
                .card-details {
                    display: flex;
                    flex-direction: column;
                }
                
                .card-number {
                    font-size: 14px;
                    font-weight: 500;
                    color: var(--settings-text-primary);
                    font-family: monospace;
                }

                .card-expiry {
                    font-size: 12px;
                    color: var(--settings-text-muted);
                }
                
                .payment-method-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .method-action {
                    padding: 6px 12px;
                    border: none;
                    border-radius: 6px;
                    font-size: 12px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }
                
                .method-default {
                    background: rgba(16, 185, 129, 0.1);
                    color: #10b981;
                    border: 1px solid rgba(16, 185, 129, 0.3);
                }
                
                .method-make-default {
                    background: transparent;
                    color: #9ca3af;
                    border: 1px solid #374151;
                }
                
                .method-make-default:hover {
                    background: rgba(255, 255, 255, 0.05);
                    border-color: #4b5563;
                }
                
                .method-remove {
                    background: transparent;
                    color: #ef4444;
                    border: 1px solid rgba(239, 68, 68, 0.3);
                }
                
                .method-remove:hover {
                    background: rgba(239, 68, 68, 0.1);
                    border-color: rgba(239, 68, 68, 0.5);
                }
                
                .no-payment-methods {
                    text-align: center;
                    padding: 32px;
                    color: #6b7280;
                }
                
                .no-payment-methods i {
                    font-size: 36px;
                    opacity: 0.3;
                    margin-bottom: 12px;
                    display: block;
                }
                
                /* Responsive layout improvements */
                @media (max-width: 768px) {
                    .subscription-usage-stats {
                        grid-template-columns: 1fr;
                        gap: 16px;
                    }
                    
                    .subscription-usage-breakdown {
                        grid-template-columns: 1fr;
                    }
                    
                    .subscription-plans-grid {
                        grid-template-columns: 1fr;
                    }
                    
                    .subscription-plan-card,
                    .subscription-payment-methods-card,
                    .subscription-transactions-card {
                        padding: 20px;
                        margin-bottom: 20px;
                    }
                    
                    .subscription-transactions-table {
                        font-size: 12px;
                    }
                    
                    .subscription-transactions-table th,
                    .subscription-transactions-table td {
                        padding: 8px;
                    }
                    
                    .subscription-payment-method-item {
                        flex-direction: column;
                        align-items: flex-start;
                        gap: 12px;
                    }
                    
                    .subscription-payment-method-actions {
                        width: 100%;
                        justify-content: space-between;
                    }
                }
            </style>

            <div class="subscription-cards-grid">
            <!-- Current Plan Card -->
            <div class="subscription-plan-card" style="position: relative;">
                <span style="position: absolute; top: -10px; right: 24px; background: var(--settings-card-bg); color: #a78bfa; border: 1px solid rgba(167, 139, 250, 0.4); padding: 4px 12px; border-radius: 999px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    {% if user_credit.is_free_tier %}Free Tier{% else %}Pro Monthly{% endif %}
                </span>
                <div class="subscription-plan-header">
                    <div>
                        {% if additional_credits_plan %}
                        <a href="{% url 'subscriptions:checkout' additional_credits_plan.id %}" style="display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; font-size: 14px; font-weight: 500; color: white; background: linear-gradient(135deg, #8B5CF6, #A855F7); border-radius: 8px; text-decoration: none; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.35)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.25)';">
                            <i class="fas fa-plus" style="font-size: 12px;"></i> Buy Credits
                        </a>
                        {% endif %}
                        <div style="color: var(--settings-text-secondary); font-size: 12px; margin-top: 12px;">
                            {% if user_credit.is_free_tier %}
                                {{ free_tier_token_limit|intcomma }} onetime tokens â€¢ gpt-5-mini only
                            {% else %}
                                {{ pro_monthly_token_limit|intcomma }} tokens per month â€¢ All AI models
                            {% endif %}
                        </div>
                    </div>
                    {% if user_credit.is_subscribed and user_credit.stripe_subscription_id %}
                    <form method="post" action="{% url 'subscriptions:cancel_subscription' %}" onsubmit="return confirm('Are you sure you want to cancel your subscription?');">
                        {% csrf_token %}
                        <input type="hidden" name="redirect_to" value="settings">
                        <button type="submit" class="cancel-button" style="padding: 8px 16px; background: transparent; color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">Cancel Subscription</button>
                    </form>
                    {% endif %}
                </div>
                
                {% if user_credit.is_free_tier %}
                <!-- Free Tier Usage -->
                <div class="subscription-usage-progress">
                    <div class="subscription-progress-header">
                        <span class="subscription-progress-title">Lifetime Usage</span>
                        <span style="color: var(--settings-text-muted); font-size: 12px;">{{ usage_percentage|floatformat:0 }}% used</span>
                    </div>
                    <div class="subscription-progress-bar-container">
                        <div class="subscription-progress-bar-fill{% if usage_percentage > 80 %} danger{% elif usage_percentage > 60 %} warning{% endif %}" style="width: {{ usage_percentage }}%"></div>
                    </div>
                </div>
                {% else %}
                <!-- Pro Tier - Monthly Usage -->
                <div class="subscription-usage-progress">
                    <div class="subscription-progress-header">
                        <span class="subscription-progress-title">Monthly Usage</span>
                        <span style="color: var(--settings-text-muted); font-size: 12px;">{{ monthly_usage_percentage|floatformat:0 }}% used</span>
                    </div>
                    <div class="subscription-progress-bar-container">
                        <div class="subscription-progress-bar-fill{% if monthly_usage_percentage > 80 %} danger{% elif monthly_usage_percentage > 60 %} warning{% endif %}" style="width: {{ monthly_usage_percentage }}%"></div>
                    </div>
                </div>
                
                <!-- Pro Tier - Additional Credits Usage -->
                {% if user_credit.credits > 0 or additional_credits_usage_percentage > 0 %}
                <div class="subscription-usage-progress" style="margin-top: 16px;">
                    <div class="subscription-progress-header">
                        <span class="subscription-progress-title">Additional Credits</span>
                        <span style="color: var(--settings-text-muted); font-size: 12px;">{{ additional_credits_usage_percentage|floatformat:0 }}% used</span>
                    </div>
                    <div class="subscription-progress-bar-container">
                        <div class="subscription-progress-bar-fill{% if additional_credits_usage_percentage > 80 %} danger{% elif additional_credits_usage_percentage > 60 %} warning{% endif %}" style="width: {{ additional_credits_usage_percentage }}%; background: #10b981;"></div>
                    </div>
                </div>
                {% endif %}
                {% endif %}
                
                <div class="subscription-usage-stats">
                    <div class="subscription-stat-item">
                        <span class="subscription-stat-label">Used</span>
                        <span class="subscription-stat-value">{{ user_credit.total_tokens_used|intcomma }}</span>
                    </div>
                    <div class="subscription-stat-item">
                        <span class="subscription-stat-label">Remaining</span>
                        <span class="subscription-stat-value remaining{% if user_credit.get_remaining_tokens < 10000 %} low{% endif %}">
                            {{ user_credit.get_remaining_tokens|intcomma }}
                        </span>
                    </div>
                </div>
                
                <!-- Credit Breakdown -->
                <div style="margin-top: 16px; text-align: center; font-size: 9px; color: var(--settings-text-secondary); line-height: 1.3;">
                    Free: {{ free_tier_token_limit|intcomma }} (one-time){% if not user_credit.is_free_tier %} â€¢ Monthly: {{ pro_monthly_token_limit|intcomma }}{% if user_credit.credits > 0 %} â€¢ Additional: {{ user_credit.credits|intcomma }}{% endif %}{% endif %}
                </div>
                
                {% if not user_credit.is_free_tier and user_credit.subscription_end_date %}
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--settings-card-border); color: var(--settings-text-secondary); font-size: 12px;">
                    <i class="fas fa-sync-alt"></i>
                    Your subscription renews on {{ user_credit.subscription_end_date|date:"F d, Y" }}
                </div>
                {% endif %}
            </div>

            <!-- Payment Methods -->
            <div class="subscription-plan-card">
                <h3 style="color: var(--settings-text-primary); font-size: 18px; font-weight: 600; margin-bottom: 20px;">Payment Methods</h3>
                <div id="payment-methods-list-settings" style="flex: 1;">
                    <div class="loading-payment-methods" style="text-align: center; padding: 32px; color: var(--settings-text-secondary);">
                        <i class="fas fa-spinner fa-spin"></i> Loading payment methods...
                    </div>
                </div>
                <button id="add-payment-method-settings" class="add-payment-button-settings" style="display: none; margin-top: auto;">
                    <i class="fas fa-plus"></i> Add Payment Method
                </button>
            </div>

            <!-- Available Plans -->
            <div class="subscription-plan-card">
                <h3 style="color: var(--settings-text-primary); font-size: 18px; font-weight: 600; margin-bottom: 20px;">Available Plans</h3>
                {% if not payment_plans %}
                    <div style="text-align: center; padding: 2rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #ef4444; margin-bottom: 24px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p style="margin: 0.5rem 0 0 0;">No payment plans found in database</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 12px;">Run: <code>python manage.py create_default_plans</code></p>
                    </div>
                {% endif %}
                <div class="subscription-plans-grid">
                    {% for plan in payment_plans %}
                    <div class="subscription-pricing-card{% if plan.name == 'Pro Monthly' %} recommended{% endif %}">
                        {% if plan.name == 'Pro Monthly' %}
                        <span class="subscription-recommended-badge">Recommended</span>
                        {% endif %}
                        
                        <h4 class="subscription-plan-name">{{ plan.name }}</h4>
                        <div class="subscription-plan-price">
                            {% if plan.price == 0 %}
                                Free
                            {% else %}
                                ${{ plan.price|floatformat:0 }}
                                {% if plan.is_subscription %}<span>/ month</span>{% endif %}
                            {% endif %}
                        </div>
                        <p class="subscription-plan-description">{{ plan.description }}</p>
                        
                        <ul class="subscription-plan-features">
                            {% if plan.name == 'Free Tier' %}
                                <li><i class="fas fa-check"></i> {{ free_tier_token_limit|intcomma }} one-time tokens</li>
                                <li><i class="fas fa-check"></i> Low tier models (GPT-5-mini and Haiku)</li>
                                <li><i class="fas fa-check"></i> Limited documents and </li>
                                <li><i class="fas fa-check"></i> Community support</li>
                            {% elif plan.name == 'Pro Monthly' %}
                                <li><i class="fas fa-check"></i> {{ pro_monthly_token_limit|intcomma }} tokens per month</li>
                                <li><i class="fas fa-check"></i> GPT-5 included with platform credits</li>
                                <li><i class="fas fa-check"></i> BYO Anthropic &amp; Google API keys</li>
                                <li><i class="fas fa-check"></i> Priority support &amp; advanced features</li>
                            {% else %}
                                <li><i class="fas fa-check"></i> {{ plan.credits|intcomma }} additional tokens</li>
                                <li><i class="fas fa-check"></i> One-time purchase</li>
                                <li><i class="fas fa-check"></i> Never expires</li>
                                <li><i class="fas fa-check"></i> Use with any plan</li>
                            {% endif %}
                        </ul>
                        
                        {% if plan.price > 0 %}
                            {% if has_paid_subscription and plan.is_subscription %}
                                <button class="subscription-plan-button secondary" disabled>Current Plan</button>
                            {% else %}
                                <a href="{% url 'subscriptions:checkout' plan.id %}" class="subscription-plan-button primary">
                                    {% if plan.is_subscription %}Get Started{% else %}Purchase Credits{% endif %}
                                </a>
                            {% endif %}
                        {% else %}
                            {% if user_credit.is_free_tier %}
                                <button class="subscription-plan-button secondary" disabled>Your Current Plan</button>
                            {% else %}
                                <button class="subscription-plan-button secondary" disabled>Free Tier</button>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Recent Transactions -->
            <h3 style="color: var(--settings-text-primary); font-size: 18px; font-weight: 600; margin: 32px 0 20px 0;">Recent Transactions</h3>
            <div class="subscription-plan-card">
                {% if transactions %}
                <table class="subscription-transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Plan</th>
                            <th>Amount</th>
                            <th>Credits</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.created_at|date:"M d, Y" }}</td>
                            <td>{{ transaction.payment_plan.name }}</td>
                            <td>${{ transaction.amount|floatformat:2 }}</td>
                            <td>{{ transaction.credits_added|intcomma }}</td>
                            <td>
                                <span class="subscription-status-badge {{ transaction.status }}">
                                    <i class="fas fa-{% if transaction.status == 'completed' %}check-circle{% elif transaction.status == 'pending' %}clock{% else %}times-circle{% endif %}"></i>
                                    {{ transaction.get_status_display }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="subscription-empty-state">
                    <i class="fas fa-receipt"></i>
                    <p>No transactions yet</p>
                </div>
                {% endif %}
            </div>
            </div> <!-- Close subscription-cards-grid -->
        </div>
        
        <!-- LLM Settings Section -->
        <div id="llm-settings" class="settings-section">
            <h2 class="section-heading">Language Model API Keys</h2>
            {% if not user_credit.is_free_tier %}
            <div class="integrations-list">
                <!-- OpenAI Integration -->
                <div class="integration-item">
                    <div class="integration-header">
                        <div class="integration-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.051 6.051 0 0 0 6.0865-6.0958 5.9894 5.9894 0 0 0 3.9575-2.9001 6.0557 6.0557 0 0 0-.7475-7.0966zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.5093-2.6067-1.4997z" fill="#a78bfa"/>
                            </svg>
                        </div>
                        <div class="integration-info">
                            <h3 class="integration-name">
                                OpenAI
                                {% if openai_connected %}
                                    <span class="connected-check">
                                        <i class="fas fa-check"></i>
                                    </span>
                                {% endif %}
                            </h3>
                            <p class="integration-description">GPT-5</p>
                        </div>
                    </div>
                    
                    {% if openai_connected %}
                        <form method="post" action="{% url 'accounts:disconnect_api_key' 'openai' %}">
                            {% csrf_token %}
                            <div class="api-key-section">
                                <div class="api-key-input-wrapper">
                                    <input type="password" class="api-input connected" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly>
                                    <span class="input-status" style="color: #22c55e;">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                </div>
                                <button type="submit" class="disconnect-button">Disconnect</button>
                            </div>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'accounts:save_api_key' 'openai' %}">
                            {% csrf_token %}
                            <div class="api-key-section">
                                <div class="api-key-input-wrapper">
                                    <input type="password" name="api_key" class="api-input" placeholder="Enter your OpenAI API key" required>
                                </div>
                                <button type="submit" class="save-button">Connect</button>
                            </div>
                        </form>
                    {% endif %}
                    
                    <a href="https://platform.openai.com/settings/organization/api-keys" target="_blank" class="external-link" title="OpenAI API key guide">
                        <span class="integration-help">?</span>
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>

                <!-- Anthropic Integration -->
                <div class="integration-item">
                    <div class="integration-header">
                        <div class="integration-icon">
                            <img src="{% static 'images/anthropic-logo.png' %}" alt="Anthropic" class="llm-logo-img">
                        </div>
                        <div class="integration-info">
                            <h3 class="integration-name">
                                Anthropic
                                {% if anthropic_connected %}
                                    <span class="connected-check">
                                        <i class="fas fa-check"></i>
                                    </span>
                                {% endif %}
                            </h3>
                            <p class="integration-description">Claude 4 Sonnet</p>
                        </div>
                    </div>
                    
                    {% if anthropic_connected %}
                        <form method="post" action="{% url 'accounts:disconnect_api_key' 'anthropic' %}">
                            {% csrf_token %}
                            <div class="api-key-section">
                                <div class="api-key-input-wrapper">
                                    <input type="password" class="api-input connected" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly>
                                    <span class="input-status" style="color: #22c55e;">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                </div>
                                <button type="submit" class="disconnect-button">Disconnect</button>
                            </div>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'accounts:save_api_key' 'anthropic' %}">
                            {% csrf_token %}
                            <div class="api-key-section">
                                <div class="api-key-input-wrapper">
                                    <input type="password" name="api_key" class="api-input" placeholder="Enter your Anthropic API key" required>
                                </div>
                                <button type="submit" class="save-button">Connect</button>
                            </div>
                        </form>
                    {% endif %}
                    
                    <a href="https://console.anthropic.com/settings/keys" target="_blank" class="external-link" title="Anthropic API key guide">
                        <span class="integration-help">?</span>
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>

                <!-- XAI Integration -->
                <div class="integration-item">
                    <div class="integration-header">
                        <div class="integration-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" fill="#a78bfa"/>
                            </svg>
                        </div>
                        <div class="integration-info">
                            <h3 class="integration-name">
                                xAI
                                {% if xai_connected %}
                                    <span class="connected-check">
                                        <i class="fas fa-check"></i>
                                    </span>
                                {% endif %}
                            </h3>
                            <p class="integration-description">Grok 4</p>
                        </div>
                    </div>
                    
                    {% if xai_connected %}
                        <form method="post" action="{% url 'accounts:disconnect_api_key' 'xai' %}">
                            {% csrf_token %}
                            <div class="api-key-section">
                                <div class="api-key-input-wrapper">
                                    <input type="password" class="api-input connected" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly>
                                    <span class="input-status" style="color: #22c55e;">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                </div>
                                <button type="submit" class="disconnect-button">Disconnect</button>
                            </div>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'accounts:save_api_key' 'xai' %}">
                            {% csrf_token %}
                            <div class="api-key-section">
                                <div class="api-key-input-wrapper">
                                    <input type="password" name="api_key" class="api-input" placeholder="Enter your xAI API key" required>
                                </div>
                                <button type="submit" class="save-button">Connect</button>
                            </div>
                        </form>
                    {% endif %}
                    
                    <a href="https://console.x.ai/" target="_blank" class="external-link" title="xAI API key guide">
                        <span class="integration-help">?</span>
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>

                <!-- Google Integration -->
                <div class="integration-item">
                    <div class="integration-header">
                        <div class="integration-icon">
                            <img src="{% static 'images/gemini-logo.png' %}" alt="Google Gemini" class="llm-logo-img">
                        </div>
                        <div class="integration-info">
                            <h3 class="integration-name">
                                Google AI
                                {% if google_connected %}
                                    <span class="connected-check">
                                        <i class="fas fa-check"></i>
                                    </span>
                                {% endif %}
                            </h3>
                            <p class="integration-description">Gemini 2.5 Pro</p>
                        </div>
                    </div>
                    
                    {% if google_connected %}
                        <form method="post" action="{% url 'accounts:disconnect_api_key' 'google' %}">
                            {% csrf_token %}
                            <div class="api-key-section">
                                <div class="api-key-input-wrapper">
                                    <input type="password" class="api-input connected" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly>
                                    <span class="input-status" style="color: #22c55e;">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                </div>
                                <button type="submit" class="disconnect-button">Disconnect</button>
                            </div>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'accounts:save_api_key' 'google' %}">
                            {% csrf_token %}
                            <div class="api-key-section">
                                <div class="api-key-input-wrapper">
                                    <input type="password" name="api_key" class="api-input" placeholder="Enter your Google AI API key" required>
                                </div>
                                <button type="submit" class="save-button">Connect</button>
                            </div>
                        </form>
                    {% endif %}
                    
                    <a href="https://aistudio.google.com/apikey" target="_blank" class="external-link" title="Google AI Studio keys">
                        <span class="integration-help">?</span>
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>
            {% else %}
            <!-- Blocked message for free tier users -->
            <div style="text-align: center; padding: 3rem; max-width: 800px; width: 100%;">
                <div style="background: rgba(167, 139, 250, 0.1); border: 1px solid rgba(167, 139, 250, 0.3); border-radius: 16px; padding: 2rem;">
                    <i class="fas fa-lock" style="font-size: 2rem; color: #a78bfa; margin-bottom: 1rem;"></i>
                    <h3 style="color: var(--settings-text-primary); font-size: 1.25rem; font-weight: 600; margin: 0 0 1rem 0;">Pro Feature</h3>
                    <p style="color: rgba(255, 255, 255, 0.7); margin: 0 0 1.5rem 0; line-height: 1.5;">
                        LLM API key management is available for Pro subscribers only. Upgrade to connect your own API keys and access advanced AI models.
                    </p>
                    <a href="{% url 'subscriptions:dashboard' %}" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        background: linear-gradient(135deg, #8B5CF6, #A855F7);
                        color: white;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 600;
                        text-decoration: none;
                        transition: all 0.2s;
                        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.35)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.25)';">
                        <i class="fas fa-rocket"></i>
                        Upgrade to Pro
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
        
        
        <!-- Organizations Section -->
        <div id="organizations" class="settings-section">
            <h2 class="section-heading">Organizations</h2>
            <div class="integrations-list">
                <div class="integration-item">
                    <div class="integration-header">
                        <div class="integration-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="#a78bfa"/>
                                <circle cx="18" cy="8" r="3" fill="#a78bfa" opacity="0.7"/>
                                <circle cx="6" cy="8" r="3" fill="#a78bfa" opacity="0.7"/>
                            </svg>
                        </div>
                        <div class="integration-info">
                            <h3 class="integration-name">
                                Team Organizations
                                {% if user.profile.current_organization %}
                                    <span class="connected-check">
                                        <i class="fas fa-check"></i>
                                    </span>
                                {% endif %}
                            </h3>
                            <p class="integration-description">Manage your team organizations and billing</p>
                        </div>
                    </div>
                    
                    {% if user.profile.current_organization %}
                        <div class="team-organization-card current">
                            <div class="organization-header">
                                {% if user.profile.current_organization.avatar %}
                                    <img src="{{ user.profile.current_organization.avatar.url }}" alt="{{ user.profile.current_organization.name }}" class="organization-avatar">
                                {% else %}
                                    <div class="organization-avatar placeholder">
                                        {{ user.profile.current_organization.name|first|upper }}
                                    </div>
                                {% endif %}
                                <div class="organization-info">
                                    <h3>{{ user.profile.current_organization.name }}</h3>
                                    <p class="subtitle">
                                        {{ current_org_role|capfirst|default:"Member" }} â€¢ 
                                        {{ user.profile.current_organization.member_count }} member{{ user.profile.current_organization.member_count|pluralize }}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="organization-stats">
                                <div class="stat-card">
                                    <div class="stat-value">{{ user.profile.current_organization.credit.credits|default:0 }}</div>
                                    <div class="stat-label">Credits</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value {% if user.profile.current_organization.credit.is_subscribed %}success{% else %}muted{% endif %}">
                                        {% if user.profile.current_organization.credit.is_subscribed %}<i class="fas fa-check"></i> Pro{% else %}<i class="fas fa-building"></i> Free{% endif %}
                                    </div>
                                    <div class="stat-label">Plan</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">{{ user.profile.current_organization.credit.seat_count|default:1 }}</div>
                                    <div class="stat-label">Seats</div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="personal-space-card">
                            <div class="organization-header">
                                <div class="organization-avatar placeholder">
                                    {{ user.first_name|first|default:user.username|first|upper }}
                                </div>
                                <div class="organization-info">
                                    <h3>Personal Space</h3>
                                    <p class="subtitle">Individual account</p>
                                </div>
                            </div>
                            
                            <div class="organization-stats">
                                <div class="stat-card">
                                    <div class="stat-value">{{ user_credits|default:0 }}</div>
                                    <div class="stat-label">Credits</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value {% if user.llm_api_keys.free_trial %}muted{% else %}success{% endif %}">
                                        {% if user.llm_api_keys.free_trial %}<i class="fas fa-times"></i>{% else %}<i class="fas fa-check"></i>{% endif %}
                                    </div>
                                    <div class="stat-label">API Keys</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">1</div>
                                    <div class="stat-label">Members</div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="organization-actions">
                        <a href="{% url 'accounts:organization_list' %}" class="btn btn-primary">
                            <i class="fas fa-building"></i>
                            Manage Organizations
                        </a>
                        <a href="{% url 'accounts:create_organization' %}" class="btn btn-secondary">
                            <i class="fas fa-plus"></i>
                            Create New
                        </a>
                    </div>
                    
                    {% if user.profile.current_organization %}
                        <a href="{% url 'accounts:organization_dashboard' user.profile.current_organization.slug %}" class="external-link">
                            Organization Billing
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    {% else %}
                        <a href="{% url 'subscriptions:dashboard' %}" target="_blank" class="external-link">
                            Billing & Subscriptions
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- GitHub Section -->
        <div id="github" class="settings-section">
            <h2 class="section-heading">Code Repository</h2>
            <div class="integrations-list">
                <!-- GitHub Integration -->
                <div class="integration-item">
                    <div class="integration-header">
                        <div class="integration-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.475 2 2 6.475 2 12C2 16.425 4.8625 20.1625 8.8375 21.4875C9.3375 21.575 9.525 21.275 9.525 21.0125C9.525 20.775 9.5125 19.9875 9.5125 19.15C7 19.6125 6.35 18.5375 6.15 17.975C6.0375 17.6875 5.55 16.8 5.125 16.5625C4.775 16.375 4.275 15.9125 5.1125 15.9C5.9 15.8875 6.4625 16.625 6.65 16.925C7.55 18.4375 8.9875 18.0125 9.5625 17.75C9.65 17.1 9.9125 16.6625 10.2 16.4125C7.975 16.1625 5.65 15.3 5.65 11.475C5.65 10.3875 6.0375 9.4875 6.675 8.7875C6.575 8.5375 6.225 7.5125 6.775 6.1375C6.775 6.1375 7.6125 5.875 9.525 7.1625C10.325 6.9375 11.175 6.825 12.025 6.825C12.875 6.825 13.725 6.9375 14.525 7.1625C16.4375 5.8625 17.275 6.1375 17.275 6.1375C17.825 7.5125 17.475 8.5375 17.375 8.7875C18.0125 9.4875 18.4 10.375 18.4 11.475C18.4 15.3125 16.0625 16.1625 13.8375 16.4125C14.2 16.725 14.5125 17.325 14.5125 18.2625C14.5125 19.6 14.5 20.675 14.5 21.0125C14.5 21.275 14.6875 21.5875 15.1875 21.4875C19.1375 20.1625 22 16.4125 22 12C22 6.475 17.525 2 12 2Z" fill="#a78bfa"/>
                            </svg>
                        </div>
                        <div class="integration-info">
                            <h3 class="integration-name">
                                GitHub
                                {% if github_connected %}
                                    <span class="connected-check">
                                        <i class="fas fa-check"></i>
                                    </span>
                                {% endif %}
                            </h3>
                            <p class="integration-description">Version control and code collaboration</p>
                        </div>
                    </div>
                    
                    {% if github_connected %}
                        <div class="github-connection-info">
                            <div class="connected-user">
                                {% if github_avatar %}
                                    <img src="{{ github_avatar }}" alt="{{ github_username }}" class="connected-avatar">
                                {% endif %}
                                <span>Connected as <strong>{{ github_username }}</strong></span>
                            </div>
                            <form method="post" action="{% url 'accounts:integrations' %}" style="margin: 0;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="github_disconnect">
                                <button type="submit" class="disconnect-button" style="margin-top: 0.75rem;">Disconnect</button>
                            </form>
                        </div>
                    {% else %}
                        <div class="api-key-section" style="align-items: center;">
                            {% if github_missing_config %}
                                <button class="save-button" disabled style="width: auto;">GitHub API Not Configured</button>
                            {% else %}
                                <a href="{{ github_auth_url }}" class="save-button" style="text-decoration: none; display: inline-flex; width: auto;">Connect GitHub</a>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <a href="https://github.com/" target="_blank" class="external-link">
                        Visit GitHub
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Claude Code Section -->
        <div id="claude-code" class="settings-section">
            <h2 class="section-heading">Claude Code CLI</h2>
            <div class="integrations-list">
                <!-- Claude Code Integration -->
                <div class="integration-item">
                    <div class="integration-header">
                        <div class="integration-icon" style="background: linear-gradient(135deg, #D97706, #F59E0B);">
                            <i class="fas fa-terminal" style="color: white;"></i>
                        </div>
                        <div class="integration-info">
                            <h3 class="integration-name">
                                Claude Code
                                <span id="claude-code-status-check" style="display: none;">
                                    <i class="fas fa-check"></i>
                                </span>
                            </h3>
                            <p class="integration-description">Use Claude Code CLI for enhanced ticket execution</p>
                        </div>
                    </div>

                    <div id="claude-code-auth-section">
                        <!-- Auth status will be loaded dynamically -->
                        <div class="api-key-section" style="align-items: center;">
                            <button id="claude-code-connect-btn" class="save-button" style="width: auto;">
                                <i class="fas fa-plug" style="margin-right: 0.5rem;"></i>Connect Claude Code
                            </button>
                        </div>
                    </div>

                    <!-- OAuth URL Display (hidden by default) -->
                    <div id="claude-code-oauth-section" style="display: none; margin-top: 1rem;">
                        <div style="background: var(--bg-alt); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-info-circle"></i> Open this URL in your browser and authenticate:
                            </p>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" id="claude-code-oauth-url" readonly
                                    style="flex: 1; min-width: 0; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 0.8rem;">
                                <button onclick="window.open(document.getElementById('claude-code-oauth-url').value, '_blank')" title="Open URL"
                                    class="save-button" style="width: auto; padding: 0.5rem 1rem; flex-shrink: 0;">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="text" id="claude-code-auth-code" placeholder="Paste authentication code here..."
                                style="flex: 1; padding: 0.75rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                            <button id="claude-code-submit-btn" class="save-button" style="width: auto;">
                                Submit Code
                            </button>
                        </div>
                        <p id="claude-code-error" style="color: #EF4444; font-size: 0.875rem; margin-top: 0.5rem; display: none;"></p>
                    </div>

                    <!-- Connected State (hidden by default) -->
                    <div id="claude-code-connected-section" style="display: none; margin-top: 1rem;">
                        <div class="connected-user" style="margin-bottom: 1rem;">
                            <i class="fas fa-check-circle" style="color: #10B981; margin-right: 0.5rem;"></i>
                            <span>Claude Code is <strong>connected</strong></span>
                        </div>

                        <!-- CLI Mode Toggle -->
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-alt); border-radius: 8px; margin-bottom: 1rem;">
                            <label class="toggle-switch" style="flex-shrink: 0;">
                                <input type="checkbox" id="claude-code-enabled-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <div>
                                <h4 style="margin: 0; color: var(--text-primary);">Use CLI Mode for Tickets</h4>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-light); font-size: 0.875rem;">
                                    Execute tickets using Claude Code CLI instead of API
                                </p>
                            </div>
                        </div>

                        <button id="claude-code-disconnect-btn" class="disconnect-button" style="width: auto; margin-top: 0.5rem;">
                            Disconnect
                        </button>
                    </div>

                    <a href="https://docs.anthropic.com/en/docs/claude-code" target="_blank" class="external-link" style="margin-top: 1rem;">
                        Learn about Claude Code
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Prompts Section (Disabled) -->
        <div id="prompts" class="settings-section">
            <h2 class="section-heading">Prompts</h2>
            <p style="color: var(--text-light); font-size: 0.875rem;">Coming soon...</p>
        </div>
    </div>
</div>
</div>

<script>
    // Claude Code Integration Scripts
    document.addEventListener('DOMContentLoaded', function() {
        const connectBtn = document.getElementById('claude-code-connect-btn');
        const submitBtn = document.getElementById('claude-code-submit-btn');
        const disconnectBtn = document.getElementById('claude-code-disconnect-btn');
        const enabledToggle = document.getElementById('claude-code-enabled-toggle');
        const oauthSection = document.getElementById('claude-code-oauth-section');
        const connectedSection = document.getElementById('claude-code-connected-section');
        const authSection = document.getElementById('claude-code-auth-section');
        const statusCheck = document.getElementById('claude-code-status-check');
        const errorDisplay = document.getElementById('claude-code-error');

        // Check initial status
        checkClaudeCodeStatus();

        async function checkClaudeCodeStatus() {
            try {
                const response = await fetch('/accounts/claude-code/status/');
                const data = await response.json();

                if (data.authenticated) {
                    showConnectedState(data.enabled);
                } else {
                    showDisconnectedState();
                }
            } catch (error) {
                console.error('Error checking Claude Code status:', error);
            }
        }

        function showConnectedState(enabled) {
            authSection.style.display = 'none';
            oauthSection.style.display = 'none';
            connectedSection.style.display = 'block';
            statusCheck.style.display = 'inline';
            enabledToggle.checked = enabled;
        }

        function showDisconnectedState() {
            authSection.style.display = 'block';
            oauthSection.style.display = 'none';
            connectedSection.style.display = 'none';
            statusCheck.style.display = 'none';
        }

        function showError(message) {
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
        }

        function hideError() {
            errorDisplay.style.display = 'none';
        }

        // Connect button
        connectBtn.addEventListener('click', async function() {
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Connecting...';
            hideError();

            try {
                const response = await fetch('/accounts/claude-code/start-auth/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                const data = await response.json();

                if (data.status === 'already_authenticated') {
                    showConnectedState(false);
                } else if (data.status === 'pending' && data.oauth_url) {
                    // Show OAuth section
                    document.getElementById('claude-code-oauth-url').value = data.oauth_url;
                    authSection.style.display = 'none';
                    oauthSection.style.display = 'block';
                } else if (data.status === 'error') {
                    showError(data.error || 'Failed to start authentication');
                    authSection.style.display = 'block';
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                connectBtn.disabled = false;
                connectBtn.innerHTML = '<i class="fas fa-plug" style="margin-right: 0.5rem;"></i>Connect Claude Code';
            }
        });

        // Submit code button
        submitBtn.addEventListener('click', async function() {
            const code = document.getElementById('claude-code-auth-code').value.trim();
            if (!code) {
                showError('Please enter the authentication code');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Verifying...';
            hideError();

            try {
                const response = await fetch('/accounts/claude-code/submit-code/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ code: code })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    showConnectedState(false);
                } else {
                    showError(data.error || 'Authentication failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Code';
            }
        });

        // Toggle CLI mode
        enabledToggle.addEventListener('change', async function() {
            const enabled = this.checked;

            try {
                const response = await fetch('/accounts/claude-code/toggle/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ enabled: enabled })
                });
                const data = await response.json();

                if (data.status === 'error') {
                    this.checked = !enabled; // Revert
                    alert(data.error);
                }
            } catch (error) {
                this.checked = !enabled; // Revert
                alert('Failed to update setting');
            }
        });

        // Disconnect button
        disconnectBtn.addEventListener('click', async function() {
            if (!confirm('Are you sure you want to disconnect Claude Code?')) return;

            disconnectBtn.disabled = true;
            disconnectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Disconnecting...';

            try {
                const response = await fetch('/accounts/claude-code/disconnect/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                const data = await response.json();

                if (data.status === 'success') {
                    showDisconnectedState();
                }
            } catch (error) {
                alert('Failed to disconnect');
            } finally {
                disconnectBtn.disabled = false;
                disconnectBtn.innerHTML = 'Disconnect';
            }
        });

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
        }
    });

    // Settings navigation
    document.addEventListener('DOMContentLoaded', function() {
        const navItems = document.querySelectorAll('.settings-nav-item:not(.disabled)');
        const sections = document.querySelectorAll('.settings-section');
        
        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all items and sections
                navItems.forEach(nav => nav.classList.remove('active'));
                sections.forEach(section => section.classList.remove('active'));
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Show corresponding section
                const sectionId = this.getAttribute('data-section');
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('active');
                }
                
                // Update URL hash
                window.location.hash = sectionId;
            });
        });
        
        // Handle initial hash
        const hash = window.location.hash.slice(1);
        if (hash) {
            const navItem = document.querySelector(`[data-section="${hash}"]`);
            if (navItem && !navItem.classList.contains('disabled')) {
                navItem.click();
                // If it's the subscriptions section, load payment methods immediately
                if (hash === 'subscriptions') {
                    setTimeout(() => {
                        loadPaymentMethodsSettings();
                    }, 100);
                }
            }
        }
        
        // No expandable functionality needed anymore since we're showing input fields directly
        
        // Handle notification dismissal
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            alert.style.cursor = 'pointer';
            alert.addEventListener('click', function() {
                this.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => this.remove(), 300);
            });
        });
        
        // Handle project collaboration toggle
        const projectInvitationsToggle = document.getElementById('allow-guest-invitations');
        if (projectInvitationsToggle) {
            projectInvitationsToggle.addEventListener('change', function() {
                const enabled = this.checked;
                
                // Show a loading state or feedback
                const settingInfo = this.closest('.setting-toggle-wrapper').querySelector('.setting-info');
                const originalDescription = settingInfo.querySelector('.setting-description').textContent;
                
                if (enabled) {
                    settingInfo.querySelector('.setting-description').textContent = 'Enabling guest invitations...';
                } else {
                    settingInfo.querySelector('.setting-description').textContent = 'Disabling guest invitations...';
                }
                
                // Make API call to save the setting
                fetch('/accounts/settings/project-collaboration/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        allow_project_invitations: enabled
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success state
                        settingInfo.querySelector('.setting-description').textContent = enabled 
                            ? 'Project invitations are now enabled. Team members can invite external collaborators.' 
                            : 'Project invitations are disabled. Only organization members can access projects.';
                        
                        // Show a temporary success indicator
                        const checkIcon = settingInfo.querySelector('.setting-title');
                        const originalTitle = checkIcon.textContent;
                        checkIcon.innerHTML = '<i class="fas fa-check" style="color: #10b981; margin-right: 0.5rem;"></i>' + originalTitle;
                        
                        setTimeout(() => {
                            checkIcon.textContent = originalTitle;
                            settingInfo.querySelector('.setting-description').textContent = originalDescription;
                        }, 3000);
                    } else {
                        // Revert toggle state on error
                        this.checked = !enabled;
                        settingInfo.querySelector('.setting-description').textContent = 'Error updating setting. Please try again.';
                        setTimeout(() => {
                            settingInfo.querySelector('.setting-description').textContent = originalDescription;
                        }, 3000);
                    }
                })
                .catch(error => {
                    // Revert toggle state on error
                    this.checked = !enabled;
                    settingInfo.querySelector('.setting-description').textContent = 'Network error. Please try again.';
                    setTimeout(() => {
                        settingInfo.querySelector('.setting-description').textContent = originalDescription;
                    }, 3000);
                });
            });
        }
    });
    
    // Help modal function
    function showProjectInvitationHelp() {
        const helpModal = document.createElement('div');
        helpModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        `;
        
        helpModal.innerHTML = `
            <div style="
                background: #1a1a1a;
                border: 1px solid rgba(167, 139, 250, 0.3);
                border-radius: 16px;
                padding: 2rem;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            ">
                <button onclick="this.closest('.help-modal').remove()" style="
                    position: absolute;
                    top: 1rem;
                    right: 1rem;
                    background: none;
                    border: none;
                    color: rgba(255, 255, 255, 0.6);
                    font-size: 1.25rem;
                    cursor: pointer;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 8px;
                    transition: all 0.2s;
                " onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.color='white';" onmouseout="this.style.background='none'; this.style.color='rgba(255,255,255,0.6)';">
                    <i class="fas fa-times"></i>
                </button>
                
                <h3 style="
                    color: #a78bfa;
                    font-size: 1.25rem;
                    margin: 0 0 1.5rem 0;
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                ">
                    <i class="fas fa-user-friends"></i>
                    Project Invitations Guide
                </h3>
                
                <div style="color: rgba(255, 255, 255, 0.8); line-height: 1.6; font-size: 0.875rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: white; font-size: 1rem; margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-envelope" style="color: #3b82f6;"></i>
                            How it works
                        </h4>
                        <p style="margin: 0 0 0.75rem 0;">When you invite someone to a project:</p>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            <li>They receive a secure invitation email with a unique link</li>
                            <li>Upon accepting, they're automatically added to your organization</li>
                            <li>They gain access to project files, tickets, and AI assistant</li>
                            <li>Their access level is determined by the role you assign</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: white; font-size: 1rem; margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user-tag" style="color: #10b981;"></i>
                            Permission Roles
                        </h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="padding: 0.75rem; background: rgba(167, 139, 250, 0.1); border-radius: 8px; border-left: 3px solid #a78bfa;">
                                <strong>Admin:</strong> Can manage project, invite members, edit files, manage tickets
                            </div>
                            <div style="padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                                <strong>Member:</strong> Can edit files, manage tickets, chat with AI assistant
                            </div>
                            <div style="padding: 0.75rem; background: rgba(107, 114, 128, 0.1); border-radius: 8px; border-left: 3px solid #6b7280;">
                                <strong>Viewer:</strong> Read-only access to files and tickets, can chat with AI
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #f59e0b; font-size: 0.875rem; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-shield-alt"></i>
                            Security Note
                        </h4>
                        <p style="margin: 0; color: rgba(255, 255, 255, 0.7); font-size: 0.8125rem;">
                            Invitation links expire after 7 days and can only be used once. 
                            You can revoke access or change roles at any time from the project settings.
                        </p>
                    </div>
                </div>
            </div>
        `;
        
        helpModal.className = 'help-modal';
        document.body.appendChild(helpModal);
        
        // Close on outside click
        helpModal.addEventListener('click', function(e) {
            if (e.target === helpModal) {
                helpModal.remove();
            }
        });
    }
    
    // Initialize Stripe for subscriptions functionality
    let stripe = null;
    const stripePublicKey = '{{ STRIPE_PUBLIC_KEY }}';
    
    // Initialize Stripe when DOM is ready and Stripe is available
    function initializeStripe() {
        if (typeof Stripe !== 'undefined' && stripePublicKey) {
            stripe = Stripe(stripePublicKey);
        } else {
            console.warn('Stripe not available or public key missing');
        }
    }
    
    // Load payment methods when subscriptions section is shown
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Stripe
        initializeStripe();
        // Watch for section changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.target.id === 'subscriptions' && mutation.target.classList.contains('active')) {
                    loadPaymentMethodsSettings();
                }
            });
        });
        
        // Observe the subscriptions section for class changes
        const subscriptionsSection = document.getElementById('subscriptions');
        if (subscriptionsSection) {
            observer.observe(subscriptionsSection, { attributes: true, attributeFilter: ['class'] });
        }
        
        // Load immediately if subscriptions section is already active
        if (subscriptionsSection && subscriptionsSection.classList.contains('active')) {
            loadPaymentMethodsSettings();
        }
        
        // Add payment method button handler for settings
        const addButton = document.getElementById('add-payment-method-settings');
        if (addButton) {
            addButton.addEventListener('click', addPaymentMethodSettings);
        }
    });
    
    async function loadPaymentMethodsSettings() {
        try {
            const response = await fetch('/subscriptions/payment-methods/');
            const data = await response.json();
            
            const container = document.getElementById('payment-methods-list-settings');
            const addButton = document.getElementById('add-payment-method-settings');
            
            if (data.payment_methods && data.payment_methods.length > 0) {
                container.innerHTML = '';
                data.payment_methods.forEach(method => {
                    container.appendChild(createPaymentMethodElementSettings(method));
                });
            } else {
                container.innerHTML = `
                    <div class="no-payment-methods">
                        <i class="fas fa-credit-card"></i>
                        <p>No payment methods added yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Add a payment method to upgrade your plan or purchase credits</p>
                    </div>
                `;
            }
            
            addButton.style.display = 'flex';
        } catch (error) {
            console.error('Error loading payment methods:', error);
            document.getElementById('payment-methods-list-settings').innerHTML = `
                <div class="no-payment-methods">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Unable to load payment methods</p>
                </div>
            `;
            document.getElementById('add-payment-method-settings').style.display = 'flex';
        }
    }
    
    function createPaymentMethodElementSettings(method) {
        const div = document.createElement('div');
        div.className = 'payment-method-item';
        
        const brand = method.card.brand;
        const last4 = method.card.last4;
        const expMonth = method.card.exp_month.toString().padStart(2, '0');
        const expYear = method.card.exp_year.toString().slice(-2);
        const isDefault = method.is_default;
        
        div.innerHTML = `
            <div class="payment-method-info">
                <div class="card-icon ${brand}">
                    ${brand.toUpperCase()}
                </div>
                <div class="card-details">
                    <div class="card-number">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ ${last4}</div>
                    <div class="card-expiry">Expires ${expMonth}/${expYear}</div>
                </div>
            </div>
            <div class="payment-method-actions">
                ${isDefault ? 
                    '<button class="method-action method-default" disabled><i class="fas fa-check"></i> Default</button>' :
                    `<button class="method-action method-make-default" onclick="setDefaultPaymentMethodSettings('${method.id}')">Make Default</button>`
                }
                <button class="method-action method-remove" onclick="removePaymentMethodSettings('${method.id}')"><i class="fas fa-trash"></i></button>
            </div>
        `;
        
        return div;
    }
    
    async function addPaymentMethodSettings() {
        try {
            if (!stripe) {
                alert('Stripe is not configured. Please contact support.');
                return;
            }
            
            const response = await fetch('/subscriptions/create-setup-intent/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Server error' }));
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.setup_url) {
                window.location.href = data.setup_url;
            } else {
                throw new Error(data.error || 'No setup URL received');
            }
        } catch (error) {
            console.error('Error adding payment method:', error);
            alert('Error adding payment method: ' + error.message);
        }
    }
    
    async function setDefaultPaymentMethodSettings(paymentMethodId) {
        try {
            const response = await fetch('/subscriptions/set-default-payment-method/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ payment_method_id: paymentMethodId })
            });
            
            if (response.ok) {
                loadPaymentMethodsSettings();
                showMessageSettings('Default payment method updated!', 'success');
            } else {
                alert('Error setting default payment method');
            }
        } catch (error) {
            console.error('Error setting default payment method:', error);
            alert('Error setting default payment method');
        }
    }
    
    async function removePaymentMethodSettings(paymentMethodId) {
        if (!confirm('Are you sure you want to remove this payment method?')) {
            return;
        }
        
        try {
            const response = await fetch('/subscriptions/remove-payment-method/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ payment_method_id: paymentMethodId })
            });
            
            if (response.ok) {
                loadPaymentMethodsSettings();
                showMessageSettings('Payment method removed!', 'success');
            } else {
                alert('Error removing payment method');
            }
        } catch (error) {
            console.error('Error removing payment method:', error);
            alert('Error removing payment method');
        }
    }
    
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    function showMessageSettings(message, type = 'info') {
        // Create a temporary notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : '#ef4444'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 3000);
    }
</script>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}
