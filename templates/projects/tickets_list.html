<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if current_project %}{{ current_project.name }} - Tickets{% else %}Tickets{% endif %} - LFG ðŸš€</title>
    <!-- Theme Variables (must load first) -->
    <link rel="stylesheet" href="/static/css/theme-variables.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/tickets.css?v=5">
    <!-- Light Mode Overrides -->
    <link rel="stylesheet" href="/static/css/light/light-mode.css?v=5">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <meta name="color-scheme" content="dark light">
    <!-- Theme Switcher (load early to prevent flash) -->
    <script src="/static/js/theme-switcher.js?v=3"></script>
    <style>
        /* Execution logs styles */
        .execution-summary {
            background: var(--surface-secondary, #1a1a1a);
            border: 1px solid var(--border-color, #333);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .execution-summary h4 {
            margin: 0 0 0.75rem 0;
            color: var(--text-primary, #fff);
            font-size: 0.95rem;
            font-weight: 600;
        }

        .execution-summary h4 i {
            margin-right: 0.5rem;
            color: var(--accent-color, #4A90E2);
        }

        .execution-logs-container h4 {
            color: var(--text-primary, #fff);
            font-size: 0.95rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
        }

        .execution-logs-container h4 i {
            margin-right: 0.5rem;
            color: var(--accent-color, #4A90E2);
        }

        .execution-log-entry {
            /* padding: 0.15rem 0; */
            /* border-bottom: 1px solid rgba(255, 255, 255, 0.05); */
        }

        .execution-log-entry:last-child {
            border-bottom: none;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            margin: -0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .log-header:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .log-command-num {
            font-weight: 300;
            color: var(--text-primary, #fff);
            font-size: 0.875rem;
        }

        .log-timestamp {
            font-size: 0.75rem;
            color: var(--text-secondary, #888);
        }

        .log-explanation {
            color: var(--text-secondary, #aaa);
            font-size: 0.875rem;
            font-weight: 400;
        }

        .log-explanation-detail {
            background: rgba(74, 144, 226, 0.08);
            padding: 0.625rem 0.875rem;
            border-left: 3px solid var(--accent-color, #4A90E2);
            color: var(--text-secondary, #ccc);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            font-style: italic;
            border-radius: 4px;
        }

        .log-command {
            background: rgba(255, 255, 255, 0.02);
            padding: 0.5rem 0.75rem;
            border-left: 2px solid var(--accent-color, #4A90E2);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.8125rem;
            color: #4EC9B0;
            margin-bottom: 0.5rem;
            overflow-x: auto;
            white-space: pre;
        }

        .log-output {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 0.75rem;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.8125rem;
            color: var(--text-secondary, #ccc);
            margin: 0;
            overflow-x: auto;
            white-space: pre;
        }

        .log-details {
            max-width: 100%;
            overflow-x: auto;
        }

        .log-notes {
            background: var(--surface-primary, #0d0d0d);
            padding: 0.75rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary, #ccc);
            margin: 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Logs tab layout - flex container for logs + chat */
        .logs-tab-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            position: relative;
        }

        .logs-tab-content .execution-logs-container {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 100px; /* Space for fixed chat input */
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .logs-tab-content .execution-logs-container::-webkit-scrollbar {
            width: 10px;
        }

        .logs-tab-content .execution-logs-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .logs-tab-content .execution-logs-container::-webkit-scrollbar-thumb {
            background-color: transparent;
            border-radius: 999px;
        }

        .logs-tab-content .execution-logs-container:hover::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.08);
        }

        /* Chat input container - fixed at bottom */
        .logs-chat-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid var(--border-color, #333);
            padding: 1rem;
            background: var(--surface-primary, #1e1e1e);
        }

        /* AI typing indicator */
        .ai-typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            /* padding: 0.75rem 0; */
            margin: 0.25rem 0 0.5rem;
            border-left: none;
            background: transparent;
            border-radius: 0;
            color: var(--text-secondary, #bdbdbd);
            font-size: 0.9rem;
        }

        .ai-typing-indicator .typing-dots {
            display: flex;
            gap: 4px;
        }

        .ai-typing-indicator .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--purple-accent, #8B5CF6);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .ai-typing-indicator .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .ai-typing-indicator .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-indicator .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
            40% { transform: translateY(-4px); opacity: 1; }
        }

        /* Stop execution button */
        .stop-execution-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: radial-gradient(circle at 30% 30%, #f87171, #dc2626);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 0.6rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .stop-execution-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(248, 113, 113, 0.25);
        }

        .stop-execution-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .logs-chat-actions {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .logs-chat-stop-btn {
            display: none;
        }

        .logs-chat-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .logs-chat-field {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--surface-secondary, #111111);
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 12px;
            padding: 0.2rem 0.45rem 0.2rem 0.3rem;
        }

        .logs-chat-field:focus-within {
            border-color: rgba(139, 92, 246, 0.8);
            box-shadow: 0 0 0 1px rgba(139, 92, 246, 0.6);
        }

        .logs-chat-attach-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-secondary, #a3a3a3);
            padding: 0.35rem;
            cursor: pointer;
            transition: color 0.2s, background 0.2s;
            border-radius: 50%;
        }

        .logs-chat-attach-btn:hover {
            color: var(--text-primary, #fff);
            background: rgba(255, 255, 255, 0.05);
        }

        .logs-chat-attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .logs-chat-attachment {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            background: var(--surface-secondary, #1a1a1a);
            border: 1px solid var(--border-color, #333);
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary, #888);
        }

        .logs-chat-attachment .remove-attachment {
            cursor: pointer;
            color: var(--text-secondary, #888);
            padding: 0.125rem;
        }

        .logs-chat-attachment .remove-attachment:hover {
            color: var(--error-color, #ef4444);
        }

        .logs-chat-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 0.45rem 0.3rem 0.45rem 0.1rem;
            color: var(--text-primary, #fff);
            font-size: 0.9rem;
            resize: none;
            font-family: inherit;
            line-height: 1.4;
            min-height: 38px;
            max-height: 120px;
        }

        .logs-chat-input:focus {
            outline: none;
        }

        .logs-chat-input::placeholder {
            color: var(--text-secondary, #888);
        }

        .logs-chat-send-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: radial-gradient(circle at 30% 30%, #c084fc, #7c3aed);
            color: #fff;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .logs-chat-send-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(124, 58, 237, 0.35);
        }

        .logs-chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .logs-chat-send-btn i {
            font-size: 0.675rem;
        }


        /* User message in logs - purple theme */
        .execution-log-entry.user-message {
            border-left: 3px solid var(--purple-accent, #8B5CF6);
            margin: 1rem 0;
            padding: 0.75rem 1rem;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 0 8px 8px 0;
        }

        .execution-log-entry.user-message .log-header {
            cursor: default;
            padding: 0;
        }

        .execution-log-entry.user-message .log-explanation {
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-primary, #fff);
        }

        .user-message-icon {
            color: var(--purple-accent, #8B5CF6);
            flex-shrink: 0;
        }

        /* AI response in logs - slightly different shade */
        .execution-log-entry.ai-response {
            border-left: 3px solid #34d399;
            margin: 1rem 0;
            padding: 0.75rem 1rem;
            background: rgba(167, 139, 250, 0.05);
            border-radius: 0 8px 8px 0;
        }

        .execution-log-entry.ai-response .log-header {
            cursor: default;
            padding: 0;
        }

        .ai-response-icon {
            color: #a78bfa;
            flex-shrink: 0;
        }

        .ai-response-content {
            margin-top: 0.75rem;
            color: var(--text-primary, #e6e6e6);
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.65;
        }

        .ai-response-content p {
            margin: 0 0 0.75rem;
        }

        .ai-response-content ul,
        .ai-response-content ol {
            margin: 0.5rem 0 0.75rem 1.25rem;
            padding-left: 1.25rem;
        }

        .ai-response-content li {
            margin-bottom: 0.35rem;
        }

        .ai-response-content pre {
            background: #111826;
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.8rem;
            color: #e5e7eb;
            margin-bottom: 1rem;
        }

        .ai-response-content code {
            background: rgba(148, 163, 184, 0.15);
            padding: 0.2rem 0.35rem;
            border-radius: 4px;
            font-size: 0.82rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
        }

        .ai-response-content blockquote {
            border-left: 4px solid rgba(167, 139, 250, 0.4);
            padding-left: 0.75rem;
            margin: 0.5rem 0 1rem;
            color: var(--text-secondary, #b4b4b4);
            font-style: italic;
        }

        /* Command entries - more spacing */
        .execution-log-entry:not(.user-message):not(.ai-response) {
            margin: 0.75rem 0;
        }

        /* Tasks styling */
        .tasks-list {
            padding: 0;
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            padding: 0.625rem 0.5rem;
            gap: 0.75rem;
            border: none;
            background: transparent;
        }

        .task-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            margin-top: 0.125rem;
            background-color: transparent;
            transition: all 0.2s;
        }

        .task-checkbox:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }

        .task-checkbox:checked {
            background-color: transparent;
            border-color: #22c55e;
        }

        .task-checkbox:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #22c55e;
            font-size: 10px;
        }

        .task-item.pending .task-checkbox {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .task-item.success .task-checkbox,
        .task-item.completed .task-checkbox {
            background-color: transparent;
            border-color: #22c55e;
        }

        .task-item.success .task-checkbox::after,
        .task-item.completed .task-checkbox::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #22c55e;
            font-size: 10px;
        }

        .task-item.in_progress .task-checkbox {
            border-color: #f59e0b;
            background-color: transparent;
        }

        .task-item.in_progress .task-checkbox::after {
            content: '\f110';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f59e0b;
            font-size: 10px;
        }

        .task-item.fail .task-checkbox,
        .task-item.failed .task-checkbox {
            border-color: #ef4444;
            background-color: transparent;
        }

        .task-item.fail .task-checkbox::after,
        .task-item.failed .task-checkbox::after {
            content: '\f00d';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ef4444;
            font-size: 10px;
        }

        .task-label {
            flex: 1;
            cursor: pointer;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--text-primary, #fff);
        }

        .task-item.success .task-label,
        .task-item.completed .task-label {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .task-description {
            display: block;
            color: var(--text-secondary, #aaa);
            font-size: 0.8125rem;
            margin-top: 0.25rem;
        }

        /* Markdown content styling */
        .markdown-content {
            line-height: 1.6;
            color: var(--text-primary, #fff);
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary, #fff);
        }

        .markdown-content h1 { font-size: 1.75rem; }
        .markdown-content h2 { font-size: 1.5rem; }
        .markdown-content h3 { font-size: 1.25rem; }
        .markdown-content h4 { font-size: 1.1rem; }
        .markdown-content h5 { font-size: 1rem; }
        .markdown-content h6 { font-size: 0.95rem; }

        .markdown-content p {
            margin-bottom: 1rem;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .markdown-content li {
            margin-bottom: 0.5rem;
        }

        /* Task list items (checkboxes) - no bullets */
        .markdown-content li:has(input[type="checkbox"]) {
            list-style: none;
            margin-left: -1.25rem;
        }

        .markdown-content input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: var(--primary-color);
        }

        .markdown-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.875rem;
            color: #4EC9B0;
        }

        .markdown-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
            color: var(--text-secondary, #ccc);
        }

        .markdown-content blockquote {
            border-left: 3px solid var(--accent-color, #4A90E2);
            padding-left: 1rem;
            margin-left: 0;
            color: var(--text-secondary, #aaa);
            font-style: italic;
        }

        .markdown-content table {
            border-collapse: collapse;
            margin: 1rem 0;
            width: 100%;
            overflow-x: auto;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        .markdown-content table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }

        .markdown-content a {
            color: var(--accent-color, #4A90E2);
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin: 1.5rem 0;
        }

        .markdown-content strong {
            font-weight: 600;
        }

        .markdown-content em {
            font-style: italic;
        }

        /* Animation for status indicator */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tickets-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
        }

        .tickets-filters .filter-left {
            flex: 1;
            min-width: 240px;
        }

        .tickets-filters .filter-right {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .new-ticket-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.55rem 1rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .new-ticket-btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-dialog {
            background: #0f1419;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .modal-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
        }

        .modal-body {
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.875rem;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }

        .modal-body label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .modal-body input,
        .modal-body select,
        .modal-body textarea {
            width: 100%;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.03);
            color: #fff;
            padding: 0.625rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.15s ease;
        }

        .modal-body input:focus,
        .modal-body select:focus,
        .modal-body textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.05);
        }

        .modal-body input::placeholder,
        .modal-body textarea::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .modal-body textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .modal-body select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='rgba(255,255,255,0.5)' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2rem;
        }

        .modal-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(0, 0, 0, 0.2);
        }

        .modal-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
            border-radius: 8px;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .modal-close-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8125rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .modal-checkbox input {
            width: auto;
        }

        .modal-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.8125rem;
            display: none;
        }

        .attachment-preview-list {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .attachment-chip {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.3);
            font-size: 0.85rem;
            gap: 0.75rem;
        }

        .attachment-chip .meta {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .attachment-chip button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            padding: 0.15rem;
        }

        .attachment-chip button:hover {
            color: #fff;
        }

        .file-upload-field input[type="file"] {
            font-size: 0.8rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px dashed rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            cursor: pointer;
        }

        .file-upload-field input[type="file"]::file-selector-button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 0.75rem;
        }

        .file-upload-field input[type="file"]::file-selector-button:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .file-upload-hint {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 0.25rem;
        }

        .attachment-preview-empty {
            color: rgba(255, 255, 255, 0.35);
            font-size: 0.75rem;
            font-style: italic;
        }

        .ticket-attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .ticket-attachment-card {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(15, 23, 42, 0.6);
            text-decoration: none;
            color: inherit;
            transition: border-color 0.2s ease, transform 0.2s ease;
        }

        .ticket-attachment-card:hover {
            border-color: rgba(167, 139, 250, 0.6);
            transform: translateY(-1px);
        }

        .ticket-attachment-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(167, 139, 250, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #c4b5fd;
            font-size: 1rem;
        }

        .ticket-attachment-info .name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .ticket-attachment-info .meta {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.15rem;
        }

        .modal-context {
            padding: 0.625rem 0.75rem;
            border-radius: 6px;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .modal-context-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(139, 92, 246, 0.8);
            margin-bottom: 0.2rem;
        }

        .modal-context-value {
            font-weight: 600;
            font-size: 0.875rem;
            color: #fff;
        }

        .modal-context-hint {
            margin-top: 0.25rem;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body data-theme="dark"
      data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}"
      data-model-key="{{ current_model_key|default:'gpt-5-mini' }}"
      data-sidebar-minimized="{% if sidebar_minimized %}true{% else %}false{% endif %}">
    <div class="app-container{% if sidebar_minimized %} sidebar-minimized{% endif %}">
        {% include 'includes/sidebar.html' with show_conversations=False %}

        <div class="main-content tickets-page">

            <div class="tickets-body">
                <!-- Filters Section -->
                <div class="tickets-filters">
                    <div class="filter-left">
                        <input type="text" class="filter-search" id="ticketSearch" placeholder="Search tickets..." onkeyup="filterTickets()">
                    </div>
                    <div class="filter-right">
                        {% if not current_project %}
                        <select class="filter-select" id="projectFilter" onchange="filterTickets()">
                            <option value="">All Projects</option>
                            {% for project in projects %}
                                <option value="{{ project.project_id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <input type="hidden" id="projectFilter" value="{{ current_project.project_id }}">
                        {% endif %}
                        <select class="filter-select" id="statusFilter" onchange="filterTickets()">
                            <option value="">All Statuses</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="review">Review</option>
                            <option value="done">Done</option>
                            <option value="blocked">Blocked</option>
                            <option value="failed">Failed</option>
                        </select>
                        <select class="filter-select" id="priorityFilter" onchange="filterTickets()">
                            <option value="">All Priorities</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                        {% if current_project and project_files %}
                        <select class="filter-select" id="fileFilter" onchange="filterTickets()">
                            <option value="">All Files</option>
                            {% for file in project_files %}
                                <option value="{{ file.id }}">{{ file.name }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}

                        <!-- Execution Mode Toggle -->
                        <div class="execution-mode-toggle" id="executionModeToggle">
                            <button type="button"
                                    class="mode-btn {% if not claude_code_enabled %}active{% endif %}"
                                    data-mode="api"
                                    onclick="setExecutionMode('api')"
                                    title="Use API for ticket execution">
                                <i class="fas fa-cloud"></i>
                                <span>API</span>
                            </button>
                            <button type="button"
                                    class="mode-btn {% if claude_code_enabled %}active{% endif %}"
                                    data-mode="cli"
                                    onclick="setExecutionMode('cli')"
                                    {% if not claude_code_authenticated %}disabled title="Connect Claude Code in settings first"{% else %}title="Use Claude Code CLI for ticket execution"{% endif %}>
                                <i class="fas fa-terminal"></i>
                                <span>CLI</span>
                            </button>
                        </div>

                        <!-- Model Dropdown - Only visible in API mode -->
                        <select class="filter-select model-select" id="model-dropdown" {% if claude_code_enabled %}style="display: none;"{% endif %}>
                            {% if llm_model_config.providers %}
                                {% for provider_key, provider in llm_model_config.providers.items %}
                                    <optgroup label="{{ provider.label }}">
                                        {% for model in provider.models %}
                                            <option value="{{ model.key }}"
                                                {% if current_model_key == model.key %}
                                                    selected
                                                {% elif not current_model_key and forloop.parentloop.first and forloop.first %}
                                                    selected
                                                {% endif %}>
                                                {{ model.label }}
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            {% else %}

                            {% endif %}
                        </select>

                        <button type="button"
                                class="btn btn-primary new-ticket-btn"
                                id="newTicketBtn"
                                {% if not projects and not current_project %}
                                    disabled
                                    title="Create a project first"
                                {% endif %}>
                            <i class="fas fa-plus"></i>
                            New Ticket
                        </button>
                        {% if current_project %}
                        <div class="view-toggle-group">
                            <button type="button" class="view-toggle-btn active" id="listViewBtn" onclick="setView('list')" title="List view">
                                <i class="fas fa-list"></i>
                            </button>
                            <button type="button" class="view-toggle-btn" id="boardViewBtn" onclick="setView('board')" title="Board view">
                                <i class="fas fa-columns"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Kanban Board View -->
                <div class="kanban-board" id="kanbanBoard" style="display: none;">
                    <div class="kanban-column" data-status="open">
                        <div class="kanban-column-header" style="border-top-color: #6366f1;">
                            <div class="kanban-column-title">
                                <span class="stage-color-dot" style="background: #6366f1;"></span>
                                <span class="stage-name">Open</span>
                                <span class="ticket-count" id="statusCountOpen">0</span>
                            </div>
                        </div>
                        <div class="kanban-column-body" id="statusColumnOpen" data-status="open"></div>
                    </div>
                    <div class="kanban-column" data-status="in_progress">
                        <div class="kanban-column-header" style="border-top-color: #f59e0b;">
                            <div class="kanban-column-title">
                                <span class="stage-color-dot" style="background: #f59e0b;"></span>
                                <span class="stage-name">In Progress</span>
                                <span class="ticket-count" id="statusCountInProgress">0</span>
                            </div>
                        </div>
                        <div class="kanban-column-body" id="statusColumnInProgress" data-status="in_progress"></div>
                    </div>
                    <div class="kanban-column" data-status="review">
                        <div class="kanban-column-header" style="border-top-color: #8b5cf6;">
                            <div class="kanban-column-title">
                                <span class="stage-color-dot" style="background: #8b5cf6;"></span>
                                <span class="stage-name">Review</span>
                                <span class="ticket-count" id="statusCountReview">0</span>
                            </div>
                        </div>
                        <div class="kanban-column-body" id="statusColumnReview" data-status="review"></div>
                    </div>
                    <div class="kanban-column" data-status="done">
                        <div class="kanban-column-header" style="border-top-color: #22c55e;">
                            <div class="kanban-column-title">
                                <span class="stage-color-dot" style="background: #22c55e;"></span>
                                <span class="stage-name">Done</span>
                                <span class="ticket-count" id="statusCountDone">0</span>
                            </div>
                        </div>
                        <div class="kanban-column-body" id="statusColumnDone" data-status="done"></div>
                    </div>
                    <div class="kanban-column" data-status="blocked">
                        <div class="kanban-column-header" style="border-top-color: #ef4444;">
                            <div class="kanban-column-title">
                                <span class="stage-color-dot" style="background: #ef4444;"></span>
                                <span class="stage-name">Blocked</span>
                                <span class="ticket-count" id="statusCountBlocked">0</span>
                            </div>
                        </div>
                        <div class="kanban-column-body" id="statusColumnBlocked" data-status="blocked"></div>
                    </div>
                    <div class="kanban-column" data-status="failed">
                        <div class="kanban-column-header" style="border-top-color: #dc2626;">
                            <div class="kanban-column-title">
                                <span class="stage-color-dot" style="background: #dc2626;"></span>
                                <span class="stage-name">Failed</span>
                                <span class="ticket-count" id="statusCountFailed">0</span>
                            </div>
                        </div>
                        <div class="kanban-column-body" id="statusColumnFailed" data-status="failed"></div>
                    </div>
                </div>

                <!-- Tickets Table -->
                <div class="tickets-table-wrapper">
                    <table class="tickets-table" id="ticketsTable" {% if not tickets %}style="display: none;"{% endif %}>
                        <thead>
                            <tr>
                                <th>Ticket</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Queue</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="ticketsTableBody">
                            {% if tickets %}
                                {% for ticket in tickets %}
                                    <tr class="ticket-row"
                                        data-ticket-id="{{ ticket.id }}"
                                        data-project-id="{{ ticket.project.project_id }}"
                                        data-status="{{ ticket.status }}"
                                        data-priority="{{ ticket.priority }}"
                                        data-name="{{ ticket.name|lower }}"
                                        data-description="{{ ticket.description|lower }}"
                                        data-source-document="{{ ticket.source_document.id|default:'' }}">
                                        <td onclick="viewTicketDetails({{ ticket.id }}, '{{ ticket.project.project_id }}')" style="cursor: pointer;">
                                            <div class="ticket-info">
                                                <div class="ticket-name">{{ ticket.name }}</div>
                                            </div>
                                        </td>
                                        <td>
                                            <select class="table-select status-select"
                                                    data-ticket-id="{{ ticket.id }}"
                                                    data-project-id="{{ ticket.project.project_id }}"
                                                    data-status="{{ ticket.status }}"
                                                    onchange="updateTicketFromTable(this, 'status')">
                                                <option value="open" {% if ticket.status == 'open' %}selected{% endif %}>Open</option>
                                                <option value="in_progress" {% if ticket.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                                <option value="review" {% if ticket.status == 'review' %}selected{% endif %}>Review</option>
                                                <option value="done" {% if ticket.status == 'done' %}selected{% endif %}>Done</option>
                                                <option value="blocked" {% if ticket.status == 'blocked' %}selected{% endif %}>Blocked</option>
                                                <option value="failed" {% if ticket.status == 'failed' %}selected{% endif %}>Failed</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="table-select priority-select"
                                                    data-ticket-id="{{ ticket.id }}"
                                                    data-project-id="{{ ticket.project.project_id }}"
                                                    data-priority="{{ ticket.priority }}"
                                                    onchange="updateTicketFromTable(this, 'priority')">
                                                <option value="Low" {% if ticket.priority == 'Low' %}selected{% endif %}>Low</option>
                                                <option value="Medium" {% if ticket.priority == 'Medium' %}selected{% endif %}>Medium</option>
                                                <option value="High" {% if ticket.priority == 'High' %}selected{% endif %}>High</option>
                                            </select>
                                        </td>
                                        <td>
                                            <div class="queue-status-cell"
                                                 data-ticket-id="{{ ticket.id }}"
                                                 data-project-id="{{ ticket.project.project_id }}"
                                                 data-queue-status="{{ ticket.queue_status }}">
                                                {% if ticket.queue_status == 'queued' %}
                                                    <span class="queue-badge queued">
                                                        <i class="fas fa-clock"></i> Queued
                                                    </span>
                                                    <button class="queue-cancel-btn" onclick="cancelFromQueue({{ ticket.id }}, '{{ ticket.project.project_id }}')" title="Remove from queue">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <button class="queue-restart-btn" onclick="restartFromQueue({{ ticket.id }}, '{{ ticket.project.project_id }}')" title="Restart ticket">
                                                        <i class="fas fa-redo"></i>
                                                    </button>
                                                {% elif ticket.queue_status == 'executing' %}
                                                    <span class="queue-badge executing">
                                                        <i class="fas fa-spinner fa-spin"></i> Executing
                                                    </span>
                                                    <button class="queue-force-stop-btn" onclick="forceStopFromQueue({{ ticket.id }}, '{{ ticket.project.project_id }}')" title="Force stop (use if stuck)">
                                                        <i class="fas fa-stop"></i>
                                                    </button>
                                                    <button class="queue-restart-btn" onclick="restartFromQueue({{ ticket.id }}, '{{ ticket.project.project_id }}')" title="Force restart">
                                                        <i class="fas fa-redo"></i>
                                                    </button>
                                                {% else %}
                                                    <span class="queue-badge none">-</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <button class="action-btn edit-ticket-btn"
                                                    onclick="openEditFromList({{ ticket.id }}, '{{ ticket.project.project_id }}')"
                                                    title="Edit ticket">
                                                <i class="fas fa-pen"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                    <div class="empty-state" id="ticketsEmptyState" {% if tickets %}style="display: none;"{% endif %}>
                        <div class="empty-state-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <h3 class="empty-state-title">No tickets yet</h3>
                        <div class="empty-state-text">
                            {% if current_project %}
                            Create tickets for {{ current_project.name }} to track work items.
                            {% else %}
                            Create tickets in your projects to track work items.
                            {% endif %}
                        </div>
                        {% if not current_project %}
                        <a href="{% url 'projects:project_list' %}" class="btn btn-primary">
                            <i class="fas fa-folder"></i> Go to Projects
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket Details Drawer -->
    <div id="ticketDrawerOverlay" class="drawer-overlay" onclick="handleOverlayClick()"></div>
    <div id="ticketDrawer" class="drawer">
        <div class="drawer-resize-handle" id="drawerResizeHandle"></div>
        <div class="drawer-header">
            <div class="drawer-header-left">
                <h3 class="drawer-title" id="drawerTicketTitle"></h3>
            </div>
            <div class="drawer-header-right">
                <div class="drawer-actions">
                    <button type="button" class="drawer-server-btn" id="restartServerBtn" onclick="restartDevServer()">
                        Restart Server
                    </button>
                    <button class="drawer-open-url-btn" onclick="openPreviewInNewTab()" id="openPreviewBtn" title="Preview not available yet" disabled>
                        <i class="fas fa-arrow-up-right-from-square"></i>
                    </button>
                    <button class="drawer-execute-btn" onclick="handleExecuteButtonClick()" id="executeTicketBtn">
                        <i class="fas fa-hammer"></i> Build Ticket
                    </button>
                </div>
                <button class="drawer-close" onclick="closeTicketDrawer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="drawer-tabs">
            <button class="drawer-tab active" data-tab="details" onclick="switchDrawerTab('details')">
                <i class="fas fa-info-circle"></i> Details
            </button>
            <button class="drawer-tab" data-tab="logs" onclick="switchDrawerTab('logs')">
                <i class="fas fa-terminal"></i> Actions
            </button>
            <button class="drawer-tab" data-tab="tasks" onclick="switchDrawerTab('tasks')">
                <i class="fas fa-list-check"></i> Tasks
            </button>
            <button class="drawer-tab" data-tab="preview" onclick="switchDrawerTab('preview')">
                <i class="fas fa-desktop"></i> Preview
            </button>
            <button class="drawer-tab" data-tab="git" onclick="switchDrawerTab('git')">
                <i class="fab fa-github"></i> Git
            </button>
            <button class="drawer-tab" data-tab="server-logs" onclick="switchDrawerTab('server-logs')">
                <i class="fas fa-file-alt"></i> Server Logs
            </button>
        </div>
        <div class="drawer-body" id="drawerTicketBody">
            <!-- Ticket details will be loaded here -->
        </div>
    </div>

    <!-- New Ticket Modal -->
    <div class="modal-overlay" id="newTicketModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 style="margin: 0; font-size: 1.1rem;">Create Ticket</h3>
                <button type="button" class="modal-close-btn" id="closeNewTicketBtn" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            {% if projects %}
                <form id="newTicketForm">
                    <div class="modal-body">
                        <input type="hidden" id="newTicketProject">
                        <div class="modal-context" id="newTicketProjectDisplay">
                            <div class="modal-context-label">Project</div>
                            <div class="modal-context-value" id="newTicketProjectLabel">{% if current_project %}{{ current_project.name }}{% else %}---{% endif %}</div>
                            {% if not current_project %}
                            <div class="modal-context-hint">
                                Uses the project from the filters above. Switch the filter to create a ticket in another project.
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <label for="newTicketName">Ticket name</label>
                            <input type="text" id="newTicketName" maxlength="255" required placeholder="Add an informative title">
                        </div>
                        <div>
                            <label for="newTicketDescription">Description</label>
                            <textarea id="newTicketDescription" placeholder="What needs to be built?" required></textarea>
                        </div>
                        <div class="file-upload-field">
                            <label for="newTicketFiles">Attachments (optional)</label>
                            <input type="file"
                                   id="newTicketFiles"
                                   multiple
                                   accept="image/*,.pdf,.csv,.txt,.md,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.json,.zip,.rar,.7z,.mp4,.mov,.mp3">
                            <div class="file-upload-hint">
                                Attach screenshots, specs, or reference files. You can add more later from the ticket drawer.
                            </div>
                            <div id="newTicketFileList" class="attachment-preview-list">
                                <p class="attachment-preview-empty">No files selected.</p>
                            </div>
                        </div>
                        <div class="modal-form-row">
                            <div>
                                <label for="newTicketStatus">Status</label>
                                <select id="newTicketStatus">
                                    <option value="open" selected>Open</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="review">Review</option>
                                    <option value="done">Done</option>
                                    <option value="blocked">Blocked</option>
                                </select>
                            </div>
                            <div>
                                <label for="newTicketPriority">Priority</label>
                                <select id="newTicketPriority">
                                    <option value="High">High</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-form-row">
                            <div>
                                <label for="newTicketRole">Role</label>
                                <select id="newTicketRole">
                                    <option value="user" selected>User</option>
                                    <option value="agent">Agent</option>
                                </select>
                            </div>
                            <div>
                                <label for="newTicketComplexity">Complexity</label>
                                <select id="newTicketComplexity">
                                    <option value="simple">Simple</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="complex">Complex</option>
                                </select>
                            </div>
                        </div>
                        <label class="modal-checkbox" for="newTicketRequiresWorktree">
                            <input type="checkbox" id="newTicketRequiresWorktree" checked>
                            Requires worktree
                        </label>
                        <div class="modal-error" id="newTicketError"></div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="cancelNewTicketBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="createTicketSubmit">
                            <i class="fas fa-plus" style="margin-right: 0.375rem;"></i>
                            Create Ticket
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="modal-body">
                    <p style="margin: 0;">You need a project before you can add tickets. Create a project and try again.</p>
                </div>
                <div class="modal-actions">
                    <a href="{% url 'projects:create_project' %}" class="btn btn-primary">Create Project</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Edit Ticket Modal -->
    <div class="modal-overlay" id="editTicketModal" aria-hidden="true">
        <div class="modal-dialog edit-ticket-dialog">
            <div class="modal-header">
                <h3 style="margin: 0; font-size: 1.1rem;">Edit Ticket</h3>
                <button type="button" class="modal-close-btn" onclick="closeEditTicketModal()" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTicketId">
                <input type="hidden" id="editTicketProjectId">
                <div>
                    <label for="editTicketName">Ticket name</label>
                    <input type="text" id="editTicketName" maxlength="255" required placeholder="Add an informative title">
                </div>
                <div>
                    <label for="editTicketDescription">Description</label>
                    <textarea id="editTicketDescription" placeholder="What needs to be built?" required rows="6"></textarea>
                </div>
                <div class="edit-ticket-row">
                    <div>
                        <label for="editTicketStatus">Status</label>
                        <select id="editTicketStatus">
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="review">Review</option>
                            <option value="done">Done</option>
                            <option value="blocked">Blocked</option>
                        </select>
                    </div>
                    <div>
                        <label for="editTicketPriority">Priority</label>
                        <select id="editTicketPriority">
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="edit-ticket-row">
                    <div>
                        <label for="editTicketRole">Role</label>
                        <select id="editTicketRole">
                            <option value="user">User</option>
                            <option value="agent">Agent</option>
                        </select>
                    </div>
                    <div>
                        <label for="editTicketComplexity">Complexity</label>
                        <select id="editTicketComplexity">
                            <option value="simple">Simple</option>
                            <option value="medium">Medium</option>
                            <option value="complex">Complex</option>
                        </select>
                    </div>
                </div>
                <label class="modal-checkbox" for="editTicketRequiresWorktree">
                    <input type="checkbox" id="editTicketRequiresWorktree" checked>
                    Requires worktree
                </label>
                <div class="modal-error" id="editTicketError"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-danger" id="deleteTicketBtn" onclick="deleteCurrentTicket()">
                    <i class="fas fa-trash" style="margin-right: 0.375rem;"></i> Delete
                </button>
                <div style="flex: 1;"></div>
                <button type="button" class="btn btn-secondary" onclick="closeEditTicketModal()">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTicketBtn" onclick="saveTicketChanges()">
                    <i class="fas fa-save" style="margin-right: 0.375rem;"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <script src="/static/js/sidebar.js"></script>
    <script src="/static/js/marked.min.js"></script>
    <script src="/static/js/model-handler.js"></script>
    <script>
        // Verify marked.js loaded
        if (typeof marked === 'undefined') {
            console.error('marked.js failed to load!');
        } else {
            console.log('marked.js loaded successfully!');
            // Configure marked for GitHub Flavored Markdown
            marked.setOptions({
                gfm: true,
                breaks: true,
                headerIds: true,
                mangle: false
            });
        }
    </script>
    <script>
        // Current project context (set by server when viewing project-scoped tickets)
        const currentProject = {% if current_project %}{ id: '{{ current_project.project_id }}', name: '{{ current_project.name|escapejs }}' }{% else %}null{% endif %};

        // Stages data from server
        const projectStages = [
            {% for stage in stages %}
            { id: {{ stage.id }}, name: '{{ stage.name|escapejs }}', color: '{{ stage.color }}', order: {{ stage.order }}, is_default: {{ stage.is_default|yesno:"true,false" }}, is_completed: {{ stage.is_completed|yesno:"true,false" }} },
            {% endfor %}
        ];

        // Current view mode (list or board)
        let currentViewMode = localStorage.getItem('ticketViewMode') || 'list';

        // View toggle functionality
        function setView(view) {
            currentViewMode = view;
            localStorage.setItem('ticketViewMode', view);

            const listViewBtn = document.getElementById('listViewBtn');
            const boardViewBtn = document.getElementById('boardViewBtn');
            const ticketsTable = document.querySelector('.tickets-table-wrapper');
            const kanbanBoard = document.getElementById('kanbanBoard');
            const emptyState = document.getElementById('ticketsEmptyState');

            if (view === 'list') {
                listViewBtn?.classList.add('active');
                boardViewBtn?.classList.remove('active');
                if (ticketsTable) ticketsTable.style.display = '';
                if (kanbanBoard) kanbanBoard.style.display = 'none';
                // Re-apply filters for list view
                filterTickets();
            } else {
                listViewBtn?.classList.remove('active');
                boardViewBtn?.classList.add('active');
                if (ticketsTable) ticketsTable.style.display = 'none';
                if (kanbanBoard) kanbanBoard.style.display = 'flex';
                if (emptyState) emptyState.style.display = 'none';
                // Populate kanban board
                populateKanbanBoard();
            }
        }

        // Current execution mode (api or cli)
        let currentExecutionMode = '{{ claude_code_enabled|yesno:"cli,api" }}';

        // Execution mode toggle functionality
        async function setExecutionMode(mode) {
            // If already in this mode, do nothing
            if (currentExecutionMode === mode) return;

            // If trying to enable CLI mode but not authenticated, show message
            const cliBtn = document.querySelector('.mode-btn[data-mode="cli"]');
            if (mode === 'cli' && cliBtn && cliBtn.disabled) {
                alert('Please connect Claude Code in Settings first to use CLI mode.');
                return;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch('/accounts/claude-code/toggle/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        enabled: mode === 'cli'
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    currentExecutionMode = mode;

                    // Update button states
                    document.querySelectorAll('.execution-mode-toggle .mode-btn').forEach(btn => {
                        if (btn.dataset.mode === mode) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });

                    // Show/hide model dropdown based on mode
                    const modelDropdown = document.getElementById('model-dropdown');
                    if (modelDropdown) {
                        if (mode === 'cli') {
                            modelDropdown.style.display = 'none';
                        } else {
                            modelDropdown.style.display = '';
                        }
                    }
                } else {
                    alert(data.error || 'Failed to switch execution mode');
                }
            } catch (error) {
                console.error('Error switching execution mode:', error);
                alert('Error switching execution mode');
            }
        }

        // Populate kanban board with tickets grouped by status
        async function populateKanbanBoard() {
            if (!currentProject) return;

            try {
                const response = await fetch(`/projects/${currentProject.id}/api/checklist/`);
                const data = await response.json();
                const tickets = data.tickets || [];

                // Clear all columns
                document.querySelectorAll('.kanban-column-body').forEach(col => {
                    col.innerHTML = '';
                });

                // Group by status
                const statusMap = {
                    'open': 'Open',
                    'in_progress': 'InProgress',
                    'review': 'Review',
                    'done': 'Done',
                    'blocked': 'Blocked',
                    'failed': 'Failed'
                };

                Object.keys(statusMap).forEach(status => {
                    const column = document.getElementById(`statusColumn${statusMap[status]}`);
                    const countEl = document.getElementById(`statusCount${statusMap[status]}`);
                    const statusTickets = tickets.filter(t => t.status === status);

                    if (countEl) countEl.textContent = statusTickets.length;

                    statusTickets.forEach(ticket => {
                        if (column) {
                            column.appendChild(createKanbanCard(ticket));
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading kanban board:', error);
            }
        }

        // Create a kanban card for a ticket
        function createKanbanCard(ticket) {
            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.dataset.ticketId = ticket.id;
            card.dataset.projectId = ticket.project_id;
            card.draggable = true;

            const priorityColors = {
                'High': '#ef4444',
                'Medium': '#f59e0b',
                'Low': '#6b7280'
            };

            // Build queue status HTML
            let queueStatusHtml = '';
            if (ticket.queue_status === 'queued') {
                queueStatusHtml = `
                    <div class="kanban-card-queue" onclick="event.stopPropagation();">
                        <span class="queue-badge queued">
                            <i class="fas fa-clock"></i> Queued
                        </span>
                        <button class="queue-cancel-btn" onclick="event.stopPropagation(); cancelFromQueue(${ticket.id}, '${ticket.project_id}')" title="Remove from queue">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="queue-restart-btn" onclick="event.stopPropagation(); restartFromQueue(${ticket.id}, '${ticket.project_id}')" title="Restart ticket">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                `;
            } else if (ticket.queue_status === 'executing') {
                queueStatusHtml = `
                    <div class="kanban-card-queue" onclick="event.stopPropagation();">
                        <span class="queue-badge executing">
                            <i class="fas fa-spinner fa-spin"></i> Executing
                        </span>
                        <button class="queue-force-stop-btn" onclick="event.stopPropagation(); forceStopFromQueue(${ticket.id}, '${ticket.project_id}')" title="Force stop (use if stuck)">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button class="queue-restart-btn" onclick="event.stopPropagation(); restartFromQueue(${ticket.id}, '${ticket.project_id}')" title="Force restart">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="kanban-card-header">
                    <div class="kanban-card-title">${escapeHtml(ticket.name)}</div>
                    <button class="kanban-edit-btn" onclick="event.stopPropagation(); openEditTicketModal(${JSON.stringify(ticket).replace(/"/g, '&quot;')})" title="Edit ticket">
                        <i class="fas fa-pen"></i>
                    </button>
                </div>
                <div class="kanban-card-meta">
                    <span class="priority-indicator" style="background: ${priorityColors[ticket.priority] || '#6b7280'};"></span>
                    <span class="priority-label">${ticket.priority || 'Medium'}</span>
                </div>
                ${queueStatusHtml}
            `;

            // Click to open sidebar drawer (like list view)
            card.addEventListener('click', () => {
                viewTicketDetails(ticket.id, ticket.project_id);
            });

            // Drag events
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            return card;
        }

        // Drag and drop handlers
        let draggedCard = null;

        function handleDragStart(e) {
            draggedCard = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.ticketId);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.kanban-column-body').forEach(col => {
                col.classList.remove('drag-over');
            });
            draggedCard = null;
        }

        // Set up drop zones
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize view based on saved preference
            if (currentProject && currentViewMode === 'board') {
                setView('board');
            }

            // Set up drag and drop for kanban columns
            document.querySelectorAll('.kanban-column-body').forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });

                column.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');

                    if (!draggedCard) return;

                    const ticketId = draggedCard.dataset.ticketId;
                    const projectId = draggedCard.dataset.projectId;
                    const newStatus = column.dataset.status;

                    // Move card visually
                    column.appendChild(draggedCard);

                    // Update counts
                    updateKanbanCounts();

                    // Update ticket status via API
                    try {
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                        await fetch(`/projects/${projectId}/api/checklist/update/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({
                                item_id: parseInt(ticketId),
                                status: newStatus
                            })
                        });
                    } catch (error) {
                        console.error('Error updating ticket status:', error);
                    }
                });
            });
        });

        function updateKanbanCounts() {
            document.querySelectorAll('.kanban-column').forEach(column => {
                const body = column.querySelector('.kanban-column-body');
                const countEl = column.querySelector('.ticket-count');
                if (body && countEl) {
                    countEl.textContent = body.children.length;
                }
            });
        }

        // Stages Modal Functions
        function openStagesModal() {
            const modal = document.getElementById('stagesModal');
            if (modal) {
                modal.classList.add('active');
                loadStages();
            }
        }

        function closeStagesModal() {
            const modal = document.getElementById('stagesModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        async function loadStages() {
            if (!currentProject) return;

            const stagesList = document.getElementById('stagesList');
            if (!stagesList) return;

            try {
                const response = await fetch(`/projects/${currentProject.id}/api/stages/`);
                const data = await response.json();

                if (data.success) {
                    renderStagesList(data.stages);
                }
            } catch (error) {
                console.error('Error loading stages:', error);
            }
        }

        function renderStagesList(stages) {
            const stagesList = document.getElementById('stagesList');
            if (!stagesList) return;

            stagesList.innerHTML = stages.map(stage => `
                <div class="stage-item" data-stage-id="${stage.id}" draggable="true">
                    <div class="stage-drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <input type="color" class="stage-color-input" value="${stage.color}"
                           onchange="updateStageColor(${stage.id}, this.value)" title="Stage color">
                    <input type="text" class="stage-name-input" value="${escapeHtml(stage.name)}"
                           onblur="updateStageName(${stage.id}, this.value)" placeholder="Stage name">
                    <div class="stage-badges">
                        ${stage.is_default ? '<span class="stage-badge default">Default</span>' : ''}
                        ${stage.is_completed ? '<span class="stage-badge completed">Done</span>' : ''}
                    </div>
                    <div class="stage-actions">
                        <button class="stage-action-btn" onclick="toggleStageDefault(${stage.id}, ${!stage.is_default})" title="Set as default">
                            <i class="fas fa-star${stage.is_default ? '' : '-o'}"></i>
                        </button>
                        <button class="stage-action-btn" onclick="toggleStageCompleted(${stage.id}, ${!stage.is_completed})" title="Mark as done stage">
                            <i class="fas fa-check${stage.is_completed ? '' : '-circle'}"></i>
                        </button>
                        <button class="stage-action-btn danger" onclick="deleteStage(${stage.id})" title="Delete stage">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Set up drag and drop for reordering
            setupStagesDragDrop();
        }

        function setupStagesDragDrop() {
            const stagesList = document.getElementById('stagesList');
            if (!stagesList) return;

            let draggedStage = null;

            stagesList.querySelectorAll('.stage-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedStage = item;
                    item.classList.add('dragging');
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    draggedStage = null;
                    saveStageOrder();
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedStage && draggedStage !== item) {
                        const rect = item.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            stagesList.insertBefore(draggedStage, item);
                        } else {
                            stagesList.insertBefore(draggedStage, item.nextSibling);
                        }
                    }
                });
            });
        }

        async function saveStageOrder() {
            if (!currentProject) return;

            const stagesList = document.getElementById('stagesList');
            if (!stagesList) return;

            const stageIds = Array.from(stagesList.querySelectorAll('.stage-item')).map(
                item => parseInt(item.dataset.stageId)
            );

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                await fetch(`/projects/${currentProject.id}/api/stages/reorder/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ stage_ids: stageIds })
                });
            } catch (error) {
                console.error('Error saving stage order:', error);
            }
        }

        async function addNewStage() {
            if (!currentProject) return;

            const nameInput = document.getElementById('newStageName');
            const colorInput = document.getElementById('newStageColor');

            const name = nameInput?.value.trim();
            const color = colorInput?.value || '#6366f1';

            if (!name) {
                alert('Please enter a stage name');
                return;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                const response = await fetch(`/projects/${currentProject.id}/api/stages/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ name, color })
                });

                const data = await response.json();
                if (data.success) {
                    nameInput.value = '';
                    loadStages();
                    // Reload the page to update the kanban columns
                    location.reload();
                } else {
                    alert(data.error || 'Failed to create stage');
                }
            } catch (error) {
                console.error('Error creating stage:', error);
                alert('Failed to create stage');
            }
        }

        async function updateStageName(stageId, name) {
            if (!currentProject || !name.trim()) return;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                await fetch(`/projects/${currentProject.id}/api/stages/${stageId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ name: name.trim() })
                });
            } catch (error) {
                console.error('Error updating stage name:', error);
            }
        }

        async function updateStageColor(stageId, color) {
            if (!currentProject) return;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                await fetch(`/projects/${currentProject.id}/api/stages/${stageId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ color })
                });
            } catch (error) {
                console.error('Error updating stage color:', error);
            }
        }

        async function toggleStageDefault(stageId, isDefault) {
            if (!currentProject) return;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                await fetch(`/projects/${currentProject.id}/api/stages/${stageId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ is_default: isDefault })
                });
                loadStages();
            } catch (error) {
                console.error('Error updating stage:', error);
            }
        }

        async function toggleStageCompleted(stageId, isCompleted) {
            if (!currentProject) return;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                await fetch(`/projects/${currentProject.id}/api/stages/${stageId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ is_completed: isCompleted })
                });
                loadStages();
            } catch (error) {
                console.error('Error updating stage:', error);
            }
        }

        async function deleteStage(stageId) {
            if (!currentProject) return;

            if (!confirm('Delete this stage? Tickets in this stage will be moved to the default stage.')) {
                return;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                const response = await fetch(`/projects/${currentProject.id}/api/stages/${stageId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                if (response.ok) {
                    loadStages();
                    // Reload the page to update the kanban columns
                    location.reload();
                }
            } catch (error) {
                console.error('Error deleting stage:', error);
            }
        }

        // Open edit modal from list view
        async function openEditFromList(ticketId, projectId) {
            try {
                const response = await fetch(`/projects/${projectId}/api/checklist/`);
                const data = await response.json();
                const tickets = data.tickets || [];
                const ticket = tickets.find(t => t.id === ticketId);

                if (ticket) {
                    if (!ticket.project_id) {
                        ticket.project_id = projectId;
                    }
                    openEditTicketModal(ticket);
                } else {
                    alert('Ticket not found');
                }
            } catch (error) {
                console.error('Error loading ticket:', error);
                alert('Error loading ticket details');
            }
        }

        // Edit Ticket Modal Functions
        function openEditTicketModal(ticket) {
            const modal = document.getElementById('editTicketModal');
            if (!modal) return;

            document.getElementById('editTicketId').value = ticket.id;
            document.getElementById('editTicketProjectId').value = ticket.project_id;
            document.getElementById('editTicketName').value = ticket.name || '';
            document.getElementById('editTicketDescription').value = ticket.description || '';
            document.getElementById('editTicketStatus').value = ticket.status || 'open';
            document.getElementById('editTicketPriority').value = ticket.priority || 'Medium';
            document.getElementById('editTicketRole').value = ticket.role || 'user';
            document.getElementById('editTicketComplexity').value = ticket.complexity || 'medium';
            document.getElementById('editTicketRequiresWorktree').checked = ticket.requires_worktree !== false;

            document.getElementById('editTicketError').textContent = '';
            modal.classList.add('active');
        }

        function closeEditTicketModal() {
            const modal = document.getElementById('editTicketModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        async function saveTicketChanges() {
            const ticketId = document.getElementById('editTicketId').value;
            const projectId = document.getElementById('editTicketProjectId').value;

            const payload = {
                item_id: parseInt(ticketId),
                name: document.getElementById('editTicketName').value.trim(),
                description: document.getElementById('editTicketDescription').value.trim(),
                status: document.getElementById('editTicketStatus').value,
                priority: document.getElementById('editTicketPriority').value,
                role: document.getElementById('editTicketRole').value,
                complexity: document.getElementById('editTicketComplexity').value,
                requires_worktree: document.getElementById('editTicketRequiresWorktree').checked
            };

            if (!payload.name || !payload.description) {
                document.getElementById('editTicketError').textContent = 'Name and description are required';
                return;
            }

            const saveBtn = document.getElementById('saveTicketBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                const response = await fetch(`/projects/${projectId}/api/checklist/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    closeEditTicketModal();
                    // Refresh the current view
                    if (currentViewMode === 'board') {
                        populateKanbanBoard();
                    } else {
                        location.reload();
                    }
                } else {
                    document.getElementById('editTicketError').textContent = data.error || 'Failed to save changes';
                }
            } catch (error) {
                console.error('Error saving ticket:', error);
                document.getElementById('editTicketError').textContent = 'Network error occurred';
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        async function deleteCurrentTicket() {
            const ticketId = document.getElementById('editTicketId').value;
            const projectId = document.getElementById('editTicketProjectId').value;

            if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
                return;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                const response = await fetch(`/projects/${projectId}/api/checklist/${ticketId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                if (response.ok) {
                    closeEditTicketModal();
                    location.reload();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to delete ticket');
                }
            } catch (error) {
                console.error('Error deleting ticket:', error);
                alert('Network error occurred');
            }
        }

        // Filter tickets function
        function filterTickets() {
            const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();
            const projectFilter = document.getElementById('projectFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const fileFilterEl = document.getElementById('fileFilter');
            const fileFilter = fileFilterEl ? fileFilterEl.value : '';

            const rows = document.querySelectorAll('.ticket-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const name = row.dataset.name || '';
                const description = row.dataset.description || '';
                const projectId = row.dataset.projectId || '';
                const status = row.dataset.status || '';
                const priority = row.dataset.priority || '';
                const sourceDocument = row.dataset.sourceDocument || '';

                const matchesSearch = !searchTerm ||
                    name.includes(searchTerm) ||
                    description.includes(searchTerm);
                const matchesProject = !projectFilter || projectId === projectFilter;
                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesPriority = !priorityFilter || priority === priorityFilter;
                const matchesFile = !fileFilter || sourceDocument === fileFilter;

                if (matchesSearch && matchesProject && matchesStatus && matchesPriority && matchesFile) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show/hide empty state if needed
            const table = document.getElementById('ticketsTable');
            if (table) {
                table.style.display = visibleCount > 0 ? 'table' : 'none';
            }
            toggleTicketsEmptyState(visibleCount > 0);
        }

        function toggleTicketsEmptyState(hasTickets) {
            const emptyState = document.getElementById('ticketsEmptyState');
            const table = document.getElementById('ticketsTable');
            if (emptyState) {
                emptyState.style.display = hasTickets ? 'none' : '';
            }
            if (table && hasTickets) {
                table.style.display = 'table';
            }
        }

        function addTicketRow(ticket) {
            if (!ticket) return;
            const tbody = document.getElementById('ticketsTableBody');
            if (!tbody) return;

            toggleTicketsEmptyState(true);

            const row = document.createElement('tr');
            row.className = 'ticket-row';
            row.dataset.ticketId = ticket.id;
            row.dataset.projectId = ticket.project_id || '';
            row.dataset.status = ticket.status || 'open';
            row.dataset.priority = ticket.priority || 'Medium';
            row.dataset.name = (ticket.name || '').toLowerCase();
            row.dataset.description = (ticket.description || '').toLowerCase();
            row.dataset.sourceDocument = ticket.source_document_id || '';

            const ticketCell = document.createElement('td');
            ticketCell.style.cursor = 'pointer';
            ticketCell.addEventListener('click', () => viewTicketDetails(ticket.id, ticket.project_id));
            ticketCell.innerHTML = `
                <div class="ticket-info">
                    <div class="ticket-name">${escapeHtml(ticket.name)}</div>
                </div>
            `;

            const statusCell = document.createElement('td');
            const statusSelect = document.createElement('select');
            statusSelect.className = 'table-select status-select';
            statusSelect.dataset.ticketId = ticket.id;
            statusSelect.dataset.projectId = ticket.project_id || '';
            statusSelect.dataset.status = ticket.status || 'open';
            [
                { value: 'open', label: 'Open' },
                { value: 'in_progress', label: 'In Progress' },
                { value: 'done', label: 'Done' },
                { value: 'blocked', label: 'Blocked' },
                { value: 'failed', label: 'Failed' }
            ].forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;
                if (option.value === (ticket.status || 'open')) {
                    opt.selected = true;
                }
                statusSelect.appendChild(opt);
            });
            statusSelect.addEventListener('change', function() {
                updateTicketFromTable(this, 'status');
            });
            statusCell.appendChild(statusSelect);

            const priorityCell = document.createElement('td');
            const prioritySelect = document.createElement('select');
            prioritySelect.className = 'table-select priority-select';
            prioritySelect.dataset.ticketId = ticket.id;
            prioritySelect.dataset.projectId = ticket.project_id || '';
            prioritySelect.dataset.priority = ticket.priority || 'Medium';
            [
                { value: 'Low', label: 'Low' },
                { value: 'Medium', label: 'Medium' },
                { value: 'High', label: 'High' }
            ].forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.label;
                if (option.value === (ticket.priority || 'Medium')) {
                    opt.selected = true;
                }
                prioritySelect.appendChild(opt);
            });
            prioritySelect.addEventListener('change', function() {
                updateTicketFromTable(this, 'priority');
            });
            priorityCell.appendChild(prioritySelect);

            // Queue status cell
            const queueCell = document.createElement('td');
            const queueDiv = document.createElement('div');
            queueDiv.className = 'queue-status-cell';
            queueDiv.dataset.ticketId = ticket.id;
            queueDiv.dataset.projectId = ticket.project_id || '';
            queueDiv.dataset.queueStatus = ticket.queue_status || 'none';
            queueDiv.innerHTML = '<span class="queue-badge none">-</span>';
            queueCell.appendChild(queueDiv);

            row.appendChild(ticketCell);
            row.appendChild(statusCell);
            row.appendChild(priorityCell);
            row.appendChild(queueCell);
            tbody.prepend(row);

            filterTickets();
        }

        const newTicketModal = document.getElementById('newTicketModal');
        const newTicketForm = document.getElementById('newTicketForm');
        const newTicketProjectInput = document.getElementById('newTicketProject');
        const newTicketProjectLabel = document.getElementById('newTicketProjectLabel');
        const newTicketProjectDisplay = document.getElementById('newTicketProjectDisplay');
        const newTicketNameInput = document.getElementById('newTicketName');
        const newTicketDescriptionInput = document.getElementById('newTicketDescription');
        const newTicketStatusSelect = document.getElementById('newTicketStatus');
        const newTicketPrioritySelect = document.getElementById('newTicketPriority');
        const newTicketRoleSelect = document.getElementById('newTicketRole');
        const newTicketComplexitySelect = document.getElementById('newTicketComplexity');
        const newTicketRequiresWorktree = document.getElementById('newTicketRequiresWorktree');
        const newTicketFileInput = document.getElementById('newTicketFiles');
        const newTicketFileList = document.getElementById('newTicketFileList');
        let newTicketFiles = [];
        const newTicketError = document.getElementById('newTicketError');
        const newTicketBtn = document.getElementById('newTicketBtn');
        const cancelNewTicketBtn = document.getElementById('cancelNewTicketBtn');
        const closeNewTicketBtn = document.getElementById('closeNewTicketBtn');
        const createTicketSubmit = document.getElementById('createTicketSubmit');

        function resolveProjectContextFromFilter() {
            // If we have a current project context, use it
            if (currentProject) {
                return currentProject;
            }

            const projectFilter = document.getElementById('projectFilter');
            if (!projectFilter) return null;

            // For hidden input (when current_project is set), just use the value
            if (projectFilter.type === 'hidden') {
                return currentProject;
            }

            let projectOption = null;
            if (projectFilter.value) {
                projectOption = projectFilter.options[projectFilter.selectedIndex];
            } else {
                projectOption = Array.from(projectFilter.options).find(opt => opt.value);
            }

            if (projectOption && projectOption.value) {
                return {
                    id: projectOption.value,
                    name: projectOption.textContent.trim()
                };
            }
            return null;
        }

        function setModalProjectFromFilter() {
            if (!newTicketProjectInput) return false;
            const context = resolveProjectContextFromFilter();
            if (context) {
                newTicketProjectInput.value = context.id;
                if (newTicketProjectLabel) {
                    newTicketProjectLabel.textContent = context.name;
                }
                return true;
            }

            newTicketProjectInput.value = '';
            if (newTicketProjectLabel) {
                newTicketProjectLabel.textContent = 'Select a project first';
            }
            return false;
        }

        function openNewTicketModal() {
            if (!newTicketModal) return;
            const hasProject = setModalProjectFromFilter();
            if (!hasProject) {
                showNewTicketError('Select a project from the filters before creating a ticket.');
                if (createTicketSubmit) {
                    createTicketSubmit.disabled = true;
                }
            } else {
                showNewTicketError('');
                if (createTicketSubmit) {
                    createTicketSubmit.disabled = false;
                }
            }
            newTicketModal.classList.add('active');
            if (newTicketNameInput) {
                newTicketNameInput.focus();
            }
        }

        function closeNewTicketModal() {
            if (!newTicketModal) return;
            newTicketModal.classList.remove('active');
            resetNewTicketForm();
        }

        function resetNewTicketForm() {
            if (!newTicketForm) return;
            newTicketForm.reset();
            showNewTicketError('');
            if (newTicketStatusSelect) newTicketStatusSelect.value = 'open';
            if (newTicketPrioritySelect) newTicketPrioritySelect.value = 'Medium';
            if (newTicketRoleSelect) newTicketRoleSelect.value = 'user';
            if (newTicketComplexitySelect) newTicketComplexitySelect.value = 'medium';
            if (newTicketRequiresWorktree) newTicketRequiresWorktree.checked = true;
            setModalProjectFromFilter();
            newTicketFiles = [];
            if (newTicketFileInput) {
                newTicketFileInput.value = '';
            }
            renderNewTicketFiles();
        }

        function showNewTicketError(message) {
            if (!newTicketError) return;
            if (message) {
                newTicketError.textContent = message;
                newTicketError.style.display = 'block';
            } else {
                newTicketError.textContent = '';
                newTicketError.style.display = 'none';
            }
        }

        function renderNewTicketFiles() {
            if (!newTicketFileList) return;
            if (!newTicketFiles.length) {
                newTicketFileList.innerHTML = '<p class="attachment-preview-empty">No files selected.</p>';
                return;
            }

            newTicketFileList.innerHTML = newTicketFiles.map((file, index) => `
                <div class="attachment-chip">
                    <div>
                        <div>${escapeHtml(file.name)}</div>
                        <div class="meta">${formatFileSizeHuman(file.size)}</div>
                    </div>
                    <button type="button" class="chip-remove" data-index="${index}" aria-label="Remove ${escapeHtml(file.name)}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            newTicketFileList.querySelectorAll('.chip-remove').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.dataset.index, 10);
                    removeNewTicketFile(idx);
                });
            });
        }

        function removeNewTicketFile(index) {
            if (index < 0 || index >= newTicketFiles.length) {
                return;
            }
            newTicketFiles.splice(index, 1);
            renderNewTicketFiles();
        }

        function handleNewTicketFileChange(event) {
            const files = Array.from(event.target.files || []);
            if (!files.length) return;

            files.forEach(file => {
                const fingerprint = `${file.name}-${file.size}-${file.lastModified}`;
                const exists = newTicketFiles.some(existing => `${existing.name}-${existing.size}-${existing.lastModified}` === fingerprint);
                if (!exists) {
                    newTicketFiles.push(file);
                }
            });

            if (newTicketFileInput) {
                newTicketFileInput.value = '';
            }
            renderNewTicketFiles();
        }

        async function handleNewTicketSubmit(event) {
            event.preventDefault();
            if (!newTicketProjectInput) return;

            const projectId = newTicketProjectInput.value;
            if (!projectId) {
                showNewTicketError('Select a project from the filters before creating a ticket.');
                return;
            }

            const name = (newTicketNameInput?.value || '').trim();
            const description = (newTicketDescriptionInput?.value || '').trim();

            if (!name || !description) {
                showNewTicketError('Name and description are required.');
                return;
            }

            const payload = {
                name,
                description,
                status: newTicketStatusSelect ? newTicketStatusSelect.value : 'open',
                priority: newTicketPrioritySelect ? newTicketPrioritySelect.value : 'Medium',
                role: newTicketRoleSelect ? newTicketRoleSelect.value : 'user',
                complexity: newTicketComplexitySelect ? newTicketComplexitySelect.value : 'medium',
                requires_worktree: newTicketRequiresWorktree ? newTicketRequiresWorktree.checked : true,
            };

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                showNewTicketError('Missing CSRF token.');
                return;
            }

            showNewTicketError('');
            const originalButtonText = createTicketSubmit ? createTicketSubmit.innerHTML : '';
            if (createTicketSubmit) {
                createTicketSubmit.disabled = true;
                createTicketSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            }

            try {
                const response = await fetch(`/projects/${projectId}/api/checklist/create/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken.value
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    const createdTicket = data.ticket || {};
                    addTicketRow(createdTicket);

                    // Refresh kanban board if in board view
                    if (currentViewMode === 'board') {
                        populateKanbanBoard();
                    }

                    if (newTicketFiles.length > 0) {
                        try {
                            await uploadTicketAttachments(projectId, createdTicket.id, newTicketFiles);
                        } catch (uploadError) {
                            console.error('Attachment upload failed:', uploadError);
                            alert('Ticket created, but attachments failed to upload. Please retry from the ticket drawer.');
                        }
                    }

                    closeNewTicketModal();
                } else {
                    showNewTicketError(data.error || 'Failed to create ticket');
                }
            } catch (error) {
                console.error('Error creating ticket:', error);
                showNewTicketError('Network error occurred while creating ticket.');
            } finally {
                if (createTicketSubmit) {
                    createTicketSubmit.disabled = false;
                    createTicketSubmit.innerHTML = originalButtonText || '<i class="fas fa-plus" style="margin-right: 0.375rem;"></i> Create Ticket';
                }
            }
        }

        async function uploadTicketAttachments(projectId, ticketId, files) {
            if (!files || !files.length) return [];

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                throw new Error('Missing CSRF token.');
            }

            const formData = new FormData();
            files.forEach(file => formData.append('files', file));

            const response = await fetch(`/projects/${projectId}/api/tickets/${ticketId}/attachments/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value
                },
                body: formData
            });

            const data = await response.json();
            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Unable to upload attachments');
            }
            return data.attachments || [];
        }

        if (newTicketBtn && newTicketForm) {
            newTicketBtn.addEventListener('click', openNewTicketModal);
        }
        if (cancelNewTicketBtn) {
            cancelNewTicketBtn.addEventListener('click', closeNewTicketModal);
        }
        if (closeNewTicketBtn) {
            closeNewTicketBtn.addEventListener('click', closeNewTicketModal);
        }
        if (newTicketModal) {
            newTicketModal.addEventListener('click', (event) => {
                if (event.target === newTicketModal) {
                    closeNewTicketModal();
                }
            });
        }
        if (newTicketForm) {
            newTicketForm.addEventListener('submit', handleNewTicketSubmit);
        }
        if (newTicketFileInput) {
            newTicketFileInput.addEventListener('change', handleNewTicketFileChange);
        }
        renderNewTicketFiles();
        setModalProjectFromFilter();
        const projectFilterElement = document.getElementById('projectFilter');
        if (projectFilterElement) {
            projectFilterElement.addEventListener('change', () => {
                const hasProject = setModalProjectFromFilter();
                if (newTicketModal && newTicketModal.classList.contains('active')) {
                    if (!hasProject && createTicketSubmit) {
                        createTicketSubmit.disabled = true;
                        showNewTicketError('Select a project from the filters before creating a ticket.');
                    } else if (createTicketSubmit) {
                        createTicketSubmit.disabled = false;
                        showNewTicketError('');
                    }
                }
            });
        }

        // View ticket details
        async function viewTicketDetails(ticketId, projectId) {
            console.log('viewTicketDetails called:', {ticketId, projectId});
            try {
                const url = `/projects/${projectId}/api/checklist/`;
                console.log('Fetching from:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                // Handle both response formats: {success, checklist} and {tickets}
                const ticketsList = data.tickets || data.checklist || [];
                console.log('Tickets list:', ticketsList);

                const ticket = ticketsList.find(t => t.id === ticketId);
                console.log('Found ticket:', ticket);

                if (ticket) {
                    // Add project_id to ticket if it doesn't exist
                    if (!ticket.project_id) {
                        ticket.project_id = projectId;
                    }
                    if (!Array.isArray(ticket.attachments)) {
                        ticket.attachments = [];
                    }
                    showTicketModal(ticket);
                } else {
                    console.error('Ticket not found in list');
                    alert('Ticket not found');
                }
            } catch (error) {
                console.error('Error loading ticket details:', error);
                alert('Error loading ticket details: ' + error.message);
            }
        }

        let currentTicket = null;
        let currentProjectId = null;
        let currentTab = 'details';
        let ticketLogsWebSocket = null;
        let reconnectAttempts = 0;
        let isAiProcessing = false;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // State persistence functions - save/restore ticket drawer state per project
        function getTicketStateKey() {
            if (!currentProject || !currentProject.id) return null;
            return `lfg_ticket_state_${currentProject.id}`;
        }

        function saveTicketState() {
            const key = getTicketStateKey();
            if (!key || !currentTicket) return;

            const state = {
                ticketId: currentTicket.id,
                projectId: currentTicket.project_id,
                tab: currentTab,
                timestamp: Date.now()
            };
            localStorage.setItem(key, JSON.stringify(state));
        }

        function clearTicketState() {
            const key = getTicketStateKey();
            if (key) {
                localStorage.removeItem(key);
            }
        }

        function getSavedTicketState() {
            const key = getTicketStateKey();
            if (!key) return null;

            try {
                const saved = localStorage.getItem(key);
                if (!saved) return null;

                const state = JSON.parse(saved);
                // Optional: expire state after 24 hours
                if (Date.now() - state.timestamp > 24 * 60 * 60 * 1000) {
                    clearTicketState();
                    return null;
                }
                return state;
            } catch (e) {
                console.error('Error loading saved ticket state:', e);
                return null;
            }
        }

        async function restoreTicketState() {
            const savedState = getSavedTicketState();
            if (!savedState) return;

            console.log('Restoring ticket state:', savedState);

            // Temporarily store the desired tab before opening the ticket
            const desiredTab = savedState.tab || 'details';

            try {
                // Fetch and open the saved ticket
                await viewTicketDetails(savedState.ticketId, savedState.projectId);

                // Switch to the saved tab after a brief delay to ensure drawer is ready
                setTimeout(() => {
                    if (currentTicket && currentTicket.id === savedState.ticketId) {
                        switchDrawerTab(desiredTab);
                    }
                }, 100);
            } catch (error) {
                console.error('Error restoring ticket state:', error);
                clearTicketState();
            }
        }

        // WebSocket functions for real-time log updates
        function connectTicketLogsWebSocket(ticketId) {
            // Close existing connection if any
            disconnectTicketLogsWebSocket();

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/tickets/${ticketId}/logs/`;

                console.log(`Connecting to ticket logs WebSocket: ${wsUrl}`);
                ticketLogsWebSocket = new WebSocket(wsUrl);

                ticketLogsWebSocket.onopen = function() {
                    console.log(`Connected to ticket logs WebSocket for ticket ${ticketId}`);
                    reconnectAttempts = 0;
                };

                ticketLogsWebSocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    console.log('Received WebSocket message:', data);

                    if (data.type === 'log_created') {
                        // Add the new log to the UI
                        handleNewLog(data.log);
                    } else if (data.type === 'status_changed') {
                        // Handle ticket status change with optional queue_status and error_reason
                        handleStatusChange(data.status, data.ticket_id, data.queue_status || null, data.error_reason || null);
                    }
                };

                ticketLogsWebSocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };

                ticketLogsWebSocket.onclose = function(event) {
                    console.log('WebSocket closed:', event.code, event.reason);

                    // Try to reconnect if we're still viewing the logs tab
                    if (currentTab === 'logs' && currentTicket && currentTicket.id === ticketId) {
                        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                            reconnectAttempts++;
                            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                            console.log(`Attempting to reconnect in ${delay}ms (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                            setTimeout(() => {
                                if (currentTab === 'logs' && currentTicket && currentTicket.id === ticketId) {
                                    connectTicketLogsWebSocket(ticketId);
                                }
                            }, delay);
                        }
                    }
                };
            } catch (error) {
                console.error('Error creating WebSocket connection:', error);
            }
        }

        function disconnectTicketLogsWebSocket() {
            if (ticketLogsWebSocket) {
                console.log('Closing ticket logs WebSocket');
                ticketLogsWebSocket.close();
                ticketLogsWebSocket = null;
            }
        }

        // Render a log entry based on its type
        function renderLogEntry(log, index) {
            const logType = log.log_type || 'command';
            const timestamp = formatDate(log.created_at);

            if (logType === 'user_message') {
                // User message - purple theme
                return `
                    <div class="execution-log-entry user-message" data-cmd-index="${index}" data-log-id="${log.id}" data-log-type="user_message">
                        <div class="log-header">
                            <div style="display: flex; align-items: flex-start; gap: 0.625rem; flex: 1;">
                                <i class="fas fa-user user-message-icon" style="font-size: 0.875rem; margin-top: 3px;"></i>
                                <div>
                                    <span style="color: #8B5CF6; font-weight: 500; font-size: 0.8rem;">You</span>
                                    <div class="log-explanation" style="margin-top: 0.25rem;">${escapeHtml(log.command)}</div>
                                </div>
                            </div>
                            <span class="log-timestamp" style="white-space: nowrap; margin-left: 1rem; align-self: flex-start;">${timestamp}</span>
                        </div>
                    </div>
                `;
            } else if (logType === 'ai_response') {
                // AI response - show full message with markdown support
                const fullResponse = log.output || log.command || '';
                const renderedResponse = renderMarkdown(fullResponse);
                return `
                    <div class="execution-log-entry ai-response" data-cmd-index="${index}" data-log-id="${log.id}" data-log-type="ai_response">
                        <div class="log-header">
                            <div style="display: flex; align-items: flex-start; gap: 0.625rem; flex: 1;">
                                <span style="color: #a78bfa; font-weight: 500; font-size: 0.8rem;">ðŸš€ Agent</span>
                            </div>
                            <span class="log-timestamp" style="white-space: nowrap; margin-left: 1rem;">${timestamp}</span>
                        </div>
                        <div class="ai-response-content">${renderedResponse}</div>
                    </div>
                `;
            } else if (logType === 'error') {
                // Error message - red theme
                const errorMessage = log.output || log.explanation || 'An error occurred';
                return `
                    <div class="execution-log-entry error-message" data-cmd-index="${index}" data-log-id="${log.id}" data-log-type="error" style="border-left: 3px solid #ef4444; background: rgba(239, 68, 68, 0.1); padding-left: 1rem;">
                        <div class="log-header">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; flex: 1;">
                                <i class="fas fa-exclamation-circle" style="color: #ef4444; font-size: 0.875rem; margin-top: 3px; flex-shrink: 0;"></i>
                                <div>
                                    <span style="color: #ef4444; font-weight: 500; font-size: 0.8rem;">${escapeHtml(log.command || 'Error')}</span>
                                    <div class="log-explanation" style="margin-top: 0.375rem; color: var(--text-color);">${escapeHtml(errorMessage)}</div>
                                </div>
                            </div>
                            <span class="log-timestamp" style="white-space: nowrap; margin-left: 1rem; align-self: flex-start;">${timestamp}</span>
                        </div>
                    </div>
                `;
            } else if (logType === 'system') {
                // System message - blue/gray theme
                const systemMessage = log.output || log.explanation || '';
                return `
                    <div class="execution-log-entry system-message" data-cmd-index="${index}" data-log-id="${log.id}" data-log-type="system" style="border-left: 3px solid #6366f1; background: rgba(99, 102, 241, 0.05); padding-left: 1rem;">
                        <div class="log-header">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; flex: 1;">
                                <i class="fas fa-cog" style="color: #6366f1; font-size: 0.875rem; margin-top: 3px; flex-shrink: 0;"></i>
                                <div>
                                    <span style="color: #6366f1; font-weight: 500; font-size: 0.8rem;">${escapeHtml(log.command || 'System')}</span>
                                    ${systemMessage ? `<div class="log-explanation" style="margin-top: 0.375rem; color: var(--text-secondary);">${escapeHtml(systemMessage)}</div>` : ''}
                                </div>
                            </div>
                            <span class="log-timestamp" style="white-space: nowrap; margin-left: 1rem; align-self: flex-start;">${timestamp}</span>
                        </div>
                    </div>
                `;
            } else {
                // Command - default collapsible entry
                const explanation = log.explanation || 'No explanation provided';
                return `
                    <div class="execution-log-entry collapsed" data-cmd-index="${index}" data-log-id="${log.id}" data-log-type="command">
                        <div class="log-header" onclick="toggleCommandExpand('${index}')">
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; overflow: hidden;">
                                <i class="fas fa-chevron-right expand-icon" style="font-size: 0.75rem; transition: transform 0.2s;"></i>
                                <span class="log-explanation" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(explanation)}</span>
                            </div>
                            <span class="log-timestamp" style="white-space: nowrap; margin-left: 1rem;">${timestamp}</span>
                        </div>
                        <div class="log-details" style="display: none;">
                            <pre class="log-command">${escapeHtml(log.command)}</pre>
                            ${log.output ? `<pre class="log-output">${escapeHtml(log.output)}</pre>` : '<p style="color: var(--text-secondary); font-style: italic; margin-top: 0.5rem; font-size: 0.875rem;">No output</p>'}
                        </div>
                    </div>
                `;
            }
        }

        // Scroll logs container to bottom to show latest logs
        function scrollLogsToBottom() {
            const logsContainer = document.getElementById('executionLogsContainer');
            if (logsContainer) {
                // Use requestAnimationFrame to ensure DOM is updated
                requestAnimationFrame(() => {
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                });
            }
        }

        // Store pending file attachments for chat
        let logsChatAttachments = [];

        // Handle file selection for chat attachments
        function handleLogsChatFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                // Prevent duplicates
                if (!logsChatAttachments.find(f => f.name === file.name && f.size === file.size)) {
                    logsChatAttachments.push(file);
                }
            });
            renderLogsChatAttachments();
            // Reset file input
            event.target.value = '';
        }

        // Render attachment previews
        function renderLogsChatAttachments() {
            const container = document.getElementById('logsChatAttachments');
            if (!container) return;

            if (logsChatAttachments.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = logsChatAttachments.map((file, index) => `
                <div class="logs-chat-attachment">
                    <i class="fas ${getFileIcon(file.name)}"></i>
                    <span>${escapeHtml(truncateFilename(file.name, 20))}</span>
                    <span class="remove-attachment" onclick="removeLogsChatAttachment(${index})" title="Remove">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            `).join('');
        }

        // Get appropriate icon for file type
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word', 'docx': 'fa-file-word',
                'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                'png': 'fa-file-image', 'jpg': 'fa-file-image', 'jpeg': 'fa-file-image', 'gif': 'fa-file-image', 'svg': 'fa-file-image',
                'zip': 'fa-file-archive', 'rar': 'fa-file-archive', 'tar': 'fa-file-archive', 'gz': 'fa-file-archive',
                'js': 'fa-file-code', 'ts': 'fa-file-code', 'py': 'fa-file-code', 'html': 'fa-file-code', 'css': 'fa-file-code', 'json': 'fa-file-code',
                'txt': 'fa-file-alt', 'md': 'fa-file-alt',
            };
            return icons[ext] || 'fa-file';
        }

        // Truncate filename for display
        function truncateFilename(name, maxLen) {
            if (name.length <= maxLen) return name;
            const ext = name.split('.').pop();
            const base = name.slice(0, name.length - ext.length - 1);
            const truncatedBase = base.slice(0, maxLen - ext.length - 4) + '...';
            return truncatedBase + '.' + ext;
        }

        // Remove an attachment
        function removeLogsChatAttachment(index) {
            logsChatAttachments.splice(index, 1);
            renderLogsChatAttachments();
        }

        // Clear all attachments
        function clearLogsChatAttachments() {
            logsChatAttachments = [];
            renderLogsChatAttachments();
        }

        // Handle keydown in chat input (Enter to send, Shift+Enter for newline)
        function handleLogsChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendLogsChatMessage();
            }
        }

        // Send chat message to continue ticket execution
        async function sendLogsChatMessage() {
            const input = document.getElementById('logsChatInput');
            const sendBtn = document.getElementById('logsChatSendBtn');
            const attachBtn = document.querySelector('.logs-chat-attach-btn');
            const message = input?.value?.trim();
            const hasAttachments = logsChatAttachments.length > 0;

            // Need either message or attachments to send
            if ((!message && !hasAttachments) || !currentTicket || !currentProjectId) {
                return;
            }

            // Disable inputs while sending
            input.disabled = true;
            sendBtn.disabled = true;
            if (attachBtn) attachBtn.disabled = true;
            const originalBtnHtml = sendBtn.innerHTML;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // User message will be added via WebSocket after it's saved to database
                // Send the message to the backend API using FormData for file support
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                if (!csrfToken) {
                    throw new Error('CSRF token not found. Please refresh the page.');
                }

                const formData = new FormData();
                formData.append('message', message || '');
                formData.append('project_id', currentProjectId);

                // Add attachments
                logsChatAttachments.forEach((file, index) => {
                    formData.append('attachments', file);
                });

                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/chat/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    // Check for auth expired error
                    if (data.auth_expired || response.status === 401) {
                        showNotification('Claude Code session expired. Please reconnect in Settings > Claude Code.', 'error');
                        hideAiTypingIndicator();
                        setAiProcessingState(false);
                        return;
                    }
                    throw new Error(data.error || 'Failed to send message');
                }

                // Clear input and attachments on success
                input.value = '';
                clearLogsChatAttachments();

                // Show AI typing indicator
                showAiTypingIndicator();

                // Show success feedback
                console.log('Chat message sent successfully:', data);

            } catch (error) {
                console.error('Error sending chat message:', error);
                // Show error notification
                showNotification('Failed to send message: ' + error.message, 'error');
                // Hide typing indicator on error
                hideAiTypingIndicator();
                setAiProcessingState(false);
            } finally {
                // Re-enable inputs
                input.disabled = false;
                sendBtn.disabled = false;
                if (attachBtn) attachBtn.disabled = false;
                sendBtn.innerHTML = originalBtnHtml;
                input.focus();
            }
        }

        // Show AI typing indicator
        function showAiTypingIndicator() {
            const indicatorSlot = document.getElementById('aiTypingIndicatorSlot');
            if (!indicatorSlot) return;

            // Remove existing indicator if any
            hideAiTypingIndicator();

            indicatorSlot.innerHTML = `
                <div class="ai-typing-indicator" id="aiTypingIndicator">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>ðŸš€ Agent is workingâ€¦</span>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            setAiProcessingState(true);
        }

        // Hide AI typing indicator
        function hideAiTypingIndicator() {
            const indicator = document.getElementById('aiTypingIndicator');
            if (indicator) {
                indicator.remove();
                const slot = document.getElementById('aiTypingIndicatorSlot');
                if (slot) {
                    slot.innerHTML = '';
                }
            }
            setAiProcessingState(false);
        }

        // Stop/interrupt AI execution
        async function stopExecution(event = null) {
            if (!currentTicket) return;

            const stopBtn = event?.currentTarget || document.getElementById('logsChatStopBtn');
            const originalBtnHtml = stopBtn ? stopBtn.innerHTML : null;
            if (stopBtn) {
                stopBtn.disabled = true;
                stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/stop/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    console.log('Stop request sent:', data);
                    // Hide typing indicator
                    hideAiTypingIndicator();
                } else {
                    console.error('Failed to stop:', data);
                    alert('Failed to stop: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error stopping execution:', error);
                alert('Failed to stop execution');
            } finally {
                if (stopBtn) {
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = originalBtnHtml;
                }
            }
        }
        function updateSendStopButtons() {
            const sendBtn = document.getElementById('logsChatSendBtn');
            const stopBtn = document.getElementById('logsChatStopBtn');
            if (!sendBtn || !stopBtn) return;

            if (isAiProcessing) {
                sendBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
            } else {
                sendBtn.style.display = 'inline-flex';
                stopBtn.style.display = 'none';
            }
        }

        function setAiProcessingState(value) {
            isAiProcessing = value;
            updateSendStopButtons();
        }

        // Show toast notification
        function showNotification(message, type = 'info') {
            // Remove existing notification if any
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            const colors = {
                'error': { bg: 'rgba(239, 68, 68, 0.95)', icon: 'fa-exclamation-circle' },
                'success': { bg: 'rgba(34, 197, 94, 0.95)', icon: 'fa-check-circle' },
                'warning': { bg: 'rgba(245, 158, 11, 0.95)', icon: 'fa-exclamation-triangle' },
                'info': { bg: 'rgba(99, 102, 241, 0.95)', icon: 'fa-info-circle' }
            };
            const config = colors[type] || colors['info'];

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                padding: 1rem 1.25rem;
                background: ${config.bg};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                gap: 0.75rem;
                max-width: 400px;
                font-size: 0.875rem;
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = `
                <i class="fas ${config.icon}"></i>
                <span>${message}</span>
                <i class="fas fa-times" style="cursor: pointer; margin-left: auto; opacity: 0.7;" onclick="this.parentElement.remove()"></i>
            `;

            // Add animation keyframes
            if (!document.querySelector('#toast-keyframes')) {
                const style = document.createElement('style');
                style.id = 'toast-keyframes';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(toast);

            // Auto-remove after 6 seconds for errors, 4 seconds for others
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, type === 'error' ? 6000 : 4000);
        }

        // Store pending logs when not on logs tab
        let pendingLogs = [];

        function handleNewLog(log) {
            console.log('Handling new log:', log);

            // Hide typing indicator when AI response arrives
            if (log.log_type === 'ai_response') {
                hideAiTypingIndicator();
            }

            // Hide typing indicator when processing is fully complete
            if (log.log_type === 'chat_complete') {
                hideAiTypingIndicator();
                setAiProcessingState(false);
                return;  // Don't render this log in the UI
            }

            // Hide typing indicator for errors only (not system messages - agent may still be working)
            if (log.log_type === 'error') {
                hideAiTypingIndicator();
                setAiProcessingState(false);

                // Check if it's an auth error and show toast
                const logOutput = (log.output || '').toLowerCase();
                const logCommand = (log.command || '').toLowerCase();
                if (logOutput.includes('expired') || logOutput.includes('reconnect') ||
                    logCommand.includes('authentication') || logCommand.includes('auth error')) {
                    showNotification('Claude Code session expired. Please reconnect in Settings.', 'error');
                } else if (logCommand.includes('workspace') || logOutput.includes('settings')) {
                    showNotification(log.output || 'Please check Settings to resolve this issue.', 'error');
                }
            }

            // Find the logs container
            const logsContainer = document.querySelector('.execution-logs-container');
            if (!logsContainer) {
                // Not on logs tab - store for later
                console.log('Logs container not found, storing log for later');
                pendingLogs.push(log);
                return;
            }

            // Check if this log already exists (to prevent duplicates)
            const existingLog = document.querySelector(`.execution-log-entry[data-log-id="${log.id}"]`);
            if (existingLog) {
                console.log('Log already exists, skipping');
                return;
            }

            // Remove the "no logs" message if it exists
            const noLogsMessage = logsContainer.querySelector('.no-logs-message');
            if (noLogsMessage) {
                noLogsMessage.remove();
            }

            // Create new log entry HTML using the shared render function
            const logHtml = renderLogEntry(log, `new-${log.id}`);

            // Append at the bottom (oldest first, latest at bottom)
            logsContainer.insertAdjacentHTML('beforeend', logHtml);

            // Add a subtle animation to highlight the new log
            const newLogElement = document.querySelector(`.execution-log-entry[data-log-id="${log.id}"]`);
            if (newLogElement) {
                newLogElement.style.backgroundColor = 'rgba(74, 144, 226, 0.1)';
                setTimeout(() => {
                    newLogElement.style.transition = 'background-color 1s ease';
                    newLogElement.style.backgroundColor = '';
                }, 100);
            }

            // Scroll to show the new log
            scrollLogsToBottom();
        }

        function handleStatusChange(status, ticketId, queueStatus = null, errorReason = null) {
            console.log(`Ticket ${ticketId} status changed to: ${status}, queue_status: ${queueStatus}, error: ${errorReason}`);

            // Determine the correct queue status
            // If queue_status is explicitly provided, use it
            // Otherwise, derive from ticket status (done/blocked/failed = none)
            let effectiveQueueStatus = queueStatus;
            if (effectiveQueueStatus === null) {
                if (['done', 'blocked', 'failed', 'review'].includes(status)) {
                    effectiveQueueStatus = 'none';
                } else {
                    effectiveQueueStatus = status;
                }
            }

            // Update the queue status in the table
            updateQueueStatusUI(ticketId, effectiveQueueStatus);

            // Update the execute button if this is the currently viewed ticket
            if (currentTicket && currentTicket.id === ticketId) {
                const executeBtn = document.getElementById('executeTicketBtn');
                if (executeBtn) {
                    if (effectiveQueueStatus === 'none') {
                        executeBtn.disabled = false;
                        const hasBeenBuilt = currentTicket && (currentTicket.has_logs || currentTicket.last_execution_at);
                        executeBtn.innerHTML = hasBeenBuilt
                            ? '<i class="fas fa-play"></i> Continue'
                            : '<i class="fas fa-hammer"></i> Build Ticket';
                        executeBtn.classList.remove('stop-mode');
                        // Update currentTicket's queue_status
                        currentTicket.queue_status = 'none';
                    } else if (effectiveQueueStatus === 'executing') {
                        executeBtn.disabled = false;
                        executeBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Build';
                        executeBtn.classList.add('stop-mode');
                        currentTicket.queue_status = 'executing';
                    } else if (effectiveQueueStatus === 'queued') {
                        executeBtn.disabled = false;
                        executeBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Queue';
                        executeBtn.classList.add('stop-mode');
                        currentTicket.queue_status = 'queued';
                    }
                }

                // Update the detail panel queue status indicator
                updateDetailPanelQueueStatus(effectiveQueueStatus);

                // Also update the ticket status in currentTicket
                currentTicket.status = status;
            }

            // Find the logs container
            const logsContainer = document.querySelector('.execution-logs-container');
            if (!logsContainer) {
                console.log('Logs container not found');
                return;
            }

            // Remove any existing status indicator
            const existingIndicator = document.querySelector('.ticket-status-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            // Add a status indicator at the top if status is 'done'
            if (status === 'done') {
                const header = logsContainer.querySelector('h4');
                if (header) {
                    const indicator = document.createElement('div');
                    indicator.className = 'ticket-status-indicator';
                    indicator.style.cssText = `
                        background: rgba(34, 197, 94, 0.1);
                        border: 1px solid rgba(34, 197, 94, 0.3);
                        border-radius: 8px;
                        padding: 1rem;
                        margin-bottom: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        animation: slideIn 0.3s ease-out;
                    `;
                    indicator.innerHTML = `
                        <div style="
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            background: rgba(34, 197, 94, 0.2);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-check" style="color: rgb(34, 197, 94); font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: rgb(34, 197, 94); margin-bottom: 2px;">Ticket Completed</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">All commands have been executed successfully</div>
                        </div>
                    `;
                    header.insertAdjacentElement('afterend', indicator);
                }
            } else if (status === 'blocked') {
                // Show blocked indicator with actual error reason
                const header = logsContainer.querySelector('h4');
                if (header) {
                    const indicator = document.createElement('div');
                    indicator.className = 'ticket-status-indicator';
                    indicator.style.cssText = `
                        background: rgba(245, 158, 11, 0.1);
                        border: 1px solid rgba(245, 158, 11, 0.3);
                        border-radius: 8px;
                        padding: 1rem;
                        margin-bottom: 1rem;
                        display: flex;
                        align-items: flex-start;
                        gap: 0.75rem;
                        animation: slideIn 0.3s ease-out;
                    `;

                    // Format the error reason for display
                    let errorDisplay = 'Execution was blocked.';
                    if (errorReason) {
                        // Truncate long errors and clean up for display
                        let cleanError = errorReason.replace(/^CLI Error:\s*/i, '');
                        if (cleanError.length > 200) {
                            cleanError = cleanError.substring(0, 200) + '...';
                        }
                        errorDisplay = cleanError;
                    }

                    // Check if it's an auth error
                    const isAuthError = errorReason && (
                        errorReason.toLowerCase().includes('auth') ||
                        errorReason.toLowerCase().includes('credential') ||
                        errorReason.toLowerCase().includes('login') ||
                        errorReason.toLowerCase().includes('not logged in')
                    );

                    indicator.innerHTML = `
                        <div style="
                            width: 32px;
                            height: 32px;
                            min-width: 32px;
                            border-radius: 50%;
                            background: rgba(245, 158, 11, 0.2);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-exclamation-triangle" style="color: rgb(245, 158, 11); font-size: 18px;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: rgb(245, 158, 11); margin-bottom: 4px;">Ticket Blocked</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); word-break: break-word;">
                                ${errorDisplay}
                            </div>
                            ${isAuthError ? `
                            <a href="/settings/#claude-code" style="color: rgb(245, 158, 11); font-size: 0.875rem; margin-top: 8px; display: inline-block;">
                                <i class="fas fa-cog"></i> Reconnect Claude Code
                            </a>
                            ` : ''}
                        </div>
                    `;
                    header.insertAdjacentElement('afterend', indicator);
                }
            }
        }

        function switchDrawerTab(tab) {
            currentTab = tab;

            // Keep WebSocket connected even when switching tabs
            // This ensures we don't miss any messages
            // WebSocket will be disconnected only when drawer closes or ticket changes

            // Update tab buttons
            document.querySelectorAll('.drawer-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.drawer-tab[data-tab="${tab}"]`).classList.add('active');

            // Reload content for current ticket
            if (currentTicket) {
                loadTabContent(tab);
            }

            // Save state when tab changes
            saveTicketState();
        }

        function loadTabContent(tab) {
            const body = document.getElementById('drawerTicketBody');

            switch(tab) {
                case 'details':
                    showDetailsTab(body);
                    break;
                case 'logs':
                    showLogsTab(body);
                    break;
                case 'tasks':
                    showTasksTab(body);
                    break;
                case 'preview':
                    showPreviewTab(body);
                    break;
                case 'git':
                    showGitTab(body);
                    break;
                case 'server-logs':
                    showServerLogsTab(body);
                    break;
            }
        }

        // Track if we're in edit mode for details tab
        let isDetailsEditMode = false;

        function showDetailsTab(body) {
            if (isDetailsEditMode) {
                showDetailsEditMode(body);
            } else {
                showDetailsReadMode(body);
            }
        }

        function showDetailsReadMode(body) {
            const ticket = currentTicket;

            const attachments = Array.isArray(ticket.attachments) ? ticket.attachments : [];
            const attachmentsHTML = attachments.length ? `
                <div class="detail-section">
                    <h4>Attachments</h4>
                    <div class="ticket-attachments-grid">
                        ${attachments.map(file => `
                            <a href="${file.file_url}" class="ticket-attachment-card" target="_blank" rel="noopener noreferrer">
                                <div class="ticket-attachment-icon">
                                    <i class="fas fa-paperclip"></i>
                                </div>
                                <div class="ticket-attachment-info">
                                    <div class="name">${escapeHtml(file.original_filename || 'Attachment')}</div>
                                    <div class="meta">${escapeHtml(file.file_type || 'file')} â€¢ ${formatFileSizeHuman(file.file_size)}</div>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            body.innerHTML = `
                <div class="ticket-detail-drawer">
                    <div class="detail-meta-row">
                        <span class="detail-label status-label status-${ticket.status}">${formatStatus(ticket.status)}</span>
                        <span class="detail-label priority-label priority-${ticket.priority?.toLowerCase()}">${ticket.priority || 'Medium'}</span>
                        ${ticket.queue_status && ticket.queue_status !== 'none' ? `
                        <div class="detail-queue-status" id="detailQueueStatus">
                            <span class="queue-badge ${ticket.queue_status}">
                                <i class="fas fa-${ticket.queue_status === 'executing' ? 'spinner fa-spin' : 'clock'}"></i>
                                ${ticket.queue_status === 'executing' ? 'Building' : 'Queued'}
                            </span>
                            <button class="queue-cancel-btn" onclick="event.stopPropagation(); ${ticket.queue_status === 'executing' ? 'stopBuild()' : 'cancelBuild()'}" title="${ticket.queue_status === 'executing' ? 'Stop build' : 'Remove from queue'}">
                                <i class="fas fa-${ticket.queue_status === 'executing' ? 'stop' : 'times'}"></i>
                            </button>
                        </div>
                        ` : ''}
                        <div class="detail-meta-spacer"></div>
                        <button type="button" class="detail-edit-btn" onclick="enterDetailsEditMode()">
                            <i class="fas fa-pen"></i> Edit
                        </button>
                        <button type="button" class="detail-delete-btn" onclick="deleteCurrentTicket()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>

                    <div class="detail-section">
                        <h4>Description</h4>
                        <div class="markdown-content">${ticket.description ? renderMarkdown(ticket.description) : '<p style="color: var(--text-secondary); font-style: italic;">No description provided</p>'}</div>
                    </div>

                    ${attachmentsHTML}

                    ${ticket.linked_documents && ticket.linked_documents.length ? `
                    <div class="detail-section">
                        <h4>Linked Documents</h4>
                        <div class="linked-docs-list">
                            ${ticket.linked_documents.map(doc => `
                                <div class="linked-doc-item">
                                    <i class="fas fa-file-alt"></i>
                                    <span class="linked-doc-name">${escapeHtml(doc.name)}</span>
                                    <span class="linked-doc-type">${escapeHtml(doc.file_type)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div class="detail-section">
                        <h4>Details</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Created</label>
                                <span>${formatDate(ticket.created_at)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Updated</label>
                                <span>${formatDate(ticket.updated_at)}</span>
                            </div>
                            ${ticket.execution_time_seconds > 0 ? `
                            <div class="detail-item">
                                <label>Time Spent</label>
                                <span class="execution-time-badge">
                                    <i class="fas fa-clock"></i> ${formatExecutionTime(ticket.execution_time_seconds)}
                                </span>
                            </div>
                            <div class="detail-item">
                                <label>Last Executed</label>
                                <span>${ticket.last_execution_at ? formatDate(ticket.last_execution_at) : 'Never'}</span>
                            </div>
                            ` : ''}
                            ${ticket.linear_issue_url ? `
                            <div class="detail-item" style="grid-column: span 2;">
                                <label>Linear Issue</label>
                                <a href="${ticket.linear_issue_url}" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                                    <i class="fas fa-external-link-alt" style="margin-right: 0.25rem;"></i> View in Linear
                                </a>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function showDetailsEditMode(body) {
            const ticket = currentTicket;

            const attachments = Array.isArray(ticket.attachments) ? ticket.attachments : [];
            const attachmentsHTML = attachments.length ? `
                <div class="inline-edit-section">
                    <label>Attachments</label>
                    <div class="ticket-attachments-grid">
                        ${attachments.map(file => `
                            <a href="${file.file_url}" class="ticket-attachment-card" target="_blank" rel="noopener noreferrer">
                                <div class="ticket-attachment-icon">
                                    <i class="fas fa-paperclip"></i>
                                </div>
                                <div class="ticket-attachment-info">
                                    <div class="name">${escapeHtml(file.original_filename || 'Attachment')}</div>
                                    <div class="meta">${escapeHtml(file.file_type || 'file')} â€¢ ${formatFileSizeHuman(file.file_size)}</div>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            body.innerHTML = `
                <div class="ticket-detail-drawer inline-edit-mode">
                    <div class="inline-edit-header-row">
                        <div class="inline-edit-section" style="flex: 1; margin-bottom: 0;">
                            <label for="inlineTicketName">Title</label>
                            <input type="text" id="inlineTicketName" class="inline-edit-input"
                                   value="${escapeHtml(ticket.name || '')}"
                                   onchange="saveInlineField('name', this.value)"
                                   placeholder="Ticket title">
                        </div>
                        <button type="button" class="detail-edit-btn" onclick="exitDetailsEditMode()" style="align-self: flex-end; margin-bottom: 0.25rem;">
                            <i class="fas fa-check"></i> Done
                        </button>
                    </div>

                    <div class="inline-edit-row">
                        <div class="inline-edit-section">
                            <label for="inlineTicketStatus">Status</label>
                            <select id="inlineTicketStatus" class="inline-edit-select status-select"
                                    data-status="${ticket.status}"
                                    onchange="saveInlineField('status', this.value); this.dataset.status = this.value;">
                                <option value="open" ${ticket.status === 'open' ? 'selected' : ''}>Open</option>
                                <option value="in_progress" ${ticket.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="review" ${ticket.status === 'review' ? 'selected' : ''}>Review</option>
                                <option value="done" ${ticket.status === 'done' ? 'selected' : ''}>Done</option>
                                <option value="blocked" ${ticket.status === 'blocked' ? 'selected' : ''}>Blocked</option>
                            </select>
                        </div>

                        <div class="inline-edit-section">
                            <label for="inlineTicketPriority">Priority</label>
                            <select id="inlineTicketPriority" class="inline-edit-select priority-select"
                                    data-priority="${ticket.priority}"
                                    onchange="saveInlineField('priority', this.value); this.dataset.priority = this.value;">
                                <option value="Low" ${ticket.priority === 'Low' ? 'selected' : ''}>Low</option>
                                <option value="Medium" ${ticket.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="High" ${ticket.priority === 'High' ? 'selected' : ''}>High</option>
                            </select>
                        </div>
                    </div>

                    <div class="inline-edit-section">
                        <label for="inlineTicketDescription">Description</label>
                        <textarea id="inlineTicketDescription" class="inline-edit-textarea"
                                  onchange="saveInlineField('description', this.value)"
                                  placeholder="Describe what needs to be done..."
                                  rows="8">${escapeHtml(ticket.description || '')}</textarea>
                    </div>

                    ${attachmentsHTML}

                    <div class="inline-edit-row">
                        <div class="inline-edit-section">
                            <label for="inlineTicketComplexity">Complexity</label>
                            <select id="inlineTicketComplexity" class="inline-edit-select"
                                    onchange="saveInlineField('complexity', this.value)">
                                <option value="simple" ${ticket.complexity === 'simple' ? 'selected' : ''}>Simple</option>
                                <option value="medium" ${ticket.complexity === 'medium' ? 'selected' : ''}>Medium</option>
                                <option value="complex" ${ticket.complexity === 'complex' ? 'selected' : ''}>Complex</option>
                            </select>
                        </div>

                        <div class="inline-edit-section">
                            <label for="inlineTicketRole">Role</label>
                            <select id="inlineTicketRole" class="inline-edit-select"
                                    onchange="saveInlineField('role', this.value)">
                                <option value="user" ${ticket.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="agent" ${ticket.role === 'agent' ? 'selected' : ''}>Agent</option>
                            </select>
                        </div>
                    </div>

                    <div class="inline-edit-meta">
                        <span><i class="fas fa-calendar"></i> Created: ${formatDate(ticket.created_at)}</span>
                        ${ticket.linear_issue_url ? `
                            <a href="${ticket.linear_issue_url}" target="_blank" class="inline-linear-link">
                                <i class="fas fa-external-link-alt"></i> View in Linear
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function enterDetailsEditMode() {
            isDetailsEditMode = true;
            const body = document.getElementById('drawerTicketBody');
            showDetailsEditMode(body);
        }

        async function exitDetailsEditMode() {
            // Blur any focused element to trigger onchange for any pending edits
            if (document.activeElement) {
                document.activeElement.blur();
            }
            // Small delay to allow any pending saves to complete
            await new Promise(resolve => setTimeout(resolve, 100));

            isDetailsEditMode = false;
            const body = document.getElementById('drawerTicketBody');
            showDetailsReadMode(body);
            // Update kanban board if in board view
            if (currentViewMode === 'board') {
                populateKanbanBoard();
            }
            // Also update the list view if visible
            if (currentViewMode === 'list') {
                updateTicketInList(currentTicket);
            }
        }

        // Delete the current ticket
        async function deleteCurrentTicket() {
            if (!currentTicket || !currentProjectId) return;

            const ticketName = currentTicket.name || `Ticket #${currentTicket.id}`;
            if (!confirm(`Are you sure you want to delete "${ticketName}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${currentProjectId}/api/checklist/${currentTicket.id}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Close the drawer
                    closeTicketDrawer();

                    // Remove from tickets array
                    const ticketIndex = tickets.findIndex(t => t.id === currentTicket.id);
                    if (ticketIndex > -1) {
                        tickets.splice(ticketIndex, 1);
                    }

                    // Update the view
                    if (currentViewMode === 'board') {
                        populateKanbanBoard();
                    } else {
                        // Remove from list view
                        const row = document.querySelector(`tr[data-ticket-id="${currentTicket.id}"]`);
                        if (row) row.remove();
                    }

                    // Show success notification
                    if (typeof showNotification === 'function') {
                        showNotification('Ticket deleted successfully', 'success');
                    }
                } else {
                    alert('Failed to delete ticket: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting ticket:', error);
                alert('Error deleting ticket: ' + error.message);
            }
        }

        // Update a ticket row in the list view
        function updateTicketInList(ticket) {
            const row = document.querySelector(`tr[data-ticket-id="${ticket.id}"]`);
            if (!row) return;

            // Update the name cell
            const nameCell = row.querySelector('.ticket-name');
            if (nameCell) nameCell.textContent = ticket.name;

            // Update status badge
            const statusCell = row.querySelector('.status-badge');
            if (statusCell) {
                statusCell.className = `status-badge status-${ticket.status}`;
                statusCell.textContent = formatStatus(ticket.status);
            }

            // Update priority badge
            const priorityCell = row.querySelector('.priority-badge');
            if (priorityCell) {
                priorityCell.className = `priority-badge priority-${ticket.priority?.toLowerCase()}`;
                priorityCell.textContent = ticket.priority || 'Medium';
            }
        }

        // Save inline field changes
        async function saveInlineField(field, value) {
            if (!currentTicket || !currentProjectId) return;

            const payload = {
                item_id: currentTicket.id,
                [field]: value
            };

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                const response = await fetch(`/projects/${currentProjectId}/api/checklist/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    // Update currentTicket with new value
                    currentTicket[field] = value;

                    // Update drawer title if name changed
                    if (field === 'name') {
                        const drawerTitle = document.querySelector('.drawer-title');
                        if (drawerTitle) {
                            drawerTitle.textContent = `TKT-${currentTicket.id}: ${value}`;
                        }
                    }

                    // Update kanban board if in board view
                    if (currentViewMode === 'board') {
                        populateKanbanBoard();
                    }

                    // Show subtle success feedback
                    showInlineSaveSuccess();
                } else {
                    console.error('Failed to save:', data.error);
                    showInlineSaveError(data.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error saving field:', error);
                showInlineSaveError('Network error');
            }
        }

        function showInlineSaveSuccess() {
            // Brief visual feedback that save succeeded
            const indicator = document.createElement('div');
            indicator.className = 'inline-save-indicator success';
            indicator.innerHTML = '<i class="fas fa-check"></i> Saved';
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 1500);
        }

        function showInlineSaveError(message) {
            const indicator = document.createElement('div');
            indicator.className = 'inline-save-indicator error';
            indicator.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 3000);
        }

        async function showLogsTab(body) {
            // Show loading state
            body.innerHTML = `
                <div class="drawer-tab-content logs-tab-content">
                    <div class="empty-logs">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                        <p style="color: var(--text-secondary); margin-top: 1rem;">Loading execution logs...</p>
                    </div>
                </div>
            `;

            // Fetch ticket logs
            if (!currentTicket || !currentProjectId) {
                body.innerHTML = `
                    <div class="drawer-tab-content logs-tab-content">
                        <div class="empty-logs">
                            <i class="fas fa-terminal" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                            <p style="color: var(--text-secondary); margin-top: 1rem;">No execution logs available.</p>
                        </div>
                    </div>
                `;
                return;
            }

            try {
                // Add cache-busting parameter to avoid stale data
                const cacheBuster = new Date().getTime();
                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/logs/?_=${cacheBuster}`);
                const data = await response.json();

                console.log(`[LOGS] Loaded ${data.commands?.length || 0} logs for ticket ${currentTicket.id}`);

                // Log breakdown by type for debugging
                if (data.commands && data.commands.length > 0) {
                    const typeBreakdown = data.commands.reduce((acc, cmd) => {
                        acc[cmd.log_type || 'unknown'] = (acc[cmd.log_type || 'unknown'] || 0) + 1;
                        return acc;
                    }, {});
                    console.log('[LOGS] Type breakdown:', typeBreakdown);
                }

                // Build the logs HTML (oldest first, latest at bottom)
                let logsHtml = '';
                if (data.commands && data.commands.length > 0) {
                    // Keep original order (oldest first)
                    const commands = data.commands;
                    logsHtml = commands.map((cmd, index) => renderLogEntry(cmd, index)).join('');
                }

                // Build git status one-liner if available
                let gitStatusHtml = '';
                if (currentTicket.github_branch) {
                    const branchName = currentTicket.github_branch;
                    const mergeStatus = currentTicket.github_merge_status;
                    const commitSha = currentTicket.github_commit_sha;

                    let mergeIcon, mergeText, mergeClass;
                    if (mergeStatus === 'merged') {
                        mergeIcon = 'fa-check-circle';
                        mergeText = 'Merged to lfg-agent';
                        mergeClass = 'git-merged';
                    } else if (mergeStatus === 'conflict') {
                        mergeIcon = 'fa-exclamation-triangle';
                        mergeText = 'Merge conflict';
                        mergeClass = 'git-conflict';
                    } else if (mergeStatus === 'failed') {
                        mergeIcon = 'fa-times-circle';
                        mergeText = 'Merge failed';
                        mergeClass = 'git-failed';
                    } else {
                        mergeIcon = 'fa-clock';
                        mergeText = 'Pending merge';
                        mergeClass = 'git-pending';
                    }

                    gitStatusHtml = `
                        <div class="git-status-banner ${mergeClass}">
                            <span class="git-branch"><i class="fas fa-code-branch"></i> ${escapeHtml(branchName)}</span>
                            ${commitSha ? `<span class="git-commit"><i class="fas fa-code-commit"></i> ${escapeHtml(commitSha.substring(0, 7))}</span>` : ''}
                            <span class="git-merge-status"><i class="fas ${mergeIcon}"></i> ${mergeText}</span>
                        </div>
                    `;
                }

                // Display logs with chat input at bottom
                body.innerHTML = `
                    <div class="drawer-tab-content logs-tab-content">
                        ${gitStatusHtml}
                        <div class="execution-logs-container" id="executionLogsContainer">
                            <h4><i class="fas fa-terminal"></i> Command History</h4>
                            ${logsHtml || '<p class="no-logs-message" style="color: var(--text-secondary); font-size: 0.875rem; padding: 1rem 0;">No execution logs yet. Logs will appear here after the ticket is executed.</p>'}
                        </div>
                        <div class="logs-chat-container">
                            <div id="aiTypingIndicatorSlot"></div>
                            <div class="logs-chat-attachments" id="logsChatAttachments"></div>
                            <div class="logs-chat-input-wrapper">
                                <input type="file" id="logsChatFileInput" style="display: none;" multiple onchange="handleLogsChatFileSelect(event)">
                                <div class="logs-chat-field">
                                    <button class="logs-chat-attach-btn" onclick="document.getElementById('logsChatFileInput').click()" title="Attach files">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <textarea
                                        id="logsChatInput"
                                        class="logs-chat-input"
                                        placeholder="Message AI assistant..."
                                        rows="1"
                                        onkeydown="handleLogsChatKeydown(event)"
                                    ></textarea>
                                    <div class="logs-chat-actions">
                                        <button class="logs-chat-send-btn" id="logsChatSendBtn" onclick="sendLogsChatMessage()" title="Send message">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                        <button class="stop-execution-btn logs-chat-stop-btn" id="logsChatStopBtn" onclick="stopExecution(event)" title="Stop AI execution">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                updateSendStopButtons();

                // Process any pending logs that arrived while on other tabs
                if (pendingLogs.length > 0) {
                    console.log(`Processing ${pendingLogs.length} pending logs`);
                    pendingLogs.forEach(log => handleNewLog(log));
                    pendingLogs = [];
                }

                // Restore typing indicator if AI is currently processing
                // But not if the agent already responded (post-processing like git commit may still be running)
                if (data.is_ai_processing) {
                    const lastLog = data.commands && data.commands.length > 0 ? data.commands[data.commands.length - 1] : null;
                    const lastLogType = lastLog ? lastLog.log_type : null;
                    if (lastLogType !== 'ai_response' && lastLogType !== 'git' && lastLogType !== 'chat_complete') {
                        console.log('[LOGS] AI is currently processing, showing typing indicator');
                        showAiTypingIndicator();
                    } else {
                        console.log('[LOGS] AI processing flag set but agent already responded, skipping indicator');
                    }
                }

                // Scroll to bottom to show latest logs
                scrollLogsToBottom();

                // Connect to WebSocket for real-time log updates (if not already connected)
                if (!ticketLogsWebSocket || ticketLogsWebSocket.readyState !== WebSocket.OPEN) {
                    connectTicketLogsWebSocket(currentTicket.id);
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                body.innerHTML = `
                    <div class="drawer-tab-content logs-tab-content">
                        <div class="empty-logs">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--error-color); opacity: 0.5;"></i>
                            <p style="color: var(--text-secondary); margin-top: 1rem;">Error loading execution logs.</p>
                        </div>
                    </div>
                `;
            }
        }

        async function showTasksTab(body) {
            // Show loading state
            body.innerHTML = `
                <div class="drawer-tab-content">
                    <div class="empty-logs">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                        <p style="color: var(--text-secondary); margin-top: 1rem;">Loading tasks...</p>
                    </div>
                </div>
            `;

            if (!currentTicket || !currentProjectId) {
                body.innerHTML = `
                    <div class="drawer-tab-content">
                        <div class="empty-logs">
                            <i class="fas fa-list-check" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                            <p style="color: var(--text-secondary); margin-top: 1rem;">No tasks available.</p>
                        </div>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/tasks/`);
                const data = await response.json();

                const tasks = data.tasks || (currentTicket.acceptance_criteria || []);

                if (tasks.length === 0) {
                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="empty-logs">
                                <i class="fas fa-list-check" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                                <p style="color: var(--text-secondary); margin-top: 1rem;">No tasks defined for this ticket.</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Check if tasks have structured data (from ProjectTaskList model) or are simple strings
                    const isStructuredTasks = tasks.length > 0 && typeof tasks[0] === 'object';

                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="tasks-list">
                                ${tasks.map((task, index) => {
                                    if (isStructuredTasks) {
                                        const taskStatus = task.status || 'pending';
                                        const taskText = task.description || 'Unnamed task';
                                        return `
                                            <div class="task-item ${taskStatus}">
                                                <input type="checkbox" id="task-${task.id || index}"
                                                       class="task-checkbox"
                                                       disabled>
                                                <label for="task-${task.id || index}" class="task-label">
                                                    ${escapeHtml(taskText)}
                                                </label>
                                            </div>
                                        `;
                                    } else {
                                        // Simple string tasks from acceptance_criteria
                                        return `
                                            <div class="task-item pending">
                                                <input type="checkbox" id="task-${index}" class="task-checkbox" disabled>
                                                <label for="task-${index}" class="task-label">${escapeHtml(task)}</label>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                // Fallback to acceptance criteria
                const tasks = currentTicket.acceptance_criteria || [];
                if (tasks.length === 0) {
                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="empty-logs">
                                <i class="fas fa-list-check" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                                <p style="color: var(--text-secondary); margin-top: 1rem;">No tasks defined for this ticket.</p>
                            </div>
                        </div>
                    `;
                } else {
                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="tasks-list">
                                ${tasks.map((task, index) => `
                                    <div class="task-item pending">
                                        <input type="checkbox" id="task-${index}" class="task-checkbox" disabled>
                                        <label for="task-${index}" class="task-label">${escapeHtml(task)}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
        }

        function showTicketModal(ticket) {
            console.log('showTicketModal called with ticket:', ticket);

            // Disconnect existing WebSocket if switching to a different ticket
            if (currentTicket && currentTicket.id !== ticket.id) {
                disconnectTicketLogsWebSocket();
                pendingLogs = [];
            }

            currentTicket = ticket;
            currentProjectId = ticket.project_id;
            isDetailsEditMode = false; // Reset edit mode when opening a new ticket
            setAiProcessingState(false);

            // Reset the execute button state based on this ticket's queue status
            const executeBtn = document.getElementById('executeTicketBtn');
            if (executeBtn) {
                const queueStatus = ticket.queue_status || 'none';
                if (queueStatus === 'executing') {
                    executeBtn.disabled = false;
                    executeBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Build';
                    executeBtn.classList.add('stop-mode');
                } else if (queueStatus === 'queued') {
                    executeBtn.disabled = false;
                    executeBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Queue';
                    executeBtn.classList.add('stop-mode');
                } else {
                    executeBtn.disabled = false;
                    const hasBeenBuilt = ticket.has_logs || ticket.last_execution_at;
                    executeBtn.innerHTML = hasBeenBuilt
                        ? '<i class="fas fa-play"></i> Continue'
                        : '<i class="fas fa-hammer"></i> Build Ticket';
                    executeBtn.classList.remove('stop-mode');
                }
            }

            const drawer = document.getElementById('ticketDrawer');
            const overlay = document.getElementById('ticketDrawerOverlay');
            const title = document.getElementById('drawerTicketTitle');

            console.log('Drawer elements:', {drawer, overlay, title});

            if (!drawer || !overlay) {
                console.error('Drawer elements not found!');
                return;
            }

            title.textContent = `TKT-${ticket.id}: ${ticket.name}`;

            // Determine which tab to open - Actions tab if ticket is being worked on OR has existing logs
            const queueStatus = ticket.queue_status || 'none';
            const hasLogs = ticket.has_logs || false;
            const defaultTab = (queueStatus === 'executing' || queueStatus === 'queued' || hasLogs) ? 'logs' : 'details';
            currentTab = defaultTab;

            // Reset tabs
            document.querySelectorAll('.drawer-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.drawer-tab[data-tab="${defaultTab}"]`).classList.add('active');

            // Load the default tab
            loadTabContent(defaultTab);

            // Pre-connect WebSocket for this ticket (so messages aren't missed)
            connectTicketLogsWebSocket(ticket.id);

            drawer.classList.add('active');
            overlay.classList.add('active');

            // Save state to localStorage for persistence
            saveTicketState();
        }

        function closeTicketDrawer() {
            // Disconnect WebSocket when closing drawer
            disconnectTicketLogsWebSocket();
            pendingLogs = [];

            const drawer = document.getElementById('ticketDrawer');
            const overlay = document.getElementById('ticketDrawerOverlay');
            drawer.classList.remove('active');
            overlay.classList.remove('active');
            setAiProcessingState(false);
            currentTicket = null;
            currentProjectId = null;
            // Reset edit mode when drawer closes
            isDetailsEditMode = false;

            // Clear saved state when drawer is explicitly closed
            clearTicketState();
        }

        function handleOverlayClick() {
            closeTicketDrawer();
        }

        function closeTicketModal() {
            closeTicketDrawer();
        }

        async function cancelFromQueue(ticketId, projectId) {
            if (!confirm('Remove this ticket from the execution queue?')) {
                return;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${projectId}/api/tickets/${ticketId}/cancel-queue/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();
                if (data.success) {
                    // Update both table and kanban views
                    updateQueueStatusUI(ticketId, 'none');

                    // Show success notification if available
                    if (typeof showNotification === 'function') {
                        showNotification('Ticket removed from queue', 'success');
                    }
                } else {
                    alert('Failed to remove from queue: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error canceling from queue:', error);
                alert('Error removing ticket from queue');
            }
        }

        async function forceStopFromQueue(ticketId, projectId) {
            if (!confirm('Force stop this ticket? Use this if the ticket is stuck and the executor has crashed.')) {
                return;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${projectId}/api/tickets/${ticketId}/force-reset-queue/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();
                if (data.success) {
                    // Update the queue status cell in the table
                    updateQueueStatusUI(ticketId, 'none');

                    // Show success notification if available
                    if (typeof showNotification === 'function') {
                        showNotification('Ticket force stopped', 'success');
                    }
                } else {
                    alert('Failed to force stop: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error force stopping ticket:', error);
                alert('Error force stopping ticket');
            }
        }

        async function restartFromQueue(ticketId, projectId) {
            if (!confirm('Restart this ticket? This will reset its queue status and re-queue it for execution.')) {
                return;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${projectId}/api/tickets/${ticketId}/restart-queue/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        conversation_id: 0
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update the queue status cell in the table
                    updateQueueStatusUI(ticketId, data.queue_status || 'queued');

                    // Show success notification if available
                    if (typeof showNotification === 'function') {
                        showNotification('Ticket restarted and queued', 'success');
                    }
                } else {
                    alert('Failed to restart ticket: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error restarting ticket:', error);
                alert('Error restarting ticket');
            }
        }

        function updateQueueStatusUI(ticketId, queueStatus) {
            // Get project ID from either table cell or kanban card
            const queueCell = document.querySelector(`.queue-status-cell[data-ticket-id="${ticketId}"]`);
            const kanbanCard = document.querySelector(`.kanban-card[data-ticket-id="${ticketId}"]`);
            const projectId = queueCell?.dataset.projectId || kanbanCard?.dataset.projectId || currentProjectId;

            // Update table view
            if (queueCell) {
                queueCell.dataset.queueStatus = queueStatus;

                if (queueStatus === 'queued') {
                    queueCell.innerHTML = `
                        <span class="queue-badge queued">
                            <i class="fas fa-clock"></i> Queued
                        </span>
                        <button class="queue-cancel-btn" onclick="cancelFromQueue(${ticketId}, '${projectId}')" title="Remove from queue">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="queue-restart-btn" onclick="restartFromQueue(${ticketId}, '${projectId}')" title="Restart ticket">
                            <i class="fas fa-redo"></i>
                        </button>
                    `;
                } else if (queueStatus === 'executing') {
                    queueCell.innerHTML = `
                        <span class="queue-badge executing">
                            <i class="fas fa-spinner fa-spin"></i> Executing
                        </span>
                        <button class="queue-force-stop-btn" onclick="forceStopFromQueue(${ticketId}, '${projectId}')" title="Force stop (use if stuck)">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button class="queue-restart-btn" onclick="restartFromQueue(${ticketId}, '${projectId}')" title="Force restart">
                            <i class="fas fa-redo"></i>
                        </button>
                    `;
                } else {
                    queueCell.innerHTML = '<span class="queue-badge none">-</span>';
                }
            }

            // Update kanban board view
            if (kanbanCard) {
                let queueDiv = kanbanCard.querySelector('.kanban-card-queue');

                if (queueStatus === 'queued' || queueStatus === 'executing') {
                    const statusText = queueStatus === 'queued' ? 'Queued' : 'Executing';
                    const icon = queueStatus === 'queued' ? 'fa-clock' : 'fa-cog fa-spin';
                    const badgeClass = queueStatus;

                    if (!queueDiv) {
                        queueDiv = document.createElement('div');
                        queueDiv.className = 'kanban-card-queue';
                        queueDiv.setAttribute('onclick', 'event.stopPropagation();');
                        kanbanCard.appendChild(queueDiv);
                    }

                    queueDiv.innerHTML = `
                        <span class="queue-badge ${badgeClass}">
                            <i class="fas ${icon}"></i> ${statusText}
                        </span>
                        <button class="queue-cancel-btn" onclick="event.stopPropagation(); cancelFromQueue(${ticketId}, '${projectId}')" title="Remove from queue">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="queue-restart-btn" onclick="event.stopPropagation(); restartTicket(${ticketId}, '${projectId}')" title="Restart">
                            <i class="fas fa-redo"></i>
                        </button>
                    `;
                } else if (queueDiv) {
                    queueDiv.remove();
                }
            }
        }

        function updateDetailPanelQueueStatus(queueStatus) {
            // Update the queue status indicator in the detail panel
            const metaRow = document.querySelector('.detail-meta-row');
            if (!metaRow) return;

            // Remove existing queue status
            const existingStatus = metaRow.querySelector('.detail-queue-status');
            if (existingStatus) {
                existingStatus.remove();
            }

            // Add new queue status if not 'none'
            if (queueStatus && queueStatus !== 'none') {
                const priorityLabel = metaRow.querySelector('.priority-label');
                if (priorityLabel) {
                    const queueDiv = document.createElement('div');
                    queueDiv.className = 'detail-queue-status';
                    queueDiv.id = 'detailQueueStatus';

                    const isExecuting = queueStatus === 'executing';
                    queueDiv.innerHTML = `
                        <span class="queue-badge ${queueStatus}">
                            <i class="fas fa-${isExecuting ? 'spinner fa-spin' : 'clock'}"></i>
                            ${isExecuting ? 'Building' : 'Queued'}
                        </span>
                        <button class="queue-cancel-btn" onclick="event.stopPropagation(); ${isExecuting ? 'stopBuild()' : 'cancelBuild()'}" title="${isExecuting ? 'Stop build' : 'Remove from queue'}">
                            <i class="fas fa-${isExecuting ? 'stop' : 'times'}"></i>
                        </button>
                    `;

                    priorityLabel.insertAdjacentElement('afterend', queueDiv);
                }
            }
        }

        async function updateTicketFromTable(selectElement, field) {
            const ticketId = selectElement.dataset.ticketId;
            const projectId = selectElement.dataset.projectId;
            const value = selectElement.value;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${projectId}/api/checklist/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        item_id: parseInt(ticketId),
                        [field]: value
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update the row data attributes
                    const row = selectElement.closest('tr');
                    if (row) {
                        row.dataset[field] = value;
                    }

                    // Update the select element's data attribute for color coding
                    if (field === 'status') {
                        selectElement.dataset.status = value;
                    } else if (field === 'priority') {
                        selectElement.dataset.priority = value;
                    }

                    // If drawer is open for this ticket, update it too
                    if (currentTicket && currentTicket.id === parseInt(ticketId)) {
                        currentTicket[field] = value;
                        const drawerSelect = document.getElementById(field === 'status' ? 'ticketStatus' : 'ticketPriority');
                        if (drawerSelect) {
                            drawerSelect.value = value;
                        }
                    }
                } else {
                    alert('Failed to update ticket: ' + (data.error || 'Unknown error'));
                    // Revert the select to previous value
                    const row = selectElement.closest('tr');
                    if (row) {
                        selectElement.value = row.dataset[field];
                    }
                }
            } catch (error) {
                console.error('Error updating ticket:', error);
                alert('Error updating ticket');
                // Revert the select to previous value
                const row = selectElement.closest('tr');
                if (row) {
                    selectElement.value = row.dataset[field];
                }
            }
        }

        async function updateTicketField(field, value) {
            if (!currentTicket || !currentProjectId) return;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${currentProjectId}/api/checklist/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        item_id: currentTicket.id,
                        [field]: value
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update the current ticket object
                    currentTicket[field] = value;

                    // Update the drawer select's data attribute for color coding
                    const drawerSelect = document.getElementById(field === 'status' ? 'ticketStatus' : 'ticketPriority');
                    if (drawerSelect) {
                        if (field === 'status') {
                            drawerSelect.setAttribute('data-status', value);
                        } else if (field === 'priority') {
                            drawerSelect.setAttribute('data-priority', value);
                        }
                    }

                    // Update the table row
                    const row = document.querySelector(`tr[data-ticket-id="${currentTicket.id}"]`);
                    if (row) {
                        row.dataset[field] = value;

                        // Update the select in the table
                        const selectClass = field === 'status' ? '.status-select' : '.priority-select';
                        const select = row.querySelector(selectClass);
                        if (select) {
                            select.value = value;
                            // Update data attribute for color coding
                            if (field === 'status') {
                                select.setAttribute('data-status', value);
                            } else if (field === 'priority') {
                                select.setAttribute('data-priority', value);
                            }
                        }
                    }
                } else {
                    alert('Failed to update ticket: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating ticket:', error);
                alert('Error updating ticket');
            }
        }

        // Handle click on the execute/stop button based on current state
        async function handleExecuteButtonClick() {
            if (!currentTicket || !currentProjectId) return;

            const queueStatus = currentTicket.queue_status || 'none';

            if (queueStatus === 'executing') {
                // Stop the build
                await stopBuild();
            } else if (queueStatus === 'queued') {
                // Cancel from queue
                await cancelBuild();
            } else {
                // Start build
                await executeTicket();
            }
        }

        async function stopBuild() {
            if (!currentTicket || !currentProjectId) return;

            const btn = document.getElementById('executeTicketBtn');
            if (!btn) return;

            if (!confirm('Stop this build? This will force stop the current execution.')) {
                return;
            }

            // Show stopping state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${currentProjectId}/api/tickets/${currentTicket.id}/force-reset-queue/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();
                if (data.success) {
                    // Update queue status
                    updateQueueStatusUI(currentTicket.id, 'none');
                    currentTicket.queue_status = 'none';

                    // Reset button to build state
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-hammer"></i> Build Ticket';
                    btn.classList.remove('stop-mode');

                    if (typeof showNotification === 'function') {
                        showNotification('Build stopped', 'success');
                    }
                } else {
                    alert('Failed to stop build: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-stop"></i> Stop Build';
                }
            } catch (error) {
                console.error('Error stopping build:', error);
                alert('Error stopping build: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-stop"></i> Stop Build';
            }
        }

        async function cancelBuild() {
            if (!currentTicket || !currentProjectId) return;

            const btn = document.getElementById('executeTicketBtn');
            if (!btn) return;

            // Show canceling state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Canceling...';

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${currentProjectId}/api/tickets/${currentTicket.id}/cancel-queue/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();
                if (data.success) {
                    // Update queue status
                    updateQueueStatusUI(currentTicket.id, 'none');
                    currentTicket.queue_status = 'none';

                    // Reset button to build state
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-hammer"></i> Build Ticket';
                    btn.classList.remove('stop-mode');

                    if (typeof showNotification === 'function') {
                        showNotification('Build canceled', 'success');
                    }
                } else {
                    alert('Failed to cancel: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-times"></i> Cancel Queue';
                }
            } catch (error) {
                console.error('Error canceling build:', error);
                alert('Error canceling build: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-times"></i> Cancel Queue';
            }
        }

        async function executeTicket(force = false) {
            if (!currentTicket || !currentProjectId) return;

            const btn = document.getElementById('executeTicketBtn');
            if (!btn) return;

            // Disable button and show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${currentProjectId}/api/tickets/${currentTicket.id}/execute/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        ticket_id: currentTicket.id,
                        conversation_id: ticketConversationId,
                        force: force  // Force clear stale locks if true
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update queue status in the table
                    const queueStatus = data.queue_status || 'queued';
                    updateQueueStatusUI(currentTicket.id, queueStatus);

                    // Update button to reflect actual queue status (now stoppable)
                    btn.disabled = false;
                    if (queueStatus === 'executing') {
                        btn.innerHTML = '<i class="fas fa-stop"></i> Stop Build';
                        btn.classList.add('stop-mode');
                    } else if (queueStatus === 'queued') {
                        btn.innerHTML = '<i class="fas fa-times"></i> Cancel Queue';
                        btn.classList.add('stop-mode');
                    }

                    // Update currentTicket's queue_status so it persists when reopening
                    currentTicket.queue_status = queueStatus;

                    // Switch to Logs tab to show execution progress
                    switchDrawerTab('logs');
                } else {
                    // Check if it's a lock/execution conflict error - offer to force restart
                    const errorMsg = data.error || 'Unknown error';
                    if (errorMsg.includes('still executing') || errorMsg.includes('already queued') || errorMsg.includes('already executing')) {
                        if (confirm('A previous execution may be stuck. Do you want to force restart?\n\nThis will clear the stale lock and start fresh.')) {
                            // Retry with force=true
                            return executeTicket(true);
                        }
                    } else {
                        alert('Failed to execute ticket: ' + errorMsg);
                    }
                    // Re-enable button
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-hammer"></i> Build Ticket';
                    btn.classList.remove('stop-mode');
                }
            } catch (error) {
                console.error('Error executing ticket:', error);
                alert('Error executing ticket: ' + error.message);
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-hammer"></i> Build Ticket';
                btn.classList.remove('stop-mode');
            }
        }

        // Helper functions
        function formatStatus(status) {
            return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatComplexity(complexity) {
            const labels = {
                'simple': 'Simple',
                'medium': 'Medium Complexity',
                'complex': 'Complex'
            };
            return labels[complexity] || complexity || 'Medium Complexity';
        }

        function formatDate(dateString) {
            if (!dateString) return 'â€”';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function formatFileSizeHuman(bytes) {
            if (bytes === null || bytes === undefined || isNaN(bytes)) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(size === Math.floor(size) ? 0 : 1)} ${units[unitIndex]}`;
        }

        function formatExecutionTime(seconds) {
            if (!seconds || seconds <= 0) return '0s';

            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function sanitizeHtml(html) {
            if (!html) return '';
            const temp = document.createElement('div');
            temp.innerHTML = html;
            temp.querySelectorAll('script, style').forEach(el => el.remove());
            temp.querySelectorAll('*').forEach(el => {
                Array.from(el.attributes).forEach(attr => {
                    const name = attr.name.toLowerCase();
                    const value = (attr.value || '').trim().toLowerCase();
                    if (name.startsWith('on')) {
                        el.removeAttribute(attr.name);
                    } else if ((name === 'href' || name === 'src') && value.startsWith('javascript:')) {
                        el.removeAttribute(attr.name);
                    }
                });
            });
            return temp.innerHTML;
        }

        function renderMarkdown(content) {
            if (!content) return '';
            if (typeof marked === 'undefined') {
                return `<pre>${escapeHtml(content)}</pre>`;
            }
            try {
                const rendered = marked.parse(content);
                return sanitizeHtml(rendered);
            } catch (error) {
                console.error('Error rendering markdown:', error);
                return `<pre>${escapeHtml(content)}</pre>`;
            }
        }

        let previewContent = null; // Cache the preview content
        let shouldAutoStartPreview = true;
        let lastDevServerUrl = null;

        function getPreviewLoadingMarkup(primaryText = 'Loading preview...', secondaryText = "We'll automatically restart the dev server if needed.") {
            return `
                <div class="preview-loading-state" style="
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    height: 100%;
                    color: var(--text-secondary);
                    text-align: center;
                    padding: 2rem;
                ">
                    <i class="fas fa-spinner fa-spin" style="font-size: 1.75rem; opacity: 0.7; margin-bottom: 1rem; color: var(--primary-color, #8b5cf6);"></i>
                    <p style="font-size: 0.95rem; margin: 0;">${primaryText}</p>
                    <p style="font-size: 0.8rem; opacity: 0.65; margin-top: 0.35rem;">${secondaryText}</p>
                </div>
            `;
        }

        async function showPreviewTab(body) {
            if (previewContent && isServerRunning) {
                body.innerHTML = previewContent;
                shouldAutoStartPreview = true;
                updatePreviewLaunchButton(isServerRunning && !!lastDevServerUrl);
                return;
            }

            body.innerHTML = `
                <div class="drawer-tab-content" style="height: 100%; display: flex; flex-direction: column; padding: 0;">
                    <div class="preview-container" style="height: 100%; display: flex; flex-direction: column;">
                        <div class="preview-body" id="previewBody" style="flex: 1; position: relative; background: var(--surface-primary, #0d0d0d);">
                            ${getPreviewLoadingMarkup()}
                        </div>
                    </div>
                </div>
            `;

            if (shouldAutoStartPreview) {
                startDevServer();
            }
            shouldAutoStartPreview = true;
            updatePreviewLaunchButton(false);
        }

        // ============================================
        // GIT TAB FUNCTIONS
        // ============================================

        async function showGitTab(body) {
            const ticket = currentTicket;
            if (!ticket) {
                body.innerHTML = '<div class="drawer-tab-content"><p>No ticket selected</p></div>';
                return;
            }

            // Show loading state
            body.innerHTML = `
                <div class="drawer-tab-content git-tab-content">
                    <div class="git-loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading git status...
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`/projects/${currentProjectId}/api/tickets/${ticket.id}/git-status/`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load git status');
                }

                renderGitTab(body, data);
            } catch (error) {
                console.error('Error loading git status:', error);
                body.innerHTML = `
                    <div class="drawer-tab-content git-tab-content">
                        <div class="git-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Failed to load git status: ${escapeHtml(error.message)}</p>
                            <button class="btn btn-secondary" onclick="showGitTab(document.getElementById('drawerTicketBody'))">
                                <i class="fas fa-refresh"></i> Retry
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function renderGitTab(body, data) {
            const ticket = currentTicket;
            const branch = data.branch || ticket.github_branch;
            const mergeStatus = data.merge_status || 'pending';
            const commitSha = data.commit_sha;
            const mergeCommitSha = data.merge_commit_sha || ticket.github_merge_commit_sha;
            const repoUrl = data.repo_url || '';
            const branchUrl = data.branch_url || '';
            const lfgAgentUrl = data.lfg_agent_url || '';
            const commitUrl = data.commit_url || '';
            const repoName = data.github_repo || '';
            const hasUncommittedChanges = data.has_uncommitted_changes || false;
            const uncommittedFiles = data.uncommitted_files || [];
            const recentCommits = data.recent_commits || [];
            const revertedAt = data.reverted_at || null;
            const revertedBy = data.reverted_by || null;

            // Build the git tree visualization
            const isMerged = mergeStatus === 'merged';
            const isReverted = mergeStatus === 'reverted';
            const hasConflict = mergeStatus === 'conflict';
            const hasFailed = mergeStatus === 'failed';

            // Build commits list HTML
            let commitsHtml = '';
            if (recentCommits.length > 0) {
                commitsHtml = `
                    <div class="git-tree-commits">
                        ${recentCommits.map((commit, idx) => {
                            const parts = commit.split(' ');
                            const sha = parts[0] || '';
                            const msg = parts.slice(1).join(' ') || '';
                            return `
                                <div class="git-tree-commit">
                                    <div class="git-tree-commit-dot ${idx === 0 ? 'latest' : ''}"></div>
                                    <div class="git-tree-commit-info">
                                        <code class="git-tree-sha">${escapeHtml(sha.substring(0, 7))}</code>
                                        <span class="git-tree-msg">${escapeHtml(msg)}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            // Build uncommitted files section
            let uncommittedHtml = '';
            if (hasUncommittedChanges && uncommittedFiles.length > 0) {
                uncommittedHtml = `
                    <div class="git-uncommitted-section">
                        <div class="git-uncommitted-header">
                            <i class="fas fa-exclamation-circle"></i> Uncommitted Changes
                        </div>
                        <div class="git-uncommitted-files">
                            ${uncommittedFiles.slice(0, 10).map(file => `
                                <div class="git-uncommitted-file">
                                    <span class="git-file-status">${escapeHtml(file.substring(0, 2))}</span>
                                    <span class="git-file-path">${escapeHtml(file.substring(3))}</span>
                                </div>
                            `).join('')}
                            ${uncommittedFiles.length > 10 ? `<div class="git-uncommitted-more">... and ${uncommittedFiles.length - 10} more files</div>` : ''}
                        </div>
                    </div>
                `;
            }

            body.innerHTML = `
                <div class="drawer-tab-content git-tab-content">
                    <div class="git-tree-container">
                        <!-- Repository Header -->
                        <div class="git-tree-header">
                            <i class="fab fa-github"></i>
                            ${repoUrl ? `<a href="${repoUrl}" target="_blank" rel="noopener">${escapeHtml(repoName || 'Repository')}</a>` : '<span class="git-not-set">Repository not configured</span>'}
                        </div>

                        <!-- Git Tree Visualization -->
                        <div class="git-tree">
                            <!-- lfg-agent branch -->
                            <div class="git-tree-branch git-tree-main">
                                <div class="git-tree-branch-line"></div>
                                <div class="git-tree-branch-node ${isMerged ? 'merged' : ''}">
                                    <div class="git-tree-branch-dot"></div>
                                    <div class="git-tree-branch-info">
                                        <span class="git-tree-branch-name">
                                            ${lfgAgentUrl ? `<a href="${lfgAgentUrl}" target="_blank" rel="noopener">lfg-agent</a>` : 'lfg-agent'}
                                        </span>
                                        <span class="git-tree-branch-label main">main integration</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Merge indicator -->
                            <div class="git-tree-merge ${isMerged ? 'merged' : isReverted ? 'reverted' : hasConflict ? 'conflict' : hasFailed ? 'failed' : 'pending'}">
                                <div class="git-tree-merge-line"></div>
                                <div class="git-tree-merge-status">
                                    ${isMerged ? '<i class="fas fa-check-circle"></i> Merged' :
                                      isReverted ? '<i class="fas fa-undo-alt"></i> Reverted' :
                                      hasConflict ? '<i class="fas fa-exclamation-triangle"></i> Conflict' :
                                      hasFailed ? '<i class="fas fa-times-circle"></i> Failed' :
                                      '<i class="fas fa-clock"></i> Pending'}
                                </div>
                            </div>

                            <!-- Feature branch -->
                            <div class="git-tree-branch git-tree-feature">
                                <div class="git-tree-branch-line"></div>
                                <div class="git-tree-branch-node">
                                    <div class="git-tree-branch-dot feature"></div>
                                    <div class="git-tree-branch-info">
                                        <span class="git-tree-branch-name">
                                            ${branch ? (branchUrl ? `<a href="${branchUrl}" target="_blank" rel="noopener">${escapeHtml(branch)}</a>` : escapeHtml(branch)) : '<span class="git-not-set">No branch assigned</span>'}
                                        </span>
                                        <span class="git-tree-branch-label feature">feature branch</span>
                                    </div>
                                </div>

                                <!-- Commits on feature branch -->
                                ${commitsHtml}

                                <!-- Last commit info -->
                                ${commitSha ? `
                                    <div class="git-tree-last-commit">
                                        <span class="git-tree-last-label">Last pushed:</span>
                                        ${commitUrl ? `<a href="${commitUrl}" target="_blank" rel="noopener"><code>${escapeHtml(commitSha.substring(0, 7))}</code></a>` : `<code>${escapeHtml(commitSha.substring(0, 7))}</code>`}
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Uncommitted changes -->
                        ${uncommittedHtml}

                        <!-- Commit Details Section (for merged or reverted tickets) -->
                        ${(isMerged || isReverted) && mergeCommitSha ? `
                            <div class="git-commit-details-section">
                                <div class="git-section-header" onclick="toggleCommitDetails()">
                                    <i class="fas fa-file-code"></i>
                                    <span>Commit Details</span>
                                    <i class="fas fa-chevron-down" id="commitDetailsChevron"></i>
                                </div>
                                <div class="git-commit-details" id="commitDetailsContent" style="display: none;">
                                    <div class="git-loading-inline">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Reverted info banner -->
                        ${isReverted ? `
                            <div class="git-reverted-banner">
                                <i class="fas fa-undo-alt"></i>
                                <span>Merge was reverted${revertedBy ? ` by ${escapeHtml(revertedBy)}` : ''}${revertedAt ? ` on ${new Date(revertedAt).toLocaleDateString()}` : ''}</span>
                            </div>
                        ` : ''}

                        <!-- Actions -->
                        <div class="git-tree-actions">
                            ${(!isMerged && !isReverted) || hasUncommittedChanges ? `
                                <button class="btn btn-primary" onclick="pushToLfgAgent()" id="pushToLfgAgentBtn">
                                    <i class="fas fa-code-branch"></i> Push & Merge to lfg-agent
                                </button>
                            ` : isMerged && !hasUncommittedChanges ? `
                                <div class="git-tree-success">
                                    <i class="fas fa-check-circle"></i> All changes merged to lfg-agent
                                </div>
                                ${mergeCommitSha ? `
                                    <button class="btn btn-danger btn-sm" onclick="revertMerge()" id="revertMergeBtn" style="margin-left: 0.5rem;">
                                        <i class="fas fa-undo"></i> Revert Merge
                                    </button>
                                ` : `
                                    <span class="git-revert-unavailable" title="Revert unavailable: This ticket was merged before revert tracking was enabled">
                                        <i class="fas fa-info-circle"></i>
                                    </span>
                                `}
                            ` : isReverted ? `
                                <div class="git-tree-info">
                                    <i class="fas fa-info-circle"></i> Merge was reverted. You can re-merge to include changes again.
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="pushToLfgAgent()" id="pushToLfgAgentBtn" style="margin-left: 0.5rem;">
                                    <i class="fas fa-code-branch"></i> Re-merge to lfg-agent
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary btn-sm" onclick="showGitTab(document.getElementById('drawerTicketBody'))">
                                <i class="fas fa-sync-alt" style="margin-right: 0.375rem;"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function pushToLfgAgent() {
            if (!currentTicket || !currentProjectId) return;

            const btn = document.getElementById('pushToLfgAgentBtn');
            if (!btn) return;

            if (!confirm('This will commit any pending changes, push to the feature branch, and merge into lfg-agent. Continue?')) {
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Pushing...';

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${currentProjectId}/api/tickets/${currentTicket.id}/push-to-lfg-agent/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Refresh the git tab to show updated status
                    showGitTab(document.getElementById('drawerTicketBody'));
                    if (typeof showNotification === 'function') {
                        showNotification('Successfully pushed and merged to lfg-agent', 'success');
                    }
                } else {
                    alert('Push failed: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-upload"></i> Push & Merge to lfg-agent';
                }
            } catch (error) {
                console.error('Error pushing to lfg-agent:', error);
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload"></i> Push & Merge to lfg-agent';
            }
        }

        // Toggle commit details section
        async function toggleCommitDetails() {
            const content = document.getElementById('commitDetailsContent');
            const chevron = document.getElementById('commitDetailsChevron');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
                await loadCommitDetails();
            } else {
                content.style.display = 'none';
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            }
        }

        // Load commit details from API
        async function loadCommitDetails() {
            const content = document.getElementById('commitDetailsContent');
            if (!currentTicket || !currentProjectId) return;

            try {
                const response = await fetch(
                    `/projects/${currentProjectId}/api/tickets/${currentTicket.id}/commit-details/`
                );
                const data = await response.json();

                if (data.success) {
                    content.innerHTML = renderCommitDetails(data);
                } else {
                    content.innerHTML = `
                        <div class="git-error-inline">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${escapeHtml(data.error || 'Failed to load details')}
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="git-error-inline">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error: ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }

        // Render commit details HTML
        function renderCommitDetails(data) {
            const files = data.files || [];
            const stats = data.stats || {};

            return `
                <div class="commit-info">
                    <div class="commit-message">${escapeHtml(data.message || 'No message')}</div>
                    <div class="commit-meta">
                        <span><i class="fas fa-user"></i> ${escapeHtml(data.author?.name || 'Unknown')}</span>
                        <span><i class="fas fa-calendar"></i> ${data.author?.date ? new Date(data.author.date).toLocaleString() : 'Unknown'}</span>
                    </div>
                    <div class="commit-stats">
                        <span class="stat-additions">+${stats.additions || 0}</span>
                        <span class="stat-deletions">-${stats.deletions || 0}</span>
                        <span class="stat-files">${files.length} files changed</span>
                    </div>
                </div>
                <div class="commit-files">
                    <div class="files-header">Changed Files</div>
                    ${files.map(file => `
                        <div class="commit-file ${file.status}">
                            <span class="file-icon">
                                ${file.status === 'added' ? '<i class="fas fa-plus text-success"></i>' :
                                  file.status === 'removed' ? '<i class="fas fa-minus text-danger"></i>' :
                                  '<i class="fas fa-edit text-warning"></i>'}
                            </span>
                            <span class="file-name">${escapeHtml(file.filename)}</span>
                            <span class="file-stats">
                                <span class="additions">+${file.additions}</span>
                                <span class="deletions">-${file.deletions}</span>
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Revert merge
        async function revertMerge() {
            if (!currentTicket || !currentProjectId) return;

            const confirmed = confirm(
                'Are you sure you want to revert this merge?\n\n' +
                'This will create a new commit on lfg-agent that undoes all changes from this ticket. ' +
                'The feature branch will remain intact, and you can re-merge later if needed.'
            );

            if (!confirmed) return;

            const btn = document.getElementById('revertMergeBtn');
            if (!btn) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reverting...';

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(
                    `/projects/${currentProjectId}/api/tickets/${currentTicket.id}/revert-merge/`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    }
                );

                const data = await response.json();

                if (data.success) {
                    if (typeof showNotification === 'function') {
                        showNotification('Merge reverted successfully', 'success');
                    }
                    // Refresh the git tab
                    showGitTab(document.getElementById('drawerTicketBody'));
                    // Update the ticket in our local cache
                    if (currentTicket) {
                        currentTicket.github_merge_status = 'reverted';
                    }
                } else {
                    alert('Revert failed: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-undo"></i> Revert Merge';
                }
            } catch (error) {
                console.error('Error reverting merge:', error);
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-undo"></i> Revert Merge';
            }
        }

        // ============================================
        // SERVER LOGS TAB
        // ============================================

        async function showServerLogsTab(body) {
            const ticket = currentTicket;
            if (!ticket) {
                body.innerHTML = '<div class="empty-state"><p>No ticket selected</p></div>';
                return;
            }

            // Show loading state
            body.innerHTML = `
                <div class="server-logs-container" style="padding: 1rem; height: 100%; display: flex; flex-direction: column;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading server logs...</span>
                    </div>
                </div>
            `;

            await fetchAndRenderServerLogs(body);
        }

        async function fetchAndRenderServerLogs(body, lines = 200) {
            const ticket = currentTicket;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

            try {
                const response = await fetch(`/api/v1/project-tickets/${ticket.id}/dev-server-logs/?lines=${lines}`, {
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch logs');
                }

                renderServerLogsTab(body, data);
            } catch (error) {
                console.error('Error loading server logs:', error);
                body.innerHTML = `
                    <div class="server-logs-container" style="padding: 1rem;">
                        <div class="empty-state" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--warning-color, #f59e0b); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-secondary);">Failed to load server logs: ${escapeHtml(error.message)}</p>
                            <button class="btn btn-secondary" onclick="showServerLogsTab(document.getElementById('drawerTicketBody'))" style="margin-top: 1rem;">
                                <i class="fas fa-sync-alt" style="margin-right: 0.35rem;"></i>Retry
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function renderServerLogsTab(body, data) {
            const { logs, is_running, pid, lines_requested } = data;

            const statusColor = is_running ? 'var(--success-color, #22c55e)' : 'var(--text-secondary, #666)';
            const statusText = is_running ? `Running (PID: ${pid})` : 'Stopped';
            const statusIcon = is_running ? 'fa-circle-check' : 'fa-circle-xmark';

            body.innerHTML = `
                <div class="server-logs-container" style="padding: 1rem; height: 100%; display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Header with status and controls -->
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="display: flex; align-items: center; gap: 0.5rem; color: ${statusColor};">
                                <i class="fas ${statusIcon}"></i>
                                <strong>Dev Server:</strong> ${statusText}
                            </span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="logLinesSelect" onchange="refreshServerLogs()" style="
                                background: var(--surface-secondary, #1a1a1a);
                                border: 1px solid var(--border-color, #333);
                                color: var(--text-primary, #fff);
                                padding: 0.35rem 0.5rem;
                                border-radius: 4px;
                                font-size: 0.8rem;
                            ">
                                <option value="50" ${lines_requested === 50 ? 'selected' : ''}>50 lines</option>
                                <option value="100" ${lines_requested === 100 ? 'selected' : ''}>100 lines</option>
                                <option value="200" ${lines_requested === 200 ? 'selected' : ''}>200 lines</option>
                                <option value="500" ${lines_requested === 500 ? 'selected' : ''}>500 lines</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" onclick="refreshServerLogs()" style="padding: 0.35rem 0.75rem;">
                                <i class="fas fa-sync-alt" style="margin-right: 0.375rem;"></i>Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Log content -->
                    <div style="
                        flex: 1;
                        background: var(--surface-secondary, #0a0a0a);
                        border: 1px solid var(--border-color, #333);
                        border-radius: 6px;
                        overflow: auto;
                        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                        font-size: 0.75rem;
                        line-height: 1.5;
                    ">
                        <pre id="serverLogsContent" style="
                            margin: 0;
                            padding: 1rem;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            color: var(--text-secondary, #ccc);
                        ">${logs ? escapeHtml(logs) : 'No logs available yet. Start the dev server from the Preview tab.'}</pre>
                    </div>

                    <!-- Footer hint -->
                    <div style="font-size: 0.75rem; color: var(--text-tertiary, #666);">
                        <i class="fas fa-info-circle"></i> Logs are from <code style="background: var(--surface-secondary); padding: 0.1rem 0.3rem; border-radius: 3px;">/workspace/project/dev.log</code>
                    </div>
                </div>
            `;

            // Auto-scroll to bottom
            const logsContent = document.getElementById('serverLogsContent');
            if (logsContent) {
                logsContent.parentElement.scrollTop = logsContent.parentElement.scrollHeight;
            }
        }

        function refreshServerLogs() {
            const select = document.getElementById('logLinesSelect');
            const lines = select ? parseInt(select.value) : 200;
            const body = document.getElementById('drawerTicketBody');
            fetchAndRenderServerLogs(body, lines);
        }

        let devServerProcess = null;

        let isServerRunning = false;
        let isStartingDevServer = false;
        let isRestartingDevServer = false;

        async function startDevServer() {
            if (!currentTicket || !currentProjectId) {
                console.error('No ticket selected');
                return;
            }

            if (isStartingDevServer) {
                return;
            }
            isStartingDevServer = true;

            const previewBody = document.getElementById('previewBody');
            updatePreviewLaunchButton(false);

            if (previewBody) {
                previewBody.innerHTML = getPreviewLoadingMarkup('Starting dev server...', 'This usually takes about 20 seconds.');
            }

            try {
                // Kill existing npm processes and start dev server
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/start-dev-server/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        project_id: currentProjectId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to start dev server');
                }

                const data = await response.json();

                // Get the dev server URL from response (supports IPv6)
                const devServerUrl = data.url || 'http://localhost:3000';
                console.log('Dev server started at:', devServerUrl);

                isServerRunning = true;
                lastDevServerUrl = devServerUrl;
                updatePreviewLaunchButton(true);

                if (!previewBody) {
                    console.warn('Preview body element is missing; skipping preview render.');
                    return;
                }

                // Show iframe with preview
                previewBody.innerHTML = `
                    <div style="height: 100%; display: flex; flex-direction: column; position: relative;">
                        <!-- URL Bar with all controls -->
                        <div style="padding: 0.4rem 0.5rem; background: var(--surface-secondary, #1a1a1a); border-bottom: 1px solid var(--border-color, #333); display: flex; align-items: center; gap: 0.5rem;">
                            <input
                                type="text"
                                id="previewUrlInput"
                                value="${devServerUrl}"
                                style="
                                    flex: 1;
                                    background: var(--surface-primary, #0d0d0d);
                                    border: 1px solid var(--border-color, #333);
                                    color: var(--text-primary);
                                    padding: 0.35rem 0.5rem;
                                    border-radius: 4px;
                                    font-size: 0.75rem;
                                    font-family: monospace;
                                    outline: none;
                                "
                                onkeypress="if(event.key === 'Enter') { const iframe = document.getElementById('previewIframe'); iframe.src = this.value; lastDevServerUrl = this.value; updatePreviewLaunchButton(true); }"
                            />
                            <button onclick="document.getElementById('previewIframe').contentWindow.location.reload()" style="
                                background: none;
                                border: 1px solid var(--border-color, #333);
                                color: var(--text-secondary);
                                padding: 0.35rem 0.5rem;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.75rem;
                            " title="Reload">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button id="serverToggleBtn" onclick="toggleDevServer()" style="
                                background: #e74c3c;
                                border: none;
                                color: white;
                                padding: 0.35rem 0.6rem;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.75rem;
                            " title="Stop Server">
                                <i class="fas fa-stop"></i>
                            </button>
                            <button onclick="togglePreviewFullscreen()" style="
                                background: none;
                                border: 1px solid var(--border-color, #333);
                                color: var(--text-secondary);
                                padding: 0.35rem 0.5rem;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.75rem;
                            " title="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>

                        <!-- iframe container -->
                        <div id="iframeContainer" style="flex: 1; position: relative; overflow: hidden;">
                            <iframe
                                id="previewIframe"
                                src="${devServerUrl}"
                                style="width: 100%; height: 100%; border: none; background: white;"
                                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-top-navigation allow-top-navigation-by-user-activation"
                            ></iframe>
                        </div>

                        <!-- Console Panel (hidden by default) -->
                        <div id="consolePanel" style="
                            position: absolute;
                            bottom: 0;
                            left: 0;
                            right: 0;
                            height: 0;
                            background: var(--surface-primary, #0d0d0d);
                            border-top: 1px solid var(--border-color, #333);
                            transition: height 0.3s ease;
                            overflow: hidden;
                            display: flex;
                            flex-direction: column;
                        ">
                            <div style="padding: 0.5rem; border-bottom: 1px solid var(--border-color, #333); display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.75rem; font-weight: 500; color: var(--text-primary);">
                                    <i class="fas fa-terminal"></i> Console Logs
                                </span>
                                <button onclick="toggleConsole()" style="
                                    background: none;
                                    border: none;
                                    color: var(--text-secondary);
                                    cursor: pointer;
                                    padding: 0.25rem;
                                    font-size: 0.75rem;
                                ">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="consoleLogs" style="
                                flex: 1;
                                padding: 0.5rem;
                                overflow-y: auto;
                                font-family: monospace;
                                font-size: 0.7rem;
                                color: var(--text-secondary);
                            ">
                                <div style="opacity: 0.5;">Console logs will appear here...</div>
                            </div>
                        </div>

                        <!-- Console Toggle Button -->
                        <button
                            onclick="toggleConsole()"
                            id="consoleToggleBtn"
                            style="
                                position: absolute;
                                bottom: 0.75rem;
                                right: 0.75rem;
                                background: var(--surface-secondary, #1a1a1a);
                                border: 1px solid var(--border-color, #333);
                                color: var(--text-primary);
                                padding: 0.5rem 0.75rem;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 0.75rem;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                z-index: 10;
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            "
                        >
                            <i class="fas fa-terminal"></i>
                            Console
                        </button>
                    </div>
                `;

                // Monitor iframe URL changes and update URL bar
                const iframe = document.getElementById('previewIframe');
                const urlInput = document.getElementById('previewUrlInput');

                // Function to update URL bar
                function updateUrlBar() {
                    try {
                        const iframeUrl = iframe.contentWindow.location.href;
                        if (iframeUrl && iframeUrl !== 'about:blank') {
                            urlInput.value = iframeUrl;
                            lastDevServerUrl = iframeUrl;
                            updatePreviewLaunchButton(true);
                        }
                    } catch (e) {
                        // Cross-origin or security error - can't read URL
                        // This is expected for external navigation
                    }
                }

                // Listen for iframe load events
                iframe.addEventListener('load', updateUrlBar);

                // Also poll for URL changes (catches client-side routing)
                let lastUrl = '';
                setInterval(() => {
                    try {
                        const currentUrl = iframe.contentWindow.location.href;
                        if (currentUrl !== lastUrl && currentUrl !== 'about:blank') {
                            lastUrl = currentUrl;
                            urlInput.value = currentUrl;
                            lastDevServerUrl = currentUrl;
                            updatePreviewLaunchButton(true);
                        }
                    } catch (e) {
                        // Ignore cross-origin errors
                    }
                }, 500);

                // Cache the preview content so it can be restored when switching tabs
                const drawerBody = document.getElementById('drawerTicketBody');
                if (drawerBody) {
                    previewContent = drawerBody.innerHTML;
                }

            } catch (error) {
                console.error('Error starting dev server:', error);
                isServerRunning = false;

                if (previewBody) {
                    previewBody.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--error-color, #ff4444);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Failed to start dev server</p>
                            <p style="font-size: 0.875rem; opacity: 0.7;">${error.message}</p>
                        </div>
                    `;
                }
            } finally {
                isStartingDevServer = false;
                updatePreviewLaunchButton(isServerRunning && !!lastDevServerUrl);
            }
        }

        async function restartDevServer() {
            if (!currentTicket || !currentProjectId || isRestartingDevServer || isStartingDevServer) {
                return;
            }

            const restartBtn = document.getElementById('restartServerBtn');
            const defaultLabel = 'Restart Server';

            isRestartingDevServer = true;

            if (restartBtn) {
                restartBtn.classList.add('loading');
                restartBtn.innerHTML = '<span class="label-dot"></span> Restarting...';
            }

            if (currentTab !== 'preview') {
                shouldAutoStartPreview = false;
                switchDrawerTab('preview');
            }

            const previewBody = document.getElementById('previewBody');
            if (previewBody) {
                previewBody.innerHTML = getPreviewLoadingMarkup('Restarting dev server...', "We'll bring the browser view back as soon as it is ready.");
            }
            updatePreviewLaunchButton(false);

            try {
                if (isServerRunning) {
                    await stopDevServer();
                }
                await startDevServer();
            } catch (error) {
                console.error('Error restarting dev server:', error);
            } finally {
                isRestartingDevServer = false;
                if (restartBtn) {
                    restartBtn.classList.remove('loading');
                    restartBtn.innerHTML = defaultLabel;
                }
            }
        }

        async function toggleDevServer() {
            if (isServerRunning) {
                await stopDevServer();
            } else {
                await startDevServer();
            }
        }

        function updatePreviewLaunchButton(isEnabled) {
            const btn = document.getElementById('openPreviewBtn');
            if (!btn) return;
            btn.disabled = !isEnabled;
            btn.title = isEnabled ? 'Open preview in a new tab' : 'Preview not available yet';
        }

        function openPreviewInNewTab() {
            const fallbackInput = document.getElementById('previewUrlInput');
            const targetUrl = lastDevServerUrl || (fallbackInput ? fallbackInput.value : '');

            if (targetUrl) {
                window.open(targetUrl, '_blank', 'noopener,noreferrer');
            } else {
                alert('Preview URL is not available yet. Restart the server first.');
            }
        }

        async function stopDevServer() {
            if (!currentTicket) return;

            const serverToggleBtn = document.getElementById('serverToggleBtn');
            const previewBody = document.getElementById('previewBody');

            if (serverToggleBtn) {
                serverToggleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                serverToggleBtn.disabled = true;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/stop-dev-server/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include'
                });

                isServerRunning = false;
                previewContent = null; // Clear cached content when server stops
                updatePreviewLaunchButton(false);

                if (serverToggleBtn) {
                    serverToggleBtn.innerHTML = '<i class="fas fa-play"></i>';
                    serverToggleBtn.disabled = false;
                    serverToggleBtn.style.background = 'var(--accent-color, #4A90E2)';
                    serverToggleBtn.title = 'Start Server';
                }

                if (previewBody) {
                    previewBody.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                            <i class="fas fa-desktop" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <p>Dev server stopped</p>
                            <p style="font-size: 0.875rem; opacity: 0.7;">Use the Restart Server control above to bring it back.</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error stopping dev server:', error);
                if (serverToggleBtn) {
                    serverToggleBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    serverToggleBtn.disabled = false;
                }
            }
        }

        function togglePreviewFullscreen() {
            const previewContainer = document.querySelector('.preview-container');
            const fullscreenBtn = event.currentTarget;

            if (!document.fullscreenElement) {
                // Enter fullscreen
                if (previewContainer.requestFullscreen) {
                    previewContainer.requestFullscreen();
                } else if (previewContainer.webkitRequestFullscreen) {
                    previewContainer.webkitRequestFullscreen();
                } else if (previewContainer.msRequestFullscreen) {
                    previewContainer.msRequestFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.title = 'Exit Fullscreen';
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.title = 'Toggle Fullscreen';
            }
        }

        // Listen for fullscreen changes to update button icon
        document.addEventListener('fullscreenchange', () => {
            const fullscreenBtn = document.querySelector('[onclick="togglePreviewFullscreen()"]');
            if (fullscreenBtn) {
                if (!document.fullscreenElement) {
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                    fullscreenBtn.title = 'Toggle Fullscreen';
                }
            }
        });

        function toggleConsole() {
            const consolePanel = document.getElementById('consolePanel');
            const consoleToggleBtn = document.getElementById('consoleToggleBtn');
            const iframeContainer = document.getElementById('iframeContainer');

            if (!consolePanel || !consoleToggleBtn) return;

            const isOpen = consolePanel.style.height !== '0px' && consolePanel.style.height !== '';

            if (isOpen) {
                // Close console
                consolePanel.style.height = '0';
                consoleToggleBtn.style.display = 'flex';
            } else {
                // Open console (40% of container height)
                consolePanel.style.height = '40%';
                consoleToggleBtn.style.display = 'none';

                // Capture console logs from iframe (if same-origin)
                try {
                    const iframe = document.getElementById('previewIframe');
                    const iframeWindow = iframe.contentWindow;
                    const consoleLogs = document.getElementById('consoleLogs');

                    // Override console methods to capture logs
                    const originalLog = iframeWindow.console.log;
                    const originalError = iframeWindow.console.error;
                    const originalWarn = iframeWindow.console.warn;

                    iframeWindow.console.log = function(...args) {
                        originalLog.apply(iframeWindow.console, args);
                        addConsoleLog('log', args);
                    };

                    iframeWindow.console.error = function(...args) {
                        originalError.apply(iframeWindow.console, args);
                        addConsoleLog('error', args);
                    };

                    iframeWindow.console.warn = function(...args) {
                        originalWarn.apply(iframeWindow.console, args);
                        addConsoleLog('warn', args);
                    };

                    function addConsoleLog(type, args) {
                        const timestamp = new Date().toLocaleTimeString();
                        const message = args.map(arg => {
                            if (typeof arg === 'object') {
                                try {
                                    return JSON.stringify(arg, null, 2);
                                } catch (e) {
                                    return String(arg);
                                }
                            }
                            return String(arg);
                        }).join(' ');

                        const colors = {
                            log: 'var(--text-secondary)',
                            error: '#ff4444',
                            warn: '#ffaa00'
                        };

                        const logEntry = document.createElement('div');
                        logEntry.style.marginBottom = '0.25rem';
                        logEntry.style.paddingBottom = '0.25rem';
                        logEntry.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        logEntry.innerHTML = `
                            <span style="opacity: 0.5; margin-right: 0.5rem;">${timestamp}</span>
                            <span style="color: ${colors[type]}; font-weight: 500; margin-right: 0.5rem;">[${type.toUpperCase()}]</span>
                            <span style="color: ${colors[type]};">${message}</span>
                        `;

                        consoleLogs.appendChild(logEntry);
                        consoleLogs.scrollTop = consoleLogs.scrollHeight;
                    }

                    consoleLogs.innerHTML = '<div style="opacity: 0.5; margin-bottom: 0.5rem;">Console output will appear here...</div>';
                } catch (e) {
                    // Cross-origin iframe, can't capture logs
                    const consoleLogs = document.getElementById('consoleLogs');
                    consoleLogs.innerHTML = `
                        <div style="color: #ffaa00;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Cannot capture console logs from cross-origin iframe.
                        </div>
                        <div style="opacity: 0.5; margin-top: 0.5rem; font-size: 0.65rem;">
                            Open browser DevTools to view console output.
                        </div>
                    `;
                }
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function toggleCommandExpand(index) {
            const entry = document.querySelector(`.execution-log-entry[data-cmd-index="${index}"]`);
            if (!entry) return;

            const details = entry.querySelector('.log-details');
            const icon = entry.querySelector('.expand-icon');
            const isExpanded = entry.classList.contains('expanded');

            if (isExpanded) {
                // Collapse
                entry.classList.remove('expanded');
                entry.classList.add('collapsed');
                details.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            } else {
                // Expand
                entry.classList.remove('collapsed');
                entry.classList.add('expanded');
                details.style.display = 'block';
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            }
        }

        // Close drawer on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTicketDrawer();
            }
        });

        // Drawer resize functionality
        (function initDrawerResize() {
            const drawer = document.getElementById('ticketDrawer');
            const resizeHandle = document.getElementById('drawerResizeHandle');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            const minWidth = 500;
            const maxWidth = window.innerWidth - 200;

            // Load saved width from localStorage
            const savedWidth = localStorage.getItem('ticketDrawerWidth');
            if (savedWidth) {
                const width = parseInt(savedWidth);
                if (width >= minWidth && width <= maxWidth) {
                    drawer.style.width = width + 'px';
                }
            }

            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = drawer.offsetWidth;
                drawer.classList.add('resizing');
                resizeHandle.classList.add('active');
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const deltaX = startX - e.clientX;
                const newWidth = Math.min(Math.max(startWidth + deltaX, minWidth), maxWidth);
                drawer.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    drawer.classList.remove('resizing');
                    resizeHandle.classList.remove('active');
                    // Save width to localStorage
                    localStorage.setItem('ticketDrawerWidth', drawer.offsetWidth);
                }
            });

            // Update max width on window resize
            window.addEventListener('resize', function() {
                const currentWidth = drawer.offsetWidth;
                const newMaxWidth = window.innerWidth - 200;
                if (currentWidth > newMaxWidth) {
                    drawer.style.width = newMaxWidth + 'px';
                    localStorage.setItem('ticketDrawerWidth', newMaxWidth);
                }
            });
        })();

        // WebSocket connection for ticket chat
        let ticketWebSocket = null;
        let ticketConversationId = null;

        function initializeTicketWebSocket() {
            // Generate or get conversation ID
            ticketConversationId = Date.now(); // Simple ID generation for now

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/${ticketConversationId}/`;

            ticketWebSocket = new WebSocket(wsUrl);

            ticketWebSocket.onopen = function() {
                console.log('Ticket WebSocket connected');
            };

            ticketWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('WebSocket message received:', data);

                if (data.type === 'ticket_chat') {
                    handleTicketChatMessage(data);
                }
            };

            ticketWebSocket.onclose = function() {
                console.log('Ticket WebSocket disconnected');
                // Reconnect after 3 seconds
                setTimeout(initializeTicketWebSocket, 3000);
            };

            ticketWebSocket.onerror = function(error) {
                console.error('Ticket WebSocket error:', error);
            };
        }

        // Test drawer on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, checking drawer elements...');
            const drawer = document.getElementById('ticketDrawer');
            const overlay = document.getElementById('ticketDrawerOverlay');
            console.log('Drawer exists:', !!drawer);
            console.log('Overlay exists:', !!overlay);
            if (drawer) {
                console.log('Drawer classes:', drawer.className);
            }
            if (overlay) {
                console.log('Overlay classes:', overlay.className);
            }

            // Initialize WebSocket connection
            initializeTicketWebSocket();

            // Restore saved ticket state if any (opens ticket drawer to last viewed ticket/tab)
            restoreTicketState();
        });
    </script>

    {% csrf_token %}
</body>
</html>
