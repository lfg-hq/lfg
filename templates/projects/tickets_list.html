<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tickets - LFG ðŸš€</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/tickets.css?v=5">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <style>
        /* Execution logs styles */
        .execution-summary {
            background: var(--surface-secondary, #1a1a1a);
            border: 1px solid var(--border-color, #333);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .execution-summary h4 {
            margin: 0 0 0.75rem 0;
            color: var(--text-primary, #fff);
            font-size: 0.95rem;
            font-weight: 600;
        }

        .execution-summary h4 i {
            margin-right: 0.5rem;
            color: var(--accent-color, #4A90E2);
        }

        .execution-logs-container h4 {
            color: var(--text-primary, #fff);
            font-size: 0.95rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
        }

        .execution-logs-container h4 i {
            margin-right: 0.5rem;
            color: var(--accent-color, #4A90E2);
        }

        .execution-log-entry {
            padding: 0.15rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .execution-log-entry:last-child {
            border-bottom: none;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            margin: -0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .log-header:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .log-command-num {
            font-weight: 300;
            color: var(--text-primary, #fff);
            font-size: 0.875rem;
        }

        .log-timestamp {
            font-size: 0.75rem;
            color: var(--text-secondary, #888);
        }

        .log-explanation {
            color: var(--text-secondary, #aaa);
            font-size: 0.875rem;
            font-weight: 400;
        }

        .log-explanation-detail {
            background: rgba(74, 144, 226, 0.08);
            padding: 0.625rem 0.875rem;
            border-left: 3px solid var(--accent-color, #4A90E2);
            color: var(--text-secondary, #ccc);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            font-style: italic;
            border-radius: 4px;
        }

        .log-command {
            background: rgba(255, 255, 255, 0.02);
            padding: 0.5rem 0.75rem;
            border-left: 2px solid var(--accent-color, #4A90E2);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.8125rem;
            color: #4EC9B0;
            margin-bottom: 0.5rem;
            overflow-x: auto;
            white-space: pre;
        }

        .log-output {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem 0.75rem;
            border-left: 2px solid rgba(255, 255, 255, 0.1);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.8125rem;
            color: var(--text-secondary, #ccc);
            margin: 0;
            overflow-x: auto;
            white-space: pre;
        }

        .log-details {
            max-width: 100%;
            overflow-x: auto;
        }

        .log-notes {
            background: var(--surface-primary, #0d0d0d);
            padding: 0.75rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary, #ccc);
            margin: 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Tasks styling */
        .tasks-list {
            padding: 0;
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            padding: 0.625rem 0.5rem;
            gap: 0.75rem;
            border: none;
            background: transparent;
        }

        .task-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            margin-top: 0.125rem;
            background-color: transparent;
            transition: all 0.2s;
        }

        .task-checkbox:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }

        .task-checkbox:checked {
            background-color: transparent;
            border-color: #22c55e;
        }

        .task-checkbox:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #22c55e;
            font-size: 10px;
        }

        .task-item.pending .task-checkbox {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .task-item.success .task-checkbox,
        .task-item.completed .task-checkbox {
            background-color: transparent;
            border-color: #22c55e;
        }

        .task-item.success .task-checkbox::after,
        .task-item.completed .task-checkbox::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #22c55e;
            font-size: 10px;
        }

        .task-item.in_progress .task-checkbox {
            border-color: #f59e0b;
            background-color: transparent;
        }

        .task-item.in_progress .task-checkbox::after {
            content: '\f110';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f59e0b;
            font-size: 10px;
        }

        .task-item.fail .task-checkbox,
        .task-item.failed .task-checkbox {
            border-color: #ef4444;
            background-color: transparent;
        }

        .task-item.fail .task-checkbox::after,
        .task-item.failed .task-checkbox::after {
            content: '\f00d';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ef4444;
            font-size: 10px;
        }

        .task-label {
            flex: 1;
            cursor: pointer;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--text-primary, #fff);
        }

        .task-item.success .task-label,
        .task-item.completed .task-label {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .task-description {
            display: block;
            color: var(--text-secondary, #aaa);
            font-size: 0.8125rem;
            margin-top: 0.25rem;
        }

        /* Markdown content styling */
        .markdown-content {
            line-height: 1.6;
            color: var(--text-primary, #fff);
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary, #fff);
        }

        .markdown-content h1 { font-size: 1.75rem; }
        .markdown-content h2 { font-size: 1.5rem; }
        .markdown-content h3 { font-size: 1.25rem; }
        .markdown-content h4 { font-size: 1.1rem; }
        .markdown-content h5 { font-size: 1rem; }
        .markdown-content h6 { font-size: 0.95rem; }

        .markdown-content p {
            margin-bottom: 1rem;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .markdown-content li {
            margin-bottom: 0.5rem;
        }

        .markdown-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            font-size: 0.875rem;
            color: #4EC9B0;
        }

        .markdown-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
            color: var(--text-secondary, #ccc);
        }

        .markdown-content blockquote {
            border-left: 3px solid var(--accent-color, #4A90E2);
            padding-left: 1rem;
            margin-left: 0;
            color: var(--text-secondary, #aaa);
            font-style: italic;
        }

        .markdown-content table {
            border-collapse: collapse;
            margin: 1rem 0;
            width: 100%;
            overflow-x: auto;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        .markdown-content table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }

        .markdown-content a {
            color: var(--accent-color, #4A90E2);
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin: 1.5rem 0;
        }

        .markdown-content strong {
            font-weight: 600;
        }

        .markdown-content em {
            font-style: italic;
        }

        /* Animation for status indicator */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
    <div class="app-container">
        {% include 'includes/sidebar.html' with show_conversations=False %}

        <div class="main-content tickets-page">

            <div class="tickets-body">
                <!-- Filters Section -->
                <div class="tickets-filters">
                    <div class="filter-left">
                        <input type="text" class="filter-search" id="ticketSearch" placeholder="Search tickets..." onkeyup="filterTickets()">
                    </div>
                    <div class="filter-right">
                        <select class="filter-select" id="projectFilter" onchange="filterTickets()">
                            <option value="">All Projects</option>
                            {% for project in projects %}
                                <option value="{{ project.project_id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                        <select class="filter-select" id="statusFilter" onchange="filterTickets()">
                            <option value="">All Statuses</option>
                            {% for status in statuses %}
                                <option value="{{ status }}">{{ status|title }}</option>
                            {% endfor %}
                        </select>
                        <select class="filter-select" id="priorityFilter" onchange="filterTickets()">
                            <option value="">All Priorities</option>
                            {% for priority in priorities %}
                                <option value="{{ priority }}">{{ priority }}</option>
                            {% endfor %}
                        </select>
                        <select class="filter-select" id="llmModelFilter" style="min-width: 180px;">
                            <optgroup label="Anthropic">
                                <option value="claude_4_sonnet" selected>Claude 4 Sonnet</option>
                            </optgroup>
                            <optgroup label="OpenAI">
                                <option value="gpt-5">GPT-5</option>
                                <option value="gpt-5-mini">GPT-5 Mini</option>
                            </optgroup>
                            <optgroup label="Google">
                                <option value="gemini_2.5_pro">Gemini 2.5 Pro</option>
                                <option value="gemini_2.5_flash">Gemini 2.5 Flash</option>
                            </optgroup>
                            <optgroup label="xAI">
                                <option value="grok_4">Grok 4</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <!-- Tickets Table -->
                <div class="tickets-table-wrapper">
                    {% if tickets %}
                        <table class="tickets-table" id="ticketsTable">
                            <thead>
                                <tr>
                                    <th>Ticket</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                </tr>
                            </thead>
                            <tbody id="ticketsTableBody">
                                {% for ticket in tickets %}
                                    <tr class="ticket-row"
                                        data-ticket-id="{{ ticket.id }}"
                                        data-project-id="{{ ticket.project.project_id }}"
                                        data-status="{{ ticket.status }}"
                                        data-priority="{{ ticket.priority }}"
                                        data-name="{{ ticket.name|lower }}"
                                        data-description="{{ ticket.description|lower }}">
                                        <td onclick="viewTicketDetails({{ ticket.id }}, '{{ ticket.project.project_id }}')" style="cursor: pointer;">
                                            <div class="ticket-info">
                                                <div class="ticket-name">{{ ticket.name }}</div>
                                            </div>
                                        </td>
                                        <td>
                                            <select class="table-select status-select"
                                                    data-ticket-id="{{ ticket.id }}"
                                                    data-project-id="{{ ticket.project.project_id }}"
                                                    data-status="{{ ticket.status }}"
                                                    onchange="updateTicketFromTable(this, 'status')">
                                                <option value="open" {% if ticket.status == 'open' %}selected{% endif %}>Open</option>
                                                <option value="in_progress" {% if ticket.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                                <option value="done" {% if ticket.status == 'done' %}selected{% endif %}>Done</option>
                                                <option value="blocked" {% if ticket.status == 'blocked' %}selected{% endif %}>Blocked</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="table-select priority-select"
                                                    data-ticket-id="{{ ticket.id }}"
                                                    data-project-id="{{ ticket.project.project_id }}"
                                                    data-priority="{{ ticket.priority }}"
                                                    onchange="updateTicketFromTable(this, 'priority')">
                                                <option value="Low" {% if ticket.priority == 'Low' %}selected{% endif %}>Low</option>
                                                <option value="Medium" {% if ticket.priority == 'Medium' %}selected{% endif %}>Medium</option>
                                                <option value="High" {% if ticket.priority == 'High' %}selected{% endif %}>High</option>
                                            </select>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <h3 class="empty-state-title">No tickets yet</h3>
                            <div class="empty-state-text">
                                Create tickets in your projects to track work items.
                            </div>
                            <a href="{% url 'projects:project_list' %}" class="btn btn-primary">
                                <i class="fas fa-folder"></i> Go to Projects
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket Details Drawer -->
    <div id="ticketDrawerOverlay" class="drawer-overlay" onclick="handleOverlayClick()"></div>
    <div id="ticketDrawer" class="drawer">
        <div class="drawer-resize-handle" id="drawerResizeHandle"></div>
        <div class="drawer-header">
            <div class="drawer-header-left">
                <h3 class="drawer-title" id="drawerTicketTitle"></h3>
            </div>
            <div class="drawer-header-right">
                <button class="drawer-pin-btn" onclick="toggleDrawerPin()" id="drawerPinBtn" title="Pin drawer">
                    <i class="fas fa-thumbtack"></i>
                </button>
                <button class="drawer-execute-btn" onclick="executeTicket()" id="executeTicketBtn">
                    <i class="fas fa-play"></i> Execute
                </button>
                <button class="drawer-close" onclick="closeTicketDrawer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="drawer-tabs">
            <button class="drawer-tab active" data-tab="details" onclick="switchDrawerTab('details')">
                <i class="fas fa-info-circle"></i> Details
            </button>
            <button class="drawer-tab" data-tab="chat" onclick="switchDrawerTab('chat')">
                <i class="fas fa-comments"></i> Chat
            </button>
            <button class="drawer-tab" data-tab="logs" onclick="switchDrawerTab('logs')">
                <i class="fas fa-terminal"></i> Logs
            </button>
            <button class="drawer-tab" data-tab="tasks" onclick="switchDrawerTab('tasks')">
                <i class="fas fa-list-check"></i> Tasks
            </button>
            <button class="drawer-tab" data-tab="preview" onclick="switchDrawerTab('preview')">
                <i class="fas fa-desktop"></i> Preview
            </button>
        </div>
        <div class="drawer-body" id="drawerTicketBody">
            <!-- Ticket details will be loaded here -->
        </div>
    </div>

    <script src="/static/js/sidebar.js"></script>
    <script src="/static/js/marked.min.js"></script>
    <script>
        // Verify marked.js loaded
        if (typeof marked === 'undefined') {
            console.error('marked.js failed to load!');
        } else {
            console.log('marked.js loaded successfully!');
            // Configure marked for GitHub Flavored Markdown
            marked.setOptions({
                gfm: true,
                breaks: true,
                headerIds: true,
                mangle: false
            });
        }
    </script>
    <script>
        // Filter tickets function
        function filterTickets() {
            const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();
            const projectFilter = document.getElementById('projectFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;

            const rows = document.querySelectorAll('.ticket-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const name = row.dataset.name || '';
                const description = row.dataset.description || '';
                const projectId = row.dataset.projectId || '';
                const status = row.dataset.status || '';
                const priority = row.dataset.priority || '';

                const matchesSearch = !searchTerm ||
                    name.includes(searchTerm) ||
                    description.includes(searchTerm);
                const matchesProject = !projectFilter || projectId === projectFilter;
                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesPriority = !priorityFilter || priority === priorityFilter;

                if (matchesSearch && matchesProject && matchesStatus && matchesPriority) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show/hide empty state if needed
            const table = document.getElementById('ticketsTable');
            if (table) {
                table.style.display = visibleCount > 0 ? 'table' : 'none';
            }
        }

        // View ticket details
        async function viewTicketDetails(ticketId, projectId) {
            console.log('viewTicketDetails called:', {ticketId, projectId});
            try {
                const url = `/projects/${projectId}/api/checklist/`;
                console.log('Fetching from:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                // Handle both response formats: {success, checklist} and {tickets}
                const ticketsList = data.tickets || data.checklist || [];
                console.log('Tickets list:', ticketsList);

                const ticket = ticketsList.find(t => t.id === ticketId);
                console.log('Found ticket:', ticket);

                if (ticket) {
                    // Add project_id to ticket if it doesn't exist
                    if (!ticket.project_id) {
                        ticket.project_id = projectId;
                    }
                    showTicketModal(ticket);
                } else {
                    console.error('Ticket not found in list');
                    alert('Ticket not found');
                }
            } catch (error) {
                console.error('Error loading ticket details:', error);
                alert('Error loading ticket details: ' + error.message);
            }
        }

        let currentTicket = null;
        let currentProjectId = null;
        let currentTab = 'details';
        let drawerPinned = false;
        let ticketLogsWebSocket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // WebSocket functions for real-time log updates
        function connectTicketLogsWebSocket(ticketId) {
            // Close existing connection if any
            disconnectTicketLogsWebSocket();

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/tickets/${ticketId}/logs/`;

                console.log(`Connecting to ticket logs WebSocket: ${wsUrl}`);
                ticketLogsWebSocket = new WebSocket(wsUrl);

                ticketLogsWebSocket.onopen = function() {
                    console.log(`Connected to ticket logs WebSocket for ticket ${ticketId}`);
                    reconnectAttempts = 0;
                };

                ticketLogsWebSocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    console.log('Received WebSocket message:', data);

                    if (data.type === 'log_created') {
                        // Add the new log to the UI
                        handleNewLog(data.log);
                    } else if (data.type === 'status_changed') {
                        // Handle ticket status change
                        handleStatusChange(data.status, data.ticket_id);
                    }
                };

                ticketLogsWebSocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };

                ticketLogsWebSocket.onclose = function(event) {
                    console.log('WebSocket closed:', event.code, event.reason);

                    // Try to reconnect if we're still viewing the logs tab
                    if (currentTab === 'logs' && currentTicket && currentTicket.id === ticketId) {
                        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                            reconnectAttempts++;
                            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                            console.log(`Attempting to reconnect in ${delay}ms (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                            setTimeout(() => {
                                if (currentTab === 'logs' && currentTicket && currentTicket.id === ticketId) {
                                    connectTicketLogsWebSocket(ticketId);
                                }
                            }, delay);
                        }
                    }
                };
            } catch (error) {
                console.error('Error creating WebSocket connection:', error);
            }
        }

        function disconnectTicketLogsWebSocket() {
            if (ticketLogsWebSocket) {
                console.log('Closing ticket logs WebSocket');
                ticketLogsWebSocket.close();
                ticketLogsWebSocket = null;
            }
        }

        function handleNewLog(log) {
            console.log('Handling new log:', log);

            // Find the logs container
            const logsContainer = document.querySelector('.execution-logs-container');
            if (!logsContainer) {
                console.log('Logs container not found, user may not be on logs tab');
                return;
            }

            // Check if this log already exists (to prevent duplicates)
            const existingLog = document.querySelector(`.execution-log-entry[data-log-id="${log.id}"]`);
            if (existingLog) {
                console.log('Log already exists, skipping');
                return;
            }

            // Create new log entry HTML
            const explanation = log.explanation || 'No explanation provided';
            const logHtml = `
                <div class="execution-log-entry collapsed" data-log-id="${log.id}" data-cmd-index="new-${log.id}">
                    <div class="log-header" onclick="toggleCommandExpand('new-${log.id}')">
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; overflow: hidden;">
                            <i class="fas fa-chevron-right expand-icon" style="font-size: 0.75rem; transition: transform 0.2s;"></i>
                            <span class="log-explanation" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(explanation)}</span>
                        </div>
                        <span class="log-timestamp" style="white-space: nowrap; margin-left: 1rem;">${formatDate(log.created_at)}</span>
                    </div>
                    <div class="log-details" style="display: none;">
                        <pre class="log-command">${escapeHtml(log.command)}</pre>
                        ${log.output ? `<pre class="log-output">${escapeHtml(log.output)}</pre>` : '<p style="color: var(--text-secondary); font-style: italic; margin-top: 0.5rem; font-size: 0.875rem;">No output</p>'}
                    </div>
                </div>
            `;

            // Insert at the top (latest first)
            const firstLog = logsContainer.querySelector('.execution-log-entry');
            if (firstLog) {
                firstLog.insertAdjacentHTML('beforebegin', logHtml);
            } else {
                // No logs yet, add after the header
                const header = logsContainer.querySelector('h4');
                if (header) {
                    header.insertAdjacentHTML('afterend', logHtml);
                }
            }

            // Add a subtle animation to highlight the new log
            const newLogElement = document.querySelector(`.execution-log-entry[data-log-id="${log.id}"]`);
            if (newLogElement) {
                newLogElement.style.backgroundColor = 'rgba(74, 144, 226, 0.1)';
                setTimeout(() => {
                    newLogElement.style.transition = 'background-color 1s ease';
                    newLogElement.style.backgroundColor = '';
                }, 100);
            }
        }

        function handleStatusChange(status, ticketId) {
            console.log(`Ticket ${ticketId} status changed to: ${status}`);

            // Find the logs container
            const logsContainer = document.querySelector('.execution-logs-container');
            if (!logsContainer) {
                console.log('Logs container not found');
                return;
            }

            // Remove any existing status indicator
            const existingIndicator = document.querySelector('.ticket-status-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            // Add a status indicator at the top if status is 'done'
            if (status === 'done') {
                const header = logsContainer.querySelector('h4');
                if (header) {
                    const indicator = document.createElement('div');
                    indicator.className = 'ticket-status-indicator';
                    indicator.style.cssText = `
                        background: rgba(34, 197, 94, 0.1);
                        border: 1px solid rgba(34, 197, 94, 0.3);
                        border-radius: 8px;
                        padding: 1rem;
                        margin-bottom: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        animation: slideIn 0.3s ease-out;
                    `;
                    indicator.innerHTML = `
                        <div style="
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            background: rgba(34, 197, 94, 0.2);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-check" style="color: rgb(34, 197, 94); font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: rgb(34, 197, 94); margin-bottom: 2px;">Ticket Completed</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">All commands have been executed successfully</div>
                        </div>
                    `;
                    header.insertAdjacentElement('afterend', indicator);
                }
            }
        }

        function switchDrawerTab(tab) {
            currentTab = tab;

            // Disconnect WebSocket if leaving logs tab
            if (tab !== 'logs') {
                disconnectTicketLogsWebSocket();
            }

            // Update tab buttons
            document.querySelectorAll('.drawer-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.drawer-tab[data-tab="${tab}"]`).classList.add('active');

            // Reload content for current ticket
            if (currentTicket) {
                loadTabContent(tab);
            }
        }

        function loadTabContent(tab) {
            const body = document.getElementById('drawerTicketBody');

            switch(tab) {
                case 'details':
                    showDetailsTab(body);
                    break;
                case 'chat':
                    showChatTab(body);
                    break;
                case 'logs':
                    showLogsTab(body);
                    break;
                case 'tasks':
                    showTasksTab(body);
                    break;
                case 'preview':
                    showPreviewTab(body);
                    break;
            }
        }

        function showDetailsTab(body) {
            const ticket = currentTicket;

            console.log('showDetailsTab called, marked available:', typeof marked !== 'undefined');

            // Helper function to render markdown safely
            const renderMarkdown = (text) => {
                if (!text) return 'No description provided';

                console.log('renderMarkdown called with text:', text.substring(0, 50));
                console.log('marked type:', typeof marked);

                if (typeof marked !== 'undefined') {
                    const result = marked.parse(text);
                    console.log('marked.parse result:', result.substring(0, 100));
                    return result;
                } else {
                    console.warn('marked.js not loaded, using escapeHtml');
                    return escapeHtml(text);
                }
            };

            // Pre-render markdown content
            const descriptionHTML = renderMarkdown(ticket.description);
            const notesHTML = ticket.notes ? renderMarkdown(ticket.notes) : '';

            // Render acceptance criteria with inline markdown
            const criteriaHTML = ticket.acceptance_criteria && ticket.acceptance_criteria.length > 0
                ? ticket.acceptance_criteria.map(criteria => {
                    const renderedCriteria = typeof marked !== 'undefined' ? marked.parseInline(criteria) : escapeHtml(criteria);
                    return `<li>${renderedCriteria}</li>`;
                }).join('')
                : '';

            body.innerHTML = `
                <div class="ticket-detail-drawer">
                    <div class="detail-meta-row">
                        <select class="compact-select status-select" id="ticketStatus" data-status="${ticket.status}" onchange="updateTicketField('status', this.value)">
                            <option value="open" ${ticket.status === 'open' ? 'selected' : ''}>Open</option>
                            <option value="in_progress" ${ticket.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="done" ${ticket.status === 'done' ? 'selected' : ''}>Done</option>
                            <option value="blocked" ${ticket.status === 'blocked' ? 'selected' : ''}>Blocked</option>
                        </select>

                        <select class="compact-select priority-select" id="ticketPriority" data-priority="${ticket.priority}" onchange="updateTicketField('priority', this.value)">
                            <option value="Low" ${ticket.priority === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${ticket.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="High" ${ticket.priority === 'High' ? 'selected' : ''}>High</option>
                        </select>

                        <div class="detail-meta-badge">
                            <i class="fas fa-layer-group"></i> ${ticket.complexity || 'medium'}
                        </div>

                        <div class="detail-meta-badge">
                            <i class="fas fa-calendar"></i> ${formatDate(ticket.created_at)}
                        </div>
                    </div>

                    <div class="detail-section markdown-content">
                        ${descriptionHTML}
                    </div>

                    ${criteriaHTML ? `
                        <div class="detail-section">
                            <h4>Acceptance Criteria</h4>
                            <div class="markdown-content">
                                <ul class="criteria-list">
                                    ${criteriaHTML}
                                </ul>
                            </div>
                        </div>
                    ` : ''}

                    ${ticket.notes ? `
                        <div class="detail-section">
                            <h4>Notes</h4>
                            <div class="markdown-content">
                                ${notesHTML}
                            </div>
                        </div>
                    ` : ''}

                    ${ticket.linear_issue_url ? `
                        <div class="detail-section">
                            <h4>Linear Integration</h4>
                            <a href="${ticket.linear_issue_url}" target="_blank" class="btn btn-outline btn-sm">
                                <i class="fas fa-external-link-alt"></i> View in Linear
                            </a>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function showLogsTab(body) {
            // Show loading state
            body.innerHTML = `
                <div class="drawer-tab-content">
                    <div class="empty-logs">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                        <p style="color: var(--text-secondary); margin-top: 1rem;">Loading execution logs...</p>
                    </div>
                </div>
            `;

            // Fetch ticket logs
            if (!currentTicket || !currentProjectId) {
                body.innerHTML = `
                    <div class="drawer-tab-content">
                        <div class="empty-logs">
                            <i class="fas fa-terminal" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                            <p style="color: var(--text-secondary); margin-top: 1rem;">No execution logs available.</p>
                        </div>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/logs/`);
                const data = await response.json();

                if (data.commands && data.commands.length > 0) {
                    // Reverse commands to show latest first
                    const reversedCommands = [...data.commands].reverse();
                    const totalCommands = data.commands.length;

                    // Display command execution logs
                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="execution-logs-container">
                                
                                <h4><i class="fas fa-terminal"></i> Command History (Latest First)</h4>
                                ${reversedCommands.map((cmd, index) => {
                                    const explanation = cmd.explanation || 'No explanation provided';
                                    return `
                                    <div class="execution-log-entry collapsed" data-cmd-index="${index}" data-log-id="${cmd.id}">
                                        <div class="log-header" onclick="toggleCommandExpand(${index})">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; overflow: hidden;">
                                                <i class="fas fa-chevron-right expand-icon" style="font-size: 0.75rem; transition: transform 0.2s;"></i>
                                                <span class="log-explanation" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(explanation)}</span>
                                            </div>
                                            <span class="log-timestamp" style="white-space: nowrap; margin-left: 1rem;">${formatDate(cmd.created_at)}</span>
                                        </div>
                                        <div class="log-details" style="display: none;">
                                            <pre class="log-command">${escapeHtml(cmd.command)}</pre>
                                            ${cmd.output ? `<pre class="log-output">${escapeHtml(cmd.output)}</pre>` : '<p style="color: var(--text-secondary); font-style: italic; margin-top: 0.5rem; font-size: 0.875rem;">No output</p>'}
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // No logs available
                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="empty-logs">
                                <i class="fas fa-terminal" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                                <p style="color: var(--text-secondary); margin-top: 1rem;">No execution logs available for this ticket yet.</p>
                                <p style="color: var(--text-secondary); font-size: 0.875rem;">Logs will appear here after the ticket is executed.</p>
                            </div>
                        </div>
                    `;
                }

                // Connect to WebSocket for real-time log updates
                connectTicketLogsWebSocket(currentTicket.id);
            } catch (error) {
                console.error('Error loading logs:', error);
                body.innerHTML = `
                    <div class="drawer-tab-content">
                        <div class="empty-logs">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--error-color); opacity: 0.5;"></i>
                            <p style="color: var(--text-secondary); margin-top: 1rem;">Error loading execution logs.</p>
                        </div>
                    </div>
                `;
            }
        }

        async function showTasksTab(body) {
            // Show loading state
            body.innerHTML = `
                <div class="drawer-tab-content">
                    <div class="empty-logs">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                        <p style="color: var(--text-secondary); margin-top: 1rem;">Loading tasks...</p>
                    </div>
                </div>
            `;

            if (!currentTicket || !currentProjectId) {
                body.innerHTML = `
                    <div class="drawer-tab-content">
                        <div class="empty-logs">
                            <i class="fas fa-list-check" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                            <p style="color: var(--text-secondary); margin-top: 1rem;">No tasks available.</p>
                        </div>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/tasks/`);
                const data = await response.json();

                const tasks = data.tasks || (currentTicket.acceptance_criteria || []);

                if (tasks.length === 0) {
                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="empty-logs">
                                <i class="fas fa-list-check" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                                <p style="color: var(--text-secondary); margin-top: 1rem;">No tasks defined for this ticket.</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Check if tasks have structured data (from ProjectTaskList model) or are simple strings
                    const isStructuredTasks = tasks.length > 0 && typeof tasks[0] === 'object';

                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="tasks-list">
                                ${tasks.map((task, index) => {
                                    if (isStructuredTasks) {
                                        const taskStatus = task.status || 'pending';
                                        const taskText = task.description || 'Unnamed task';
                                        return `
                                            <div class="task-item ${taskStatus}">
                                                <input type="checkbox" id="task-${task.id || index}"
                                                       class="task-checkbox"
                                                       disabled>
                                                <label for="task-${task.id || index}" class="task-label">
                                                    ${escapeHtml(taskText)}
                                                </label>
                                            </div>
                                        `;
                                    } else {
                                        // Simple string tasks from acceptance_criteria
                                        return `
                                            <div class="task-item pending">
                                                <input type="checkbox" id="task-${index}" class="task-checkbox" disabled>
                                                <label for="task-${index}" class="task-label">${escapeHtml(task)}</label>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                // Fallback to acceptance criteria
                const tasks = currentTicket.acceptance_criteria || [];
                if (tasks.length === 0) {
                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="empty-logs">
                                <i class="fas fa-list-check" style="font-size: 2rem; color: var(--text-secondary); opacity: 0.5;"></i>
                                <p style="color: var(--text-secondary); margin-top: 1rem;">No tasks defined for this ticket.</p>
                            </div>
                        </div>
                    `;
                } else {
                    body.innerHTML = `
                        <div class="drawer-tab-content">
                            <div class="tasks-list">
                                ${tasks.map((task, index) => `
                                    <div class="task-item pending">
                                        <input type="checkbox" id="task-${index}" class="task-checkbox" disabled>
                                        <label for="task-${index}" class="task-label">${escapeHtml(task)}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
        }

        function showChatTab(body) {
            body.innerHTML = `
                <div class="ticket-chat-container">
                    <div class="ticket-chat-messages" id="ticketChatMessages">
                        <div class="ticket-chat-welcome">
                            <i class="fas fa-robot" style="font-size: 2rem; color: var(--primary-color); opacity: 0.5;"></i>
                            <p style="color: var(--text-secondary); margin-top: 1rem;">Chat with AI agent for ticket #${currentTicket.id}</p>
                            <p style="color: var(--text-secondary); font-size: 0.875rem;">Ask questions or provide guidance during implementation</p>
                        </div>
                    </div>
                    <div class="ticket-chat-input-container">
                        <textarea
                            id="ticketChatInput"
                            class="ticket-chat-input"
                            placeholder="Type your message..."
                            rows="1"
                            onkeydown="handleChatInputKeydown(event)"
                        ></textarea>
                        <button class="ticket-chat-send-btn" onclick="sendTicketChatMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            `;

            // Auto-resize textarea
            const textarea = document.getElementById('ticketChatInput');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                });
            }

            // Load existing chat messages if any
            loadTicketChatHistory();
        }

        function handleChatInputKeydown(event) {
            // Send on Enter (without Shift)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendTicketChatMessage();
            }
        }

        let ticketChatMessages = [];
        let currentAIMessageElement = null;

        function loadTicketChatHistory() {
            // Initialize empty chat history for now
            // In the future, we can load from backend
            ticketChatMessages = [];
        }

        function sendTicketChatMessage() {
            const input = document.getElementById('ticketChatInput');
            const message = input.value.trim();

            if (!message || !currentTicket) return;

            // Clear input
            input.value = '';
            input.style.height = 'auto';

            // Add user message to chat
            addChatMessage('user', message);

            // Send message to backend via WebSocket or API
            sendMessageToTicketAgent(message);
        }

        function addChatMessage(role, content, isStreaming = false) {
            const messagesContainer = document.getElementById('ticketChatMessages');
            if (!messagesContainer) return;

            // Remove welcome message if it exists
            const welcome = messagesContainer.querySelector('.ticket-chat-welcome');
            if (welcome) {
                welcome.remove();
            }

            if (role === 'user') {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'ticket-chat-message ticket-user-message';
                messageDiv.innerHTML = `
                    <div class="ticket-message-content">
                        <div class="ticket-message-text">${escapeHtml(content)}</div>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
                ticketChatMessages.push({role: 'user', content});
            } else if (role === 'assistant') {
                if (isStreaming && currentAIMessageElement) {
                    // Update existing streaming message
                    const textDiv = currentAIMessageElement.querySelector('.ticket-message-text');
                    if (textDiv) {
                        textDiv.textContent = content;
                    }
                } else {
                    // Create new assistant message
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'ticket-chat-message ticket-assistant-message';
                    messageDiv.innerHTML = `
                        <div class="ticket-message-content">
                            <div class="ticket-message-icon"><i class="fas fa-robot"></i></div>
                            <div class="ticket-message-text">${escapeHtml(content)}</div>
                        </div>
                    `;
                    messagesContainer.appendChild(messageDiv);

                    if (isStreaming) {
                        currentAIMessageElement = messageDiv;
                    } else {
                        ticketChatMessages.push({role: 'assistant', content});
                        currentAIMessageElement = null;
                    }
                }
            }

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTicketModal(ticket) {
            console.log('showTicketModal called with ticket:', ticket);
            currentTicket = ticket;
            currentProjectId = ticket.project_id;
            currentTab = 'details';

            const drawer = document.getElementById('ticketDrawer');
            const overlay = document.getElementById('ticketDrawerOverlay');
            const title = document.getElementById('drawerTicketTitle');

            console.log('Drawer elements:', {drawer, overlay, title});

            if (!drawer || !overlay) {
                console.error('Drawer elements not found!');
                return;
            }

            title.textContent = `TKT-${ticket.id}: ${ticket.name}`;

            // Reset tabs
            document.querySelectorAll('.drawer-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.drawer-tab[data-tab="details"]').classList.add('active');

            // Load details tab
            loadTabContent('details');

            drawer.classList.add('active');
            overlay.classList.add('active');
        }

        function closeTicketDrawer() {
            if (drawerPinned) return; // Don't close if pinned

            const drawer = document.getElementById('ticketDrawer');
            const overlay = document.getElementById('ticketDrawerOverlay');
            drawer.classList.remove('active');
            overlay.classList.remove('active');
            currentTicket = null;
            currentProjectId = null;
        }

        function handleOverlayClick() {
            if (!drawerPinned) {
                closeTicketDrawer();
            }
        }

        function toggleDrawerPin() {
            drawerPinned = !drawerPinned;
            const pinBtn = document.getElementById('drawerPinBtn');
            const drawer = document.getElementById('ticketDrawer');

            if (drawerPinned) {
                pinBtn.classList.add('pinned');
                pinBtn.title = 'Unpin drawer';
                drawer.classList.add('pinned');
            } else {
                pinBtn.classList.remove('pinned');
                pinBtn.title = 'Pin drawer';
                drawer.classList.remove('pinned');
            }
        }

        function closeTicketModal() {
            closeTicketDrawer();
        }

        async function updateTicketFromTable(selectElement, field) {
            const ticketId = selectElement.dataset.ticketId;
            const projectId = selectElement.dataset.projectId;
            const value = selectElement.value;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${projectId}/api/checklist/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        item_id: parseInt(ticketId),
                        [field]: value
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update the row data attributes
                    const row = selectElement.closest('tr');
                    if (row) {
                        row.dataset[field] = value;
                    }

                    // Update the select element's data attribute for color coding
                    if (field === 'status') {
                        selectElement.dataset.status = value;
                    } else if (field === 'priority') {
                        selectElement.dataset.priority = value;
                    }

                    // If drawer is open for this ticket, update it too
                    if (currentTicket && currentTicket.id === parseInt(ticketId)) {
                        currentTicket[field] = value;
                        const drawerSelect = document.getElementById(field === 'status' ? 'ticketStatus' : 'ticketPriority');
                        if (drawerSelect) {
                            drawerSelect.value = value;
                        }
                    }
                } else {
                    alert('Failed to update ticket: ' + (data.error || 'Unknown error'));
                    // Revert the select to previous value
                    const row = selectElement.closest('tr');
                    if (row) {
                        selectElement.value = row.dataset[field];
                    }
                }
            } catch (error) {
                console.error('Error updating ticket:', error);
                alert('Error updating ticket');
                // Revert the select to previous value
                const row = selectElement.closest('tr');
                if (row) {
                    selectElement.value = row.dataset[field];
                }
            }
        }

        async function updateTicketField(field, value) {
            if (!currentTicket || !currentProjectId) return;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${currentProjectId}/api/checklist/update/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        item_id: currentTicket.id,
                        [field]: value
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Update the current ticket object
                    currentTicket[field] = value;

                    // Update the drawer select's data attribute for color coding
                    const drawerSelect = document.getElementById(field === 'status' ? 'ticketStatus' : 'ticketPriority');
                    if (drawerSelect) {
                        if (field === 'status') {
                            drawerSelect.setAttribute('data-status', value);
                        } else if (field === 'priority') {
                            drawerSelect.setAttribute('data-priority', value);
                        }
                    }

                    // Update the table row
                    const row = document.querySelector(`tr[data-ticket-id="${currentTicket.id}"]`);
                    if (row) {
                        row.dataset[field] = value;

                        // Update the select in the table
                        const selectClass = field === 'status' ? '.status-select' : '.priority-select';
                        const select = row.querySelector(selectClass);
                        if (select) {
                            select.value = value;
                            // Update data attribute for color coding
                            if (field === 'status') {
                                select.setAttribute('data-status', value);
                            } else if (field === 'priority') {
                                select.setAttribute('data-priority', value);
                            }
                        }
                    }
                } else {
                    alert('Failed to update ticket: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating ticket:', error);
                alert('Error updating ticket');
            }
        }

        async function executeTicket() {
            if (!currentTicket || !currentProjectId) return;

            const btn = document.getElementById('executeTicketBtn');
            if (!btn) return;

            // Disable button and show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing...';

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/projects/${currentProjectId}/api/tickets/${currentTicket.id}/execute/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        ticket_id: currentTicket.id,
                        conversation_id: ticketConversationId
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Switch to Chat tab to show execution progress
                    switchDrawerTab('chat');

                    // Show success message in chat
                    addChatMessage('assistant', 'Ticket execution started. You can monitor progress here and provide guidance as needed.');
                } else {
                    alert('Failed to execute ticket: ' + (data.error || 'Unknown error'));
                    // Re-enable button
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play"></i> Execute Ticket';
                }
            } catch (error) {
                console.error('Error executing ticket:', error);
                alert('Error executing ticket: ' + error.message);
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Execute Ticket';
            }
        }

        // Helper functions
        function formatStatus(status) {
            return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatDate(dateString) {
            if (!dateString) return 'â€”';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let previewContent = null; // Cache the preview content

        async function showPreviewTab(body) {
            // If we already have preview content, just restore it
            if (previewContent && isServerRunning) {
                body.innerHTML = previewContent;
                return;
            }

            // Otherwise, show initial state with manual start option
            body.innerHTML = `
                <div class="drawer-tab-content" style="height: 100%; display: flex; flex-direction: column; padding: 0;">
                    <div class="preview-container" style="height: 100%; display: flex; flex-direction: column;">
                        <div class="preview-body" id="previewBody" style="flex: 1; position: relative; background: var(--surface-primary, #0d0d0d);">
                            <div class="preview-placeholder" style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                height: 100%;
                                color: var(--text-secondary);
                            ">
                                <i class="fas fa-desktop" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                <p style="font-size: 1rem; margin: 0;">Dev server not running</p>
                                <button
                                    onclick="startDevServer()"
                                    style="
                                        background: var(--accent-color, #4A90E2);
                                        color: white;
                                        border: none;
                                        padding: 0.75rem 1.5rem;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 0.875rem;
                                        margin-top: 1.5rem;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.5rem;
                                    "
                                >
                                    <i class="fas fa-play"></i> Start Dev Server
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        let devServerProcess = null;

        let isServerRunning = false;

        async function startDevServer() {
            if (!currentTicket || !currentProjectId) {
                console.error('No ticket selected');
                return;
            }

            const previewBody = document.getElementById('previewBody');

            try {
                // Kill existing npm processes and start dev server
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/start-dev-server/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        project_id: currentProjectId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to start dev server');
                }

                const data = await response.json();

                // Get the dev server URL from response (supports IPv6)
                const devServerUrl = data.url || 'http://localhost:3000';
                console.log('Dev server started at:', devServerUrl);

                isServerRunning = true;

                // Show iframe with preview
                previewBody.innerHTML = `
                    <div style="height: 100%; display: flex; flex-direction: column; position: relative;">
                        <!-- URL Bar with all controls -->
                        <div style="padding: 0.4rem 0.5rem; background: var(--surface-secondary, #1a1a1a); border-bottom: 1px solid var(--border-color, #333); display: flex; align-items: center; gap: 0.5rem;">
                            <input
                                type="text"
                                id="previewUrlInput"
                                value="${devServerUrl}"
                                style="
                                    flex: 1;
                                    background: var(--surface-primary, #0d0d0d);
                                    border: 1px solid var(--border-color, #333);
                                    color: var(--text-primary);
                                    padding: 0.35rem 0.5rem;
                                    border-radius: 4px;
                                    font-size: 0.75rem;
                                    font-family: monospace;
                                    outline: none;
                                "
                                onkeypress="if(event.key === 'Enter') { const iframe = document.getElementById('previewIframe'); iframe.src = this.value; }"
                            />
                            <button onclick="document.getElementById('previewIframe').contentWindow.location.reload()" style="
                                background: none;
                                border: 1px solid var(--border-color, #333);
                                color: var(--text-secondary);
                                padding: 0.35rem 0.5rem;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.75rem;
                            " title="Reload">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button id="serverToggleBtn" onclick="toggleDevServer()" style="
                                background: #e74c3c;
                                border: none;
                                color: white;
                                padding: 0.35rem 0.6rem;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.75rem;
                            " title="Stop Server">
                                <i class="fas fa-stop"></i>
                            </button>
                            <button onclick="togglePreviewFullscreen()" style="
                                background: none;
                                border: 1px solid var(--border-color, #333);
                                color: var(--text-secondary);
                                padding: 0.35rem 0.5rem;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.75rem;
                            " title="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>

                        <!-- iframe container -->
                        <div id="iframeContainer" style="flex: 1; position: relative; overflow: hidden;">
                            <iframe
                                id="previewIframe"
                                src="${devServerUrl}"
                                style="width: 100%; height: 100%; border: none; background: white;"
                                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-top-navigation"
                            ></iframe>
                        </div>

                        <!-- Console Panel (hidden by default) -->
                        <div id="consolePanel" style="
                            position: absolute;
                            bottom: 0;
                            left: 0;
                            right: 0;
                            height: 0;
                            background: var(--surface-primary, #0d0d0d);
                            border-top: 1px solid var(--border-color, #333);
                            transition: height 0.3s ease;
                            overflow: hidden;
                            display: flex;
                            flex-direction: column;
                        ">
                            <div style="padding: 0.5rem; border-bottom: 1px solid var(--border-color, #333); display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.75rem; font-weight: 500; color: var(--text-primary);">
                                    <i class="fas fa-terminal"></i> Console Logs
                                </span>
                                <button onclick="toggleConsole()" style="
                                    background: none;
                                    border: none;
                                    color: var(--text-secondary);
                                    cursor: pointer;
                                    padding: 0.25rem;
                                    font-size: 0.75rem;
                                ">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="consoleLogs" style="
                                flex: 1;
                                padding: 0.5rem;
                                overflow-y: auto;
                                font-family: monospace;
                                font-size: 0.7rem;
                                color: var(--text-secondary);
                            ">
                                <div style="opacity: 0.5;">Console logs will appear here...</div>
                            </div>
                        </div>

                        <!-- Console Toggle Button -->
                        <button
                            onclick="toggleConsole()"
                            id="consoleToggleBtn"
                            style="
                                position: absolute;
                                bottom: 0.75rem;
                                right: 0.75rem;
                                background: var(--surface-secondary, #1a1a1a);
                                border: 1px solid var(--border-color, #333);
                                color: var(--text-primary);
                                padding: 0.5rem 0.75rem;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 0.75rem;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                z-index: 10;
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            "
                        >
                            <i class="fas fa-terminal"></i>
                            Console
                        </button>
                    </div>
                `;

                // Monitor iframe URL changes and update URL bar
                const iframe = document.getElementById('previewIframe');
                const urlInput = document.getElementById('previewUrlInput');

                // Function to update URL bar
                function updateUrlBar() {
                    try {
                        const iframeUrl = iframe.contentWindow.location.href;
                        if (iframeUrl && iframeUrl !== 'about:blank') {
                            urlInput.value = iframeUrl;
                        }
                    } catch (e) {
                        // Cross-origin or security error - can't read URL
                        // This is expected for external navigation
                    }
                }

                // Listen for iframe load events
                iframe.addEventListener('load', updateUrlBar);

                // Also poll for URL changes (catches client-side routing)
                let lastUrl = '';
                setInterval(() => {
                    try {
                        const currentUrl = iframe.contentWindow.location.href;
                        if (currentUrl !== lastUrl && currentUrl !== 'about:blank') {
                            lastUrl = currentUrl;
                            urlInput.value = currentUrl;
                        }
                    } catch (e) {
                        // Ignore cross-origin errors
                    }
                }, 500);

                // Cache the preview content so it can be restored when switching tabs
                const drawerBody = document.getElementById('drawerTicketBody');
                if (drawerBody) {
                    previewContent = drawerBody.innerHTML;
                }

            } catch (error) {
                console.error('Error starting dev server:', error);
                isServerRunning = false;

                previewBody.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--error-color, #ff4444);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Failed to start dev server</p>
                        <p style="font-size: 0.875rem; opacity: 0.7;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function toggleDevServer() {
            if (isServerRunning) {
                await stopDevServer();
            } else {
                await startDevServer();
            }
        }

        async function stopDevServer() {
            if (!currentTicket) return;

            const serverToggleBtn = document.getElementById('serverToggleBtn');
            const previewBody = document.getElementById('previewBody');

            if (serverToggleBtn) {
                serverToggleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                serverToggleBtn.disabled = true;
            }

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch(`/api/v1/project-tickets/${currentTicket.id}/stop-dev-server/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include'
                });

                isServerRunning = false;
                previewContent = null; // Clear cached content when server stops

                if (serverToggleBtn) {
                    serverToggleBtn.innerHTML = '<i class="fas fa-play"></i>';
                    serverToggleBtn.disabled = false;
                    serverToggleBtn.style.background = 'var(--accent-color, #4A90E2)';
                    serverToggleBtn.title = 'Start Server';
                }

                if (previewBody) {
                    previewBody.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                            <i class="fas fa-desktop" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <p>Dev server stopped</p>
                            <p style="font-size: 0.875rem; opacity: 0.7;">Click the play button in the URL bar to restart</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error stopping dev server:', error);
                if (serverToggleBtn) {
                    serverToggleBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    serverToggleBtn.disabled = false;
                }
            }
        }

        function togglePreviewFullscreen() {
            const previewContainer = document.querySelector('.preview-container');
            const fullscreenBtn = event.currentTarget;

            if (!document.fullscreenElement) {
                // Enter fullscreen
                if (previewContainer.requestFullscreen) {
                    previewContainer.requestFullscreen();
                } else if (previewContainer.webkitRequestFullscreen) {
                    previewContainer.webkitRequestFullscreen();
                } else if (previewContainer.msRequestFullscreen) {
                    previewContainer.msRequestFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.title = 'Exit Fullscreen';
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.title = 'Toggle Fullscreen';
            }
        }

        // Listen for fullscreen changes to update button icon
        document.addEventListener('fullscreenchange', () => {
            const fullscreenBtn = document.querySelector('[onclick="togglePreviewFullscreen()"]');
            if (fullscreenBtn) {
                if (!document.fullscreenElement) {
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                    fullscreenBtn.title = 'Toggle Fullscreen';
                }
            }
        });

        function toggleConsole() {
            const consolePanel = document.getElementById('consolePanel');
            const consoleToggleBtn = document.getElementById('consoleToggleBtn');
            const iframeContainer = document.getElementById('iframeContainer');

            if (!consolePanel || !consoleToggleBtn) return;

            const isOpen = consolePanel.style.height !== '0px' && consolePanel.style.height !== '';

            if (isOpen) {
                // Close console
                consolePanel.style.height = '0';
                consoleToggleBtn.style.display = 'flex';
            } else {
                // Open console (40% of container height)
                consolePanel.style.height = '40%';
                consoleToggleBtn.style.display = 'none';

                // Capture console logs from iframe (if same-origin)
                try {
                    const iframe = document.getElementById('previewIframe');
                    const iframeWindow = iframe.contentWindow;
                    const consoleLogs = document.getElementById('consoleLogs');

                    // Override console methods to capture logs
                    const originalLog = iframeWindow.console.log;
                    const originalError = iframeWindow.console.error;
                    const originalWarn = iframeWindow.console.warn;

                    iframeWindow.console.log = function(...args) {
                        originalLog.apply(iframeWindow.console, args);
                        addConsoleLog('log', args);
                    };

                    iframeWindow.console.error = function(...args) {
                        originalError.apply(iframeWindow.console, args);
                        addConsoleLog('error', args);
                    };

                    iframeWindow.console.warn = function(...args) {
                        originalWarn.apply(iframeWindow.console, args);
                        addConsoleLog('warn', args);
                    };

                    function addConsoleLog(type, args) {
                        const timestamp = new Date().toLocaleTimeString();
                        const message = args.map(arg => {
                            if (typeof arg === 'object') {
                                try {
                                    return JSON.stringify(arg, null, 2);
                                } catch (e) {
                                    return String(arg);
                                }
                            }
                            return String(arg);
                        }).join(' ');

                        const colors = {
                            log: 'var(--text-secondary)',
                            error: '#ff4444',
                            warn: '#ffaa00'
                        };

                        const logEntry = document.createElement('div');
                        logEntry.style.marginBottom = '0.25rem';
                        logEntry.style.paddingBottom = '0.25rem';
                        logEntry.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                        logEntry.innerHTML = `
                            <span style="opacity: 0.5; margin-right: 0.5rem;">${timestamp}</span>
                            <span style="color: ${colors[type]}; font-weight: 500; margin-right: 0.5rem;">[${type.toUpperCase()}]</span>
                            <span style="color: ${colors[type]};">${message}</span>
                        `;

                        consoleLogs.appendChild(logEntry);
                        consoleLogs.scrollTop = consoleLogs.scrollHeight;
                    }

                    consoleLogs.innerHTML = '<div style="opacity: 0.5; margin-bottom: 0.5rem;">Console output will appear here...</div>';
                } catch (e) {
                    // Cross-origin iframe, can't capture logs
                    const consoleLogs = document.getElementById('consoleLogs');
                    consoleLogs.innerHTML = `
                        <div style="color: #ffaa00;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Cannot capture console logs from cross-origin iframe.
                        </div>
                        <div style="opacity: 0.5; margin-top: 0.5rem; font-size: 0.65rem;">
                            Open browser DevTools to view console output.
                        </div>
                    `;
                }
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function toggleCommandExpand(index) {
            const entry = document.querySelector(`.execution-log-entry[data-cmd-index="${index}"]`);
            if (!entry) return;

            const details = entry.querySelector('.log-details');
            const icon = entry.querySelector('.expand-icon');
            const isExpanded = entry.classList.contains('expanded');

            if (isExpanded) {
                // Collapse
                entry.classList.remove('expanded');
                entry.classList.add('collapsed');
                details.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            } else {
                // Expand
                entry.classList.remove('collapsed');
                entry.classList.add('expanded');
                details.style.display = 'block';
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            }
        }

        // Close drawer on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTicketDrawer();
            }
        });

        // Drawer resize functionality
        (function initDrawerResize() {
            const drawer = document.getElementById('ticketDrawer');
            const resizeHandle = document.getElementById('drawerResizeHandle');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            const minWidth = 500;
            const maxWidth = window.innerWidth - 200;

            // Load saved width from localStorage
            const savedWidth = localStorage.getItem('ticketDrawerWidth');
            if (savedWidth) {
                const width = parseInt(savedWidth);
                if (width >= minWidth && width <= maxWidth) {
                    drawer.style.width = width + 'px';
                }
            }

            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = drawer.offsetWidth;
                drawer.classList.add('resizing');
                resizeHandle.classList.add('active');
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const deltaX = startX - e.clientX;
                const newWidth = Math.min(Math.max(startWidth + deltaX, minWidth), maxWidth);
                drawer.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    drawer.classList.remove('resizing');
                    resizeHandle.classList.remove('active');
                    // Save width to localStorage
                    localStorage.setItem('ticketDrawerWidth', drawer.offsetWidth);
                }
            });

            // Update max width on window resize
            window.addEventListener('resize', function() {
                const currentWidth = drawer.offsetWidth;
                const newMaxWidth = window.innerWidth - 200;
                if (currentWidth > newMaxWidth) {
                    drawer.style.width = newMaxWidth + 'px';
                    localStorage.setItem('ticketDrawerWidth', newMaxWidth);
                }
            });
        })();

        // WebSocket connection for ticket chat
        let ticketWebSocket = null;
        let ticketConversationId = null;

        function initializeTicketWebSocket() {
            // Generate or get conversation ID
            ticketConversationId = Date.now(); // Simple ID generation for now

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/${ticketConversationId}/`;

            ticketWebSocket = new WebSocket(wsUrl);

            ticketWebSocket.onopen = function() {
                console.log('Ticket WebSocket connected');
            };

            ticketWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('WebSocket message received:', data);

                if (data.type === 'ticket_chat') {
                    handleTicketChatMessage(data);
                }
            };

            ticketWebSocket.onclose = function() {
                console.log('Ticket WebSocket disconnected');
                // Reconnect after 3 seconds
                setTimeout(initializeTicketWebSocket, 3000);
            };

            ticketWebSocket.onerror = function(error) {
                console.error('Ticket WebSocket error:', error);
            };
        }

        function handleTicketChatMessage(data) {
            // Only show messages for the currently open ticket
            if (!currentTicket || data.ticket_id !== currentTicket.id) {
                return;
            }

            // Only update if chat tab is active
            const chatTab = document.querySelector('.drawer-tab[data-tab="chat"]');
            if (!chatTab || !chatTab.classList.contains('active')) {
                return;
            }

            const role = data.role || 'assistant';
            const content = data.content || '';
            const isStreaming = data.is_streaming || false;

            addChatMessage(role, content, isStreaming);
        }

        // Update sendMessageToTicketAgent to include conversation_id
        function sendMessageToTicketAgent(message) {
            if (!currentTicket || !currentProjectId) return;

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Send message to backend API
            fetch(`/projects/${currentProjectId}/api/tickets/${currentTicket.id}/chat/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    message: message,
                    ticket_id: currentTicket.id,
                    conversation_id: ticketConversationId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Message sent successfully
                    // Response will come via WebSocket
                    console.log('Message sent to agent');
                } else {
                    console.error('Failed to send message:', data.error);
                    addChatMessage('assistant', 'Error: Failed to send message. ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                addChatMessage('assistant', 'Error: Could not connect to server.');
            });
        }

        // Test drawer on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, checking drawer elements...');
            const drawer = document.getElementById('ticketDrawer');
            const overlay = document.getElementById('ticketDrawerOverlay');
            console.log('Drawer exists:', !!drawer);
            console.log('Overlay exists:', !!overlay);
            if (drawer) {
                console.log('Drawer classes:', drawer.className);
            }
            if (overlay) {
                console.log('Overlay classes:', overlay.className);
            }

            // Initialize WebSocket connection
            initializeTicketWebSocket();
        });
    </script>

    {% csrf_token %}
</body>
</html>
