{% extends 'projects/base_with_sidebar.html' %}

{% block title %}My Projects - LFG 🚀🚀{% endblock %}

{% block content %}
<div class="projects-container">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-project-diagram"></i>
            My Projects
        </h1>
        <button class="btn btn-primary" id="open-create-modal">
            <i class="fas fa-plus"></i> New Project
        </button>
    </div>

    {% if projects %}
        <div class="project-list">
            {% for item in projects %}
                <div class="project-list-item">
                    <a href="{% url 'create_conversation' item.project.project_id %}" class="project-list-link">
                        <div class="project-list-main">
                            <div class="project-list-header">
                                <span class="project-icon">{{ item.project.icon }}</span>
                                <h3 class="project-name">{{ item.project.name }}</h3>
                            </div>
                            <div class="project-stats">
                                <div class="stat-item">
                                    <i class="fas fa-comments"></i>
                                    <span class="stat-value">{{ item.conversations_count }}</span>
                                    <span class="stat-label">Conversations</span>
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-file-alt"></i>
                                    <span class="stat-value">{{ item.documents_count }}</span>
                                    <span class="stat-label">Documents</span>
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-tasks"></i>
                                    <span class="stat-value">{{ item.tickets_count }}</span>
                                    <span class="stat-label">Tickets</span>
                                </div>
                                {% if item.codebase_info %}
                                <div class="stat-item codebase-stat" 
                                     title="{{ item.codebase_info.github_repo_name }} - {{ item.codebase_info.indexed_files }}/{{ item.codebase_info.total_files }} files indexed">
                                    <i class="fas fa-code-branch"></i>
                                    <span class="stat-value">{{ item.codebase_info.total_chunks }}</span>
                                    <span class="stat-label">Code Chunks</span>
                                    <span class="codebase-status status-{{ item.codebase_info.status }}"
                                          title="Status: {{ item.codebase_info.status|capfirst }}"></span>
                                </div>
                                {% else %}
                                <div class="stat-item codebase-stat codebase-not-connected" 
                                     title="No codebase connected - Click to connect a GitHub repository">
                                    <i class="fas fa-code-branch"></i>
                                    <span class="stat-value">—</span>
                                    <span class="stat-label">Codebase</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    <div class="project-list-actions">
                        <div class="dropdown">
                            <button class="dropdown-button">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="dropdown-menu">
                                <a href="{% url 'projects:project_detail' item.project.project_id %}" 
                                   class="dropdown-item" 
                                   onclick="setTimeout(() => openCodebaseSidebar(), 100)">
                                    <i class="fas fa-code-branch"></i> 
                                    {% if item.codebase_info %}
                                        Manage Codebase
                                    {% else %}
                                        Connect Codebase
                                    {% endif %}
                                </a>
                                <button type="button" class="dropdown-item link-github-btn" 
                                        data-project-id="{{ item.project.project_id }}"
                                        data-project-name="{{ item.project.name }}">
                                    <i class="fab fa-github"></i> Link GitHub
                                </button>
                                <button type="button" class="dropdown-item edit-project-btn" 
                                        data-project-id="{{ item.project.project_id }}"
                                        data-project-name="{{ item.project.name }}"
                                        data-project-description="{{ item.project.description }}"
                                        data-project-icon="{{ item.project.icon }}"
                                        data-project-status="{{ item.project.status }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <form action="{% url 'projects:delete_project' item.project.project_id %}" method="post" style="margin: 0; padding: 0;">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item dropdown-item-danger delete-project-btn" data-project-name="{{ item.project.name }}">
                                        <i class="fas fa-trash-alt"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-state-illustration">
                <div class="illustration-rocket">
                    <i class="fas fa-rocket"></i>
                </div>
                <div class="illustration-particles">
                    <span class="particle"></span>
                    <span class="particle"></span>
                    <span class="particle"></span>
                </div>
            </div>
            <h2 class="empty-state-title">Let's Get Started</h2>
            <div class="empty-state-text">
                Create your first project to begin building with AI.
            </div>
            <button class="btn btn-primary btn-large" id="open-create-modal-empty">
                <i class="fas fa-rocket"></i> Create Your First Project
            </button>
        </div>
    {% endif %}
</div>

<!-- Create Project Modal -->
<div class="modal-overlay" id="create-project-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Create New Project</h2>
            <button class="modal-close" id="close-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form method="post" action="{% url 'projects:create_project' %}" id="create-project-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="project-name" class="form-label">Project Name*</label>
                    <input type="text" id="project-name" name="name" class="form-control" required autofocus>
                </div>
                <input type="hidden" name="description" value="">
                <input type="hidden" name="icon" value="🚀">
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancel-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal-overlay" id="edit-project-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Edit Project</h2>
            <button class="modal-close" id="close-edit-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form method="post" action="" id="edit-project-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="edit-project-name" class="form-label">Project Name*</label>
                    <input type="text" id="edit-project-name" name="name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-project-description" class="form-label">Description (optional)</label>
                    <textarea id="edit-project-description" name="description" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Project Icon</label>
                    <input type="hidden" id="edit-project-icon" name="icon" value="">
                    
                    <div class="emoji-picker">
                        <div class="emoji-option" data-emoji="📋">📋</div>
                        <div class="emoji-option" data-emoji="📊">📊</div>
                        <div class="emoji-option" data-emoji="🚀">🚀</div>
                        <div class="emoji-option" data-emoji="💡">💡</div>
                        <div class="emoji-option" data-emoji="📱">📱</div>
                        <div class="emoji-option" data-emoji="🌐">🌐</div>
                        <div class="emoji-option" data-emoji="📈">📈</div>
                        <div class="emoji-option" data-emoji="🎯">🎯</div>
                        <div class="emoji-option" data-emoji="🔍">🔍</div>
                        <div class="emoji-option" data-emoji="⚙️">⚙️</div>
                        <div class="emoji-option" data-emoji="🎨">🎨</div>
                        <div class="emoji-option" data-emoji="📝">📝</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit-project-status" class="form-label">Status</label>
                    <select id="edit-project-status" name="status" class="form-control">
                        <option value="active">Active</option>
                        <option value="archived">Archived</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancel-edit-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Project</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Link GitHub Modal -->
<div class="modal-overlay" id="link-github-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Link GitHub Repository</h2>
            <button class="modal-close" id="close-github-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="github-step-1" class="github-step">
                <div class="github-connection-info">
                    <div class="github-icon">
                        <i class="fab fa-github"></i>
                    </div>
                    <h3>Connect to GitHub</h3>
                    <p>To link your repository, we need to connect to your GitHub account first.</p>
                    <div class="github-benefits">
                        <div class="benefit-item">
                            <i class="fas fa-check"></i>
                            Access your repositories
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-check"></i>
                            Clone and analyze your code
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-check"></i>
                            Generate context-aware features
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancel-github-modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="connect-github-btn">
                        <i class="fab fa-github"></i> Connect GitHub
                    </button>
                </div>
            </div>
            
            <div id="github-step-2" class="github-step" style="display: none;">
                <form id="link-repository-form">
                    <div class="form-group">
                        <label for="github-url" class="form-label">GitHub Repository URL*</label>
                        <input type="url" id="github-url" name="github_url" class="form-control" required 
                               placeholder="https://github.com/username/repository">
                        <div class="form-text">Make sure this repository is accessible with your connected GitHub account.</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="github-branch" class="form-label">Branch to Index</label>
                        <input type="text" id="github-branch" name="branch" class="form-control" value="main" required>
                        <div class="form-text">Typically 'main' or 'master'</div>
                    </div>
                    
                    <div class="indexing-info">
                        <h4>What happens during indexing:</h4>
                        <ul>
                            <li>Repository is cloned and analyzed</li>
                            <li>Code is parsed into semantic chunks (functions, classes, etc.)</li>
                            <li>Vector embeddings are created for intelligent search</li>
                            <li>AI tools gain context about your existing codebase</li>
                        </ul>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" id="back-to-step1">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-link"></i> Start Indexing
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create Project Modal
    const modal = document.getElementById('create-project-modal');
    const openBtn = document.getElementById('open-create-modal');
    const openBtnEmpty = document.getElementById('open-create-modal-empty');
    const closeBtn = document.getElementById('close-modal');
    const cancelBtn = document.getElementById('cancel-modal');
    const projectNameInput = document.getElementById('project-name');
    
    function openModal() {
        modal.classList.add('active');
        // Focus on the input field when modal opens
        setTimeout(() => {
            projectNameInput.focus();
        }, 100);
    }
    
    function closeModal() {
        modal.classList.remove('active');
        projectNameInput.value = '';
    }
    
    // Open modal
    if (openBtn) {
        openBtn.addEventListener('click', openModal);
    }
    
    if (openBtnEmpty) {
        openBtnEmpty.addEventListener('click', openModal);
    }
    
    // Close modal
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });
    
    // Edit Project Modal
    const editModal = document.getElementById('edit-project-modal');
    const closeEditBtn = document.getElementById('close-edit-modal');
    const cancelEditBtn = document.getElementById('cancel-edit-modal');
    const editForm = document.getElementById('edit-project-form');
    const editProjectName = document.getElementById('edit-project-name');
    const editProjectDescription = document.getElementById('edit-project-description');
    const editProjectIcon = document.getElementById('edit-project-icon');
    const editProjectStatus = document.getElementById('edit-project-status');
    
    function openEditModal(projectData) {
        editModal.classList.add('active');
        
        // Set form action
        editForm.action = `/projects/${projectData.projectId}/update/`;
        
        // Populate form fields
        editProjectName.value = projectData.name;
        editProjectDescription.value = projectData.description || '';
        editProjectIcon.value = projectData.icon;
        editProjectStatus.value = projectData.status;
        
        // Update emoji picker
        const emojiOptions = editModal.querySelectorAll('.emoji-option');
        emojiOptions.forEach(option => {
            if (option.getAttribute('data-emoji') === projectData.icon) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
        
        // Focus on the input field when modal opens
        setTimeout(() => {
            editProjectName.focus();
        }, 100);
    }
    
    function closeEditModal() {
        editModal.classList.remove('active');
        editForm.reset();
    }
    
    // Handle edit button clicks
    document.querySelectorAll('.edit-project-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const projectData = {
                projectId: this.getAttribute('data-project-id'),
                name: this.getAttribute('data-project-name'),
                description: this.getAttribute('data-project-description'),
                icon: this.getAttribute('data-project-icon'),
                status: this.getAttribute('data-project-status')
            };
            openEditModal(projectData);
        });
    });
    
    // Close edit modal
    closeEditBtn.addEventListener('click', closeEditModal);
    cancelEditBtn.addEventListener('click', closeEditModal);
    
    // Close edit modal when clicking outside
    editModal.addEventListener('click', function(e) {
        if (e.target === editModal) {
            closeEditModal();
        }
    });
    
    // Close edit modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && editModal.classList.contains('active')) {
            closeEditModal();
        }
    });
    
    // Handle emoji picker for edit modal
    editModal.querySelectorAll('.emoji-option').forEach(option => {
        option.addEventListener('click', function() {
            // Remove selected class from all options
            editModal.querySelectorAll('.emoji-option').forEach(opt => opt.classList.remove('selected'));
            // Add selected class to clicked option
            this.classList.add('selected');
            // Update hidden input
            editProjectIcon.value = this.getAttribute('data-emoji');
        });
    });
    
    // GitHub Link Modal
    const githubModal = document.getElementById('link-github-modal');
    const closeGithubBtn = document.getElementById('close-github-modal');
    const cancelGithubBtn = document.getElementById('cancel-github-modal');
    const connectGithubBtn = document.getElementById('connect-github-btn');
    const backToStep1Btn = document.getElementById('back-to-step1');
    const linkRepoForm = document.getElementById('link-repository-form');
    const githubStep1 = document.getElementById('github-step-1');
    const githubStep2 = document.getElementById('github-step-2');
    
    let currentProjectData = null;
    
    function openGithubModal(projectData) {
        currentProjectData = projectData;
        githubModal.classList.add('active');
        
        // Check if GitHub is already connected
        checkGitHubConnection().then(connected => {
            if (connected) {
                showStep2();
            } else {
                showStep1();
            }
        });
    }
    
    function closeGithubModal() {
        githubModal.classList.remove('active');
        showStep1();
        linkRepoForm.reset();
        currentProjectData = null;
    }
    
    function showStep1() {
        githubStep1.style.display = 'block';
        githubStep2.style.display = 'none';
    }
    
    function showStep2() {
        githubStep1.style.display = 'none';
        githubStep2.style.display = 'block';
    }
    
    async function checkGitHubConnection() {
        try {
            const response = await fetch('/accounts/api/github-status/');
            const data = await response.json();
            return data.connected || false;
        } catch (error) {
            return false;
        }
    }
    
    // Handle Link GitHub button clicks
    document.querySelectorAll('.link-github-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const projectData = {
                projectId: this.getAttribute('data-project-id'),
                name: this.getAttribute('data-project-name')
            };
            openGithubModal(projectData);
        });
    });
    
    // Modal close events
    closeGithubBtn.addEventListener('click', closeGithubModal);
    cancelGithubBtn.addEventListener('click', closeGithubModal);
    
    // GitHub connection button
    connectGithubBtn.addEventListener('click', async function() {
        try {
            const response = await fetch('/accounts/api/github-oauth-url/');
            const data = await response.json();
            
            if (data.connected) {
                // Already connected, show step 2
                showStep2();
            } else if (data.auth_url) {
                // Redirect to GitHub OAuth
                window.location.href = data.auth_url;
            } else {
                alert('Error: GitHub OAuth is not configured');
            }
        } catch (error) {
            alert('Error connecting to GitHub: ' + error.message);
        }
    });
    
    // Back to step 1
    backToStep1Btn.addEventListener('click', function() {
        showStep1();
    });
    
    // Repository linking form
    linkRepoForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const githubUrl = document.getElementById('github-url').value;
        const githubBranch = document.getElementById('github-branch').value;
        
        if (!githubUrl || !currentProjectData) {
            alert('Please enter a GitHub repository URL');
            return;
        }
        
        try {
            const response = await fetch('/codebase/api/repositories/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    project_id: currentProjectData.projectId,
                    github_url: githubUrl,
                    branch: githubBranch
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`Repository linked successfully! Indexing has started for ${currentProjectData.name}.`);
                closeGithubModal();
                // Optionally reload to show updated project status
                location.reload();
            } else {
                alert('Error linking repository: ' + data.error);
            }
        } catch (error) {
            alert('Error linking repository: ' + error.message);
        }
    });
    
    // Close modals when clicking outside
    githubModal.addEventListener('click', function(e) {
        if (e.target === githubModal) {
            closeGithubModal();
        }
    });
});
</script>
{% endblock %} 