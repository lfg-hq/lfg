{% extends 'projects/base_with_sidebar.html' %}

{% block title %}Preview - {{ project.name }} - LFG{% endblock %}

{% block extra_css %}
<style>
    /* Override main content styling for full-height preview */
    .main-content-with-sidebar {
        padding: 0 !important;
        overflow: hidden;
    }

    .main-content-with-sidebar .container {
        max-width: 100%;
        padding: 0;
        height: 100vh;
    }

    /* Preview page container */
    .preview-page-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: var(--surface-primary, #0d0d0d);
    }

    /* Preview header */
    .preview-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        background: var(--surface-secondary, #1a1a1a);
        border-bottom: 1px solid var(--border-color, #333);
        flex-shrink: 0;
    }

    /* Server status */
    .server-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: var(--surface-primary);
        border-radius: 6px;
        border: 1px solid var(--border-color);
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #888;
        transition: all 0.3s ease;
    }

    .status-dot.running {
        background: #22c55e;
        box-shadow: 0 0 6px #22c55e;
    }

    .status-dot.stopped {
        background: #ef4444;
    }

    .status-dot.loading {
        background: #f59e0b;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .status-text {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* URL bar */
    .url-bar {
        flex: 1;
        display: flex;
        gap: 0.5rem;
        max-width: 600px;
    }

    .url-bar input {
        flex: 1;
        background: var(--surface-primary, #0d0d0d);
        border: 1px solid var(--border-color, #333);
        color: var(--text-primary);
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.8rem;
    }

    .url-bar button {
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .url-bar button:hover {
        background: var(--surface-secondary);
        color: var(--text-primary);
    }

    /* Viewport toggle */
    .viewport-toggle {
        display: flex;
        background: var(--surface-primary);
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .viewport-toggle button {
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .viewport-toggle button:hover {
        color: var(--text-primary);
    }

    .viewport-toggle button.active {
        background: var(--accent-purple, #8B5CF6);
        color: white;
    }

    /* Server controls dropdown */
    .server-controls {
        position: relative;
    }

    .server-dropdown-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .server-dropdown-toggle:hover {
        background: var(--surface-secondary);
        color: var(--text-primary);
    }

    .server-dropdown-toggle i.fa-caret-down {
        font-size: 0.75rem;
        opacity: 0.7;
    }

    .server-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 0.25rem;
        min-width: 160px;
        background: var(--surface-secondary, #1a1a1a);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        display: none;
        overflow: hidden;
    }

    .server-dropdown-menu.show {
        display: block;
    }

    .server-dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.625rem 1rem;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
        text-align: left;
    }

    .server-dropdown-item:hover:not(:disabled) {
        background: var(--surface-primary);
        color: var(--text-primary);
    }

    .server-dropdown-item:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .server-dropdown-item i {
        width: 16px;
        text-align: center;
    }

    .server-dropdown-item.start-item:hover:not(:disabled) {
        color: #22c55e;
    }

    .server-dropdown-item.stop-item:hover:not(:disabled) {
        color: #ef4444;
    }

    .server-dropdown-item.restart-item:hover:not(:disabled) {
        color: #f59e0b;
    }

    /* Open in new tab button */
    .open-tab-btn {
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .open-tab-btn:hover {
        background: var(--surface-secondary);
        color: var(--text-primary);
    }

    /* Console toggle in header */
    .console-toggle-btn {
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .console-toggle-btn:hover {
        background: var(--surface-secondary);
        color: var(--text-primary);
    }

    .console-toggle-btn.has-errors {
        border-color: #ef4444;
        color: #ef4444;
    }

    .console-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #ef4444;
        color: white;
        font-size: 0.65rem;
        padding: 0.1rem 0.35rem;
        border-radius: 10px;
        min-width: 16px;
        text-align: center;
    }

    /* Iframe container */
    .preview-iframe-container {
        flex: 1;
        overflow: hidden;
        background: #1a1a1a;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 0;
    }

    .iframe-wrapper {
        height: 100%;
        background: white;
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .iframe-wrapper.desktop-view {
        width: 100%;
    }

    .iframe-wrapper.mobile-view {
        width: 375px;
        max-height: calc(100% - 40px);
        box-shadow: 0 0 40px rgba(0,0,0,0.5);
        border-radius: 24px;
        margin: 20px 0;
        position: relative;
    }

    .iframe-wrapper.mobile-view::before {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 4px;
        background: #333;
        border-radius: 2px;
        z-index: 10;
    }

    .iframe-wrapper.mobile-view iframe {
        border-radius: 24px;
    }

    .preview-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }

    .iframe-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
        text-align: center;
        padding: 2rem;
    }

    .iframe-placeholder i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .iframe-placeholder p {
        margin-bottom: 1rem;
    }

    .iframe-placeholder button {
        padding: 0.75rem 1.5rem;
        background: var(--accent-purple, #8B5CF6);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }

    .iframe-placeholder button:hover {
        background: var(--accent-purple-hover, #7C3AED);
    }

    /* Console panel */
    .preview-console-panel {
        height: 200px;
        min-height: 40px;
        max-height: 50vh;
        background: var(--surface-primary, #0d0d0d);
        border-top: 1px solid var(--border-color, #333);
        display: flex;
        flex-direction: column;
        transition: height 0.3s ease;
        flex-shrink: 0;
    }

    .preview-console-panel.collapsed {
        height: 40px;
        min-height: 40px;
    }

    .console-resize-handle {
        height: 6px;
        background: rgba(139, 92, 246, 0.3);
        cursor: ns-resize;
        transition: background 0.2s;
        flex-shrink: 0;
        position: relative;
    }

    .console-resize-handle::before {
        content: '';
        position: absolute;
        top: -4px;
        left: 0;
        right: 0;
        height: 14px;
        cursor: ns-resize;
    }

    .console-resize-handle:hover {
        background: var(--accent-purple);
    }

    .console-resize-handle:active {
        background: var(--accent-purple);
    }

    .console-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--surface-secondary);
        flex-shrink: 0;
    }

    .console-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
    }

    .console-title i {
        color: var(--accent-purple);
    }

    .console-tabs {
        display: flex;
        gap: 0.25rem;
    }

    .console-tab {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .console-tab:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }

    .console-tab.active {
        background: rgba(139, 92, 246, 0.15);
        color: #a78bfa;
    }

    .console-tab i {
        font-size: 0.75rem;
    }

    .log-count {
        color: var(--text-secondary);
        font-size: 0.75rem;
    }

    .server-logs-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.8rem;
        background: #0a0a0a;
    }

    .server-logs-placeholder {
        color: var(--text-secondary);
        padding: 1rem;
        text-align: center;
        font-style: italic;
    }

    .server-logs-output {
        white-space: pre-wrap;
        word-break: break-all;
        line-height: 1.5;
        color: #d4d4d4;
    }

    .console-actions {
        display: flex;
        gap: 0.5rem;
    }

    .console-actions button {
        padding: 0.35rem 0.6rem;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.2s;
    }

    .console-actions button:hover:not(:disabled) {
        background: var(--surface-primary);
        color: var(--text-primary);
    }

    .console-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Floating Create Ticket Button */
    .floating-ticket-btn {
        position: fixed;
        z-index: 1000;
        animation: fadeInUp 0.15s ease-out;
    }

    .floating-ticket-btn button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.875rem;
        background: var(--accent-purple, #8B5CF6);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        transition: all 0.2s;
    }

    .floating-ticket-btn button:hover {
        background: var(--accent-purple-hover, #7C3AED);
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.5);
    }

    .floating-ticket-btn button i {
        font-size: 0.75rem;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .console-actions .btn-create-ticket {
        background: var(--accent-purple);
        border-color: var(--accent-purple);
        color: white;
    }

    .console-actions .btn-create-ticket:hover:not(:disabled) {
        background: var(--accent-purple-hover, #7C3AED);
    }

    .console-logs {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.75rem;
        line-height: 1.4;
    }

    .console-placeholder {
        color: var(--text-secondary);
        font-style: italic;
        padding: 1rem;
        text-align: center;
    }

    .console-entry {
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        margin-bottom: 2px;
        display: flex;
        gap: 0.5rem;
        align-items: flex-start;
    }

    .console-entry:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .console-entry.console-error {
        background: rgba(239, 68, 68, 0.1);
    }

    .console-entry.console-warn {
        background: rgba(245, 158, 11, 0.1);
    }

    .console-timestamp {
        color: var(--text-secondary);
        opacity: 0.6;
        flex-shrink: 0;
        font-size: 0.7rem;
    }

    .console-type {
        flex-shrink: 0;
        font-weight: 600;
        font-size: 0.7rem;
    }

    .console-message {
        flex: 1;
        word-break: break-word;
        white-space: pre-wrap;
    }

    /* Console selection highlighting */
    .console-logs ::selection {
        background: var(--accent-purple);
        color: white;
    }

    /* Create ticket modal */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: var(--surface-secondary, #1a1a1a);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        border: 1px solid var(--border-color);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h3 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
    }

    .modal-header h3 i {
        color: var(--accent-purple);
    }

    .modal-close-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .modal-close-btn:hover {
        background: var(--surface-primary);
        color: var(--text-primary);
    }

    .modal-body {
        padding: 1.25rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        background: var(--surface-primary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-family: inherit;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--accent-purple);
    }

    .form-group textarea {
        min-height: 150px;
        resize: vertical;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--border-color);
    }

    .btn-secondary {
        padding: 0.6rem 1rem;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: var(--surface-primary);
        color: var(--text-primary);
    }

    .btn-primary {
        padding: 0.6rem 1rem;
        background: var(--accent-purple, #8B5CF6);
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary:hover {
        background: var(--accent-purple-hover, #7C3AED);
    }

    /* Notification toast */
    .notification-toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        z-index: 2000;
        animation: slideInUp 0.3s ease;
    }

    .notification-toast.success {
        background: #22c55e;
        color: white;
    }

    .notification-toast.error {
        background: #ef4444;
        color: white;
    }

    @keyframes slideInUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Screenshot capture overlay */
    .screenshot-overlay {
        display: none;
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        cursor: crosshair;
        z-index: 100;
    }

    .screenshot-overlay.active {
        display: block;
    }

    .screenshot-selection {
        position: absolute;
        border: 2px dashed var(--accent-purple);
        background: rgba(139, 92, 246, 0.1);
        pointer-events: none;
    }

    .screenshot-hint {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--surface-secondary);
        color: var(--text-primary);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-size: 0.9rem;
        text-align: center;
        pointer-events: none;
    }

    .screenshot-hint i {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--accent-purple);
    }

    /* Screenshot modal */
    .screenshot-preview-container {
        max-height: 300px;
        overflow: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1rem;
        background: #000;
    }

    .screenshot-preview-container img {
        max-width: 100%;
        display: block;
    }

    .screenshot-actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .screenshot-actions button {
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
        background: var(--surface-primary);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 4px;
        cursor: pointer;
    }

    .screenshot-actions button:hover {
        background: var(--surface-secondary);
        color: var(--text-primary);
    }

    /* Screenshot context section */
    .screenshot-context-section {
        background: var(--surface-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 1rem;
    }

    .screenshot-context-section .context-header {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .screenshot-context-section .context-header i {
        color: var(--accent-blue);
    }

    .screenshot-context-section .context-fields {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .screenshot-context-section .context-field {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .screenshot-context-section .context-field label {
        font-size: 0.7rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .screenshot-context-section .context-field label i {
        font-size: 0.65rem;
    }

    .screenshot-context-section .context-field input {
        background: var(--surface-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .screenshot-context-section .context-field input[readonly] {
        cursor: default;
    }

    /* Inline Progress Styles */
    .progress-content {
        display: none;
        width: 100%;
        max-width: 280px;
    }

    .progress-content.active {
        display: block;
    }

    .progress-title {
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 1.25rem;
        text-align: center;
        color: var(--text-secondary);
    }

    .progress-steps {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        text-align: left;
    }

    .progress-step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.75rem;
        background: transparent;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .progress-step.active {
        background: rgba(139, 92, 246, 0.15);
        border-radius: 6px;
    }

    .progress-step.error {
        background: rgba(239, 68, 68, 0.15);
    }

    .step-icon {
        width: 20px;
        height: 20px;
        min-width: 20px;
        min-height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--surface-secondary, #2a2a2a);
        color: var(--text-secondary, #888);
        font-size: 0.55rem;
        flex-shrink: 0;
        border: 1px solid var(--border-color, #333);
        position: relative;
    }

    .step-icon i {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .step-icon i.fa-spinner {
        animation: spin-centered 1s linear infinite;
    }

    @keyframes spin-centered {
        from { transform: translate(-50%, -50%) rotate(0deg); }
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .step-label {
        font-size: 0.8rem;
        color: var(--text-secondary, #666);
        display: flex;
        align-items: center;
        height: 20px;
    }

    .progress-step.active .step-icon {
        background: var(--accent-purple, #8B5CF6);
        color: white;
        border-color: var(--accent-purple, #8B5CF6);
    }

    .progress-step.completed .step-icon {
        background: #22c55e;
        color: white;
        border-color: #22c55e;
    }

    .progress-step.error .step-icon {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }

    .progress-step.active .step-label {
        color: #6d28d9;
        font-weight: 500;
    }

    .progress-step.completed .step-label {
        color: var(--text-secondary, #666);
    }

    .progress-step.error .step-label {
        color: #ef4444;
    }

    .progress-error-message {
        margin-top: 1rem;
        padding: 0.75rem;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid #ef4444;
        border-radius: 6px;
        color: #ef4444;
        text-align: center;
        font-size: 0.8rem;
    }

    .progress-close-btn {
        margin-top: 0.75rem;
        padding: 0.4rem 0.75rem;
        background: var(--surface-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.2s;
    }

    .progress-close-btn:hover {
        background: var(--surface-primary);
        color: var(--text-primary);
    }

    /* Placeholder content states */
    .placeholder-ready-content,
    .placeholder-no-workspace-content,
    .placeholder-provisioning-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    /* Start server button */
    .start-server-btn {
        padding: 0.5rem 1rem !important;
        background: var(--accent-purple, #8B5CF6) !important;
        color: white !important;
        border: none !important;
        border-radius: 6px !important;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .start-server-btn:hover {
        background: #7c3aed !important;
    }

    .start-server-btn i {
        font-size: 0.75rem;
        margin-bottom: 0 !important;
        opacity: 1 !important;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="preview-page-container">
    <!-- Preview Header -->
    <div class="preview-header">
        <!-- Server Status -->
        <div class="server-status">
            <span class="status-dot" id="serverStatusDot"></span>
            <span class="status-text" id="serverStatusText">Checking...</span>
        </div>

        <!-- URL Bar -->
        <div class="url-bar">
            <input type="text" id="previewUrlInput" placeholder="Enter URL or start server..." onkeydown="handleUrlKeydown(event)">
            <button onclick="loadManualUrl()" title="Go" id="goBtn">
                <i class="fas fa-arrow-right"></i>
            </button>
            <button onclick="reloadPreview()" title="Reload" id="reloadBtn" disabled>
                <i class="fas fa-redo"></i>
            </button>
        </div>

        <!-- Viewport Toggle -->
        <div class="viewport-toggle">
            <button id="desktopViewBtn" class="active" onclick="setViewport('desktop')" title="Desktop View">
                <i class="fas fa-desktop"></i>
            </button>
            <button id="mobileViewBtn" onclick="setViewport('mobile')" title="Mobile View">
                <i class="fas fa-mobile-alt"></i>
            </button>
        </div>

        <!-- Server Controls Dropdown -->
        <div class="server-controls">
            <button class="server-dropdown-toggle" onclick="toggleServerDropdown()" id="serverDropdownToggle">
                <i class="fas fa-server"></i>
                Server
                <i class="fas fa-caret-down"></i>
            </button>
            <div class="server-dropdown-menu" id="serverDropdownMenu">
                <button class="server-dropdown-item start-item" onclick="startServer(); closeServerDropdown();" id="startServerBtn">
                    <i class="fas fa-play"></i> Start Server
                </button>
                <button class="server-dropdown-item stop-item" onclick="stopServer(); closeServerDropdown();" id="stopServerBtn" disabled>
                    <i class="fas fa-stop"></i> Stop Server
                </button>
                <button class="server-dropdown-item restart-item" onclick="restartServer(); closeServerDropdown();" id="restartServerBtn" disabled>
                    <i class="fas fa-sync-alt"></i> Restart Server
                </button>
            </div>
        </div>

        <!-- Screenshot Capture -->
        <button class="console-toggle-btn" onclick="startScreenshotCapture()" title="Capture Screenshot" id="screenshotBtn">
            <i class="fas fa-camera"></i>
        </button>

        <!-- Console Toggle -->
        <button class="console-toggle-btn" onclick="toggleConsole()" title="Toggle Console" id="consoleToggleBtn">
            <i class="fas fa-terminal"></i>
            <span class="console-badge" id="consoleBadge" style="display: none;">0</span>
        </button>

        <!-- Open in New Tab -->
        <button class="open-tab-btn" onclick="openInNewTab()" title="Open in New Tab" id="openTabBtn" disabled>
            <i class="fas fa-external-link-alt"></i>
        </button>
    </div>

    <!-- Preview Iframe Container -->
    <div class="preview-iframe-container" id="iframeContainer" style="position: relative;">
        <!-- Screenshot Overlay -->
        <div class="screenshot-overlay" id="screenshotOverlay">
            <div class="screenshot-hint" id="screenshotHint">
                <i class="fas fa-crop-alt"></i>
                Drag to select area<br>
                <small>Press ESC to cancel</small>
            </div>
            <div class="screenshot-selection" id="screenshotSelection"></div>
        </div>
        <div class="iframe-wrapper desktop-view" id="iframeWrapper">
            <div class="iframe-placeholder" id="iframePlaceholder">
                <!-- Ready State (with workspace) -->
                <div id="readyContent" class="placeholder-ready-content" {% if not workspace %}style="display: none;"{% endif %}>
                    <i class="fas fa-server" style="font-size: 2rem; opacity: 0.4; margin-bottom: 0.75rem;"></i>
                    <p style="font-weight: 500; margin-bottom: 0.25rem;">Workspace Ready</p>
                    <p style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 1rem;">Start the dev server to preview your application</p>
                    <button onclick="startServer()" class="start-server-btn">
                        <i class="fas fa-play"></i> Start Server
                    </button>
                </div>

                <!-- No Workspace State -->
                <div id="noWorkspaceContent" class="placeholder-no-workspace-content" {% if workspace %}style="display: none;"{% endif %}>
                    <i class="fas fa-cloud" style="font-size: 2rem; opacity: 0.4; margin-bottom: 0.75rem;"></i>
                    <p style="font-weight: 500; margin-bottom: 0.25rem;">No Workspace</p>
                    <p style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 1rem;">Create a workspace to preview your application</p>
                    <button onclick="provisionWorkspace()" id="provisionBtn" class="start-server-btn">
                        <i class="fas fa-plus"></i> Create Workspace
                    </button>
                </div>

                <!-- Provisioning State -->
                <div id="provisioningContent" class="placeholder-provisioning-content" style="display: none;">
                    <i class="fas fa-spinner fa-spin" style="color: #8B5CF6; font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p style="font-weight: 500;">Creating Workspace...</p>
                    <p id="provisionStatus" style="font-size: 0.875rem; opacity: 0.7;">Provisioning VM, this may take up to 2 minutes</p>
                </div>

                <!-- Progress State (inline) -->
                <div id="progressContent" class="progress-content">
                    <div class="progress-title">Starting Server</div>
                    <div class="progress-steps" id="progressSteps">
                        <div class="progress-step" data-step="checking_workspace">
                            <div class="step-icon"></div>
                            <span class="step-label">Checking workspace</span>
                        </div>
                        <div class="progress-step" data-step="switching_branch">
                            <div class="step-icon"></div>
                            <span class="step-label">Switching branch</span>
                        </div>
                        <div class="progress-step" data-step="downloading_dependencies">
                            <div class="step-icon"></div>
                            <span class="step-label">Installing dependencies</span>
                        </div>
                        <div class="progress-step" data-step="clearing_cache">
                            <div class="step-icon"></div>
                            <span class="step-label">Clearing cache</span>
                        </div>
                        <div class="progress-step" data-step="starting_server">
                            <div class="step-icon"></div>
                            <span class="step-label">Starting dev server</span>
                        </div>
                        <div class="progress-step" data-step="assigning_proxy">
                            <div class="step-icon"></div>
                            <span class="step-label">Assigning proxy URL</span>
                        </div>
                    </div>
                    <div class="progress-error-message" id="progressErrorMessage" style="display: none;"></div>
                    <button class="progress-close-btn" id="progressCloseBtn" style="display: none;" onclick="closeProgress()">Close</button>
                </div>
            </div>
            <iframe
                id="previewIframe"
                class="preview-iframe"
                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-top-navigation allow-top-navigation-by-user-activation"
                style="display: none;"
            ></iframe>
        </div>
    </div>

    <!-- Console Panel -->
    <div class="preview-console-panel collapsed" id="consolePanel">
        <div class="console-resize-handle" id="consoleResizeHandle"></div>
        <div class="console-header">
            <div class="console-tabs">
                <button class="console-tab active" onclick="switchConsoleTab('console')" id="consoleTabBtn">
                    <i class="fas fa-terminal"></i>
                    <span>Console</span>
                    <span class="log-count" id="logCount">(0)</span>
                </button>
                <button class="console-tab" onclick="switchConsoleTab('server-logs')" id="serverLogsTabBtn">
                    <i class="fas fa-server"></i>
                    <span>Server Logs</span>
                </button>
            </div>
            <div class="console-actions">
                <button onclick="clearConsole()" title="Clear Console" id="clearConsoleBtn">
                    <i class="fas fa-trash"></i> Clear
                </button>
                <button class="btn-create-ticket" onclick="openCreateTicketModal()" title="Create Ticket from Selected Text" id="createTicketBtn" disabled>
                    <i class="fas fa-ticket-alt"></i> Create Ticket
                </button>
                <button onclick="refreshServerLogs()" title="Refresh Server Logs" id="refreshServerLogsBtn" style="display: none;">
                    <i class="fas fa-sync-alt" style="margin-right: 0.25rem;"></i> Refresh
                </button>
                <button onclick="toggleConsole()" title="Collapse Console">
                    <i class="fas fa-chevron-up" id="consoleToggleIcon"></i>
                </button>
            </div>
        </div>
        <div class="console-logs" id="consoleLogs">
            <div class="console-placeholder">Console logs will appear here when the app runs...</div>
        </div>
        <div class="server-logs-content" id="serverLogsContent" style="display: none;">
            <div class="server-logs-placeholder">Server logs will appear here...</div>
        </div>
    </div>
</div>

<!-- Floating Create Ticket Button -->
<div class="floating-ticket-btn" id="floatingTicketBtn" style="display: none;">
    <button onclick="openCreateTicketModal()">
        <i class="fas fa-ticket-alt"></i> Create Ticket
    </button>
</div>

<!-- Create Ticket Modal -->
<div class="modal-overlay" id="consoleTicketModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-ticket-alt"></i> Create Ticket from Console</h3>
            <button class="modal-close-btn" onclick="closeCreateTicketModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="consoleTicketForm" onsubmit="handleCreateTicket(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label for="ticketName">Ticket Name</label>
                    <input type="text" id="ticketName" name="name" required placeholder="Brief description of the issue">
                </div>
                <div class="form-group">
                    <label for="ticketDescription">Description</label>
                    <textarea id="ticketDescription" name="description" required placeholder="Detailed description..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCreateTicketModal()">Cancel</button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-plus"></i> Create Ticket
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Screenshot Ticket Modal -->
<div class="modal-overlay" id="screenshotTicketModal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fas fa-camera"></i> Create Ticket from Screenshot</h3>
            <button class="modal-close-btn" onclick="closeScreenshotModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="screenshotTicketForm" onsubmit="handleCreateScreenshotTicket(event)">
            <div class="modal-body">
                <div class="screenshot-preview-container">
                    <img id="screenshotPreviewImg" src="" alt="Screenshot preview">
                </div>
                <div class="screenshot-actions">
                    <button type="button" onclick="retakeScreenshot()">
                        <i class="fas fa-redo"></i> Retake
                    </button>
                    <button type="button" onclick="downloadScreenshot()">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
                <div class="form-group">
                    <label for="screenshotTicketName">Ticket Name</label>
                    <input type="text" id="screenshotTicketName" name="name" required placeholder="Brief description of the issue">
                </div>
                <div class="form-group">
                    <label for="screenshotTicketDescription">Comments</label>
                    <textarea id="screenshotTicketDescription" name="description" placeholder="Add your comments about this issue..."></textarea>
                </div>
                <!-- Context Information -->
                <div class="screenshot-context-section">
                    <div class="context-header">
                        <i class="fas fa-info-circle"></i> Context Captured
                    </div>
                    <div class="context-fields">
                        <div class="context-field">
                            <label><i class="fas fa-link"></i> Page URL</label>
                            <input type="text" id="screenshotContextUrl" readonly>
                        </div>
                        <div class="context-field">
                            <label><i class="fas fa-desktop"></i> Viewport</label>
                            <input type="text" id="screenshotContextViewport" readonly>
                        </div>
                        <div class="context-field" id="screenshotErrorCountField" style="display: none;">
                            <label><i class="fas fa-exclamation-triangle"></i> Console Errors</label>
                            <input type="text" id="screenshotContextErrors" readonly>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeScreenshotModal()">Cancel</button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-plus"></i> Create Ticket
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Configuration
    const projectId = '{{ project.project_id }}';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const serverConfigs = {{ server_configs|safe }};
    const previewPort = {{ preview_port }};  // Dynamic port based on project stack
    let workspace = {{ workspace_json|safe }};
    let workspaceId = workspace ? workspace.workspace_id : null;

    // State
    let isServerRunning = false;
    let serverStartedManually = false;  // Track if we started the server from this page
    let currentPreviewUrl = workspace ? workspace.preview_url : '';
    let consoleLogs = [];
    let consoleExpanded = false;
    let currentViewport = 'desktop';
    let errorCount = 0;
    let selectedConsoleText = '';

    // WebSocket Progress State
    let progressSocket = null;
    let progressCompletedSteps = [];
    const accessToken = '{{ access_token|default:"" }}';

    // DOM Elements
    const iframe = document.getElementById('previewIframe');
    const iframePlaceholder = document.getElementById('iframePlaceholder');
    const urlInput = document.getElementById('previewUrlInput');
    const serverStatusDot = document.getElementById('serverStatusDot');
    const serverStatusText = document.getElementById('serverStatusText');
    const consoleLogs_el = document.getElementById('consoleLogs');
    const logCountEl = document.getElementById('logCount');
    const consoleBadge = document.getElementById('consoleBadge');

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // Check if workspace exists
        if (!workspace) {
            // Disable server controls when no workspace
            document.getElementById('startServerBtn').disabled = true;
            document.getElementById('stopServerBtn').disabled = true;
            document.getElementById('restartServerBtn').disabled = true;
            serverStatusDot.className = 'status-dot stopped';
            serverStatusText.textContent = 'No Workspace';
        } else {
            // If workspace has preview URL, try to load it directly
            if (workspace.preview_url) {
                currentPreviewUrl = workspace.preview_url;
                urlInput.value = workspace.preview_url;

                // Try to load the preview directly (server might already be running)
                loadPreview(workspace.preview_url);

                // Assume it might be running, enable controls
                document.getElementById('stopServerBtn').disabled = false;
                document.getElementById('restartServerBtn').disabled = false;
                document.getElementById('reloadBtn').disabled = false;
                document.getElementById('openTabBtn').disabled = false;
                serverStatusDot.className = 'status-dot loading';
                serverStatusText.textContent = 'Connecting...';
            }
        }

        setupConsoleCapture();
        setupTextSelection();
        setupConsoleResize();
    });

    // Workspace Provisioning
    async function provisionWorkspace() {
        const noWorkspaceContent = document.getElementById('noWorkspaceContent');
        const provisioningContent = document.getElementById('provisioningContent');
        const readyContent = document.getElementById('readyContent');
        const provisionStatus = document.getElementById('provisionStatus');
        const provisionBtn = document.getElementById('provisionBtn');

        // Show provisioning UI
        if (noWorkspaceContent) noWorkspaceContent.style.display = 'none';
        if (provisioningContent) provisioningContent.style.display = 'flex';
        if (provisionBtn) provisionBtn.disabled = true;

        try {
            provisionStatus.textContent = 'Creating VM...';

            const response = await fetch(`/projects/${projectId}/api/provision-workspace/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();

            if (data.success) {
                // Update workspace variable with new data
                workspace = data.workspace;
                workspaceId = data.workspace.workspace_id;
                currentPreviewUrl = data.workspace.preview_url;

                // Update status
                provisionStatus.textContent = 'Workspace ready! Setting up...';

                // Show success notification
                showNotification(data.message + (data.git_message ? ` - ${data.git_message}` : ''), 'success');

                // Enable server controls
                document.getElementById('startServerBtn').disabled = false;
                serverStatusDot.className = 'status-dot stopped';
                serverStatusText.textContent = 'Ready';

                // Update URL input if we have a preview URL
                if (currentPreviewUrl) {
                    urlInput.value = currentPreviewUrl;
                }

                // Show the ready content
                if (provisioningContent) provisioningContent.style.display = 'none';
                if (readyContent) readyContent.style.display = 'flex';

            } else {
                // Show error
                showNotification(data.error || 'Failed to provision workspace', 'error');

                // Reset UI
                if (noWorkspaceContent) noWorkspaceContent.style.display = 'flex';
                if (provisioningContent) provisioningContent.style.display = 'none';
                if (provisionBtn) provisionBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error provisioning workspace:', error);
            showNotification('Error provisioning workspace: ' + error.message, 'error');

            // Reset UI
            if (noWorkspaceContent) noWorkspaceContent.style.display = 'flex';
            if (provisioningContent) provisioningContent.style.display = 'none';
            if (provisionBtn) provisionBtn.disabled = false;
        }
    }

    // Server Control Functions
    async function checkServerStatus() {
        if (!workspace) {
            // No workspace - show stopped status
            updateServerUI(false);
            return;
        }

        // If we started the server manually from this page, don't let the check reset the UI
        if (serverStartedManually && isServerRunning) {
            return;
        }

        try {
            const response = await fetch(`/projects/${projectId}/api/check-servers/`);
            const data = await response.json();

            if (data.status === 'all_running' || data.status === 'partial_running' || data.status === 'restarted') {
                isServerRunning = true;
                updateServerUI(true, data.servers);

                // Find the frontend server URL - prefer workspace URL
                if (workspace.preview_url && !currentPreviewUrl) {
                    currentPreviewUrl = workspace.preview_url;
                    loadPreview(currentPreviewUrl);
                } else if (data.servers && data.servers.length > 0) {
                    const frontendServer = data.servers.find(s => s.type === 'frontend' || s.type === 'application') || data.servers[0];
                    if (frontendServer && frontendServer.url) {
                        if (currentPreviewUrl !== frontendServer.url) {
                            currentPreviewUrl = frontendServer.url;
                            loadPreview(currentPreviewUrl);
                        }
                    }
                }
            } else {
                // Server not running per API - but don't reset if we started manually
                if (!serverStartedManually) {
                    isServerRunning = false;
                    updateServerUI(false);
                    serverStatusText.textContent = 'Ready';
                }
            }
        } catch (error) {
            console.error('Error checking server status:', error);
            if (!serverStartedManually) {
                isServerRunning = false;
                updateServerUI(false);
                if (workspace) {
                    serverStatusText.textContent = 'Ready';
                }
            }
        }
    }

    function updateServerUI(running, servers = []) {
        serverStatusDot.className = `status-dot ${running ? 'running' : 'stopped'}`;
        serverStatusText.textContent = running ? 'Running' : 'Stopped';

        document.getElementById('startServerBtn').disabled = running;
        document.getElementById('stopServerBtn').disabled = !running;
        document.getElementById('restartServerBtn').disabled = !running;
        document.getElementById('reloadBtn').disabled = !running;
        document.getElementById('openTabBtn').disabled = !running;

        if (!running) {
            iframe.style.display = 'none';
            iframePlaceholder.style.display = 'flex';
            urlInput.value = '';

            // Show ready content, hide progress
            const progressContent = document.getElementById('progressContent');
            const readyContent = document.getElementById('readyContent');
            if (progressContent) progressContent.classList.remove('active');
            if (readyContent && workspace) readyContent.style.display = 'flex';
        }
    }

    async function startServer() {
        if (!workspace) {
            showNotification('No workspace available. Run a ticket build first.', 'error');
            return;
        }

        setServerLoading(true);
        showProgressOverlay();
        connectProgressWebSocket();

        try {
            // Use the start-dev-server endpoint that runs on Magpie workspace
            const response = await fetch(`/projects/${projectId}/api/start-dev-server/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ port: previewPort })
            });

            const data = await response.json();

            if (data.success) {
                isServerRunning = true;
                serverStartedManually = true;  // Mark that we started from this page
                currentPreviewUrl = data.url;

                // Update workspaceId in case it was reprovisioned
                if (data.workspace_id) {
                    workspaceId = data.workspace_id;
                }

                // Close progress overlay after a short delay to show completion
                setTimeout(() => {
                    closeProgressOverlay();
                    loadPreview(data.url);
                    updateServerUI(true);
                    showNotification('Server started successfully', 'success');
                }, 1000);

                // Log the startup output to console
                if (data.log) {
                    addConsoleEntry('info', ['Server startup log:', data.log]);
                }
            } else {
                showProgressError(data.error || 'Failed to start server');
            }
        } catch (error) {
            console.error('Error starting server:', error);
            showProgressError('Error starting server: ' + error.message);
        } finally {
            setServerLoading(false);
        }
    }

    // ==================== WEBSOCKET PROGRESS ====================

    function connectProgressWebSocket() {
        // Disconnect existing socket if any
        if (progressSocket) {
            progressSocket.close();
        }

        // Reset progress state
        progressCompletedSteps = [];
        resetProgressSteps();

        // Build WebSocket URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        let wsUrl = `${protocol}//${window.location.host}/ws/projects/${projectId}/workspace-progress/`;

        // Add token for authentication if available
        if (accessToken) {
            wsUrl += `?token=${accessToken}`;
        }

        console.log('[WS Progress] Connecting to:', wsUrl);

        try {
            progressSocket = new WebSocket(wsUrl);

            progressSocket.onopen = () => {
                console.log('[WS Progress] Connected');
            };

            progressSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[WS Progress] Message:', data);
                    handleProgressMessage(data);
                } catch (e) {
                    console.error('[WS Progress] Parse error:', e);
                }
            };

            progressSocket.onclose = (event) => {
                console.log('[WS Progress] Disconnected:', event.code);
                progressSocket = null;
            };

            progressSocket.onerror = (error) => {
                console.error('[WS Progress] Error:', error);
            };
        } catch (error) {
            console.error('[WS Progress] Connection failed:', error);
        }
    }

    function handleProgressMessage(data) {
        const { type, step, step_label, message, error, extra_data } = data;

        if (type === 'connected') {
            console.log('[WS Progress] Connection confirmed');
            return;
        }

        if (type === 'progress') {
            if (step === 'complete') {
                // Mark all steps as completed
                markAllStepsCompleted();
                return;
            }

            if (step === 'error' || error) {
                showProgressError(error || message || 'An error occurred');
                return;
            }

            // Update the step in the UI
            updateProgressStep(step, message || step_label, false);
        }
    }

    function resetProgressSteps() {
        const steps = document.querySelectorAll('.progress-step');
        steps.forEach(stepEl => {
            stepEl.classList.remove('active', 'completed', 'error');
            stepEl.querySelector('.step-icon').innerHTML = '';
        });

        document.getElementById('progressErrorMessage').style.display = 'none';
        document.getElementById('progressCloseBtn').style.display = 'none';
    }

    function updateProgressStep(stepName, message, isCompleted = false) {
        // Mark previous steps as completed
        const stepOrder = ['checking_workspace', 'switching_branch', 'downloading_dependencies', 'clearing_cache', 'starting_server', 'assigning_proxy'];
        const currentIndex = stepOrder.indexOf(stepName);

        stepOrder.forEach((step, index) => {
            const stepEl = document.querySelector(`.progress-step[data-step="${step}"]`);
            if (!stepEl) return;

            if (index < currentIndex) {
                // Mark as completed
                stepEl.classList.remove('active', 'error');
                stepEl.classList.add('completed');
                stepEl.querySelector('.step-icon').innerHTML = '<i class="fas fa-check" style="font-size: 0.55rem;"></i>';
            } else if (index === currentIndex) {
                // Mark as active
                stepEl.classList.remove('completed', 'error');
                stepEl.classList.add('active');
                stepEl.querySelector('.step-icon').innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 0.55rem;"></i>';
            } else {
                // Reset future steps
                stepEl.classList.remove('active', 'completed', 'error');
                stepEl.querySelector('.step-icon').innerHTML = '';
            }
        });
    }

    function markAllStepsCompleted() {
        const steps = document.querySelectorAll('.progress-step');
        steps.forEach(stepEl => {
            stepEl.classList.remove('active', 'error');
            stepEl.classList.add('completed');
            stepEl.querySelector('.step-icon').innerHTML = '<i class="fas fa-check" style="font-size: 0.55rem;"></i>';
        });
    }

    function showProgressError(errorMessage) {
        const errorEl = document.getElementById('progressErrorMessage');
        const closeBtn = document.getElementById('progressCloseBtn');

        errorEl.textContent = errorMessage;
        errorEl.style.display = 'block';
        closeBtn.style.display = 'inline-block';

        // Mark current active step as error
        const activeStep = document.querySelector('.progress-step.active');
        if (activeStep) {
            activeStep.classList.remove('active');
            activeStep.classList.add('error');
            activeStep.querySelector('.step-icon').innerHTML = '<i class="fas fa-times" style="font-size: 0.55rem;"></i>';
        }
    }

    function showProgress() {
        // Hide other placeholder content
        const readyContent = document.getElementById('readyContent');
        const noWorkspaceContent = document.getElementById('noWorkspaceContent');
        const provisioningContent = document.getElementById('provisioningContent');
        const progressContent = document.getElementById('progressContent');

        if (readyContent) readyContent.style.display = 'none';
        if (noWorkspaceContent) noWorkspaceContent.style.display = 'none';
        if (provisioningContent) provisioningContent.style.display = 'none';

        // Show progress
        progressContent.classList.add('active');
        resetProgressSteps();
    }

    function closeProgress() {
        const progressContent = document.getElementById('progressContent');
        const readyContent = document.getElementById('readyContent');

        // Hide progress
        progressContent.classList.remove('active');

        // Show ready content
        if (readyContent) readyContent.style.display = 'flex';

        // Close WebSocket
        if (progressSocket) {
            progressSocket.close();
            progressSocket = null;
        }
    }

    // Keep backward compatibility
    function showProgressOverlay() {
        showProgress();
    }

    function closeProgressOverlay() {
        closeProgress();
    }

    async function stopServer() {
        if (!workspace) {
            showNotification('No workspace available.', 'error');
            return;
        }

        setServerLoading(true);

        try {
            const response = await fetch(`/projects/${projectId}/api/stop-dev-server/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ port: previewPort })
            });

            const data = await response.json();

            if (data.success) {
                isServerRunning = false;
                serverStartedManually = false;  // Reset the flag
                updateServerUI(false);
                showNotification('Server stopped', 'success');
            } else {
                showNotification(data.error || 'Failed to stop server', 'error');
            }
        } catch (error) {
            console.error('Error stopping server:', error);
            showNotification('Error stopping server', 'error');
        } finally {
            setServerLoading(false);
        }
    }

    // Manual URL entry
    function handleUrlKeydown(event) {
        if (event.key === 'Enter') {
            loadManualUrl();
        }
    }

    function loadManualUrl() {
        let url = urlInput.value.trim();
        if (!url) return;

        // Add protocol if missing
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'http://' + url;
            urlInput.value = url;
        }

        loadPreview(url);
        document.getElementById('reloadBtn').disabled = false;
        document.getElementById('openTabBtn').disabled = false;
    }

    async function restartServer() {
        if (!workspace) {
            showNotification('No workspace available.', 'error');
            return;
        }

        setServerLoading(true);
        serverStatusDot.className = 'status-dot loading';
        serverStatusText.textContent = 'Restarting...';

        try {
            // Stop first
            await fetch(`/projects/${projectId}/api/stop-dev-server/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ port: previewPort })
            });

            // Wait a moment
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Start again
            const response = await fetch(`/projects/${projectId}/api/start-dev-server/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ port: previewPort })
            });

            const data = await response.json();

            if (data.success) {
                isServerRunning = true;
                serverStartedManually = true;  // Mark that we started from this page
                currentPreviewUrl = data.url;

                // Update workspaceId in case it was reprovisioned
                if (data.workspace_id) {
                    workspaceId = data.workspace_id;
                }

                loadPreview(data.url);
                updateServerUI(true);
                showNotification('Server restarted', 'success');
            } else {
                showNotification(data.error || 'Failed to restart server', 'error');
            }
        } catch (error) {
            console.error('Error restarting server:', error);
            showNotification('Error restarting server', 'error');
        } finally {
            setServerLoading(false);
        }
    }

    // Server dropdown functions
    function toggleServerDropdown() {
        const menu = document.getElementById('serverDropdownMenu');
        menu.classList.toggle('show');
    }

    function closeServerDropdown() {
        const menu = document.getElementById('serverDropdownMenu');
        menu.classList.remove('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.querySelector('.server-controls');
        if (dropdown && !dropdown.contains(e.target)) {
            closeServerDropdown();
        }
    });

    function setServerLoading(loading) {
        const buttons = document.querySelectorAll('.server-dropdown-item');
        buttons.forEach(btn => btn.disabled = loading);

        if (loading) {
            serverStatusDot.className = 'status-dot loading';
            serverStatusText.textContent = 'Working...';
        }
    }

    // Preview Functions
    function loadPreview(url) {
        if (!url) return;

        currentPreviewUrl = url;
        urlInput.value = url;

        iframe.src = url;
        iframe.style.display = 'block';
        iframePlaceholder.style.display = 'none';

        // Clear console on new load
        clearConsole();

        // Setup console capture after iframe loads
        iframe.onload = () => {
            // Server is responding - update status
            isServerRunning = true;
            serverStartedManually = true;  // Prevent status check from resetting
            serverStatusDot.className = 'status-dot running';
            serverStatusText.textContent = 'Running';
            document.getElementById('startServerBtn').disabled = true;
            document.getElementById('stopServerBtn').disabled = false;
            document.getElementById('restartServerBtn').disabled = false;

            setupIframeConsoleCapture();
        };

        iframe.onerror = () => {
            // Server not responding
            serverStatusDot.className = 'status-dot stopped';
            serverStatusText.textContent = 'Not Running';
            document.getElementById('startServerBtn').disabled = false;
        };
    }

    function reloadPreview() {
        if (iframe.src && iframe.src !== 'about:blank') {
            iframe.src = iframe.src;
        }
    }

    function openInNewTab() {
        if (currentPreviewUrl) {
            window.open(currentPreviewUrl, '_blank');
        }
    }

    // Viewport Functions
    function setViewport(mode) {
        currentViewport = mode;
        const wrapper = document.getElementById('iframeWrapper');
        const desktopBtn = document.getElementById('desktopViewBtn');
        const mobileBtn = document.getElementById('mobileViewBtn');

        if (mode === 'mobile') {
            wrapper.className = 'iframe-wrapper mobile-view';
            mobileBtn.classList.add('active');
            desktopBtn.classList.remove('active');
        } else {
            wrapper.className = 'iframe-wrapper desktop-view';
            desktopBtn.classList.add('active');
            mobileBtn.classList.remove('active');
        }
    }

    // Console Functions
    function setupConsoleCapture() {
        // Initial setup - will be enhanced when iframe loads
    }

    function setupIframeConsoleCapture() {
        try {
            const iframeWindow = iframe.contentWindow;

            if (!iframeWindow) return;

            // Store original methods
            const originalLog = iframeWindow.console.log;
            const originalError = iframeWindow.console.error;
            const originalWarn = iframeWindow.console.warn;
            const originalInfo = iframeWindow.console.info;

            // Override console methods
            iframeWindow.console.log = (...args) => {
                originalLog.apply(iframeWindow.console, args);
                addConsoleEntry('log', args);
            };

            iframeWindow.console.error = (...args) => {
                originalError.apply(iframeWindow.console, args);
                addConsoleEntry('error', args);
            };

            iframeWindow.console.warn = (...args) => {
                originalWarn.apply(iframeWindow.console, args);
                addConsoleEntry('warn', args);
            };

            iframeWindow.console.info = (...args) => {
                originalInfo.apply(iframeWindow.console, args);
                addConsoleEntry('info', args);
            };

            // Capture uncaught errors
            iframeWindow.onerror = (msg, url, line, col, error) => {
                addConsoleEntry('error', [`Uncaught Error: ${msg} at ${url}:${line}:${col}`]);
                return false;
            };

            // Capture unhandled promise rejections
            iframeWindow.onunhandledrejection = (event) => {
                addConsoleEntry('error', [`Unhandled Promise Rejection: ${event.reason}`]);
            };

        } catch (e) {
            // Cross-origin - show warning
            addConsoleEntry('warn', ['Console capture unavailable for cross-origin iframe']);
        }
    }

    function addConsoleEntry(type, args) {
        const timestamp = new Date().toLocaleTimeString();
        const message = args.map(arg => {
            if (typeof arg === 'object') {
                try {
                    return JSON.stringify(arg, null, 2);
                } catch {
                    return String(arg);
                }
            }
            return String(arg);
        }).join(' ');

        const entry = { type, message, timestamp };
        consoleLogs.push(entry);

        if (type === 'error') {
            errorCount++;
            updateErrorBadge();
        }

        renderConsoleEntry(entry);
        updateLogCount();
    }

    function renderConsoleEntry(entry) {
        const placeholder = consoleLogs_el.querySelector('.console-placeholder');
        if (placeholder) placeholder.remove();

        const colors = {
            log: 'var(--text-secondary)',
            error: '#ef4444',
            warn: '#f59e0b',
            info: '#3b82f6'
        };

        const div = document.createElement('div');
        div.className = `console-entry console-${entry.type}`;
        div.innerHTML = `
            <span class="console-timestamp">${entry.timestamp}</span>
            <span class="console-type" style="color: ${colors[entry.type]}">[${entry.type.toUpperCase()}]</span>
            <span class="console-message" style="color: ${colors[entry.type]}">${escapeHtml(entry.message)}</span>
        `;

        consoleLogs_el.appendChild(div);
        consoleLogs_el.scrollTop = consoleLogs_el.scrollHeight;
    }

    function clearConsole() {
        consoleLogs = [];
        errorCount = 0;
        consoleLogs_el.innerHTML = '<div class="console-placeholder">Console logs will appear here when the app runs...</div>';
        updateLogCount();
        updateErrorBadge();
    }

    function updateLogCount() {
        logCountEl.textContent = `(${consoleLogs.length})`;
    }

    function updateErrorBadge() {
        if (errorCount > 0) {
            consoleBadge.textContent = errorCount > 99 ? '99+' : errorCount;
            consoleBadge.style.display = 'block';
            document.getElementById('consoleToggleBtn').classList.add('has-errors');
        } else {
            consoleBadge.style.display = 'none';
            document.getElementById('consoleToggleBtn').classList.remove('has-errors');
        }
    }

    function toggleConsole() {
        const panel = document.getElementById('consolePanel');
        const icon = document.getElementById('consoleToggleIcon');

        consoleExpanded = !consoleExpanded;

        if (consoleExpanded) {
            panel.classList.remove('collapsed');
            icon.className = 'fas fa-chevron-down';
        } else {
            panel.classList.add('collapsed');
            icon.className = 'fas fa-chevron-up';
        }
    }

    // Console Tab Switching
    let currentConsoleTab = 'console';

    function switchConsoleTab(tab) {
        currentConsoleTab = tab;

        // Update tab buttons
        document.getElementById('consoleTabBtn').classList.toggle('active', tab === 'console');
        document.getElementById('serverLogsTabBtn').classList.toggle('active', tab === 'server-logs');

        // Update content visibility
        document.getElementById('consoleLogs').style.display = tab === 'console' ? 'block' : 'none';
        document.getElementById('serverLogsContent').style.display = tab === 'server-logs' ? 'block' : 'none';

        // Update action buttons visibility
        document.getElementById('clearConsoleBtn').style.display = tab === 'console' ? '' : 'none';
        document.getElementById('createTicketBtn').style.display = tab === 'console' ? '' : 'none';
        document.getElementById('refreshServerLogsBtn').style.display = tab === 'server-logs' ? '' : 'none';

        // Expand panel if collapsed and switching tabs
        if (!consoleExpanded) {
            toggleConsole();
        }

        // Load server logs if switching to that tab
        if (tab === 'server-logs') {
            loadServerLogs();
        }
    }

    // Server Logs Functions
    async function loadServerLogs() {
        const logsContainer = document.getElementById('serverLogsContent');

        if (!workspaceId) {
            logsContainer.innerHTML = '<div class="server-logs-placeholder">No workspace available</div>';
            return;
        }

        logsContainer.innerHTML = '<div class="server-logs-placeholder"><i class="fas fa-spinner fa-spin"></i> Loading server logs...</div>';

        try {
            const response = await fetch(`/api/v1/workspace/${workspaceId}/dev-server-logs/?lines=200`);
            const data = await response.json();

            if (data.success && data.logs) {
                logsContainer.innerHTML = `<pre class="server-logs-output">${escapeHtml(data.logs)}</pre>`;
                // Scroll to bottom
                logsContainer.scrollTop = logsContainer.scrollHeight;
            } else {
                logsContainer.innerHTML = `<div class="server-logs-placeholder">${data.error || 'No logs available'}</div>`;
            }
        } catch (error) {
            console.error('Error loading server logs:', error);
            logsContainer.innerHTML = '<div class="server-logs-placeholder">Failed to load server logs</div>';
        }
    }

    function refreshServerLogs() {
        loadServerLogs();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Text Selection for Ticket Creation
    function setupTextSelection() {
        const floatingBtn = document.getElementById('floatingTicketBtn');
        const serverLogsContent = document.getElementById('serverLogsContent');

        function handleTextSelection(e) {
            // Small delay to let selection complete
            setTimeout(() => {
                const selection = window.getSelection();
                selectedConsoleText = selection.toString().trim();

                const createBtn = document.getElementById('createTicketBtn');
                createBtn.disabled = selectedConsoleText.length === 0;

                if (selectedConsoleText.length > 0) {
                    // Get selection end position
                    const range = selection.getRangeAt(0);
                    const rects = range.getClientRects();
                    const lastRect = rects[rects.length - 1];

                    if (lastRect) {
                        // Position floating button at the end of selection
                        const btnWidth = 120;
                        let left = lastRect.right + 10;
                        let top = lastRect.top - 5;

                        // Keep button within viewport
                        if (left + btnWidth > window.innerWidth) {
                            left = lastRect.left;
                            top = lastRect.bottom + 5;
                        }

                        floatingBtn.style.left = `${left}px`;
                        floatingBtn.style.top = `${top}px`;
                        floatingBtn.style.display = 'block';
                    }
                } else {
                    floatingBtn.style.display = 'none';
                }
            }, 10);
        }

        function hideFloatingBtn() {
            // Hide after a short delay to allow button click
            setTimeout(() => {
                const selection = window.getSelection();
                if (!selection.toString().trim()) {
                    floatingBtn.style.display = 'none';
                }
            }, 200);
        }

        // Listen on console logs
        consoleLogs_el.addEventListener('mouseup', handleTextSelection);

        // Listen on server logs
        if (serverLogsContent) {
            serverLogsContent.addEventListener('mouseup', handleTextSelection);
        }

        // Hide floating button when clicking elsewhere
        document.addEventListener('mousedown', (e) => {
            if (!floatingBtn.contains(e.target) &&
                !consoleLogs_el.contains(e.target) &&
                (!serverLogsContent || !serverLogsContent.contains(e.target))) {
                floatingBtn.style.display = 'none';
                selectedConsoleText = '';
                document.getElementById('createTicketBtn').disabled = true;
            }
        });
    }

    // Ticket Creation Functions
    function openCreateTicketModal() {
        if (!selectedConsoleText) return;

        // Hide floating button
        document.getElementById('floatingTicketBtn').style.display = 'none';

        // Pre-fill the form
        const truncatedText = selectedConsoleText.substring(0, 50);
        document.getElementById('ticketName').value = `Console Error: ${truncatedText}${selectedConsoleText.length > 50 ? '...' : ''}`;
        document.getElementById('ticketDescription').value =
`**Console Output:**
\`\`\`
${selectedConsoleText}
\`\`\`

**Steps to Reproduce:**
1.

**Expected Behavior:**

**Actual Behavior:**
The above error appeared in the console.`;

        document.getElementById('consoleTicketModal').classList.add('active');
    }

    function closeCreateTicketModal() {
        document.getElementById('consoleTicketModal').classList.remove('active');
    }

    async function handleCreateTicket(event) {
        event.preventDefault();

        const name = document.getElementById('ticketName').value.trim();
        const description = document.getElementById('ticketDescription').value.trim();

        if (!name || !description) {
            showNotification('Please fill in all fields', 'error');
            return;
        }

        try {
            const response = await fetch(`/projects/${projectId}/api/checklist/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ name, description })
            });

            const data = await response.json();

            if (data.success) {
                closeCreateTicketModal();
                showNotification('Ticket created successfully!', 'success');

                // Clear selection
                window.getSelection().removeAllRanges();
                selectedConsoleText = '';
                document.getElementById('createTicketBtn').disabled = true;
            } else {
                showNotification(data.error || 'Failed to create ticket', 'error');
            }
        } catch (error) {
            console.error('Error creating ticket:', error);
            showNotification('Error creating ticket', 'error');
        }
    }

    // Console Resize
    function setupConsoleResize() {
        const handle = document.getElementById('consoleResizeHandle');
        const panel = document.getElementById('consolePanel');
        const iframe = document.getElementById('previewIframe');
        const previewContainer = document.querySelector('.preview-content');
        let isResizing = false;
        let startY, startHeight;

        handle.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            isResizing = true;
            startY = e.clientY;
            startHeight = panel.offsetHeight;

            // Remove collapsed class and transition for smooth dragging
            panel.classList.remove('collapsed');
            panel.style.transition = 'none';
            document.body.style.cursor = 'ns-resize';
            document.body.style.userSelect = 'none';

            // Disable iframe pointer events so it doesn't capture mouse
            if (iframe) iframe.style.pointerEvents = 'none';
            if (previewContainer) previewContainer.style.pointerEvents = 'none';

            // Update toggle icon
            const toggleIcon = document.getElementById('consoleToggleIcon');
            if (toggleIcon) {
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            }
            consoleExpanded = true;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            e.preventDefault();

            const diff = startY - e.clientY;
            const newHeight = Math.max(100, Math.min(window.innerHeight * 0.8, startHeight + diff));
            panel.style.height = newHeight + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                panel.style.transition = '';
                document.body.style.cursor = '';
                document.body.style.userSelect = '';

                // Re-enable iframe pointer events
                if (iframe) iframe.style.pointerEvents = '';
                if (previewContainer) previewContainer.style.pointerEvents = '';
            }
        });

        // Also handle mouseleave from document to catch edge cases
        document.addEventListener('mouseleave', () => {
            if (isResizing) {
                isResizing = false;
                panel.style.transition = '';
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                if (iframe) iframe.style.pointerEvents = '';
                if (previewContainer) previewContainer.style.pointerEvents = '';
            }
        });
    }

    // Utility Functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showNotification(message, type = 'success') {
        const existing = document.querySelector('.notification-toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = `notification-toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
    }

    // Close modal on overlay click
    document.getElementById('consoleTicketModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeCreateTicketModal();
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeCreateTicketModal();
            closeScreenshotModal();
            cancelScreenshotCapture();
        }
    });

    // ==================== SCREENSHOT CAPTURE ====================

    let screenshotDataUrl = null;
    let isCapturing = false;
    let captureStartX = 0, captureStartY = 0;
    let mediaStream = null;

    const screenshotOverlay = document.getElementById('screenshotOverlay');
    const screenshotSelection = document.getElementById('screenshotSelection');
    const screenshotHint = document.getElementById('screenshotHint');

    async function startScreenshotCapture() {
        try {
            // Request screen capture permission
            mediaStream = await navigator.mediaDevices.getDisplayMedia({
                video: { mediaSource: 'screen' },
                preferCurrentTab: true
            });

            // Show the selection overlay
            screenshotOverlay.classList.add('active');
            screenshotHint.style.display = 'block';
            screenshotSelection.style.display = 'none';

            showNotification('Drag to select the area you want to capture', 'success');
        } catch (err) {
            console.error('Screen capture failed:', err);
            showNotification('Screen capture cancelled or not supported', 'error');
        }
    }

    function cancelScreenshotCapture() {
        screenshotOverlay.classList.remove('active');
        screenshotSelection.style.display = 'none';
        isCapturing = false;
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
    }

    // Mouse events for selection
    screenshotOverlay.addEventListener('mousedown', (e) => {
        if (!mediaStream) return;

        isCapturing = true;
        const rect = screenshotOverlay.getBoundingClientRect();
        captureStartX = e.clientX - rect.left;
        captureStartY = e.clientY - rect.top;

        screenshotHint.style.display = 'none';
        screenshotSelection.style.display = 'block';
        screenshotSelection.style.left = captureStartX + 'px';
        screenshotSelection.style.top = captureStartY + 'px';
        screenshotSelection.style.width = '0';
        screenshotSelection.style.height = '0';
    });

    screenshotOverlay.addEventListener('mousemove', (e) => {
        if (!isCapturing) return;

        const rect = screenshotOverlay.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;

        const width = currentX - captureStartX;
        const height = currentY - captureStartY;

        screenshotSelection.style.left = (width < 0 ? currentX : captureStartX) + 'px';
        screenshotSelection.style.top = (height < 0 ? currentY : captureStartY) + 'px';
        screenshotSelection.style.width = Math.abs(width) + 'px';
        screenshotSelection.style.height = Math.abs(height) + 'px';
    });

    screenshotOverlay.addEventListener('mouseup', async (e) => {
        if (!isCapturing || !mediaStream) return;
        isCapturing = false;

        const rect = screenshotOverlay.getBoundingClientRect();
        const endX = e.clientX - rect.left;
        const endY = e.clientY - rect.top;

        const selectionRect = {
            x: Math.min(captureStartX, endX),
            y: Math.min(captureStartY, endY),
            width: Math.abs(endX - captureStartX),
            height: Math.abs(endY - captureStartY)
        };

        // Minimum selection size
        if (selectionRect.width < 20 || selectionRect.height < 20) {
            showNotification('Selection too small. Please drag a larger area.', 'error');
            screenshotSelection.style.display = 'none';
            screenshotHint.style.display = 'block';
            return;
        }

        // Capture the screenshot
        await captureScreenshot(selectionRect, rect);
    });

    async function captureScreenshot(selectionRect, overlayRect) {
        try {
            // Create video element to capture frame
            const video = document.createElement('video');
            video.srcObject = mediaStream;
            video.autoplay = true;

            await new Promise(resolve => {
                video.onloadedmetadata = () => {
                    video.play();
                    resolve();
                };
            });

            // Wait a frame for video to render
            await new Promise(resolve => requestAnimationFrame(resolve));

            // Create canvas and draw the video frame
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Calculate scale between video and overlay
            const scaleX = video.videoWidth / window.innerWidth;
            const scaleY = video.videoHeight / window.innerHeight;

            // Calculate the actual position of the overlay in the video
            const overlayScreenRect = screenshotOverlay.getBoundingClientRect();

            // Crop to selected area
            const cropX = (overlayScreenRect.left + selectionRect.x) * scaleX;
            const cropY = (overlayScreenRect.top + selectionRect.y) * scaleY;
            const cropWidth = selectionRect.width * scaleX;
            const cropHeight = selectionRect.height * scaleY;

            // Create cropped canvas
            const croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = cropWidth;
            croppedCanvas.height = cropHeight;
            const croppedCtx = croppedCanvas.getContext('2d');
            croppedCtx.drawImage(canvas, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

            // Get data URL
            screenshotDataUrl = croppedCanvas.toDataURL('image/png');

            // Stop media stream
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;

            // Hide overlay and show modal
            cancelScreenshotCapture();
            openScreenshotModal();

        } catch (err) {
            console.error('Error capturing screenshot:', err);
            showNotification('Failed to capture screenshot', 'error');
            cancelScreenshotCapture();
        }
    }

    function openScreenshotModal() {
        if (!screenshotDataUrl) return;

        document.getElementById('screenshotPreviewImg').src = screenshotDataUrl;
        document.getElementById('screenshotTicketName').value = 'UI Issue: ';
        document.getElementById('screenshotTicketDescription').value = '';

        // Populate context fields
        document.getElementById('screenshotContextUrl').value = currentPreviewUrl || 'Not available';

        // Get viewport info
        const viewportNames = { desktop: 'Desktop (100%)', tablet: 'Tablet (768px)', mobile: 'Mobile (375px)' };
        document.getElementById('screenshotContextViewport').value = viewportNames[currentViewport] || currentViewport;

        // Show console error count if any
        const errorField = document.getElementById('screenshotErrorCountField');
        if (errorCount > 0) {
            document.getElementById('screenshotContextErrors').value = `${errorCount} error${errorCount !== 1 ? 's' : ''} in console`;
            errorField.style.display = 'block';
        } else {
            errorField.style.display = 'none';
        }

        document.getElementById('screenshotTicketModal').classList.add('active');
    }

    function closeScreenshotModal() {
        document.getElementById('screenshotTicketModal').classList.remove('active');
    }

    function retakeScreenshot() {
        closeScreenshotModal();
        startScreenshotCapture();
    }

    function downloadScreenshot() {
        if (!screenshotDataUrl) return;

        const link = document.createElement('a');
        link.href = screenshotDataUrl;
        link.download = `screenshot-${Date.now()}.png`;
        link.click();
    }

    async function handleCreateScreenshotTicket(event) {
        event.preventDefault();

        const name = document.getElementById('screenshotTicketName').value.trim();
        const description = document.getElementById('screenshotTicketDescription').value.trim();
        const contextUrl = document.getElementById('screenshotContextUrl').value;
        const contextViewport = document.getElementById('screenshotContextViewport').value;
        const contextErrors = document.getElementById('screenshotContextErrors').value;

        if (!name) {
            showNotification('Please enter a ticket name', 'error');
            return;
        }

        // Build context section
        let contextSection = '### Context\n';
        if (contextUrl && contextUrl !== 'Not available') {
            contextSection += `- **URL:** ${contextUrl}\n`;
        }
        contextSection += `- **Viewport:** ${contextViewport}\n`;
        if (contextErrors) {
            contextSection += `- **Console:** ${contextErrors}\n`;
        }

        // Build description with context and screenshot
        const fullDescription = `${description}\n\n${contextSection}\n**Screenshot attached**\n\n![Screenshot](screenshot)`;

        try {
            // First create the ticket
            const response = await fetch(`/projects/${projectId}/api/checklist/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    name,
                    description: fullDescription || 'See attached screenshot'
                })
            });

            const data = await response.json();

            if (data.success && data.item && data.item.id) {
                // Now upload the screenshot as attachment
                const blob = await fetch(screenshotDataUrl).then(r => r.blob());
                const formData = new FormData();
                formData.append('file', blob, `screenshot-${Date.now()}.png`);

                await fetch(`/projects/${projectId}/api/tickets/${data.item.id}/attachments/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });

                closeScreenshotModal();
                showNotification('Ticket created with screenshot!', 'success');
                screenshotDataUrl = null;
            } else {
                showNotification(data.error || 'Failed to create ticket', 'error');
            }
        } catch (error) {
            console.error('Error creating ticket:', error);
            showNotification('Error creating ticket', 'error');
        }
    }

    // Close screenshot modal on overlay click
    document.getElementById('screenshotTicketModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeScreenshotModal();
        }
    });
</script>
{% endblock %}
