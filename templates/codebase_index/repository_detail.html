{% extends 'projects/base_with_sidebar.html' %}
{% load static %}

{% block title %}{{ repository.github_owner }}/{{ repository.github_repo_name }} - Analytics{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/project_detail.css' %}">
<style>
.analytics-container {
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.analytics-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.analytics-header-main {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.analytics-back-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background-color: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: var(--radius-md);
    color: var(--primary-color);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    margin-right: 0.5rem;
}

.analytics-back-btn:hover {
    background-color: rgba(167, 139, 250, 0.15);
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateX(-2px);
}

.repo-icon {
    font-size: 2rem;
    color: var(--primary-color);
    background: rgba(167, 139, 250, 0.1);
    padding: 0.75rem;
    border-radius: var(--radius-md);
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.analytics-card {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    transition: all 0.2s ease;
}

.analytics-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.analytics-card h3 {
    margin: 0 0 0.75rem 0;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-color);
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
    padding: 0.25rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.stat-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.stat-label {
    color: var(--text-light);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.stat-value {
    font-weight: 500;
    color: var(--text-color);
    font-size: 0.8125rem;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background-color: var(--light-bg);
    border-radius: 4px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    border-radius: 4px;
    transition: width 0.3s ease;
}

.jobs-list {
    max-height: 400px;
    overflow-y: auto;
}

.job-item {
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    margin-bottom: 0.5rem;
    background-color: rgba(167, 139, 250, 0.03);
}

.job-item:last-child {
    margin-bottom: 0;
}

.job-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

.job-type {
    font-weight: 500;
    color: var(--text-color);
    font-size: 0.8125rem;
}

.job-status {
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.job-status-completed {
    background-color: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.job-status-failed {
    background-color: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}

.job-status-running {
    background-color: rgba(0, 123, 255, 0.2);
    color: #007bff;
}

.job-meta {
    font-size: 0.6875rem;
    color: var(--text-light);
}

.empty-state {
    text-align: center;
    padding: 1.5rem;
    color: var(--text-light);
    font-size: 0.8125rem;
}

/* Search Drawer */
.search-drawer {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background-color: var(--card-bg);
    border-left: 1px solid var(--border-color);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    transition: right 0.3s ease;
    overflow-y: auto;
}

.search-drawer.open {
    right: 0;
}

.search-drawer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.search-drawer-overlay.open {
    opacity: 1;
    visibility: visible;
}

.search-drawer-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.search-drawer-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.search-drawer-close {
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    font-size: 1.25rem;
    padding: 0.25rem;
    border-radius: var(--radius-sm);
    transition: background-color 0.2s ease, color 0.2s ease;
}

.search-drawer-close:hover {
    background-color: var(--light-bg);
    color: var(--text-color);
}

.search-drawer-content {
    padding: 1rem;
}

.search-form {
    margin-bottom: 1rem;
}

.search-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background-color: var(--light-bg);
    color: var(--text-color);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
}

.search-button {
    width: 100%;
    padding: 0.75rem;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.search-button:hover {
    background-color: var(--primary-hover);
}

.search-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.search-results {
    margin-top: 1rem;
}

.search-results-header {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.75rem;
}

.search-result-item {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 0.75rem;
    background: var(--card-bg);
    transition: all 0.2s;
}

.search-result-item:hover {
    border-color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.search-result-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.search-result-file {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    flex: 1;
}

.search-result-file-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
}

.search-result-path {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-color);
}

.search-result-function {
    font-size: 0.75rem;
    color: var(--primary-color);
    font-weight: 500;
}

.search-result-lines {
    font-size: 0.75rem;
    color: var(--text-light);
}

.search-result-score {
    padding: 0.25rem 0.5rem;
    background: var(--primary-light);
    color: var(--primary-color);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
}

.search-result-content {
    margin-bottom: 0.75rem;
}

.search-result-content pre {
    margin: 0;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.75rem;
    line-height: 1.4;
    background: var(--code-bg);
    padding: 0.75rem;
    border-radius: var(--radius-sm);
    color: var(--text-color);
    overflow-x: auto;
    white-space: pre-wrap;
}

.search-result-content code {
    background: none;
    padding: 0;
    font-size: inherit;
}

.search-result-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-light);
}

.search-result-type {
    font-size: 0.75rem;
    color: var(--text-light);
    text-transform: capitalize;
}

.btn-small {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.btn-small:hover {
    background: var(--accent-hover);
    transform: translateY(-1px);
}

.btn-with-icon {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-with-icon i {
    margin-right: 0;
}

.search-loading {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
}

.search-empty {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <div class="analytics-header-main">
            <a href="{% url 'projects:project_detail' repository.project.project_id %}#codebase" class="analytics-back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Project</span>
            </a>
            <div class="repo-icon">
                <i class="fab fa-github"></i>
            </div>
            <div>
                <h1 class="page-title">{{ repository.github_owner }}/{{ repository.github_repo_name }}</h1>
                <p class="text-muted">Repository Analytics & Indexing Details</p>
            </div>
        </div>
        <div class="analytics-header-actions">
            <span class="status-badge status-{{ repository.status }}">
                {{ repository.get_status_display }}
            </span>
        </div>
    </div>

    <div class="analytics-grid">
        <!-- Repository Overview -->
        <div class="analytics-card">
            <h3><i class="fas fa-chart-bar"></i> Repository Overview</h3>
            <div class="stat-row">
                <span class="stat-label">Status</span>
                <span class="stat-value status-{{ repository.status }}">{{ repository.get_status_display }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Files Indexed</span>
                <span class="stat-value">{{ repository.indexed_files_count }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Total Code Chunks</span>
                <span class="stat-value">{{ repository.total_chunks }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Last Indexed</span>
                <span class="stat-value">
                    {% if repository.last_indexed_at %}
                        {{ repository.last_indexed_at|date:"M d, Y H:i" }}
                    {% else %}
                        Never
                    {% endif %}
                </span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ repository.indexing_progress|floatformat:1 }}%"></div>
            </div>
            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-light);">
                {{ repository.indexing_progress|floatformat:1 }}% Complete
            </div>
        </div>

        <!-- Error Information -->
        {% if repository.error_message %}
        <div class="analytics-card">
            <h3><i class="fas fa-exclamation-triangle"></i> Status Information</h3>
            <div class="stat-row">
                <span class="stat-label">Error Count</span>
                <span class="stat-value">{{ repository.error_count }}</span>
            </div>
            <div style="margin-top: 1rem; padding: 0.75rem; background-color: rgba(255, 193, 7, 0.1); border-radius: var(--radius-sm); font-size: 0.875rem; color: var(--text-color);">
                {{ repository.error_message }}
            </div>
        </div>
        {% endif %}

        <!-- Recent Indexing Jobs -->
        <div class="analytics-card">
            <h3><i class="fas fa-tasks"></i> Recent Indexing Jobs</h3>
            {% if recent_jobs %}
                <div class="jobs-list">
                    {% for job in recent_jobs %}
                        <div class="job-item">
                            <div class="job-header">
                                <span class="job-type">{{ job.job_type|capfirst }}</span>
                                <span class="job-status job-status-{{ job.status }}">{{ job.status }}</span>
                            </div>
                            <div class="job-meta">
                                Started: {{ job.started_at|date:"M d, Y H:i" }}
                                {% if job.completed_at %}
                                    | Completed: {{ job.completed_at|date:"M d, Y H:i" }}
                                {% endif %}
                            </div>
                            {% if job.error_logs %}
                                <div style="margin-top: 0.5rem; font-size: 0.8125rem; color: var(--danger-color);">
                                    {{ job.error_logs|truncatechars:100 }}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-tasks" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <p>No indexing jobs found</p>
                </div>
            {% endif %}
        </div>

        <!-- Recent Queries -->
        <div class="analytics-card" id="recent-searches-card">
            <h3><i class="fas fa-search"></i> Recent Code Searches</h3>
            {% if recent_queries %}
                <div class="jobs-list">
                    {% for query in recent_queries %}
                        <div class="job-item">
                            <div class="job-header">
                                <span class="job-type">{{ query.query_text|truncatechars:30 }}</span>
                                <span class="stat-value">{{ query.total_chunks_considered }} results</span>
                            </div>
                            <div class="job-meta">
                                {{ query.created_at|date:"M d, Y H:i" }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <p>No code searches yet</p>
                </div>
            {% endif %}
        </div>

        <!-- Repository Configuration -->
        <div class="analytics-card">
            <h3><i class="fas fa-cog"></i> Configuration</h3>
            <div class="stat-row">
                <span class="stat-label">GitHub Branch</span>
                <span class="stat-value">{{ repository.github_branch }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Max File Size</span>
                <span class="stat-value">{{ repository.max_file_size_kb }} KB</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">File Extensions</span>
                <span class="stat-value">
                    {% if repository.file_extensions %}
                        {{ repository.file_extensions|join:", " }}
                    {% else %}
                        All supported
                    {% endif %}
                </span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Last Commit</span>
                <span class="stat-value">
                    {% if repository.last_commit_hash %}
                        {{ repository.last_commit_hash|slice:":8" }}
                    {% else %}
                        Unknown
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- Actions -->
        <div class="analytics-card">
            <h3><i class="fas fa-tools"></i> Actions</h3>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button class="btn btn-outline btn-with-icon" onclick="reindexRepository({{ repository.id }})">
                    <i class="fas fa-sync"></i> Re-index Repository
                </button>
                <button class="btn btn-outline btn-with-icon" onclick="openCodeSearch()">
                    <i class="fas fa-search"></i> Search Code
                </button>
                <a href="{% url 'projects:project_detail' repository.project.project_id %}#codebase" class="btn btn-primary btn-with-icon">
                    <i class="fas fa-arrow-left"></i> Back to Project
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Search Drawer -->
<div class="search-drawer-overlay" id="searchOverlay" onclick="closeSearchDrawer()"></div>
<div class="search-drawer" id="searchDrawer">
    <div class="search-drawer-header">
        <h3 class="search-drawer-title btn-with-icon">
            <i class="fas fa-search"></i> Search Code
        </h3>
        <button class="search-drawer-close" onclick="closeSearchDrawer()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="search-drawer-content">
        <form class="search-form" onsubmit="searchCode(event)">
            <input 
                type="text" 
                class="search-input" 
                id="searchInput"
                placeholder="Search for functions, classes, variables..."
                autocomplete="off"
            >
            <button type="submit" class="search-button" id="searchButton">
                <i class="fas fa-search"></i> Search
            </button>
        </form>
        
        <div class="search-results" id="searchResults" style="display: none;">
            <div class="search-results-header" id="searchResultsHeader"></div>
            <div id="searchResultsList"></div>
        </div>
        
        <div class="search-loading" id="searchLoading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Searching codebase...</p>
        </div>
        
        <div class="search-empty" id="searchEmpty" style="display: none;">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
            <p>Enter a search term to find code snippets, functions, and classes in your repository.</p>
        </div>
    </div>
</div>

<script>
async function reindexRepository(repositoryId) {
    if (!confirm('This will re-index the entire repository. Continue?')) {
        return;
    }
    
    try {
        const response = await fetch(`/codebase/api/repositories/${repositoryId}/reindex/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Re-indexing started. Check back in a few minutes for progress.');
            location.reload();
        } else {
            alert('Error starting re-index: ' + data.error);
        }
    } catch (error) {
        alert('Error starting re-index: ' + error.message);
    }
}

// Search Drawer Functions
function openCodeSearch() {
    const drawer = document.getElementById('searchDrawer');
    const overlay = document.getElementById('searchOverlay');
    const searchInput = document.getElementById('searchInput');
    const searchEmpty = document.getElementById('searchEmpty');
    
    drawer.classList.add('open');
    overlay.classList.add('open');
    
    // Show empty state initially
    hideAllSearchStates();
    searchEmpty.style.display = 'block';
    
    // Focus on search input
    setTimeout(() => {
        searchInput.focus();
    }, 300);
}

function closeSearchDrawer() {
    const drawer = document.getElementById('searchDrawer');
    const overlay = document.getElementById('searchOverlay');
    
    drawer.classList.remove('open');
    overlay.classList.remove('open');
    
    // Clear search input and results
    document.getElementById('searchInput').value = '';
    hideAllSearchStates();
    document.getElementById('searchEmpty').style.display = 'block';
}

function hideAllSearchStates() {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('searchLoading').style.display = 'none';
    document.getElementById('searchEmpty').style.display = 'none';
}

async function searchCode(event) {
    event.preventDefault();
    
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const query = searchInput.value.trim();
    
    if (!query) {
        hideAllSearchStates();
        document.getElementById('searchEmpty').style.display = 'block';
        return;
    }
    
    // Show loading state
    hideAllSearchStates();
    document.getElementById('searchLoading').style.display = 'block';
    searchButton.disabled = true;
    
    try {
        const response = await fetch('/codebase/api/search/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                query: query,
                project_id: '{{ repository.project.project_id }}',
                n_results: 10
            })
        });
        
        const data = await response.json();
        
        hideAllSearchStates();
        
        if (data.success && data.results && data.results.length > 0) {
            displaySearchResults(data.results, query);
            updateRecentSearches(query, data.results.length);
        } else {
            displayNoResults(query);
            updateRecentSearches(query, 0);
        }
        
    } catch (error) {
        console.error('Search error:', error);
        hideAllSearchStates();
        displaySearchError(error.message);
    } finally {
        searchButton.disabled = false;
    }
}

function displaySearchResults(results, query) {
    const searchResults = document.getElementById('searchResults');
    const searchResultsHeader = document.getElementById('searchResultsHeader');
    const searchResultsList = document.getElementById('searchResultsList');
    
    searchResultsHeader.textContent = `Found ${results.length} results for "${query}"`;
    
    searchResultsList.innerHTML = '';
    
    results.forEach((result, index) => {
        const resultItem = document.createElement('div');
        resultItem.className = 'search-result-item';
        
        const distance = result.distance || 0;
        // Use the same exponential decay formula as the backend
        const similarity = Math.max(0, Math.min(100, Math.round(100 * Math.exp(-distance/2))));
        
        // Format content for better display
        const content = result.document || result.content || 'No content available';
        const metadata = result.metadata || {};
        const functionName = metadata.function_name || '';
        const chunkType = metadata.chunk_type || 'code';
        const startLine = metadata.start_line || '';
        const endLine = metadata.end_line || '';
        
        // Create formatted code content
        const formattedContent = content.length > 200 ? content.substring(0, 200) + '...' : content;
        const lineRange = startLine && endLine ? `Lines ${startLine}-${endLine}` : '';
        
        resultItem.innerHTML = `
            <div class="search-result-header">
                <div class="search-result-file">
                    <i class="fas fa-file-code"></i>
                    <div class="search-result-file-info">
                        <div class="search-result-path">${metadata.file_path || 'Unknown file'}</div>
                        ${functionName ? `<div class="search-result-function">${chunkType}: ${functionName}</div>` : ''}
                        ${lineRange ? `<div class="search-result-lines">${lineRange}</div>` : ''}
                    </div>
                </div>
                <div class="search-result-score">${similarity}% match</div>
            </div>
            <div class="search-result-content">
                <pre><code class="language-${metadata.language || 'text'}">${formattedContent}</code></pre>
            </div>
            <div class="search-result-actions">
                <button class="btn-small" onclick="showFullResult(${JSON.stringify(result).replace(/"/g, '&quot;')})">
                    <i class="fas fa-expand"></i> View Details
                </button>
                <span class="search-result-type">${chunkType}</span>
            </div>
        `;
        
        searchResultsList.appendChild(resultItem);
    });
    
    searchResults.style.display = 'block';
}

function displayNoResults(query) {
    const searchResults = document.getElementById('searchResults');
    const searchResultsHeader = document.getElementById('searchResultsHeader');
    const searchResultsList = document.getElementById('searchResultsList');
    
    searchResultsHeader.textContent = `No results found for "${query}"`;
    
    searchResultsList.innerHTML = `
        <div class="search-empty">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
            <p>No code snippets found matching your search. Try different keywords or search terms.</p>
        </div>
    `;
    
    searchResults.style.display = 'block';
}

function displaySearchError(error) {
    const searchResults = document.getElementById('searchResults');
    const searchResultsHeader = document.getElementById('searchResultsHeader');
    const searchResultsList = document.getElementById('searchResultsList');
    
    searchResultsHeader.textContent = 'Search Error';
    
    searchResultsList.innerHTML = `
        <div class="search-empty">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--danger-color);"></i>
            <p>Search failed: ${error}</p>
            <p style="font-size: 0.75rem; color: var(--text-light);">Please try again or check your connection.</p>
        </div>
    `;
    
    searchResults.style.display = 'block';
}

// Update the Recent Code Searches section
function updateRecentSearches(query, resultCount) {
    const recentSearchesCard = document.getElementById('recent-searches-card');
    if (!recentSearchesCard) return;
    
    const searchesContainer = recentSearchesCard.querySelector('.jobs-list');
    const emptyState = recentSearchesCard.querySelector('.empty-state');
    
    // Create new search item
    const searchItem = document.createElement('div');
    searchItem.className = 'job-item';
    searchItem.style.background = 'rgba(167, 139, 250, 0.05)'; // Highlight new item
    
    const now = new Date();
    const timeString = now.toLocaleDateString('en-US', {
        month: 'short', 
        day: 'numeric', 
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
    });
    
    searchItem.innerHTML = `
        <div class="job-header">
            <span class="job-type">${query.length > 30 ? query.substring(0, 30) + '...' : query}</span>
            <span class="stat-value">${resultCount} results</span>
        </div>
        <div class="job-meta">${timeString}</div>
    `;
    
    // If there's an empty state, hide it and create the container
    if (emptyState) {
        emptyState.style.display = 'none';
        if (!searchesContainer) {
            const newContainer = document.createElement('div');
            newContainer.className = 'jobs-list';
            recentSearchesCard.appendChild(newContainer);
        }
    }
    
    const container = recentSearchesCard.querySelector('.jobs-list');
    if (container) {
        // Add to top of list
        container.insertBefore(searchItem, container.firstChild);
        
        // Remove highlighting after 3 seconds
        setTimeout(() => {
            searchItem.style.background = '';
        }, 3000);
        
        // Keep only the most recent 10 searches
        const items = container.querySelectorAll('.job-item');
        if (items.length > 10) {
            for (let i = 10; i < items.length; i++) {
                items[i].remove();
            }
        }
    }
}

// Show full result details in a modal
function showFullResult(result) {
    const modal = document.createElement('div');
    modal.className = 'search-result-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 2rem;
        max-width: 80%;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        position: relative;
    `;
    
    const metadata = result.metadata || {};
    const content = result.document || result.content || 'No content available';
    
    modalContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
            <h3 style="margin: 0; color: var(--text-color);">Code Details</h3>
            <button onclick="this.closest('.search-result-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <div style="font-size: 0.875rem; color: var(--text-color); margin-bottom: 0.5rem;">
                <strong>File:</strong> ${metadata.file_path || 'Unknown'}
            </div>
            ${metadata.function_name ? `<div style="font-size: 0.875rem; color: var(--primary-color); margin-bottom: 0.5rem;">
                <strong>Function:</strong> ${metadata.function_name}
            </div>` : ''}
            <div style="font-size: 0.875rem; color: var(--text-light); margin-bottom: 0.5rem;">
                <strong>Type:</strong> ${metadata.chunk_type || 'code'} | 
                <strong>Language:</strong> ${metadata.language || 'text'} | 
                <strong>Lines:</strong> ${metadata.start_line || '?'}-${metadata.end_line || '?'} |
                <strong>Match:</strong> ${Math.round(100 * Math.exp(-result.distance/2))}%
            </div>
        </div>
        
        <div style="background: var(--code-bg); padding: 1rem; border-radius: var(--radius-sm); overflow-x: auto;">
            <pre style="margin: 0; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.875rem; line-height: 1.5; white-space: pre-wrap;"><code>${content}</code></pre>
        </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // Close on outside click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Close drawer with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeSearchDrawer();
        // Also close modal if open
        const modal = document.querySelector('.search-result-modal');
        if (modal) modal.remove();
    }
});

// Initialize empty state on page load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchEmpty').style.display = 'block';
});
</script>

<!-- Include CSRF Token -->
{% csrf_token %}
{% endblock %}